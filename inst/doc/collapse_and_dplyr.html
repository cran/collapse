<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Sebastian Krantz" />

<meta name="date" content="2020-05-22" />

<title>collapse and dplyr</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore"><em>collapse</em> and <em>dplyr</em></h1>
<h3 class="subtitle">Fast (Weighted) Aggregations, Transformations and Panel Computations in a Piped Workflow</h3>
<h4 class="author">Sebastian Krantz</h4>
<h4 class="date">2020-05-22</h4>


<div id="TOC">
<ul>
<li><a href="#fast-aggregations">1. Fast Aggregations</a><ul>
<li><a href="#simple-aggregations">1.1 Simple Aggregations</a></li>
<li><a href="#more-speed-using-collapse-verbs">1.2 More Speed using <em>collapse</em> Verbs</a></li>
<li><a href="#multi-function-aggregations">1.3 Multi-Function Aggregations</a></li>
<li><a href="#weighted-aggregations">1.4 Weighted Aggregations</a></li>
</ul></li>
<li><a href="#fast-transformations">2. Fast Transformations</a><ul>
<li><a href="#fast-transform-and-compute-variables">2.1 Fast Transform and Compute Variables</a></li>
<li><a href="#replacing-and-sweeping-out-statistics">2.2 Replacing and Sweeping out Statistics</a></li>
<li><a href="#more-control-using-the-tra-function">2.3 More Control using the <code>TRA</code> Function</a></li>
<li><a href="#faster-centering-averaging-and-standardizing">2.4 Faster Centering, Averaging and Standardizing</a></li>
<li><a href="#lags-leads-differences-and-growth-rates">2.5 Lags / Leads, Differences and Growth Rates</a></li>
</ul></li>
<li><a href="#benchmarks">3. Benchmarks</a><ul>
<li><a href="#data">3.1 Data</a></li>
<li><a href="#selecting-subsetting-and-grouping">3.1 Selecting, Subsetting and Grouping</a></li>
<li><a href="#aggregation">3.1 Aggregation</a></li>
<li><a href="#transformation">3.2 Transformation</a></li>
</ul></li>
<li><a href="#references">References</a></li>
</ul>
</div>

<style type="text/css">
pre {
  max-height: 500px;
  overflow-y: auto;
}

pre[class] {
  max-height: 500px;
}
</style>
<p><em>collapse</em> is a C/C++ based package for data manipulation in R. It’s aims are</p>
<ol style="list-style-type: decimal">
<li><p>to facilitate complex data transformation and exploration tasks and</p></li>
<li><p>to help make R code fast, flexible, parsimonious and programmer friendly.</p></li>
</ol>
<p>This vignette focuses on the integration of <em>collapse</em> and the popular <em>dplyr</em> package by Hadley Wickham. In particular it will demonstrate how using <em>collapse</em>’s fast functions and some fast alternatives for <em>dplyr</em> verbs can substantially facilitate and speed up basic data manipulation, grouped and weighted aggregations and transformations, and panel-data computations (i.e. between- and within-transformations, panel-lags, differences and growth rates) in a <em>dplyr</em> (piped) workflow.</p>
<hr />
<p><strong>Notes:</strong></p>
<ul>
<li><p>This vignette is targeted at <em>dplyr</em> / <em>tidyverse</em> users. <em>collapse</em> is a standalone package and can be programmed efficiently without pipes or <em>dplyr</em> verbs.</p></li>
<li><p>The ‘Introduction to <em>collapse</em>’ vignette provides a thorough introduction to the package and a built-in structured documentation is available under <code>help(&quot;collapse-documentation&quot;)</code> after installing the package. In addition <code>help(&quot;collapse-package&quot;)</code> provides a compact set of examples for quick-start.</p></li>
</ul>
<hr />
<div id="fast-aggregations" class="section level2">
<h2>1. Fast Aggregations</h2>
<p>A key feature of <em>collapse</em> is it’s broad set of <em>Fast Statistical Functions</em> (<code>fsum, fprod, fmean, fmedian, fmode, fvar, fsd, fmin, fmax, ffirst, flast, fNobs, fNdistinct</code>) which are able to substantially speed-up column-wise, grouped and weighted computations on vectors, matrices or data.frame’s. The functions are S3 generic, with a default (vector), matrix and data.frame method, as well as a grouped_df method for grouped tibbles used by <em>dplyr</em>. The grouped tibble method has the following arguments:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">FUN.grouped_df</span>(x, [<span class="dt">w =</span> <span class="ot">NULL</span>,] <span class="dt">TRA =</span> <span class="ot">NULL</span>, [<span class="dt">na.rm =</span> <span class="ot">TRUE</span>,]</span>
<span id="cb1-2"><a href="#cb1-2"></a>               <span class="dt">use.g.names =</span> <span class="ot">FALSE</span>, <span class="dt">keep.group_vars =</span> <span class="ot">TRUE</span>, [<span class="dt">keep.w =</span> <span class="ot">TRUE</span>,] ...)</span></code></pre></div>
<p>where <code>w</code> is a weight variable (available only to <code>fsum, fprod, fmean, fmode, fvar</code> and <code>fsd</code>), and <code>TRA</code> and can be used to transform <code>x</code> using the computed statistics and one of 10 available transformations (<code>&quot;replace_fill&quot;, &quot;replace&quot;, &quot;-&quot;, &quot;-+&quot;, &quot;/&quot;, &quot;%&quot;, &quot;+&quot;, &quot;*&quot;, &quot;%%&quot;, &quot;-%%&quot;</code>). These transformations perform grouped replacing or sweeping out of the statistics computed by the function (discussed in section 2). <code>na.rm</code> efficiently removes missing values and is <code>TRUE</code> by default. <code>use.g.names</code> generates new row-names from the unique combinations of groups (default: disabled), whereas <code>keep.group_vars</code> (default: enabled) will keep the grouping columns as is custom in the native <code>data %&gt;% group_by(...) %&gt;% summarize(...)</code> workflow in <em>dplyr</em>. Finally, <code>keep.w</code> regulates whether a weighting variable used is also aggregated and saved in a column. For <code>fsum, fmean, fvar, fsd</code> and <code>fmode</code> this will compute the sum of the weights in each group, whereas <code>fprod</code> returns the product of the weights.</p>
<p>With that in mind, let’s consider some straightforward applications.</p>
<div id="simple-aggregations" class="section level3">
<h3>1.1 Simple Aggregations</h3>
<p>Consider the Groningen Growth and Development Center 10-Sector Database included in <em>collapse</em> and introduced in the main vignette:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">library</span>(collapse)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">head</span>(GGDC10S)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">#   Country Regioncode             Region Variable Year      AGR      MIN       MAN        PU</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co"># 1     BWA        SSA Sub-saharan Africa       VA 1960       NA       NA        NA        NA</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co"># 2     BWA        SSA Sub-saharan Africa       VA 1961       NA       NA        NA        NA</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co"># 3     BWA        SSA Sub-saharan Africa       VA 1962       NA       NA        NA        NA</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co"># 4     BWA        SSA Sub-saharan Africa       VA 1963       NA       NA        NA        NA</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co"># 5     BWA        SSA Sub-saharan Africa       VA 1964 16.30154 3.494075 0.7365696 0.1043936</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co"># 6     BWA        SSA Sub-saharan Africa       VA 1965 15.72700 2.495768 1.0181992 0.1350976</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="co">#         CON      WRT      TRA     FIRE      GOV      OTH      SUM</span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="co"># 1        NA       NA       NA       NA       NA       NA       NA</span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="co"># 2        NA       NA       NA       NA       NA       NA       NA</span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co"># 3        NA       NA       NA       NA       NA       NA       NA</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="co"># 4        NA       NA       NA       NA       NA       NA       NA</span></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="co"># 5 0.6600454 6.243732 1.658928 1.119194 4.822485 2.341328 37.48229</span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co"># 6 1.3462312 7.064825 1.939007 1.246789 5.695848 2.678338 39.34710</span></span>
<span id="cb2-17"><a href="#cb2-17"></a></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="co"># Summarize the Data: </span></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="co"># descr(GGDC10S, cols = is.categorical)</span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="co"># aperm(qsu(GGDC10S, ~Variable, cols = is.numeric))</span></span></code></pre></div>
<p>Simple column-wise computations using the fast functions and pipe operators are performed as follows:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span>fNobs                       <span class="co"># Number of Observations</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co">#    Country Regioncode     Region   Variable       Year        AGR        MIN        MAN         PU </span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">#       5027       5027       5027       5027       5027       4364       4355       4355       4354 </span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co">#        CON        WRT        TRA       FIRE        GOV        OTH        SUM </span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">#       4355       4355       4355       4355       3482       4248       4364</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span>fNdistinct                  <span class="co"># Number of distinct values</span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co">#    Country Regioncode     Region   Variable       Year        AGR        MIN        MAN         PU </span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co">#         43          6          6          2         67       4353       4224       4353       4237 </span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co">#        CON        WRT        TRA       FIRE        GOV        OTH        SUM </span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co">#       4339       4344       4334       4349       3470       4238       4364</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fmedian <span class="co"># Median</span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="co">#        AGR        MIN        MAN         PU        CON        WRT        TRA       FIRE        GOV </span></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="co">#  4394.5194   173.2234  3718.0981   167.9500  1473.4470  3773.6430  1174.8000   960.1251  3928.5127 </span></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="co">#        OTH        SUM </span></span>
<span id="cb3-17"><a href="#cb3-17"></a><span class="co">#  1433.1722 23186.1936</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fmean   <span class="co"># Mean</span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="co">#        AGR        MIN        MAN         PU        CON        WRT        TRA       FIRE        GOV </span></span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="co">#  2526696.5  1867908.9  5538491.4   335679.5  1801597.6  3392909.5  1473269.7  1657114.8  1712300.3 </span></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="co">#        OTH        SUM </span></span>
<span id="cb3-22"><a href="#cb3-22"></a><span class="co">#  1684527.3 21566436.8</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span>fmode                       <span class="co"># Mode</span></span>
<span id="cb3-24"><a href="#cb3-24"></a><span class="co">#            Country         Regioncode             Region           Variable               Year </span></span>
<span id="cb3-25"><a href="#cb3-25"></a><span class="co">#              &quot;USA&quot;              &quot;ASI&quot;             &quot;Asia&quot;              &quot;EMP&quot;             &quot;2010&quot; </span></span>
<span id="cb3-26"><a href="#cb3-26"></a><span class="co">#                AGR                MIN                MAN                 PU                CON </span></span>
<span id="cb3-27"><a href="#cb3-27"></a><span class="co"># &quot;171.315882316326&quot;                &quot;0&quot; &quot;4645.12507642586&quot;                &quot;0&quot; &quot;1.34623115930777&quot; </span></span>
<span id="cb3-28"><a href="#cb3-28"></a><span class="co">#                WRT                TRA               FIRE                GOV                OTH </span></span>
<span id="cb3-29"><a href="#cb3-29"></a><span class="co"># &quot;21.8380052682527&quot; &quot;8.97743416914571&quot; &quot;40.0701608636442&quot;                &quot;0&quot; &quot;3626.84423577048&quot; </span></span>
<span id="cb3-30"><a href="#cb3-30"></a><span class="co">#                SUM </span></span>
<span id="cb3-31"><a href="#cb3-31"></a><span class="co"># &quot;37.4822945751317&quot;</span></span>
<span id="cb3-32"><a href="#cb3-32"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmode</span>(<span class="dt">drop =</span> <span class="ot">FALSE</span>)         <span class="co"># Keep data structure intact</span></span>
<span id="cb3-33"><a href="#cb3-33"></a><span class="co">#   Country Regioncode Region Variable Year      AGR MIN      MAN PU      CON      WRT      TRA</span></span>
<span id="cb3-34"><a href="#cb3-34"></a><span class="co"># 1     USA        ASI   Asia      EMP 2010 171.3159   0 4645.125  0 1.346231 21.83801 8.977434</span></span>
<span id="cb3-35"><a href="#cb3-35"></a><span class="co">#       FIRE GOV      OTH      SUM</span></span>
<span id="cb3-36"><a href="#cb3-36"></a><span class="co"># 1 40.07016   0 3626.844 37.48229</span></span></code></pre></div>
<p>Moving on to grouped statistics, we can compute the average value added and employment by sector and country using:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="st">  </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="st">  </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fmean</span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co"># # A tibble: 85 x 13</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">#    Variable Country     AGR     MIN     MAN     PU    CON    WRT    TRA   FIRE     GOV    OTH    SUM</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">#    &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">#  1 EMP      ARG       1420.   52.1   1932.  1.02e2 7.42e2 1.98e3 6.49e2  628.   2043.  9.92e2 1.05e4</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co">#  2 EMP      BOL        964.   56.0    235.  5.35e0 1.23e2 2.82e2 1.15e2   44.6    NA   3.96e2 2.22e3</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co">#  3 EMP      BRA      17191.  206.    6991.  3.65e2 3.52e3 8.51e3 2.05e3 4414.   5307.  5.71e3 5.43e4</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co">#  4 EMP      BWA        188.   10.5     18.1 3.09e0 2.53e1 3.63e1 8.36e0   15.3    61.1 2.76e1 3.94e2</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="co">#  5 EMP      CHL        702.  101.     625.  2.94e1 2.96e2 6.95e2 2.58e2  272.     NA   1.00e3 3.98e3</span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co">#  6 EMP      CHN     287744. 7050.   67144.  1.61e3 2.09e4 2.89e4 1.39e4 4929.  22669.  3.10e4 4.86e5</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="co">#  7 EMP      COL       3091.  145.    1175.  3.39e1 5.24e2 2.07e3 4.70e2  649.     NA   1.73e3 9.89e3</span></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="co">#  8 EMP      CRI        231.    1.70   136.  1.43e1 5.76e1 1.57e2 4.24e1   54.9   128.  6.51e1 8.87e2</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="co">#  9 EMP      DEW       2490.  407.    8473.  2.26e2 2.09e3 4.44e3 1.48e3 1689.   3945.  9.99e2 2.62e4</span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="co"># 10 EMP      DNK        236.    8.03   507.  1.38e1 1.71e2 4.55e2 1.61e2  181.    549.  1.11e2 2.39e3</span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="co"># # ... with 75 more rows</span></span></code></pre></div>
<p>Similarly we can aggregate using any other of the above functions.</p>
<!-- ```{r} -->
<!-- GGDC10S %>%  -->
<!--   group_by(Variable, Country) %>% -->
<!--   select_at(6:16) %>% fmedian -->
<!-- GGDC10S %>%  -->
<!--   group_by(Variable, Country) %>% -->
<!--   select_at(6:16) %>% fsd -->
<!-- ``` -->
<p>It is important to not use <em>dplyr</em>’s <code>summarize</code> together with these functions since that would totally eliminate their speed gain. These functions are fast because they are executed only once and carry out the grouped computations in C++, whereas <code>summarize</code> will apply the function to each group in the grouped tibble. - It will also work with the fast functions, but is slower than using primitive base functions since the fast functions are S3 generic -.</p>
<hr />
<div id="excursus-what-is-happening-behind-the-scenes" class="section level4">
<h4>Excursus: What is Happening Behind the Scenes?</h4>
<p>To drive this point home it is perhaps good to shed some light on what is happening behind the scenes of <em>dplyr</em> and <em>collapse</em>. Fundamentally both packages follow different computing paradigms:</p>
<p><em>dplyr</em> is an efficient implementation of the Split-Apply-Combine computing paradigm. Data is split into groups, these data-chunks are then passed to a function carrying out the computation, and finally recombined to produce the aggregated data.frame. <!-- The efficiency of that process depends on the efficiency of the grouping, splitting, the function(s) applied and the recombining.  --> This modus operandi is evident in the grouping mechanism of <em>dplyr</em>. When a data.frame is passed through <em>group_by</em>, a ‘groups’ attribute is attached:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">attr</span>(<span class="st">&quot;groups&quot;</span>)</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co"># # A tibble: 85 x 3</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co">#    Variable Country .rows     </span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">#    &lt;chr&gt;    &lt;chr&gt;   &lt;list&gt;    </span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co">#  1 EMP      ARG     &lt;int [62]&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="co">#  2 EMP      BOL     &lt;int [61]&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co">#  3 EMP      BRA     &lt;int [62]&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="co">#  4 EMP      BWA     &lt;int [52]&gt;</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">#  5 EMP      CHL     &lt;int [63]&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="co">#  6 EMP      CHN     &lt;int [62]&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="co">#  7 EMP      COL     &lt;int [61]&gt;</span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="co">#  8 EMP      CRI     &lt;int [62]&gt;</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co">#  9 EMP      DEW     &lt;int [61]&gt;</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="co"># 10 EMP      DNK     &lt;int [64]&gt;</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="co"># # ... with 75 more rows</span></span></code></pre></div>
<p>This object is a data.frame giving the unique groups and in the third (last) column vectors containing the indices of the rows belonging to that group. A command like <code>summarize</code> uses this information to split the data.frame into groups which are then passed sequentially to the function used and later recombined. These steps are also done in C++ which makes <em>dplyr</em> quite efficient.</p>
<p>Now <em>collapse</em> is based around one-pass grouped computations at the C++ level using its own grouped statistical functions. In other words the data is not split and recombined at all but the entire computation is performed in a single C++ loop running through that data and completing the computations for each group simultaneously. This modus operandi is also evident in <em>collapse</em> grouping objects. The method <code>GRP.grouped_df</code> takes a <em>dplyr</em> grouping object from a grouped tibble and efficiently converts it to a <em>collapse</em> grouping object:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span>GRP <span class="op">%&gt;%</span><span class="st"> </span>str</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co"># List of 8</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">#  $ N.groups   : int 85</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">#  $ group.id   : int [1:5027] 46 46 46 46 46 46 46 46 46 46 ...</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">#  $ group.sizes: int [1:85] 62 61 62 52 63 62 61 62 61 64 ...</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co">#  $ groups     :List of 2</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co">#   ..$ Variable: chr [1:85] &quot;EMP&quot; &quot;EMP&quot; &quot;EMP&quot; &quot;EMP&quot; ...</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">#   .. ..- attr(*, &quot;label&quot;)= chr &quot;Variable&quot;</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co">#   .. ..- attr(*, &quot;format.stata&quot;)= chr &quot;%9s&quot;</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co">#   ..$ Country : chr [1:85] &quot;ARG&quot; &quot;BOL&quot; &quot;BRA&quot; &quot;BWA&quot; ...</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co">#   .. ..- attr(*, &quot;label&quot;)= chr &quot;Country&quot;</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co">#   .. ..- attr(*, &quot;format.stata&quot;)= chr &quot;%9s&quot;</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co">#  $ group.vars : chr [1:2] &quot;Variable&quot; &quot;Country&quot;</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="co">#  $ ordered    : logi [1:2] TRUE TRUE</span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co">#  $ order      : NULL</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="co">#  $ call       : language GRP.grouped_df(X = .)</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="co">#  - attr(*, &quot;class&quot;)= chr &quot;GRP&quot;</span></span></code></pre></div>
<p>This object is a list where the first three elements give the number of groups, the group-id to which each row belongs and a vector of group-sizes. A function like <code>fsum</code> uses this information to (for each column) create a result vector of size ‘N.groups’ and the run through the column using the ‘group.id’ vector to add the i’th data point to the ’group.id[i]’th element of the result vector. When the loop is finished, the grouped computation is also finished.</p>
<p>It is thus clear that <em>collapse</em> is faster than <em>dplyr</em> since it’s method of computing involves less steps. <!-- This performance gain is realized especially as data become large, since the conversion perfomed by `GRP.grouped_df` also involves a small computational cost.  --></p>
<hr />
</div>
</div>
<div id="more-speed-using-collapse-verbs" class="section level3">
<h3>1.2 More Speed using <em>collapse</em> Verbs</h3>
<p><em>collapse</em> fast functions do not develop their maximal performance on a grouped tibble created with <code>group_by</code> because of the additional conversion cost of the grouping object incurred by <code>GRP.grouped_df</code>. This cost is already minimized through the use of C++, but we can do even better replacing <code>group_by</code> with <code>collapse::fgroup_by</code>. <code>fgroup_by</code> works like <code>group_by</code> but does the grouping with <code>collapse::GRP</code> (up to 10x faster than <code>group_by</code>) and simply attaches a <em>collapse</em> grouping object to the grouped_df. Thus the speed gain is 2-fold: Faster grouping and no conversion cost when calling <em>collapse</em> functions.</p>
<p>Another improvement comes from replacing the <em>dplyr</em> verb <code>select</code> with <code>collapse::fselect</code>, and, for selection using column names, indices or functions use <code>collapse::get_vars</code> instead of <code>select_at</code> or <code>select_if</code>. Next to <code>get_vars</code>, <em>collapse</em> also introduces the predicates <code>num_vars</code>, <code>cat_vars</code>, <code>char_vars</code>, <code>fact_vars</code>, <code>logi_vars</code> and <code>Date_vars</code> to efficiently select columns by type.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">get_vars</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fmedian</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="co"># # A tibble: 85 x 13</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co">#    Variable Country     AGR     MIN     MAN     PU    CON    WRT    TRA   FIRE     GOV    OTH    SUM</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co">#    &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co">#  1 EMP      ARG       1325.   47.4   1988.  1.05e2 7.82e2 1.85e3 5.80e2  464.   1739.   866.  9.74e3</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co">#  2 EMP      BOL        943.   53.5    167.  4.46e0 6.60e1 1.32e2 9.70e1   15.3    NA    384.  1.84e3</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co">#  3 EMP      BRA      17481.  225.    7208.  3.76e2 4.05e3 6.45e3 1.58e3 4355.   4450.  4479.  5.19e4</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co">#  4 EMP      BWA        175.   12.2     13.1 3.71e0 1.90e1 2.11e1 6.75e0   10.4    53.8   31.2 3.61e2</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co">#  5 EMP      CHL        690.   93.9    607.  2.58e1 2.30e2 4.84e2 2.05e2  106.     NA    900.  3.31e3</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co">#  6 EMP      CHN     293915  8150.   61761.  1.14e3 1.06e4 1.70e4 9.56e3 4328.  19468.  9954.  4.45e5</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="co">#  7 EMP      COL       3006.   84.0   1033.  3.71e1 4.19e2 1.55e3 3.91e2  655.     NA   1430.  8.63e3</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="co">#  8 EMP      CRI        216.    1.49   114.  7.92e0 5.50e1 8.98e1 2.55e1   19.6   122.    60.6 7.19e2</span></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="co">#  9 EMP      DEW       2178   320.    8459.  2.47e2 2.10e3 4.45e3 1.53e3 1656    3700    900   2.65e4</span></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="co"># 10 EMP      DNK        187.    3.75   508.  1.36e1 1.65e2 4.61e2 1.61e2  169.    642.   104.  2.42e3</span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="co"># # ... with 75 more rows</span></span>
<span id="cb7-16"><a href="#cb7-16"></a></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="kw">microbenchmark</span>(<span class="dt">collapse =</span> GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">get_vars</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fmedian,</span>
<span id="cb7-18"><a href="#cb7-18"></a>               <span class="dt">hybrid =</span> GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fmedian,</span>
<span id="cb7-19"><a href="#cb7-19"></a>               <span class="dt">dplyr =</span> GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise_all</span>(median, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</span>
<span id="cb7-20"><a href="#cb7-20"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb7-21"><a href="#cb7-21"></a><span class="co">#      expr       min        lq     mean    median        uq        max neval</span></span>
<span id="cb7-22"><a href="#cb7-22"></a><span class="co">#  collapse   946.936  1058.945  1202.56  1135.253  1232.534   2435.617   100</span></span>
<span id="cb7-23"><a href="#cb7-23"></a><span class="co">#    hybrid 12710.456 13270.942 15071.00 14847.980 15393.962  22668.460   100</span></span>
<span id="cb7-24"><a href="#cb7-24"></a><span class="co">#     dplyr 52049.368 54979.203 61955.01 60657.921 64398.363 101796.546   100</span></span></code></pre></div>
<p>Benchmarks on the different components of this code and with larger data are provided under ‘Benchmarks’. Note that a grouped tibble created with <code>fgroup_by</code> can no longer be used for grouped computations with <em>dplyr</em> verbs like <code>mutate</code> or <code>summarize</code>. To avoid errors with these functions and <code>print.grouped_df</code>, <code>[.grouped_df</code> etc., the classes assigned after <code>fgroup_by</code> are reshuffled, so that the data.frame is treated by the <em>dplyr</em> ecosystem like a normal tibble:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">class</span>(<span class="kw">group_by</span>(GGDC10S, Variable, Country))</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="co"># [1] &quot;grouped_df&quot; &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="kw">class</span>(<span class="kw">fgroup_by</span>(GGDC10S, Variable, Country))</span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="co"># [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;grouped_df&quot; &quot;data.frame&quot;</span></span></code></pre></div>
<p>Also note that <code>fselect</code> and <code>get_vars</code> are not full drop-in replacements for <code>select</code> because they do not have a grouped_df method:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co"># # A tibble: 3 x 13</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co"># # Groups:   Variable, Country [1]</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co">#   Variable Country   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH   SUM</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="co"># 1 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="co"># 2 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="co"># 3 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">get_vars</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="co"># # A tibble: 3 x 11</span></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="co">#     AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH   SUM</span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="co">#   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="co"># 1    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb9-14"><a href="#cb9-14"></a><span class="co"># 2    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="co"># 3    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span></code></pre></div>
<p>Since by default <code>keep.group_vars = TRUE</code> in the <em>Fast Statistical Functions</em>, the end result is nevertheless the same:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fmean <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co"># # A tibble: 3 x 13</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co">#   Variable Country    AGR   MIN   MAN     PU   CON   WRT   TRA   FIRE   GOV   OTH    SUM</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co"># 1 EMP      ARG      1420.  52.1 1932. 102.    742. 1982.  649.  628.  2043.  992. 10542.</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="co"># 2 EMP      BOL       964.  56.0  235.   5.35  123.  282.  115.   44.6   NA   396.  2221.</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="co"># 3 EMP      BRA     17191. 206.  6991. 365.   3525. 8509. 2054. 4414.  5307. 5710. 54273.</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">get_vars</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fmean <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="co"># # A tibble: 3 x 13</span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="co">#   Variable Country    AGR   MIN   MAN     PU   CON   WRT   TRA   FIRE   GOV   OTH    SUM</span></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="co"># 1 EMP      ARG      1420.  52.1 1932. 102.    742. 1982.  649.  628.  2043.  992. 10542.</span></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="co"># 2 EMP      BOL       964.  56.0  235.   5.35  123.  282.  115.   44.6   NA   396.  2221.</span></span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="co"># 3 EMP      BRA     17191. 206.  6991. 365.   3525. 8509. 2054. 4414.  5307. 5710. 54273.</span></span></code></pre></div>
<p>Another useful verb introduced by <em>collapse</em> is <code>fgroup_vars</code>, which can be used to efficiently obtain the grouping columns or grouping variables from a grouped tibble:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># fgroup_by fully supports grouped tibbles created with group_by or fgroup_by: </span></span>
<span id="cb11-2"><a href="#cb11-2"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span>fgroup_vars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co"># # A tibble: 3 x 2</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co">#   Variable Country</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;  </span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="co"># 1 VA       BWA    </span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="co"># 2 VA       BWA    </span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co"># 3 VA       BWA</span></span>
<span id="cb11-9"><a href="#cb11-9"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span>fgroup_vars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="co"># # A tibble: 3 x 2</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="co">#   Variable Country</span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;  </span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="co"># 1 VA       BWA    </span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="co"># 2 VA       BWA    </span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="co"># 3 VA       BWA</span></span>
<span id="cb11-16"><a href="#cb11-16"></a></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="co"># The other possibilities:</span></span>
<span id="cb11-18"><a href="#cb11-18"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_vars</span>(<span class="st">&quot;unique&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb11-19"><a href="#cb11-19"></a><span class="co"># # A tibble: 3 x 2</span></span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="co">#   Variable Country</span></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;  </span></span>
<span id="cb11-22"><a href="#cb11-22"></a><span class="co"># 1 EMP      ARG    </span></span>
<span id="cb11-23"><a href="#cb11-23"></a><span class="co"># 2 EMP      BOL    </span></span>
<span id="cb11-24"><a href="#cb11-24"></a><span class="co"># 3 EMP      BRA</span></span>
<span id="cb11-25"><a href="#cb11-25"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_vars</span>(<span class="st">&quot;names&quot;</span>)</span>
<span id="cb11-26"><a href="#cb11-26"></a><span class="co"># [1] &quot;Variable&quot; &quot;Country&quot;</span></span>
<span id="cb11-27"><a href="#cb11-27"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_vars</span>(<span class="st">&quot;indices&quot;</span>)</span>
<span id="cb11-28"><a href="#cb11-28"></a><span class="co"># [1] 4 1</span></span>
<span id="cb11-29"><a href="#cb11-29"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_vars</span>(<span class="st">&quot;named_indices&quot;</span>)</span>
<span id="cb11-30"><a href="#cb11-30"></a><span class="co"># Variable  Country </span></span>
<span id="cb11-31"><a href="#cb11-31"></a><span class="co">#        4        1</span></span>
<span id="cb11-32"><a href="#cb11-32"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_vars</span>(<span class="st">&quot;logical&quot;</span>)</span>
<span id="cb11-33"><a href="#cb11-33"></a><span class="co">#  [1]  TRUE FALSE FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</span></span>
<span id="cb11-34"><a href="#cb11-34"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_vars</span>(<span class="st">&quot;named_logical&quot;</span>)</span>
<span id="cb11-35"><a href="#cb11-35"></a><span class="co">#    Country Regioncode     Region   Variable       Year        AGR        MIN        MAN         PU </span></span>
<span id="cb11-36"><a href="#cb11-36"></a><span class="co">#       TRUE      FALSE      FALSE       TRUE      FALSE      FALSE      FALSE      FALSE      FALSE </span></span>
<span id="cb11-37"><a href="#cb11-37"></a><span class="co">#        CON        WRT        TRA       FIRE        GOV        OTH        SUM </span></span>
<span id="cb11-38"><a href="#cb11-38"></a><span class="co">#      FALSE      FALSE      FALSE      FALSE      FALSE      FALSE      FALSE</span></span></code></pre></div>
<p>A final <em>collapse</em> verb to mention here is <code>fsubset</code>, a faster alternative to <code>dplyr::filter</code> which also provides an option to flexibly subset columns after the select argument:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="co"># Two equivalent calls, the first is substantially faster</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fsubset</span>(Variable <span class="op">==</span><span class="st"> &quot;VA&quot;</span> <span class="op">&amp;</span><span class="st"> </span>Year <span class="op">&gt;</span><span class="st"> </span><span class="dv">1990</span>, Country, Year, AGR<span class="op">:</span>GOV) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="co">#   Country Year      AGR      MIN      MAN       PU      CON      WRT      TRA     FIRE      GOV</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="co"># 1     BWA 1991 303.1157 2646.950 472.6488 160.6079 580.0876 806.7509 232.7884 432.6965 1073.263</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="co"># 2     BWA 1992 333.4364 2690.939 537.4274 178.4532 678.7320 725.2577 285.1403 517.2141 1234.012</span></span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="co"># 3     BWA 1993 404.5488 2624.928 567.3420 219.2183 634.2797 771.8253 349.7458 673.2540 1487.193</span></span>
<span id="cb12-7"><a href="#cb12-7"></a></span>
<span id="cb12-8"><a href="#cb12-8"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Variable <span class="op">==</span><span class="st"> &quot;VA&quot;</span> <span class="op">&amp;</span><span class="st"> </span>Year <span class="op">&gt;</span><span class="st"> </span><span class="dv">1990</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Country, Year, AGR<span class="op">:</span>GOV) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb12-9"><a href="#cb12-9"></a><span class="co">#   Country Year      AGR      MIN      MAN       PU      CON      WRT      TRA     FIRE      GOV</span></span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="co"># 1     BWA 1991 303.1157 2646.950 472.6488 160.6079 580.0876 806.7509 232.7884 432.6965 1073.263</span></span>
<span id="cb12-11"><a href="#cb12-11"></a><span class="co"># 2     BWA 1992 333.4364 2690.939 537.4274 178.4532 678.7320 725.2577 285.1403 517.2141 1234.012</span></span>
<span id="cb12-12"><a href="#cb12-12"></a><span class="co"># 3     BWA 1993 404.5488 2624.928 567.3420 219.2183 634.2797 771.8253 349.7458 673.2540 1487.193</span></span></code></pre></div>
</div>
<div id="multi-function-aggregations" class="section level3">
<h3>1.3 Multi-Function Aggregations</h3>
<p>One can also aggregate with multiple functions at the same time. For such operations it is often necessary to use curly braces <code>{</code> to prevent first argument injection so that <code>%&gt;% cbind(FUN1(.), FUN2(.))</code> does not evaluate as <code>%&gt;% cbind(., FUN1(.), FUN2(.))</code>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="st">  </span><span class="kw">get_vars</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>{</span>
<span id="cb13-4"><a href="#cb13-4"></a>    <span class="kw">cbind</span>(<span class="kw">fmedian</span>(.),</span>
<span id="cb13-5"><a href="#cb13-5"></a>          <span class="kw">add_stub</span>(<span class="kw">fmean</span>(., <span class="dt">keep.group_vars =</span> <span class="ot">FALSE</span>), <span class="st">&quot;mean_&quot;</span>))</span>
<span id="cb13-6"><a href="#cb13-6"></a>    } <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="co">#   Variable Country        AGR       MIN       MAN         PU        CON      WRT        TRA</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="co"># 1      EMP     ARG  1324.5255  47.35255 1987.5912 104.738825  782.40283 1854.612  579.93982</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="co"># 2      EMP     BOL   943.1612  53.53538  167.1502   4.457895   65.97904  132.225   96.96828</span></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="co"># 3      EMP     BRA 17480.9810 225.43693 7207.7915 375.851832 4054.66103 6454.523 1580.81120</span></span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="co">#         FIRE      GOV       OTH       SUM   mean_AGR  mean_MIN  mean_MAN    mean_PU  mean_CON</span></span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="co"># 1  464.39920 1738.836  866.1119  9743.223  1419.8013  52.08903 1931.7602 101.720936  742.4044</span></span>
<span id="cb13-13"><a href="#cb13-13"></a><span class="co"># 2   15.34259       NA  384.0678  1842.055   964.2103  56.03295  235.0332   5.346433  122.7827</span></span>
<span id="cb13-14"><a href="#cb13-14"></a><span class="co"># 3 4354.86210 4449.942 4478.6927 51881.110 17191.3529 206.02389 6991.3710 364.573404 3524.7384</span></span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="co">#    mean_WRT  mean_TRA  mean_FIRE mean_GOV  mean_OTH  mean_SUM</span></span>
<span id="cb13-16"><a href="#cb13-16"></a><span class="co"># 1 1982.1775  648.5119  627.79291 2043.471  992.4475 10542.177</span></span>
<span id="cb13-17"><a href="#cb13-17"></a><span class="co"># 2  281.5164  115.4728   44.56442       NA  395.5650  2220.524</span></span>
<span id="cb13-18"><a href="#cb13-18"></a><span class="co"># 3 8509.4612 2054.3731 4413.54448 5307.280 5710.2665 54272.985</span></span></code></pre></div>
<p>The function <code>add_stub</code> used above is a <em>collapse</em> function adding a prefix (default) or suffix to variables names. The <em>collapse</em> predicate <code>add_vars</code> provides a more efficient alternative to <code>cbind.data.frame</code>. The idea here is ‘adding’ variables to the data.frame in the first argument i.e. the attributes of the first argument are preserved, so the expression below still gives a tibble instead of a data.frame:</p>
<!-- A slightly more elegant solution to such multi-function aggregations can be found using `get_vars`, a collapse predicate to efficiently select variables. In contrast to `select_at`, `get_vars` does not automatically add the grouping columns to the selection. -->
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span>{</span>
<span id="cb14-3"><a href="#cb14-3"></a>   <span class="kw">add_vars</span>(<span class="kw">ffirst</span>(<span class="kw">get_vars</span>(., <span class="st">&quot;Reg&quot;</span>, <span class="dt">regex =</span> <span class="ot">TRUE</span>)),        <span class="co"># Regular expression matching column names</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>            <span class="kw">add_stub</span>(<span class="kw">fmean</span>(<span class="kw">num_vars</span>(.), <span class="dt">keep.group_vars =</span> <span class="ot">FALSE</span>), <span class="st">&quot;mean_&quot;</span>), <span class="co"># num_vars selects all numeric variables</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>            <span class="kw">add_stub</span>(<span class="kw">fmedian</span>(<span class="kw">fselect</span>(., PU<span class="op">:</span>TRA), <span class="dt">keep.group_vars =</span> <span class="ot">FALSE</span>), <span class="st">&quot;median_&quot;</span>), </span>
<span id="cb14-6"><a href="#cb14-6"></a>            <span class="kw">add_stub</span>(<span class="kw">fmin</span>(<span class="kw">fselect</span>(., PU<span class="op">:</span>CON), <span class="dt">keep.group_vars =</span> <span class="ot">FALSE</span>), <span class="st">&quot;min_&quot;</span>))      </span>
<span id="cb14-7"><a href="#cb14-7"></a>  }</span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="co"># # A tibble: 85 x 22</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="co">#    Variable Country Regioncode Region mean_Year mean_AGR mean_MIN mean_MAN mean_PU mean_CON mean_WRT</span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="co">#  1 EMP      ARG     LAM        Latin~     1980.    1420.    52.1    1932.   102.      742.    1982. </span></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="co">#  2 EMP      BOL     LAM        Latin~     1980      964.    56.0     235.     5.35    123.     282. </span></span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="co">#  3 EMP      BRA     LAM        Latin~     1980.   17191.   206.     6991.   365.     3525.    8509. </span></span>
<span id="cb14-14"><a href="#cb14-14"></a><span class="co">#  4 EMP      BWA     SSA        Sub-s~     1986.     188.    10.5      18.1    3.09     25.3     36.3</span></span>
<span id="cb14-15"><a href="#cb14-15"></a><span class="co">#  5 EMP      CHL     LAM        Latin~     1981      702.   101.      625.    29.4     296.     695. </span></span>
<span id="cb14-16"><a href="#cb14-16"></a><span class="co">#  6 EMP      CHN     ASI        Asia       1980.  287744.  7050.    67144.  1606.    20852.   28908. </span></span>
<span id="cb14-17"><a href="#cb14-17"></a><span class="co">#  7 EMP      COL     LAM        Latin~     1980     3091.   145.     1175.    33.9     524.    2071. </span></span>
<span id="cb14-18"><a href="#cb14-18"></a><span class="co">#  8 EMP      CRI     LAM        Latin~     1980.     231.     1.70    136.    14.3      57.6    157. </span></span>
<span id="cb14-19"><a href="#cb14-19"></a><span class="co">#  9 EMP      DEW     EUR        Europe     1980     2490.   407.     8473.   226.     2093.    4442. </span></span>
<span id="cb14-20"><a href="#cb14-20"></a><span class="co"># 10 EMP      DNK     EUR        Europe     1980.     236.     8.03    507.    13.8     171.     455. </span></span>
<span id="cb14-21"><a href="#cb14-21"></a><span class="co"># # ... with 75 more rows, and 11 more variables: mean_TRA &lt;dbl&gt;, mean_FIRE &lt;dbl&gt;, mean_GOV &lt;dbl&gt;,</span></span>
<span id="cb14-22"><a href="#cb14-22"></a><span class="co"># #   mean_OTH &lt;dbl&gt;, mean_SUM &lt;dbl&gt;, median_PU &lt;dbl&gt;, median_CON &lt;dbl&gt;, median_WRT &lt;dbl&gt;,</span></span>
<span id="cb14-23"><a href="#cb14-23"></a><span class="co"># #   median_TRA &lt;dbl&gt;, min_PU &lt;dbl&gt;, min_CON &lt;dbl&gt;</span></span></code></pre></div>
<p>Another nice feature of <code>add_vars</code> is that it can also very efficiently reorder columns i.e. bind columns in a different order than they are passed. This can be done by simply specifying the positions the added columns should have in the final data.frame, and then <code>add_vars</code> shifts the first argument columns to the right to fill in the gaps.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="st">  </span><span class="kw">fsubset</span>(Variable <span class="op">==</span><span class="st"> &quot;VA&quot;</span>, Country, AGR, SUM) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Country) <span class="op">%&gt;%</span><span class="st"> </span>{</span>
<span id="cb15-4"><a href="#cb15-4"></a>   <span class="kw">add_vars</span>(<span class="kw">fgroup_vars</span>(.,<span class="st">&quot;unique&quot;</span>),</span>
<span id="cb15-5"><a href="#cb15-5"></a>            <span class="kw">add_stub</span>(<span class="kw">fmean</span>(., <span class="dt">keep.group_vars =</span> <span class="ot">FALSE</span>), <span class="st">&quot;mean_&quot;</span>),</span>
<span id="cb15-6"><a href="#cb15-6"></a>            <span class="kw">add_stub</span>(<span class="kw">fsd</span>(., <span class="dt">keep.group_vars =</span> <span class="ot">FALSE</span>), <span class="st">&quot;sd_&quot;</span>), </span>
<span id="cb15-7"><a href="#cb15-7"></a>            <span class="dt">pos =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">5</span>))</span>
<span id="cb15-8"><a href="#cb15-8"></a>  } <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb15-9"><a href="#cb15-9"></a><span class="co">#   Country  mean_AGR    sd_AGR   mean_SUM    sd_SUM</span></span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="co"># 1     ARG 14951.292 33061.413  152533.84 301316.25</span></span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="co"># 2     BOL  3299.718  4456.331   22619.18  33172.98</span></span>
<span id="cb15-12"><a href="#cb15-12"></a><span class="co"># 3     BRA 76870.146 59441.696 1200562.67 976963.14</span></span></code></pre></div>
<p>A much more compact solution to multi-function and multi-type aggregation with <em>dplyr</em> is offered by the function <em>collapg</em>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># This aggregates numeric colums using the mean (fmean) and categorical columns with the mode (fmode)</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span>collapg</span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="co"># # A tibble: 85 x 16</span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="co">#    Variable Country Regioncode Region  Year    AGR    MIN    MAN     PU    CON    WRT    TRA   FIRE</span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="co">#    &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="co">#  1 EMP      ARG     LAM        Latin~ 1980. 1.42e3 5.21e1 1.93e3 1.02e2 7.42e2 1.98e3 6.49e2  628. </span></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="co">#  2 EMP      BOL     LAM        Latin~ 1980  9.64e2 5.60e1 2.35e2 5.35e0 1.23e2 2.82e2 1.15e2   44.6</span></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="co">#  3 EMP      BRA     LAM        Latin~ 1980. 1.72e4 2.06e2 6.99e3 3.65e2 3.52e3 8.51e3 2.05e3 4414. </span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="co">#  4 EMP      BWA     SSA        Sub-s~ 1986. 1.88e2 1.05e1 1.81e1 3.09e0 2.53e1 3.63e1 8.36e0   15.3</span></span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="co">#  5 EMP      CHL     LAM        Latin~ 1981  7.02e2 1.01e2 6.25e2 2.94e1 2.96e2 6.95e2 2.58e2  272. </span></span>
<span id="cb16-11"><a href="#cb16-11"></a><span class="co">#  6 EMP      CHN     ASI        Asia   1980. 2.88e5 7.05e3 6.71e4 1.61e3 2.09e4 2.89e4 1.39e4 4929. </span></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="co">#  7 EMP      COL     LAM        Latin~ 1980  3.09e3 1.45e2 1.18e3 3.39e1 5.24e2 2.07e3 4.70e2  649. </span></span>
<span id="cb16-13"><a href="#cb16-13"></a><span class="co">#  8 EMP      CRI     LAM        Latin~ 1980. 2.31e2 1.70e0 1.36e2 1.43e1 5.76e1 1.57e2 4.24e1   54.9</span></span>
<span id="cb16-14"><a href="#cb16-14"></a><span class="co">#  9 EMP      DEW     EUR        Europe 1980  2.49e3 4.07e2 8.47e3 2.26e2 2.09e3 4.44e3 1.48e3 1689. </span></span>
<span id="cb16-15"><a href="#cb16-15"></a><span class="co"># 10 EMP      DNK     EUR        Europe 1980. 2.36e2 8.03e0 5.07e2 1.38e1 1.71e2 4.55e2 1.61e2  181. </span></span>
<span id="cb16-16"><a href="#cb16-16"></a><span class="co"># # ... with 75 more rows, and 3 more variables: GOV &lt;dbl&gt;, OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></span></code></pre></div>
<p>By default it aggregates numeric columns using the <code>fmean</code> and categorical columns using <code>fmode</code>, and preserves the order of all columns. Changing these defaults is very easy:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># This aggregates numeric colums using the median and categorical columns using the first value</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collapg</span>(fmedian, flast)</span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="co"># # A tibble: 85 x 16</span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="co">#    Variable Country Regioncode Region  Year    AGR    MIN    MAN     PU    CON    WRT    TRA   FIRE</span></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="co">#    &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="co">#  1 EMP      ARG     LAM        Latin~ 1980. 1.32e3 4.74e1 1.99e3 1.05e2 7.82e2 1.85e3 5.80e2  464. </span></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="co">#  2 EMP      BOL     LAM        Latin~ 1980  9.43e2 5.35e1 1.67e2 4.46e0 6.60e1 1.32e2 9.70e1   15.3</span></span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="co">#  3 EMP      BRA     LAM        Latin~ 1980. 1.75e4 2.25e2 7.21e3 3.76e2 4.05e3 6.45e3 1.58e3 4355. </span></span>
<span id="cb17-9"><a href="#cb17-9"></a><span class="co">#  4 EMP      BWA     SSA        Sub-s~ 1986. 1.75e2 1.22e1 1.31e1 3.71e0 1.90e1 2.11e1 6.75e0   10.4</span></span>
<span id="cb17-10"><a href="#cb17-10"></a><span class="co">#  5 EMP      CHL     LAM        Latin~ 1981  6.90e2 9.39e1 6.07e2 2.58e1 2.30e2 4.84e2 2.05e2  106. </span></span>
<span id="cb17-11"><a href="#cb17-11"></a><span class="co">#  6 EMP      CHN     ASI        Asia   1980. 2.94e5 8.15e3 6.18e4 1.14e3 1.06e4 1.70e4 9.56e3 4328. </span></span>
<span id="cb17-12"><a href="#cb17-12"></a><span class="co">#  7 EMP      COL     LAM        Latin~ 1980  3.01e3 8.40e1 1.03e3 3.71e1 4.19e2 1.55e3 3.91e2  655. </span></span>
<span id="cb17-13"><a href="#cb17-13"></a><span class="co">#  8 EMP      CRI     LAM        Latin~ 1980. 2.16e2 1.49e0 1.14e2 7.92e0 5.50e1 8.98e1 2.55e1   19.6</span></span>
<span id="cb17-14"><a href="#cb17-14"></a><span class="co">#  9 EMP      DEW     EUR        Europe 1980  2.18e3 3.20e2 8.46e3 2.47e2 2.10e3 4.45e3 1.53e3 1656  </span></span>
<span id="cb17-15"><a href="#cb17-15"></a><span class="co"># 10 EMP      DNK     EUR        Europe 1980. 1.87e2 3.75e0 5.08e2 1.36e1 1.65e2 4.61e2 1.61e2  169. </span></span>
<span id="cb17-16"><a href="#cb17-16"></a><span class="co"># # ... with 75 more rows, and 3 more variables: GOV &lt;dbl&gt;, OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></span></code></pre></div>
<p>One can apply multiple functions to both numeric and/or categorical data:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="st">  </span><span class="kw">collapg</span>(<span class="kw">list</span>(fmean, fmedian), <span class="kw">list</span>(first, fmode, flast)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="co"># # A tibble: 3 x 32</span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="co">#   Variable Country first.Regioncode fmode.Regioncode flast.Regioncode first.Region fmode.Region</span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;            &lt;chr&gt;            &lt;chr&gt;            &lt;chr&gt;        &lt;chr&gt;       </span></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="co"># 1 EMP      ARG     LAM              LAM              LAM              Latin Ameri~ Latin Ameri~</span></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="co"># 2 EMP      BOL     LAM              LAM              LAM              Latin Ameri~ Latin Ameri~</span></span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="co"># 3 EMP      BRA     LAM              LAM              LAM              Latin Ameri~ Latin Ameri~</span></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="co"># # ... with 25 more variables: flast.Region &lt;chr&gt;, fmean.Year &lt;dbl&gt;, fmedian.Year &lt;dbl&gt;,</span></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="co"># #   fmean.AGR &lt;dbl&gt;, fmedian.AGR &lt;dbl&gt;, fmean.MIN &lt;dbl&gt;, fmedian.MIN &lt;dbl&gt;, fmean.MAN &lt;dbl&gt;,</span></span>
<span id="cb18-11"><a href="#cb18-11"></a><span class="co"># #   fmedian.MAN &lt;dbl&gt;, fmean.PU &lt;dbl&gt;, fmedian.PU &lt;dbl&gt;, fmean.CON &lt;dbl&gt;, fmedian.CON &lt;dbl&gt;,</span></span>
<span id="cb18-12"><a href="#cb18-12"></a><span class="co"># #   fmean.WRT &lt;dbl&gt;, fmedian.WRT &lt;dbl&gt;, fmean.TRA &lt;dbl&gt;, fmedian.TRA &lt;dbl&gt;, fmean.FIRE &lt;dbl&gt;,</span></span>
<span id="cb18-13"><a href="#cb18-13"></a><span class="co"># #   fmedian.FIRE &lt;dbl&gt;, fmean.GOV &lt;dbl&gt;, fmedian.GOV &lt;dbl&gt;, fmean.OTH &lt;dbl&gt;, fmedian.OTH &lt;dbl&gt;,</span></span>
<span id="cb18-14"><a href="#cb18-14"></a><span class="co"># #   fmean.SUM &lt;dbl&gt;, fmedian.SUM &lt;dbl&gt;</span></span></code></pre></div>
<p>Applying multiple functions to only numeric (or only categorical) data allows return in a long format:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="st">  </span><span class="kw">collapg</span>(<span class="kw">list</span>(fmean, fmedian), <span class="dt">cols =</span> is.numeric, <span class="dt">return =</span> <span class="st">&quot;long&quot;</span>)</span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="co"># # A tibble: 170 x 15</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="co">#    Function Variable Country  Year    AGR    MIN    MAN     PU    CON    WRT    TRA   FIRE     GOV</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="co">#    &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="co">#  1 fmean    EMP      ARG     1980. 1.42e3 5.21e1 1.93e3 1.02e2 7.42e2 1.98e3 6.49e2  628.   2043. </span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="co">#  2 fmean    EMP      BOL     1980  9.64e2 5.60e1 2.35e2 5.35e0 1.23e2 2.82e2 1.15e2   44.6    NA  </span></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="co">#  3 fmean    EMP      BRA     1980. 1.72e4 2.06e2 6.99e3 3.65e2 3.52e3 8.51e3 2.05e3 4414.   5307. </span></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="co">#  4 fmean    EMP      BWA     1986. 1.88e2 1.05e1 1.81e1 3.09e0 2.53e1 3.63e1 8.36e0   15.3    61.1</span></span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="co">#  5 fmean    EMP      CHL     1981  7.02e2 1.01e2 6.25e2 2.94e1 2.96e2 6.95e2 2.58e2  272.     NA  </span></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="co">#  6 fmean    EMP      CHN     1980. 2.88e5 7.05e3 6.71e4 1.61e3 2.09e4 2.89e4 1.39e4 4929.  22669. </span></span>
<span id="cb19-12"><a href="#cb19-12"></a><span class="co">#  7 fmean    EMP      COL     1980  3.09e3 1.45e2 1.18e3 3.39e1 5.24e2 2.07e3 4.70e2  649.     NA  </span></span>
<span id="cb19-13"><a href="#cb19-13"></a><span class="co">#  8 fmean    EMP      CRI     1980. 2.31e2 1.70e0 1.36e2 1.43e1 5.76e1 1.57e2 4.24e1   54.9   128. </span></span>
<span id="cb19-14"><a href="#cb19-14"></a><span class="co">#  9 fmean    EMP      DEW     1980  2.49e3 4.07e2 8.47e3 2.26e2 2.09e3 4.44e3 1.48e3 1689.   3945. </span></span>
<span id="cb19-15"><a href="#cb19-15"></a><span class="co"># 10 fmean    EMP      DNK     1980. 2.36e2 8.03e0 5.07e2 1.38e1 1.71e2 4.55e2 1.61e2  181.    549. </span></span>
<span id="cb19-16"><a href="#cb19-16"></a><span class="co"># # ... with 160 more rows, and 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></span></code></pre></div>
<p>Finally, <code>collapg</code> also makes it very easy to apply aggregator functions to certain columns only:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="st">  </span><span class="kw">collapg</span>(<span class="dt">custom =</span> <span class="kw">list</span>(<span class="dt">fmean =</span> <span class="dv">6</span><span class="op">:</span><span class="dv">8</span>, <span class="dt">fmedian =</span> <span class="dv">10</span><span class="op">:</span><span class="dv">12</span>))</span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="co"># # A tibble: 85 x 8</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="co">#    Variable Country fmean.AGR fmean.MIN fmean.MAN fmedian.CON fmedian.WRT fmedian.TRA</span></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="co">#    &lt;chr&gt;    &lt;chr&gt;       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;</span></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="co">#  1 EMP      ARG         1420.     52.1     1932.        782.       1855.       580.  </span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="co">#  2 EMP      BOL          964.     56.0      235.         66.0       132.        97.0 </span></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="co">#  3 EMP      BRA        17191.    206.      6991.       4055.       6455.      1581.  </span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="co">#  4 EMP      BWA          188.     10.5       18.1        19.0        21.1        6.75</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="co">#  5 EMP      CHL          702.    101.       625.        230.        484.       205.  </span></span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="co">#  6 EMP      CHN       287744.   7050.     67144.      10578.      17034.      9564.  </span></span>
<span id="cb20-12"><a href="#cb20-12"></a><span class="co">#  7 EMP      COL         3091.    145.      1175.        419.       1553.       391.  </span></span>
<span id="cb20-13"><a href="#cb20-13"></a><span class="co">#  8 EMP      CRI          231.      1.70     136.         55.0        89.8       25.5 </span></span>
<span id="cb20-14"><a href="#cb20-14"></a><span class="co">#  9 EMP      DEW         2490.    407.      8473.       2095.       4454.      1525.  </span></span>
<span id="cb20-15"><a href="#cb20-15"></a><span class="co"># 10 EMP      DNK          236.      8.03     507.        165.        461.       161.  </span></span>
<span id="cb20-16"><a href="#cb20-16"></a><span class="co"># # ... with 75 more rows</span></span></code></pre></div>
<p>To understand more about <code>collapg</code>, look it up in the documentation (<code>?collapg</code>).</p>
</div>
<div id="weighted-aggregations" class="section level3">
<h3>1.4 Weighted Aggregations</h3>
<p>Weighted aggregations are currently possible with the functions <code>fsum, fprod, fmean, fmode, fvar</code> and <code>fsd</code>. The implementation is such that by default (option <code>keep.w = TRUE</code>) these functions also aggregate the weights, so that further weighted computations can be performed on the aggregated data. <code>fsum, fmean</code>, <code>fsd</code>, <code>fvar</code> and <code>fmode</code> compute a grouped sum of the weight column and place it next to the group-identifiers; <code>fprod</code> computes the product of the weights.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># This computes a frequency-weighted grouped standard-deviation, taking the total EMP / VA as weight</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="st">  </span><span class="kw">fselect</span>(AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fsd</span>(SUM)</span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="co"># # A tibble: 85 x 13</span></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="co">#    Variable Country  sum.SUM     AGR    MIN    MAN     PU    CON    WRT    TRA   FIRE     GOV    OTH</span></span>
<span id="cb21-7"><a href="#cb21-7"></a><span class="co">#    &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb21-8"><a href="#cb21-8"></a><span class="co">#  1 EMP      ARG       6.54e5   225.  2.22e1 1.76e2 2.05e1 2.85e2 8.56e2 1.95e2  493.   1123.  5.06e2</span></span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="co">#  2 EMP      BOL       1.35e5    99.7 1.71e1 1.68e2 4.87e0 1.23e2 3.24e2 9.81e1   69.8    NA   2.58e2</span></span>
<span id="cb21-10"><a href="#cb21-10"></a><span class="co">#  3 EMP      BRA       3.36e6  1587.  7.38e1 2.95e3 9.38e1 1.86e3 6.28e3 1.31e3 3003.   3621.  4.26e3</span></span>
<span id="cb21-11"><a href="#cb21-11"></a><span class="co">#  4 EMP      BWA       1.85e4    32.2 3.72e0 1.48e1 1.59e0 1.80e1 3.87e1 6.02e0   13.5    39.8 8.94e0</span></span>
<span id="cb21-12"><a href="#cb21-12"></a><span class="co">#  5 EMP      CHL       2.51e5    71.0 3.99e1 1.29e2 1.24e1 1.88e2 5.51e2 1.34e2  313.     NA   4.26e2</span></span>
<span id="cb21-13"><a href="#cb21-13"></a><span class="co">#  6 EMP      CHN       2.91e7 56281.  3.09e3 4.04e4 1.27e3 1.92e4 2.45e4 9.26e3 2853.  11541.  3.74e4</span></span>
<span id="cb21-14"><a href="#cb21-14"></a><span class="co">#  7 EMP      COL       6.03e5   637.  1.48e2 5.94e2 1.52e1 3.97e2 1.89e3 3.62e2  435.     NA   1.01e3</span></span>
<span id="cb21-15"><a href="#cb21-15"></a><span class="co">#  8 EMP      CRI       5.50e4    40.4 1.04e0 7.93e1 1.37e1 3.44e1 1.68e2 4.53e1   79.8    80.7 4.34e1</span></span>
<span id="cb21-16"><a href="#cb21-16"></a><span class="co">#  9 EMP      DEW       1.10e6  1175.  1.83e2 7.42e2 5.32e1 1.94e2 6.06e2 2.12e2  699.   1225.  3.55e2</span></span>
<span id="cb21-17"><a href="#cb21-17"></a><span class="co"># 10 EMP      DNK       1.53e5   139.  7.45e0 7.73e1 1.92e0 2.56e1 5.33e1 1.57e1   91.6   248.  1.95e1</span></span>
<span id="cb21-18"><a href="#cb21-18"></a><span class="co"># # ... with 75 more rows</span></span>
<span id="cb21-19"><a href="#cb21-19"></a></span>
<span id="cb21-20"><a href="#cb21-20"></a><span class="co"># This computes a weighted grouped mode, taking the total EMP / VA as weight</span></span>
<span id="cb21-21"><a href="#cb21-21"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb21-22"><a href="#cb21-22"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span></span>
<span id="cb21-23"><a href="#cb21-23"></a><span class="st">  </span><span class="kw">fselect</span>(AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmode</span>(SUM)</span>
<span id="cb21-24"><a href="#cb21-24"></a><span class="co"># # A tibble: 85 x 13</span></span>
<span id="cb21-25"><a href="#cb21-25"></a><span class="co">#    Variable Country  sum.SUM     AGR     MIN    MAN     PU    CON    WRT    TRA   FIRE    GOV    OTH</span></span>
<span id="cb21-26"><a href="#cb21-26"></a><span class="co">#    &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb21-27"><a href="#cb21-27"></a><span class="co">#  1 EMP      ARG       6.54e5  1.16e3  127.   2.16e3 1.52e2 1.41e3  3768. 1.06e3 1.75e3  4336. 2.00e3</span></span>
<span id="cb21-28"><a href="#cb21-28"></a><span class="co">#  2 EMP      BOL       1.35e5  8.19e2   37.6  6.04e2 1.08e1 4.33e2   893. 3.33e2 3.21e2    NA  1.06e3</span></span>
<span id="cb21-29"><a href="#cb21-29"></a><span class="co">#  3 EMP      BRA       3.36e6  1.65e4  313.   1.18e4 3.88e2 8.15e3 21860. 5.17e3 1.20e4 12149. 1.42e4</span></span>
<span id="cb21-30"><a href="#cb21-30"></a><span class="co">#  4 EMP      BWA       1.85e4  1.71e2   13.1  4.33e1 3.93e0 1.81e1   129. 2.10e1 4.67e1   113. 2.62e1</span></span>
<span id="cb21-31"><a href="#cb21-31"></a><span class="co">#  5 EMP      CHL       2.51e5  6.30e2  249.   7.42e2 6.07e1 6.71e2  1989. 4.81e2 8.54e2    NA  1.88e3</span></span>
<span id="cb21-32"><a href="#cb21-32"></a><span class="co">#  6 EMP      CHN       2.91e7  2.66e5 9247.   1.43e5 3.53e3 6.99e4 84165. 3.12e4 1.08e4 43240. 1.03e5</span></span>
<span id="cb21-33"><a href="#cb21-33"></a><span class="co">#  7 EMP      COL       6.03e5  3.93e3  513.   2.37e3 5.89e1 1.41e3  6069. 1.36e3 1.82e3    NA  3.57e3</span></span>
<span id="cb21-34"><a href="#cb21-34"></a><span class="co">#  8 EMP      CRI       5.50e4  2.83e2    2.42 2.49e2 4.38e1 1.20e2   489. 1.44e2 2.25e2   328. 1.75e2</span></span>
<span id="cb21-35"><a href="#cb21-35"></a><span class="co">#  9 EMP      DEW       1.10e6  1.03e3  260    8.73e3 2.91e2 2.06e3  4398  1.63e3 3.26e3  6129  1.79e3</span></span>
<span id="cb21-36"><a href="#cb21-36"></a><span class="co"># 10 EMP      DNK       1.53e5  7.85e1    3.12 3.99e2 1.14e1 1.95e2   579. 1.87e2 3.82e2   835. 1.50e2</span></span>
<span id="cb21-37"><a href="#cb21-37"></a><span class="co"># # ... with 75 more rows</span></span></code></pre></div>
<p>The weighted variance / standard deviation is currently only implemented with frequency weights. Reliability weights may be implemented in a future update of <em>collapse</em>, if this is a strongly requested feature.</p>
<p>Weighted aggregations may also be performed with <code>collapg</code>.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># This aggregates numeric colums using the weighted mean and categorical columns using the weighted mode</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collapg</span>(<span class="dt">w =</span> SUM)</span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="co"># # A tibble: 85 x 16</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="co">#    Variable Country    SUM Regioncode Region  Year    AGR    MIN    MAN     PU    CON    WRT    TRA</span></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="co">#    &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="co">#  1 EMP      ARG     6.54e5 LAM        Latin~ 1985. 1.36e3 5.65e1 1.93e3 1.05e2 8.11e2 2.22e3 6.95e2</span></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="co">#  2 EMP      BOL     1.35e5 LAM        Latin~ 1987. 9.77e2 5.79e1 2.96e2 7.07e0 1.67e2 4.00e2 1.52e2</span></span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="co">#  3 EMP      BRA     3.36e6 LAM        Latin~ 1989. 1.77e4 2.38e2 8.47e3 3.89e2 4.44e3 1.14e4 2.62e3</span></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="co">#  4 EMP      BWA     1.85e4 SSA        Sub-s~ 1993. 2.00e2 1.21e1 2.43e1 3.70e0 3.14e1 5.08e1 1.08e1</span></span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="co">#  5 EMP      CHL     2.51e5 LAM        Latin~ 1988. 6.93e2 1.07e2 6.68e2 3.35e1 3.67e2 8.95e2 3.09e2</span></span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="co">#  6 EMP      CHN     2.91e7 ASI        Asia   1988. 3.09e5 8.23e3 8.34e4 2.09e3 2.80e4 3.80e4 1.75e4</span></span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="co">#  7 EMP      COL     6.03e5 LAM        Latin~ 1989. 3.44e3 2.04e2 1.49e3 4.20e1 7.18e2 3.02e3 6.39e2</span></span>
<span id="cb22-13"><a href="#cb22-13"></a><span class="co">#  8 EMP      CRI     5.50e4 LAM        Latin~ 1991. 2.54e2 2.10e0 1.87e2 2.19e1 7.84e1 2.47e2 6.50e1</span></span>
<span id="cb22-14"><a href="#cb22-14"></a><span class="co">#  9 EMP      DEW     1.10e6 EUR        Europe 1971. 2.40e3 3.95e2 8.51e3 2.29e2 2.10e3 4.49e3 1.50e3</span></span>
<span id="cb22-15"><a href="#cb22-15"></a><span class="co"># 10 EMP      DNK     1.53e5 EUR        Europe 1981. 2.23e2 7.41e0 5.03e2 1.39e1 1.72e2 4.60e2 1.62e2</span></span>
<span id="cb22-16"><a href="#cb22-16"></a><span class="co"># # ... with 75 more rows, and 3 more variables: FIRE &lt;dbl&gt;, GOV &lt;dbl&gt;, OTH &lt;dbl&gt;</span></span></code></pre></div>
<!-- Thus to aggregate the entire data and save the weights one would need to opt for a manual solution: -->
<!-- ```{r} -->
<!-- GGDC10S %>% -->
<!--   fgroup_by(Variable, Country) %>% { -->
<!--     add_vars(fmean(get_vars(., 6:16), SUM), -->
<!--              fmode(get_vars(., c(2:3,16)), SUM, keep.group_vars = FALSE), -->
<!--              pos = c(5, 2:3)) -->
<!--   } -->
<!-- ``` -->
<!-- <!-- ```{r} -->
<!-- <!-- GGDC10S %>%  -->
<!-- <!--   group_by(Variable, Country) %>% collapg(w = .$SUM) -->
<!-- ``` -->
</div>
</div>
<div id="fast-transformations" class="section level2">
<h2>2. Fast Transformations</h2>
<p><em>collapse</em> also provides some fast transformations that significantly extend in scope and speed up manipulations that can be performed with <code>dplyr::mutate</code>. <!-- bring to *dplyr* in terms of grouped transformations. --></p>
<div id="fast-transform-and-compute-variables" class="section level3">
<h3>2.1 Fast Transform and Compute Variables</h3>
<p>The function <code>ftransform</code> can be used to manipulate columns in the same ways as <code>mutate</code>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fsubset</span>(Variable <span class="op">==</span><span class="st"> &quot;VA&quot;</span>, Country, Year, AGR, SUM) <span class="op">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="st">  </span><span class="kw">ftransform</span>(<span class="dt">AGR_perc =</span> AGR <span class="op">/</span><span class="st"> </span>SUM <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,  <span class="co"># Computing % of VA in Agriculture</span></span>
<span id="cb23-3"><a href="#cb23-3"></a>             <span class="dt">AGR_mean =</span> <span class="kw">fmean</span>(AGR),       <span class="co"># Average Agricultural VA</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>             <span class="dt">AGR =</span> <span class="ot">NULL</span>, <span class="dt">SUM =</span> <span class="ot">NULL</span>) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Deleting columns AGR and SUM</span></span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="st">             </span>head</span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="co">#   Country Year AGR_perc AGR_mean</span></span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="co"># 1     BWA 1960       NA  5137561</span></span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="co"># 2     BWA 1961       NA  5137561</span></span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="co"># 3     BWA 1962       NA  5137561</span></span>
<span id="cb23-10"><a href="#cb23-10"></a><span class="co"># 4     BWA 1963       NA  5137561</span></span>
<span id="cb23-11"><a href="#cb23-11"></a><span class="co"># 5     BWA 1964 43.49132  5137561</span></span>
<span id="cb23-12"><a href="#cb23-12"></a><span class="co"># 6     BWA 1965 39.96990  5137561</span></span></code></pre></div>
<p>If only the computed columns need to be returned, <code>fcompute</code> provides an efficient alternative:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fsubset</span>(Variable <span class="op">==</span><span class="st"> &quot;VA&quot;</span>, Country, Year, AGR, SUM) <span class="op">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="st">  </span><span class="kw">fcompute</span>(<span class="dt">AGR_perc =</span> AGR <span class="op">/</span><span class="st"> </span>SUM <span class="op">*</span><span class="st"> </span><span class="dv">100</span>,</span>
<span id="cb24-3"><a href="#cb24-3"></a>           <span class="dt">AGR_mean =</span> <span class="kw">fmean</span>(AGR)) <span class="op">%&gt;%</span><span class="st"> </span>head</span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="co">#   AGR_perc AGR_mean</span></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="co"># 1       NA  5137561</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="co"># 2       NA  5137561</span></span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="co"># 3       NA  5137561</span></span>
<span id="cb24-8"><a href="#cb24-8"></a><span class="co"># 4       NA  5137561</span></span>
<span id="cb24-9"><a href="#cb24-9"></a><span class="co"># 5 43.49132  5137561</span></span>
<span id="cb24-10"><a href="#cb24-10"></a><span class="co"># 6 39.96990  5137561</span></span></code></pre></div>
<p><code>ftransform</code> and <code>fcompute</code> are an order of magnitude faster than <code>mutate</code>, but they do not support grouped computations. For common grouped operations like replacing and sweeping out statistics, <em>collapse</em> however provides very efficient alternatives…</p>
</div>
<div id="replacing-and-sweeping-out-statistics" class="section level3">
<h3>2.2 Replacing and Sweeping out Statistics</h3>
<!-- using Fast Statistical Functions -->
<p>All statistical (scalar-valued) functions in the collapse package (<code>fsum, fprod, fmean, fmedian, fmode, fvar, fsd, fmin, fmax, ffirst, flast, fNobs, fNdistinct</code>) have a <code>TRA</code> argument which can be used to efficiently transforms data by either (column-wise) replacing data values with computed statistics or sweeping the statistics out of the data. Operations can be specified using either an integer or quoted operator / string. The 10 operations supported by <code>TRA</code> are:</p>
<ul>
<li><p>1 - “replace_fill” : replace and overwrite missing values (same as <code>mutate</code>)</p></li>
<li><p>2 - “replace” : replace but preserve missing values</p></li>
<li><p>3 - “-” : subtract (center)</p></li>
<li><p>4 - “-+” : subtract group-statistics but add average of group statistics</p></li>
<li><p>5 - “/” : divide (scale)</p></li>
<li><p>6 - “%” : compute percentages (divide and multiply by 100)</p></li>
<li><p>7 - “+” : add</p></li>
<li><p>8 - &quot;*&quot; : multiply</p></li>
<li><p>9 - “%%” : modulus</p></li>
<li><p>10 - “-%%” : subtract modulus</p></li>
</ul>
<!-- For functions supporting weights (`fsum, fprod, fmean, fmode, fvar` and `fsd`) the `TRA` argument is in the third position following the data and weight vector (in the *grouped_df* method), whereas functions not supporting weights have the argument in the second position. -->
<p>Simple transformations are again straightforward to specify:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># This subtracts the median value from all data points i.e. centers on the median</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span>num_vars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmedian</span>(<span class="dt">TRA =</span> <span class="st">&quot;-&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>head</span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="co">#   Year       AGR       MIN       MAN        PU       CON       WRT       TRA      FIRE       GOV</span></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="co"># 1  -22        NA        NA        NA        NA        NA        NA        NA        NA        NA</span></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="co"># 2  -21        NA        NA        NA        NA        NA        NA        NA        NA        NA</span></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="co"># 3  -20        NA        NA        NA        NA        NA        NA        NA        NA        NA</span></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="co"># 4  -19        NA        NA        NA        NA        NA        NA        NA        NA        NA</span></span>
<span id="cb25-8"><a href="#cb25-8"></a><span class="co"># 5  -18 -4378.218 -169.7294 -3717.362 -167.8456 -1472.787 -3767.399 -1173.141 -959.0059 -3923.690</span></span>
<span id="cb25-9"><a href="#cb25-9"></a><span class="co"># 6  -17 -4378.792 -170.7277 -3717.080 -167.8149 -1472.101 -3766.578 -1172.861 -958.8783 -3922.817</span></span>
<span id="cb25-10"><a href="#cb25-10"></a><span class="co">#         OTH       SUM</span></span>
<span id="cb25-11"><a href="#cb25-11"></a><span class="co"># 1        NA        NA</span></span>
<span id="cb25-12"><a href="#cb25-12"></a><span class="co"># 2        NA        NA</span></span>
<span id="cb25-13"><a href="#cb25-13"></a><span class="co"># 3        NA        NA</span></span>
<span id="cb25-14"><a href="#cb25-14"></a><span class="co"># 4        NA        NA</span></span>
<span id="cb25-15"><a href="#cb25-15"></a><span class="co"># 5 -1430.831 -23148.71</span></span>
<span id="cb25-16"><a href="#cb25-16"></a><span class="co"># 6 -1430.494 -23146.85</span></span>
<span id="cb25-17"><a href="#cb25-17"></a></span>
<span id="cb25-18"><a href="#cb25-18"></a><span class="co"># This replaces all data points with the mode</span></span>
<span id="cb25-19"><a href="#cb25-19"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span>char_vars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmode</span>(<span class="dt">TRA =</span> <span class="st">&quot;replace&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>head</span>
<span id="cb25-20"><a href="#cb25-20"></a><span class="co">#   Country Regioncode Region Variable</span></span>
<span id="cb25-21"><a href="#cb25-21"></a><span class="co"># 1     USA        ASI   Asia      EMP</span></span>
<span id="cb25-22"><a href="#cb25-22"></a><span class="co"># 2     USA        ASI   Asia      EMP</span></span>
<span id="cb25-23"><a href="#cb25-23"></a><span class="co"># 3     USA        ASI   Asia      EMP</span></span>
<span id="cb25-24"><a href="#cb25-24"></a><span class="co"># 4     USA        ASI   Asia      EMP</span></span>
<span id="cb25-25"><a href="#cb25-25"></a><span class="co"># 5     USA        ASI   Asia      EMP</span></span>
<span id="cb25-26"><a href="#cb25-26"></a><span class="co"># 6     USA        ASI   Asia      EMP</span></span></code></pre></div>
<p>We can also easily specify code to grouped demean, scale or compute percentages by groups:</p>
<!-- ^[100% being the median of all annual VA/EMP values in a given sector and country across all years, not the sectoral output share which would have to be obtained using `sweep(GGDC10S[6:16], 1, GGDC10S$SUM, "/")`] -->
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="co"># Demeaning sectoral data by Variable and Country (within transformation)</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3"></a><span class="st">  </span><span class="kw">fselect</span>(Variable, Country, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb26-4"><a href="#cb26-4"></a><span class="st">   </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmean</span>(<span class="dt">TRA =</span> <span class="st">&quot;-&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb26-5"><a href="#cb26-5"></a><span class="co"># # A tibble: 3 x 13</span></span>
<span id="cb26-6"><a href="#cb26-6"></a><span class="co">#   Variable Country   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH   SUM</span></span>
<span id="cb26-7"><a href="#cb26-7"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb26-8"><a href="#cb26-8"></a><span class="co"># 1 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb26-9"><a href="#cb26-9"></a><span class="co"># 2 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb26-10"><a href="#cb26-10"></a><span class="co"># 3 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb26-11"><a href="#cb26-11"></a></span>
<span id="cb26-12"><a href="#cb26-12"></a><span class="co"># Scaling sectoral data by Variable and Country</span></span>
<span id="cb26-13"><a href="#cb26-13"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb26-14"><a href="#cb26-14"></a><span class="st">  </span><span class="kw">fselect</span>(Variable, Country, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb26-15"><a href="#cb26-15"></a><span class="st">   </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fsd</span>(<span class="dt">TRA =</span> <span class="st">&quot;/&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb26-16"><a href="#cb26-16"></a><span class="co"># # A tibble: 3 x 13</span></span>
<span id="cb26-17"><a href="#cb26-17"></a><span class="co">#   Variable Country   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH   SUM</span></span>
<span id="cb26-18"><a href="#cb26-18"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb26-19"><a href="#cb26-19"></a><span class="co"># 1 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb26-20"><a href="#cb26-20"></a><span class="co"># 2 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb26-21"><a href="#cb26-21"></a><span class="co"># 3 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb26-22"><a href="#cb26-22"></a></span>
<span id="cb26-23"><a href="#cb26-23"></a><span class="co"># Normalizing Data by expressing them in percentages of the median value within each country and sector (i.e. the median is 100%)</span></span>
<span id="cb26-24"><a href="#cb26-24"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb26-25"><a href="#cb26-25"></a><span class="st">  </span><span class="kw">fselect</span>(Variable, Country, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st">  </span></span>
<span id="cb26-26"><a href="#cb26-26"></a><span class="st">   </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmedian</span>(<span class="dt">TRA =</span> <span class="st">&quot;%&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb26-27"><a href="#cb26-27"></a><span class="co"># # A tibble: 3 x 13</span></span>
<span id="cb26-28"><a href="#cb26-28"></a><span class="co">#   Variable Country   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH   SUM</span></span>
<span id="cb26-29"><a href="#cb26-29"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb26-30"><a href="#cb26-30"></a><span class="co"># 1 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb26-31"><a href="#cb26-31"></a><span class="co"># 2 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb26-32"><a href="#cb26-32"></a><span class="co"># 3 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span></code></pre></div>
<p>Weighted demeaning and scaling can be computed using:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># Weighted demeaning (within transformation), weighted by SUM</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="st">  </span><span class="kw">fselect</span>(Variable, Country, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="st">   </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmean</span>(SUM, <span class="st">&quot;-&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="co"># # A tibble: 3 x 13</span></span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="co">#   Variable Country   SUM   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH</span></span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="co"># 1 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb27-9"><a href="#cb27-9"></a><span class="co"># 2 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb27-10"><a href="#cb27-10"></a><span class="co"># 3 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb27-11"><a href="#cb27-11"></a></span>
<span id="cb27-12"><a href="#cb27-12"></a><span class="co"># Weighted scaling, weighted by SUM</span></span>
<span id="cb27-13"><a href="#cb27-13"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb27-14"><a href="#cb27-14"></a><span class="st">  </span><span class="kw">fselect</span>(Variable, Country, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb27-15"><a href="#cb27-15"></a><span class="st">   </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fsd</span>(SUM, <span class="st">&quot;/&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span>
<span id="cb27-16"><a href="#cb27-16"></a><span class="co"># # A tibble: 3 x 13</span></span>
<span id="cb27-17"><a href="#cb27-17"></a><span class="co">#   Variable Country   SUM   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH</span></span>
<span id="cb27-18"><a href="#cb27-18"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb27-19"><a href="#cb27-19"></a><span class="co"># 1 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb27-20"><a href="#cb27-20"></a><span class="co"># 2 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb27-21"><a href="#cb27-21"></a><span class="co"># 3 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span></code></pre></div>
<p>Alternatively we could also replace data points with their groupwise weighted mean or standard deviation:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># This conducts a weighted between transformation (replacing with weighted mean)</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="st">  </span><span class="kw">fselect</span>(Variable, Country, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="st">   </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmean</span>(SUM, <span class="st">&quot;replace&quot;</span>)</span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="co"># # A tibble: 5,027 x 13</span></span>
<span id="cb28-6"><a href="#cb28-6"></a><span class="co">#    Variable Country   SUM   AGR    MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH</span></span>
<span id="cb28-7"><a href="#cb28-7"></a><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb28-8"><a href="#cb28-8"></a><span class="co">#  1 VA       BWA      NA     NA     NA    NA    NA    NA    NA    NA    NA    NA    NA </span></span>
<span id="cb28-9"><a href="#cb28-9"></a><span class="co">#  2 VA       BWA      NA     NA     NA    NA    NA    NA    NA    NA    NA    NA    NA </span></span>
<span id="cb28-10"><a href="#cb28-10"></a><span class="co">#  3 VA       BWA      NA     NA     NA    NA    NA    NA    NA    NA    NA    NA    NA </span></span>
<span id="cb28-11"><a href="#cb28-11"></a><span class="co">#  4 VA       BWA      NA     NA     NA    NA    NA    NA    NA    NA    NA    NA    NA </span></span>
<span id="cb28-12"><a href="#cb28-12"></a><span class="co">#  5 VA       BWA      37.5 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-13"><a href="#cb28-13"></a><span class="co">#  6 VA       BWA      39.3 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-14"><a href="#cb28-14"></a><span class="co">#  7 VA       BWA      43.1 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-15"><a href="#cb28-15"></a><span class="co">#  8 VA       BWA      41.4 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-16"><a href="#cb28-16"></a><span class="co">#  9 VA       BWA      41.1 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-17"><a href="#cb28-17"></a><span class="co"># 10 VA       BWA      51.2 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-18"><a href="#cb28-18"></a><span class="co"># # ... with 5,017 more rows</span></span>
<span id="cb28-19"><a href="#cb28-19"></a></span>
<span id="cb28-20"><a href="#cb28-20"></a><span class="co"># This also replaces missing values in each group</span></span>
<span id="cb28-21"><a href="#cb28-21"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb28-22"><a href="#cb28-22"></a><span class="st">  </span><span class="kw">fselect</span>(Variable, Country, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb28-23"><a href="#cb28-23"></a><span class="st">   </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmean</span>(SUM, <span class="st">&quot;replace_fill&quot;</span>)</span>
<span id="cb28-24"><a href="#cb28-24"></a><span class="co"># # A tibble: 5,027 x 13</span></span>
<span id="cb28-25"><a href="#cb28-25"></a><span class="co">#    Variable Country   SUM   AGR    MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH</span></span>
<span id="cb28-26"><a href="#cb28-26"></a><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb28-27"><a href="#cb28-27"></a><span class="co">#  1 VA       BWA      NA   1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-28"><a href="#cb28-28"></a><span class="co">#  2 VA       BWA      NA   1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-29"><a href="#cb28-29"></a><span class="co">#  3 VA       BWA      NA   1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-30"><a href="#cb28-30"></a><span class="co">#  4 VA       BWA      NA   1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-31"><a href="#cb28-31"></a><span class="co">#  5 VA       BWA      37.5 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-32"><a href="#cb28-32"></a><span class="co">#  6 VA       BWA      39.3 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-33"><a href="#cb28-33"></a><span class="co">#  7 VA       BWA      43.1 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-34"><a href="#cb28-34"></a><span class="co">#  8 VA       BWA      41.4 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-35"><a href="#cb28-35"></a><span class="co">#  9 VA       BWA      41.1 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-36"><a href="#cb28-36"></a><span class="co"># 10 VA       BWA      51.2 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></span>
<span id="cb28-37"><a href="#cb28-37"></a><span class="co"># # ... with 5,017 more rows</span></span></code></pre></div>
<!-- It is also possible to center data points on the overall mean, which is achieved by subtracting out group means and adding the overall mean of the data again: -->
<!-- ```{r} -->
<!-- # This group-centers data on the overall mean of the data -->
<!-- GGDC10S %>% -->
<!--   group_by(Variable, Country) %>% -->
<!--     select_at(6:16) %>% fmean(TRA = "-+") -->
<!-- ``` -->
<p>Sequential operations are also easily performed:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="co"># This scales and then subtracts the median</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="st">  </span><span class="kw">fselect</span>(Variable, Country, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="st">   </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fsd</span>(<span class="dt">TRA =</span> <span class="st">&quot;/&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmedian</span>(<span class="dt">TRA =</span> <span class="st">&quot;-&quot;</span>)</span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="co"># # A tibble: 5,027 x 13</span></span>
<span id="cb29-6"><a href="#cb29-6"></a><span class="co">#    Variable Country    AGR    MIN    MAN     PU    CON     WRT     TRA    FIRE    GOV     OTH    SUM</span></span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb29-8"><a href="#cb29-8"></a><span class="co">#  1 VA       BWA     NA     NA     NA     NA     NA     NA      NA      NA      NA     NA      NA    </span></span>
<span id="cb29-9"><a href="#cb29-9"></a><span class="co">#  2 VA       BWA     NA     NA     NA     NA     NA     NA      NA      NA      NA     NA      NA    </span></span>
<span id="cb29-10"><a href="#cb29-10"></a><span class="co">#  3 VA       BWA     NA     NA     NA     NA     NA     NA      NA      NA      NA     NA      NA    </span></span>
<span id="cb29-11"><a href="#cb29-11"></a><span class="co">#  4 VA       BWA     NA     NA     NA     NA     NA     NA      NA      NA      NA     NA      NA    </span></span>
<span id="cb29-12"><a href="#cb29-12"></a><span class="co">#  5 VA       BWA     -0.182 -0.235 -0.183 -0.245 -0.118 -0.0820 -0.0724 -0.0661 -0.108 -0.0848 -0.146</span></span>
<span id="cb29-13"><a href="#cb29-13"></a><span class="co">#  6 VA       BWA     -0.183 -0.235 -0.183 -0.245 -0.117 -0.0817 -0.0722 -0.0660 -0.108 -0.0846 -0.146</span></span>
<span id="cb29-14"><a href="#cb29-14"></a><span class="co">#  7 VA       BWA     -0.180 -0.235 -0.183 -0.245 -0.117 -0.0813 -0.0720 -0.0659 -0.107 -0.0843 -0.145</span></span>
<span id="cb29-15"><a href="#cb29-15"></a><span class="co">#  8 VA       BWA     -0.177 -0.235 -0.183 -0.245 -0.117 -0.0826 -0.0724 -0.0659 -0.107 -0.0841 -0.146</span></span>
<span id="cb29-16"><a href="#cb29-16"></a><span class="co">#  9 VA       BWA     -0.174 -0.235 -0.183 -0.245 -0.117 -0.0823 -0.0717 -0.0661 -0.108 -0.0848 -0.146</span></span>
<span id="cb29-17"><a href="#cb29-17"></a><span class="co"># 10 VA       BWA     -0.173 -0.234 -0.182 -0.243 -0.115 -0.0821 -0.0715 -0.0660 -0.108 -0.0846 -0.145</span></span>
<span id="cb29-18"><a href="#cb29-18"></a><span class="co"># # ... with 5,017 more rows</span></span></code></pre></div>
<p>Of course it is also possible to combine multiple functions as in the aggregation section, or to add variables to existing data, as shown below:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="co"># This adds a groupwise observation count next to each column</span></span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="kw">add_vars</span>(GGDC10S, <span class="kw">seq</span>(<span class="dv">7</span>,<span class="dv">27</span>,<span class="dv">2</span>)) &lt;-<span class="st"> </span>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="st">    </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fselect</span>(AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span></span>
<span id="cb30-4"><a href="#cb30-4"></a><span class="st">    </span><span class="kw">fNobs</span>(<span class="st">&quot;replace_fill&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_stub</span>(<span class="st">&quot;N_&quot;</span>)</span>
<span id="cb30-5"><a href="#cb30-5"></a></span>
<span id="cb30-6"><a href="#cb30-6"></a><span class="kw">head</span>(GGDC10S)</span>
<span id="cb30-7"><a href="#cb30-7"></a><span class="co">#   Country Regioncode             Region Variable Year      AGR N_AGR      MIN N_MIN       MAN N_MAN</span></span>
<span id="cb30-8"><a href="#cb30-8"></a><span class="co"># 1     BWA        SSA Sub-saharan Africa       VA 1960       NA    47       NA    47        NA    47</span></span>
<span id="cb30-9"><a href="#cb30-9"></a><span class="co"># 2     BWA        SSA Sub-saharan Africa       VA 1961       NA    47       NA    47        NA    47</span></span>
<span id="cb30-10"><a href="#cb30-10"></a><span class="co"># 3     BWA        SSA Sub-saharan Africa       VA 1962       NA    47       NA    47        NA    47</span></span>
<span id="cb30-11"><a href="#cb30-11"></a><span class="co"># 4     BWA        SSA Sub-saharan Africa       VA 1963       NA    47       NA    47        NA    47</span></span>
<span id="cb30-12"><a href="#cb30-12"></a><span class="co"># 5     BWA        SSA Sub-saharan Africa       VA 1964 16.30154    47 3.494075    47 0.7365696    47</span></span>
<span id="cb30-13"><a href="#cb30-13"></a><span class="co"># 6     BWA        SSA Sub-saharan Africa       VA 1965 15.72700    47 2.495768    47 1.0181992    47</span></span>
<span id="cb30-14"><a href="#cb30-14"></a><span class="co">#          PU N_PU       CON N_CON      WRT N_WRT      TRA N_TRA     FIRE N_FIRE      GOV N_GOV</span></span>
<span id="cb30-15"><a href="#cb30-15"></a><span class="co"># 1        NA   47        NA    47       NA    47       NA    47       NA     47       NA    47</span></span>
<span id="cb30-16"><a href="#cb30-16"></a><span class="co"># 2        NA   47        NA    47       NA    47       NA    47       NA     47       NA    47</span></span>
<span id="cb30-17"><a href="#cb30-17"></a><span class="co"># 3        NA   47        NA    47       NA    47       NA    47       NA     47       NA    47</span></span>
<span id="cb30-18"><a href="#cb30-18"></a><span class="co"># 4        NA   47        NA    47       NA    47       NA    47       NA     47       NA    47</span></span>
<span id="cb30-19"><a href="#cb30-19"></a><span class="co"># 5 0.1043936   47 0.6600454    47 6.243732    47 1.658928    47 1.119194     47 4.822485    47</span></span>
<span id="cb30-20"><a href="#cb30-20"></a><span class="co"># 6 0.1350976   47 1.3462312    47 7.064825    47 1.939007    47 1.246789     47 5.695848    47</span></span>
<span id="cb30-21"><a href="#cb30-21"></a><span class="co">#        OTH N_OTH      SUM N_SUM</span></span>
<span id="cb30-22"><a href="#cb30-22"></a><span class="co"># 1       NA    47       NA    47</span></span>
<span id="cb30-23"><a href="#cb30-23"></a><span class="co"># 2       NA    47       NA    47</span></span>
<span id="cb30-24"><a href="#cb30-24"></a><span class="co"># 3       NA    47       NA    47</span></span>
<span id="cb30-25"><a href="#cb30-25"></a><span class="co"># 4       NA    47       NA    47</span></span>
<span id="cb30-26"><a href="#cb30-26"></a><span class="co"># 5 2.341328    47 37.48229    47</span></span>
<span id="cb30-27"><a href="#cb30-27"></a><span class="co"># 6 2.678338    47 39.34710    47</span></span>
<span id="cb30-28"><a href="#cb30-28"></a><span class="kw">rm</span>(GGDC10S)</span></code></pre></div>
<p>Certainly There are lots of other examples one could construct using the 10 operations and 13 functions listed above, the examples provided just outline the suggested programming basics.</p>
<!-- ***could add add_vars example again*** -->
</div>
<div id="more-control-using-the-tra-function" class="section level3">
<h3>2.3 More Control using the <code>TRA</code> Function</h3>
<p>Behind the scenes of the <code>TRA = ...</code> argument, the fast functions first compute the grouped statistics on all columns of the data, and these statistics are then directly fed into a C++ function that uses them to replace or sweep them out of data points in one of the 10 ways described above. This function can however also be called directly by the name of <code>TRA</code> (shorthand for ‘transforming’ data by replacing or sweeping out statistics). Fundamentally, <code>TRA</code> is a generalization of <code>base::sweep</code> for column-wise grouped operations<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. Direct calls to <code>TRA</code> enable more control over inputs and outputs.</p>
<p>The two operations below are equivalent, although the first is slightly more efficient as it only requires one method dispatch and one check of the inputs:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="co"># This divides by the product</span></span>
<span id="cb31-2"><a href="#cb31-2"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="st">    </span><span class="kw">get_vars</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fprod</span>(<span class="dt">TRA =</span> <span class="st">&quot;/&quot;</span>) </span>
<span id="cb31-5"><a href="#cb31-5"></a><span class="co"># # A tibble: 5,027 x 11</span></span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="co">#           AGR        MIN        MAN        PU        CON        WRT       TRA      FIRE        GOV</span></span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="co">#  *      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span id="cb31-8"><a href="#cb31-8"></a><span class="co">#  1 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span></span>
<span id="cb31-9"><a href="#cb31-9"></a><span class="co">#  2 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span></span>
<span id="cb31-10"><a href="#cb31-10"></a><span class="co">#  3 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span></span>
<span id="cb31-11"><a href="#cb31-11"></a><span class="co">#  4 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span></span>
<span id="cb31-12"><a href="#cb31-12"></a><span class="co">#  5  1.29e-105  2.81e-127  1.40e-101  4.44e-74  4.19e-102  3.97e-113  6.91e-92  1.01e-97  2.51e-117</span></span>
<span id="cb31-13"><a href="#cb31-13"></a><span class="co">#  6  1.24e-105  2.00e-127  1.94e-101  5.75e-74  8.55e-102  4.49e-113  8.08e-92  1.13e-97  2.96e-117</span></span>
<span id="cb31-14"><a href="#cb31-14"></a><span class="co">#  7  1.39e-105  1.58e-127  1.53e-101  8.62e-74  8.55e-102  5.26e-113  8.98e-92  1.23e-97  3.31e-117</span></span>
<span id="cb31-15"><a href="#cb31-15"></a><span class="co">#  8  1.51e-105  1.85e-127  1.78e-101  8.62e-74  5.70e-102  2.74e-113  7.18e-92  1.39e-97  3.66e-117</span></span>
<span id="cb31-16"><a href="#cb31-16"></a><span class="co">#  9  1.66e-105  1.48e-127  1.43e-101  8.62e-74  7.74e-102  3.29e-113  1.02e-91  9.33e-98  2.61e-117</span></span>
<span id="cb31-17"><a href="#cb31-17"></a><span class="co"># 10  1.72e-105  4.21e-127  4.07e-101  2.46e-73  2.21e-101  3.66e-113  1.13e-91  1.11e-97  2.91e-117</span></span>
<span id="cb31-18"><a href="#cb31-18"></a><span class="co"># # ... with 5,017 more rows, and 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></span>
<span id="cb31-19"><a href="#cb31-19"></a></span>
<span id="cb31-20"><a href="#cb31-20"></a><span class="co"># Same thing</span></span>
<span id="cb31-21"><a href="#cb31-21"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb31-22"><a href="#cb31-22"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span></span>
<span id="cb31-23"><a href="#cb31-23"></a><span class="st">    </span><span class="kw">get_vars</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">TRA</span>(<span class="kw">fprod</span>(., <span class="dt">keep.group_vars =</span> <span class="ot">FALSE</span>), <span class="st">&quot;/&quot;</span>) <span class="co"># [same as TRA(.,fprod(., keep.group_vars = FALSE),&quot;/&quot;)]</span></span>
<span id="cb31-24"><a href="#cb31-24"></a><span class="co"># # A tibble: 5,027 x 11</span></span>
<span id="cb31-25"><a href="#cb31-25"></a><span class="co">#           AGR        MIN        MAN        PU        CON        WRT       TRA      FIRE        GOV</span></span>
<span id="cb31-26"><a href="#cb31-26"></a><span class="co">#  *      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span id="cb31-27"><a href="#cb31-27"></a><span class="co">#  1 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span></span>
<span id="cb31-28"><a href="#cb31-28"></a><span class="co">#  2 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span></span>
<span id="cb31-29"><a href="#cb31-29"></a><span class="co">#  3 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span></span>
<span id="cb31-30"><a href="#cb31-30"></a><span class="co">#  4 NA         NA         NA         NA        NA         NA         NA        NA        NA        </span></span>
<span id="cb31-31"><a href="#cb31-31"></a><span class="co">#  5  1.29e-105  2.81e-127  1.40e-101  4.44e-74  4.19e-102  3.97e-113  6.91e-92  1.01e-97  2.51e-117</span></span>
<span id="cb31-32"><a href="#cb31-32"></a><span class="co">#  6  1.24e-105  2.00e-127  1.94e-101  5.75e-74  8.55e-102  4.49e-113  8.08e-92  1.13e-97  2.96e-117</span></span>
<span id="cb31-33"><a href="#cb31-33"></a><span class="co">#  7  1.39e-105  1.58e-127  1.53e-101  8.62e-74  8.55e-102  5.26e-113  8.98e-92  1.23e-97  3.31e-117</span></span>
<span id="cb31-34"><a href="#cb31-34"></a><span class="co">#  8  1.51e-105  1.85e-127  1.78e-101  8.62e-74  5.70e-102  2.74e-113  7.18e-92  1.39e-97  3.66e-117</span></span>
<span id="cb31-35"><a href="#cb31-35"></a><span class="co">#  9  1.66e-105  1.48e-127  1.43e-101  8.62e-74  7.74e-102  3.29e-113  1.02e-91  9.33e-98  2.61e-117</span></span>
<span id="cb31-36"><a href="#cb31-36"></a><span class="co"># 10  1.72e-105  4.21e-127  4.07e-101  2.46e-73  2.21e-101  3.66e-113  1.13e-91  1.11e-97  2.91e-117</span></span>
<span id="cb31-37"><a href="#cb31-37"></a><span class="co"># # ... with 5,017 more rows, and 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></span></code></pre></div>
<p><code>TRA.grouped_df</code> was designed such that it matches the columns of the statistics (aggregated columns) to those of the original data, and only transforms matching columns while returning the whole data.frame. Thus it is easily possible to only apply a transformation to the first two sectors:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="co"># This only demeans Agriculture (AGR) and Mining (MIN)</span></span>
<span id="cb32-2"><a href="#cb32-2"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span></span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="st">    </span><span class="kw">get_vars</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">TRA</span>(<span class="kw">fmean</span>(<span class="kw">fselect</span>(., AGR, MIN), <span class="dt">keep.group_vars =</span> <span class="ot">FALSE</span>), <span class="st">&quot;-&quot;</span>)</span>
<span id="cb32-5"><a href="#cb32-5"></a><span class="co"># # A tibble: 5,027 x 11</span></span>
<span id="cb32-6"><a href="#cb32-6"></a><span class="co">#      AGR    MIN    MAN     PU    CON   WRT   TRA  FIRE   GOV   OTH   SUM</span></span>
<span id="cb32-7"><a href="#cb32-7"></a><span class="co">#  * &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb32-8"><a href="#cb32-8"></a><span class="co">#  1   NA     NA  NA     NA     NA     NA    NA    NA    NA    NA     NA  </span></span>
<span id="cb32-9"><a href="#cb32-9"></a><span class="co">#  2   NA     NA  NA     NA     NA     NA    NA    NA    NA    NA     NA  </span></span>
<span id="cb32-10"><a href="#cb32-10"></a><span class="co">#  3   NA     NA  NA     NA     NA     NA    NA    NA    NA    NA     NA  </span></span>
<span id="cb32-11"><a href="#cb32-11"></a><span class="co">#  4   NA     NA  NA     NA     NA     NA    NA    NA    NA    NA     NA  </span></span>
<span id="cb32-12"><a href="#cb32-12"></a><span class="co">#  5 -446. -4505.  0.737  0.104  0.660  6.24  1.66  1.12  4.82  2.34  37.5</span></span>
<span id="cb32-13"><a href="#cb32-13"></a><span class="co">#  6 -446. -4506.  1.02   0.135  1.35   7.06  1.94  1.25  5.70  2.68  39.3</span></span>
<span id="cb32-14"><a href="#cb32-14"></a><span class="co">#  7 -444. -4507.  0.804  0.203  1.35   8.27  2.15  1.36  6.37  2.99  43.1</span></span>
<span id="cb32-15"><a href="#cb32-15"></a><span class="co">#  8 -443. -4506.  0.938  0.203  0.897  4.31  1.72  1.54  7.04  3.31  41.4</span></span>
<span id="cb32-16"><a href="#cb32-16"></a><span class="co">#  9 -441. -4507.  0.750  0.203  1.22   5.17  2.44  1.03  5.03  2.36  41.1</span></span>
<span id="cb32-17"><a href="#cb32-17"></a><span class="co"># 10 -440. -4503.  2.14   0.578  3.47   5.75  2.72  1.23  5.59  2.63  51.2</span></span>
<span id="cb32-18"><a href="#cb32-18"></a><span class="co"># # ... with 5,017 more rows</span></span></code></pre></div>
<p>Another potential use of <code>TRA</code> is to do computations in two- or more steps, for example if both aggregated and transformed data are needed, or if computations are more complex and involve other manipulations in-between the aggregating and sweeping part:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="co"># Get grouped tibble</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>gGGDC &lt;-<span class="st"> </span>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgroup_by</span>(Variable, Country)</span>
<span id="cb33-3"><a href="#cb33-3"></a></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="co"># Get aggregated data</span></span>
<span id="cb33-5"><a href="#cb33-5"></a>gsumGGDC &lt;-<span class="st"> </span>gGGDC <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fselect</span>(AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span>fsum</span>
<span id="cb33-6"><a href="#cb33-6"></a><span class="kw">head</span>(gsumGGDC)</span>
<span id="cb33-7"><a href="#cb33-7"></a><span class="co"># # A tibble: 6 x 13</span></span>
<span id="cb33-8"><a href="#cb33-8"></a><span class="co">#   Variable Country     AGR     MIN     MAN     PU     CON    WRT    TRA   FIRE     GOV    OTH    SUM</span></span>
<span id="cb33-9"><a href="#cb33-9"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb33-10"><a href="#cb33-10"></a><span class="co"># 1 EMP      ARG      8.80e4   3230.  1.20e5  6307.  4.60e4 1.23e5 4.02e4 3.89e4  1.27e5 6.15e4 6.54e5</span></span>
<span id="cb33-11"><a href="#cb33-11"></a><span class="co"># 2 EMP      BOL      5.88e4   3418.  1.43e4   326.  7.49e3 1.72e4 7.04e3 2.72e3 NA      2.41e4 1.35e5</span></span>
<span id="cb33-12"><a href="#cb33-12"></a><span class="co"># 3 EMP      BRA      1.07e6  12773.  4.33e5 22604.  2.19e5 5.28e5 1.27e5 2.74e5  3.29e5 3.54e5 3.36e6</span></span>
<span id="cb33-13"><a href="#cb33-13"></a><span class="co"># 4 EMP      BWA      8.84e3    493.  8.49e2   145.  1.19e3 1.71e3 3.93e2 7.21e2  2.87e3 1.30e3 1.85e4</span></span>
<span id="cb33-14"><a href="#cb33-14"></a><span class="co"># 5 EMP      CHL      4.42e4   6389.  3.94e4  1850.  1.86e4 4.38e4 1.63e4 1.72e4 NA      6.32e4 2.51e5</span></span>
<span id="cb33-15"><a href="#cb33-15"></a><span class="co"># 6 EMP      CHN      1.73e7 422972.  4.03e6 96364.  1.25e6 1.73e6 8.36e5 2.96e5  1.36e6 1.86e6 2.91e7</span></span>
<span id="cb33-16"><a href="#cb33-16"></a></span>
<span id="cb33-17"><a href="#cb33-17"></a><span class="co"># Get transformed (scaled) data</span></span>
<span id="cb33-18"><a href="#cb33-18"></a><span class="kw">head</span>(<span class="kw">TRA</span>(gGGDC, gsumGGDC, <span class="st">&quot;/&quot;</span>))</span>
<span id="cb33-19"><a href="#cb33-19"></a><span class="co"># # A tibble: 6 x 16</span></span>
<span id="cb33-20"><a href="#cb33-20"></a><span class="co">#   Country Regioncode Region Variable  Year      AGR      MIN      MAN       PU      CON      WRT</span></span>
<span id="cb33-21"><a href="#cb33-21"></a><span class="co">#   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb33-22"><a href="#cb33-22"></a><span class="co"># 1 BWA     SSA        Sub-s~ VA        1960 NA       NA       NA       NA       NA       NA      </span></span>
<span id="cb33-23"><a href="#cb33-23"></a><span class="co"># 2 BWA     SSA        Sub-s~ VA        1961 NA       NA       NA       NA       NA       NA      </span></span>
<span id="cb33-24"><a href="#cb33-24"></a><span class="co"># 3 BWA     SSA        Sub-s~ VA        1962 NA       NA       NA       NA       NA       NA      </span></span>
<span id="cb33-25"><a href="#cb33-25"></a><span class="co"># 4 BWA     SSA        Sub-s~ VA        1963 NA       NA       NA       NA       NA       NA      </span></span>
<span id="cb33-26"><a href="#cb33-26"></a><span class="co"># 5 BWA     SSA        Sub-s~ VA        1964  7.50e-4  1.65e-5  1.66e-5  1.03e-5  1.57e-5  6.82e-5</span></span>
<span id="cb33-27"><a href="#cb33-27"></a><span class="co"># 6 BWA     SSA        Sub-s~ VA        1965  7.24e-4  1.18e-5  2.30e-5  1.33e-5  3.20e-5  7.72e-5</span></span>
<span id="cb33-28"><a href="#cb33-28"></a><span class="co"># # ... with 5 more variables: TRA &lt;dbl&gt;, FIRE &lt;dbl&gt;, GOV &lt;dbl&gt;, OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></span></code></pre></div>
<p>As discussed above, whether using the argument to fast statistical functions or <code>TRA</code> directly, these data transformations are essentially a two-step process: Statistics are first computed and then used to transform this original data. This process is already very efficient since all functions are written in C++, and programmatically separating the computation of statistics and data transformation tasks allows for unlimited combinations and drastically simplifies the code base of this package.</p>
<p>Nonetheless there are of course more memory efficient and faster ways to program such data transformations, which principally involve doing them column-by-column with a single C++ function. To ensure that this <em>collapse</em> lives up to the highest standards of performance for common uses, it also provides slightly more efficient functions for the very commonly applied tasks of centering and averaging data by groups (widely known as ‘between’-group and ‘within’-group transformations), and scaling and centering data by groups (also known as ‘standardizing’ data).</p>
</div>
<div id="faster-centering-averaging-and-standardizing" class="section level3">
<h3>2.4 Faster Centering, Averaging and Standardizing</h3>
<!-- Between and Within Transformations and Standardization -->
<p>The functions <code>fbetween</code> and <code>fwithin</code> are slightly more memory efficient implementations of <code>fmean</code> invoked with different <code>TRA</code> options:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Same as ... %&gt;% fmean(TRA = &quot;replace&quot;)</span></span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">get_vars</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fbetween <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">2</span>)</span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="co"># # A tibble: 2 x 11</span></span>
<span id="cb34-4"><a href="#cb34-4"></a><span class="co">#     AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH   SUM</span></span>
<span id="cb34-5"><a href="#cb34-5"></a><span class="co">#   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb34-6"><a href="#cb34-6"></a><span class="co"># 1    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb34-7"><a href="#cb34-7"></a><span class="co"># 2    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb34-8"><a href="#cb34-8"></a></span>
<span id="cb34-9"><a href="#cb34-9"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Same as ... %&gt;% fmean(TRA = &quot;replace_fill&quot;)</span></span>
<span id="cb34-10"><a href="#cb34-10"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">get_vars</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fbetween</span>(<span class="dt">fill =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">2</span>)</span>
<span id="cb34-11"><a href="#cb34-11"></a><span class="co"># # A tibble: 2 x 11</span></span>
<span id="cb34-12"><a href="#cb34-12"></a><span class="co">#     AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH    SUM</span></span>
<span id="cb34-13"><a href="#cb34-13"></a><span class="co">#   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb34-14"><a href="#cb34-14"></a><span class="co"># 1  462. 4509.  942.  216.  895. 1948.  635. 1359. 2373.  773. 14112.</span></span>
<span id="cb34-15"><a href="#cb34-15"></a><span class="co"># 2  462. 4509.  942.  216.  895. 1948.  635. 1359. 2373.  773. 14112.</span></span>
<span id="cb34-16"><a href="#cb34-16"></a></span>
<span id="cb34-17"><a href="#cb34-17"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Same as ... %&gt;% fmean(TRA = &quot;-&quot;)</span></span>
<span id="cb34-18"><a href="#cb34-18"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">get_vars</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fwithin <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">2</span>)</span>
<span id="cb34-19"><a href="#cb34-19"></a><span class="co"># # A tibble: 2 x 11</span></span>
<span id="cb34-20"><a href="#cb34-20"></a><span class="co">#     AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH   SUM</span></span>
<span id="cb34-21"><a href="#cb34-21"></a><span class="co">#   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb34-22"><a href="#cb34-22"></a><span class="co"># 1    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span>
<span id="cb34-23"><a href="#cb34-23"></a><span class="co"># 2    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></span></code></pre></div>
<p>Apart from higher speed,<code>fwithin</code> has a <code>mean</code> argument to assign an arbitrary mean to centered data, the default being <code>mean = 0</code>. A very common choice for such an added mean is just the overall mean of the data, which can be added in by invoking <code>mean = &quot;overall.mean&quot;</code>:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="st">    </span><span class="kw">fselect</span>(Country, Variable, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fwithin</span>(<span class="dt">mean =</span> <span class="st">&quot;overall.mean&quot;</span>)</span>
<span id="cb35-4"><a href="#cb35-4"></a><span class="co"># # A tibble: 5,027 x 13</span></span>
<span id="cb35-5"><a href="#cb35-5"></a><span class="co">#    Country Variable     AGR     MIN     MAN      PU     CON     WRT     TRA    FIRE     GOV     OTH</span></span>
<span id="cb35-6"><a href="#cb35-6"></a><span class="co">#  * &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb35-7"><a href="#cb35-7"></a><span class="co">#  1 BWA     VA       NA      NA      NA          NA  NA      NA      NA      NA      NA      NA     </span></span>
<span id="cb35-8"><a href="#cb35-8"></a><span class="co">#  2 BWA     VA       NA      NA      NA          NA  NA      NA      NA      NA      NA      NA     </span></span>
<span id="cb35-9"><a href="#cb35-9"></a><span class="co">#  3 BWA     VA       NA      NA      NA          NA  NA      NA      NA      NA      NA      NA     </span></span>
<span id="cb35-10"><a href="#cb35-10"></a><span class="co">#  4 BWA     VA       NA      NA      NA          NA  NA      NA      NA      NA      NA      NA     </span></span>
<span id="cb35-11"><a href="#cb35-11"></a><span class="co">#  5 BWA     VA        2.53e6  1.86e6  5.54e6 335463.  1.80e6  3.39e6  1.47e6  1.66e6  1.71e6  1.68e6</span></span>
<span id="cb35-12"><a href="#cb35-12"></a><span class="co">#  6 BWA     VA        2.53e6  1.86e6  5.54e6 335463.  1.80e6  3.39e6  1.47e6  1.66e6  1.71e6  1.68e6</span></span>
<span id="cb35-13"><a href="#cb35-13"></a><span class="co">#  7 BWA     VA        2.53e6  1.86e6  5.54e6 335463.  1.80e6  3.39e6  1.47e6  1.66e6  1.71e6  1.68e6</span></span>
<span id="cb35-14"><a href="#cb35-14"></a><span class="co">#  8 BWA     VA        2.53e6  1.86e6  5.54e6 335463.  1.80e6  3.39e6  1.47e6  1.66e6  1.71e6  1.68e6</span></span>
<span id="cb35-15"><a href="#cb35-15"></a><span class="co">#  9 BWA     VA        2.53e6  1.86e6  5.54e6 335463.  1.80e6  3.39e6  1.47e6  1.66e6  1.71e6  1.68e6</span></span>
<span id="cb35-16"><a href="#cb35-16"></a><span class="co"># 10 BWA     VA        2.53e6  1.86e6  5.54e6 335464.  1.80e6  3.39e6  1.47e6  1.66e6  1.71e6  1.68e6</span></span>
<span id="cb35-17"><a href="#cb35-17"></a><span class="co"># # ... with 5,017 more rows, and 1 more variable: SUM &lt;dbl&gt;</span></span></code></pre></div>
<!-- in particular, which regards the joint use of weights and the `mean = "overall.mean"` option: `... %>% fmean(w = SUM, TRA = "-+")` will not properly group-center the data on the overall weighted mean. Instead, it will group-center data on a frequency weighted average of the weighted group-means, thus not taking into account different aggregated weights attached to those weighted group-means themselves. The reason for this shortcoming is simply that `TRA` was not designed to take a separate weight vector as input. `fwithin(w = SUM, mean = "overall.mean")` does a better job and properly centers data on the weighted overall mean after subtracting out weighted group means: -->
<!-- ```{r} -->
<!-- GGDC10S %>% # This does not center data on a properly computed weighted overall mean -->
<!--   group_by(Variable, Country) %>% select_at(6:16) %>% fmean(SUM, TRA = "-+") -->
<!-- GGDC10S %>% # This does a proper job by both subtracting weighted group-means and adding a weighted overall mean -->
<!--   group_by(Variable, Country) %>% select_at(6:16) %>% fwithin(SUM, mean = "overall.mean") -->
<!-- ``` -->
<p>This can also be done using weights. The code below uses the <code>SUM</code> column as weights, and then for each variable and each group subtracts out the weighted mean, and then adds the overall weighted column mean back to the centered columns. The <code>SUM</code> column is just kept as it is and added in front.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="st">    </span><span class="kw">fselect</span>(Country, Variable, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fwithin</span>(SUM, <span class="dt">mean =</span> <span class="st">&quot;overall.mean&quot;</span>)</span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="co"># # A tibble: 5,027 x 13</span></span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="co">#    Country Variable   SUM     AGR     MIN     MAN      PU     CON     WRT     TRA    FIRE     GOV</span></span>
<span id="cb36-6"><a href="#cb36-6"></a><span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="co">#  1 BWA     VA        NA   NA      NA      NA      NA      NA      NA      NA      NA      NA     </span></span>
<span id="cb36-8"><a href="#cb36-8"></a><span class="co">#  2 BWA     VA        NA   NA      NA      NA      NA      NA      NA      NA      NA      NA     </span></span>
<span id="cb36-9"><a href="#cb36-9"></a><span class="co">#  3 BWA     VA        NA   NA      NA      NA      NA      NA      NA      NA      NA      NA     </span></span>
<span id="cb36-10"><a href="#cb36-10"></a><span class="co">#  4 BWA     VA        NA   NA      NA      NA      NA      NA      NA      NA      NA      NA     </span></span>
<span id="cb36-11"><a href="#cb36-11"></a><span class="co">#  5 BWA     VA        37.5  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8  1.97e8  1.55e8  2.10e8</span></span>
<span id="cb36-12"><a href="#cb36-12"></a><span class="co">#  6 BWA     VA        39.3  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8  1.97e8  1.55e8  2.10e8</span></span>
<span id="cb36-13"><a href="#cb36-13"></a><span class="co">#  7 BWA     VA        43.1  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8  1.97e8  1.55e8  2.10e8</span></span>
<span id="cb36-14"><a href="#cb36-14"></a><span class="co">#  8 BWA     VA        41.4  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8  1.97e8  1.55e8  2.10e8</span></span>
<span id="cb36-15"><a href="#cb36-15"></a><span class="co">#  9 BWA     VA        41.1  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8  1.97e8  1.55e8  2.10e8</span></span>
<span id="cb36-16"><a href="#cb36-16"></a><span class="co"># 10 BWA     VA        51.2  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8  1.97e8  1.55e8  2.10e8</span></span>
<span id="cb36-17"><a href="#cb36-17"></a><span class="co"># # ... with 5,017 more rows, and 1 more variable: OTH &lt;dbl&gt;</span></span></code></pre></div>
<p>Apart from <code>fbetween</code> and <code>fwithin</code>, the function <code>fscale</code> exists to efficiently scale and center data, to avoid sequential calls such as <code>... %&gt;% fsd(TRA = &quot;/&quot;) %&gt;% fmean(TRA = &quot;-&quot;)</code> shown in an earlier example.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="co"># This efficiently scales and centers (i.e. standardizes) the data</span></span>
<span id="cb37-2"><a href="#cb37-2"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="st">    </span><span class="kw">fselect</span>(Country, Variable, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span>fscale</span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="co"># # A tibble: 5,027 x 13</span></span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="co">#    Country Variable    AGR    MIN    MAN     PU    CON    WRT    TRA   FIRE    GOV    OTH    SUM</span></span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="co">#  * &lt;chr&gt;   &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb37-8"><a href="#cb37-8"></a><span class="co">#  1 BWA     VA       NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span></span>
<span id="cb37-9"><a href="#cb37-9"></a><span class="co">#  2 BWA     VA       NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span></span>
<span id="cb37-10"><a href="#cb37-10"></a><span class="co">#  3 BWA     VA       NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span></span>
<span id="cb37-11"><a href="#cb37-11"></a><span class="co">#  4 BWA     VA       NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span></span>
<span id="cb37-12"><a href="#cb37-12"></a><span class="co">#  5 BWA     VA       -0.738 -0.717 -0.668 -0.805 -0.692 -0.603 -0.589 -0.635 -0.656 -0.596 -0.676</span></span>
<span id="cb37-13"><a href="#cb37-13"></a><span class="co">#  6 BWA     VA       -0.739 -0.717 -0.668 -0.805 -0.692 -0.603 -0.589 -0.635 -0.656 -0.596 -0.676</span></span>
<span id="cb37-14"><a href="#cb37-14"></a><span class="co">#  7 BWA     VA       -0.736 -0.717 -0.668 -0.805 -0.692 -0.603 -0.589 -0.635 -0.656 -0.595 -0.676</span></span>
<span id="cb37-15"><a href="#cb37-15"></a><span class="co">#  8 BWA     VA       -0.734 -0.717 -0.668 -0.805 -0.692 -0.604 -0.589 -0.635 -0.655 -0.595 -0.676</span></span>
<span id="cb37-16"><a href="#cb37-16"></a><span class="co">#  9 BWA     VA       -0.730 -0.717 -0.668 -0.805 -0.692 -0.604 -0.588 -0.635 -0.656 -0.596 -0.676</span></span>
<span id="cb37-17"><a href="#cb37-17"></a><span class="co"># 10 BWA     VA       -0.729 -0.716 -0.667 -0.803 -0.690 -0.603 -0.588 -0.635 -0.656 -0.596 -0.675</span></span>
<span id="cb37-18"><a href="#cb37-18"></a><span class="co"># # ... with 5,017 more rows</span></span></code></pre></div>
<p><code>fscale</code> also has additional <code>mean</code> and <code>sd</code> arguments allowing the user to (group-) scale data to an arbitrary mean and standard deviation. Setting <code>mean = FALSE</code> just scales the data but preserves the means, and is thus different from <code>fsd(..., TRA = &quot;/&quot;)</code> which just divides all values by the standard deviation:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a><span class="co"># Saving grouped tibble</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>gGGDC &lt;-<span class="st"> </span>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="st">  </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span></span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="st">    </span><span class="kw">fselect</span>(Country, Variable, AGR<span class="op">:</span>SUM)</span>
<span id="cb38-5"><a href="#cb38-5"></a></span>
<span id="cb38-6"><a href="#cb38-6"></a><span class="co"># Original means</span></span>
<span id="cb38-7"><a href="#cb38-7"></a><span class="kw">head</span>(<span class="kw">fmean</span>(gGGDC)) </span>
<span id="cb38-8"><a href="#cb38-8"></a><span class="co"># # A tibble: 6 x 13</span></span>
<span id="cb38-9"><a href="#cb38-9"></a><span class="co">#   Variable Country     AGR    MIN     MAN      PU     CON    WRT    TRA   FIRE     GOV    OTH    SUM</span></span>
<span id="cb38-10"><a href="#cb38-10"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb38-11"><a href="#cb38-11"></a><span class="co"># 1 EMP      ARG       1420.   52.1  1932.   102.     742.  1.98e3 6.49e2  628.   2043.  9.92e2 1.05e4</span></span>
<span id="cb38-12"><a href="#cb38-12"></a><span class="co"># 2 EMP      BOL        964.   56.0   235.     5.35   123.  2.82e2 1.15e2   44.6    NA   3.96e2 2.22e3</span></span>
<span id="cb38-13"><a href="#cb38-13"></a><span class="co"># 3 EMP      BRA      17191.  206.   6991.   365.    3525.  8.51e3 2.05e3 4414.   5307.  5.71e3 5.43e4</span></span>
<span id="cb38-14"><a href="#cb38-14"></a><span class="co"># 4 EMP      BWA        188.   10.5    18.1    3.09    25.3 3.63e1 8.36e0   15.3    61.1 2.76e1 3.94e2</span></span>
<span id="cb38-15"><a href="#cb38-15"></a><span class="co"># 5 EMP      CHL        702.  101.    625.    29.4    296.  6.95e2 2.58e2  272.     NA   1.00e3 3.98e3</span></span>
<span id="cb38-16"><a href="#cb38-16"></a><span class="co"># 6 EMP      CHN     287744. 7050.  67144.  1606.   20852.  2.89e4 1.39e4 4929.  22669.  3.10e4 4.86e5</span></span>
<span id="cb38-17"><a href="#cb38-17"></a></span>
<span id="cb38-18"><a href="#cb38-18"></a><span class="co"># Mean Preserving Scaling</span></span>
<span id="cb38-19"><a href="#cb38-19"></a><span class="kw">head</span>(<span class="kw">fmean</span>(<span class="kw">fscale</span>(gGGDC, <span class="dt">mean =</span> <span class="ot">FALSE</span>)))</span>
<span id="cb38-20"><a href="#cb38-20"></a><span class="co"># # A tibble: 6 x 13</span></span>
<span id="cb38-21"><a href="#cb38-21"></a><span class="co">#   Variable Country     AGR    MIN     MAN      PU     CON    WRT    TRA   FIRE     GOV    OTH    SUM</span></span>
<span id="cb38-22"><a href="#cb38-22"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb38-23"><a href="#cb38-23"></a><span class="co"># 1 EMP      ARG       1420.   52.1  1932.   102.     742.  1.98e3 6.49e2  628.   2043.  9.92e2 1.05e4</span></span>
<span id="cb38-24"><a href="#cb38-24"></a><span class="co"># 2 EMP      BOL        964.   56.0   235.     5.35   123.  2.82e2 1.15e2   44.6    NA   3.96e2 2.22e3</span></span>
<span id="cb38-25"><a href="#cb38-25"></a><span class="co"># 3 EMP      BRA      17191.  206.   6991.   365.    3525.  8.51e3 2.05e3 4414.   5307.  5.71e3 5.43e4</span></span>
<span id="cb38-26"><a href="#cb38-26"></a><span class="co"># 4 EMP      BWA        188.   10.5    18.1    3.09    25.3 3.63e1 8.36e0   15.3    61.1 2.76e1 3.94e2</span></span>
<span id="cb38-27"><a href="#cb38-27"></a><span class="co"># 5 EMP      CHL        702.  101.    625.    29.4    296.  6.95e2 2.58e2  272.     NA   1.00e3 3.98e3</span></span>
<span id="cb38-28"><a href="#cb38-28"></a><span class="co"># 6 EMP      CHN     287744. 7050.  67144.  1606.   20852.  2.89e4 1.39e4 4929.  22669.  3.10e4 4.86e5</span></span>
<span id="cb38-29"><a href="#cb38-29"></a><span class="kw">head</span>(<span class="kw">fsd</span>(<span class="kw">fscale</span>(gGGDC, <span class="dt">mean =</span> <span class="ot">FALSE</span>)))</span>
<span id="cb38-30"><a href="#cb38-30"></a><span class="co"># # A tibble: 6 x 13</span></span>
<span id="cb38-31"><a href="#cb38-31"></a><span class="co">#   Variable Country   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH   SUM</span></span>
<span id="cb38-32"><a href="#cb38-32"></a><span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb38-33"><a href="#cb38-33"></a><span class="co"># 1 EMP      ARG      1.    1.    1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.  </span></span>
<span id="cb38-34"><a href="#cb38-34"></a><span class="co"># 2 EMP      BOL      1.    1.00  1.    1.00  1.00  1.    1.    1.   NA     1.    1.  </span></span>
<span id="cb38-35"><a href="#cb38-35"></a><span class="co"># 3 EMP      BRA      1.    1.    1.    1.00  1.    1.00  1.00  1.00  1.    1.00  1.00</span></span>
<span id="cb38-36"><a href="#cb38-36"></a><span class="co"># 4 EMP      BWA      1.00  1.00  1.    1.    1.    1.00  1.    1.00  1.    1.00  1.00</span></span>
<span id="cb38-37"><a href="#cb38-37"></a><span class="co"># 5 EMP      CHL      1.    1.    1.00  1.    1.    1.    1.00  1.   NA     1.    1.00</span></span>
<span id="cb38-38"><a href="#cb38-38"></a><span class="co"># 6 EMP      CHN      1.    1.    1.    1.00  1.00  1.    1.    1.    1.00  1.00  1.</span></span></code></pre></div>
<p>One can also set <code>mean = &quot;overall.mean&quot;</code>, which group-centers columns on the overall mean as illustrated with <code>fwithin</code>. Another interesting option is setting <code>sd = &quot;within.sd&quot;</code>. This group-scales data such that every group has a standard deviation equal to the within-standard deviation of the data:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="co"># Just using VA data for this example</span></span>
<span id="cb39-2"><a href="#cb39-2"></a>gGGDC &lt;-<span class="st"> </span>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="st">  </span><span class="kw">fsubset</span>(Variable <span class="op">==</span><span class="st"> &quot;VA&quot;</span>, Country, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb39-4"><a href="#cb39-4"></a><span class="st">      </span><span class="kw">fgroup_by</span>(Country)</span>
<span id="cb39-5"><a href="#cb39-5"></a></span>
<span id="cb39-6"><a href="#cb39-6"></a><span class="co"># This calculates the within- standard deviation for all columns</span></span>
<span id="cb39-7"><a href="#cb39-7"></a><span class="kw">fsd</span>(<span class="kw">num_vars</span>(<span class="kw">ungroup</span>(<span class="kw">fwithin</span>(gGGDC))))</span>
<span id="cb39-8"><a href="#cb39-8"></a><span class="co">#       AGR       MIN       MAN        PU       CON       WRT       TRA      FIRE       GOV       OTH </span></span>
<span id="cb39-9"><a href="#cb39-9"></a><span class="co">#  45046972  40122220  75608708   3062688  30811572  44125207  20676901  16030868  20358973  18780869 </span></span>
<span id="cb39-10"><a href="#cb39-10"></a><span class="co">#       SUM </span></span>
<span id="cb39-11"><a href="#cb39-11"></a><span class="co"># 306429102</span></span>
<span id="cb39-12"><a href="#cb39-12"></a></span>
<span id="cb39-13"><a href="#cb39-13"></a><span class="co"># This scales all groups to take on the within- standard deviation while preserving group means </span></span>
<span id="cb39-14"><a href="#cb39-14"></a><span class="kw">fsd</span>(<span class="kw">fscale</span>(gGGDC, <span class="dt">mean =</span> <span class="ot">FALSE</span>, <span class="dt">sd =</span> <span class="st">&quot;within.sd&quot;</span>))</span>
<span id="cb39-15"><a href="#cb39-15"></a><span class="co"># # A tibble: 43 x 12</span></span>
<span id="cb39-16"><a href="#cb39-16"></a><span class="co">#    Country      AGR      MIN      MAN     PU     CON     WRT     TRA    FIRE     GOV     OTH     SUM</span></span>
<span id="cb39-17"><a href="#cb39-17"></a><span class="co">#    &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb39-18"><a href="#cb39-18"></a><span class="co">#  1 ARG       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7  2.04e7  1.88e7  3.06e8</span></span>
<span id="cb39-19"><a href="#cb39-19"></a><span class="co">#  2 BOL       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7 NA       1.88e7  3.06e8</span></span>
<span id="cb39-20"><a href="#cb39-20"></a><span class="co">#  3 BRA       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7  2.04e7  1.88e7  3.06e8</span></span>
<span id="cb39-21"><a href="#cb39-21"></a><span class="co">#  4 BWA       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7  2.04e7  1.88e7  3.06e8</span></span>
<span id="cb39-22"><a href="#cb39-22"></a><span class="co">#  5 CHL       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7 NA       1.88e7  3.06e8</span></span>
<span id="cb39-23"><a href="#cb39-23"></a><span class="co">#  6 CHN       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7  2.04e7  1.88e7  3.06e8</span></span>
<span id="cb39-24"><a href="#cb39-24"></a><span class="co">#  7 COL       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7 NA       1.88e7  3.06e8</span></span>
<span id="cb39-25"><a href="#cb39-25"></a><span class="co">#  8 CRI       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7  2.04e7  1.88e7  3.06e8</span></span>
<span id="cb39-26"><a href="#cb39-26"></a><span class="co">#  9 DEW       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7  2.04e7  1.88e7  3.06e8</span></span>
<span id="cb39-27"><a href="#cb39-27"></a><span class="co"># 10 DNK       4.50e7   4.01e7   7.56e7 3.06e6  3.08e7  4.41e7  2.07e7  1.60e7  2.04e7  1.88e7  3.06e8</span></span>
<span id="cb39-28"><a href="#cb39-28"></a><span class="co"># # ... with 33 more rows</span></span></code></pre></div>
<p>A grouped scaling operation with both <code>mean = &quot;overall.mean&quot;</code> and <code>sd = &quot;within.sd&quot;</code> thus efficiently achieves a complete harmonization of all groups in the first two moments without changing the fundamental properties (in terms of level and scale) of the data.</p>
</div>
<div id="lags-leads-differences-and-growth-rates" class="section level3">
<h3>2.5 Lags / Leads, Differences and Growth Rates</h3>
<!-- It was suggested some time ago that leaving the best wine for the end is not the best strategy when giving a feast. Considering the marriage of *collapse* and *dplyr* the 3 functions for time-computations introduced in this section combine great flexibility with precision and computing power, and feature amongst the highlights of *collapse*. -->
<p>This section introduces 3 further powerful <em>collapse</em> functions: <code>flag</code>, <code>fdiff</code> and <code>fgrowth</code>. The first function, <code>flag</code>, efficiently computes sequences of fully identified lags and leads on time-series and panel-data. The following code computes 1 fully-identified panel-lag and 1 fully identified panel-lead of each variable in the data:</p>
<!-- In addition: None of these functions require the data to be sorted, they can carry out fast computations on completely unordered data as long as a time-variable is supplied that uniquely identifies the data. -->
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="st">  </span><span class="kw">fselect</span>(<span class="op">-</span>Region, <span class="op">-</span>Regioncode) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb40-3"><a href="#cb40-3"></a><span class="st">    </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">flag</span>(<span class="op">-</span><span class="dv">1</span><span class="op">:</span><span class="dv">1</span>, Year)</span>
<span id="cb40-4"><a href="#cb40-4"></a><span class="co"># # A tibble: 5,027 x 36</span></span>
<span id="cb40-5"><a href="#cb40-5"></a><span class="co">#    Country Variable  Year F1.AGR   AGR L1.AGR F1.MIN   MIN L1.MIN F1.MAN    MAN L1.MAN  F1.PU     PU</span></span>
<span id="cb40-6"><a href="#cb40-6"></a><span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb40-7"><a href="#cb40-7"></a><span class="co">#  1 BWA     VA        1960   NA    NA     NA    NA    NA     NA    NA     NA     NA     NA     NA    </span></span>
<span id="cb40-8"><a href="#cb40-8"></a><span class="co">#  2 BWA     VA        1961   NA    NA     NA    NA    NA     NA    NA     NA     NA     NA     NA    </span></span>
<span id="cb40-9"><a href="#cb40-9"></a><span class="co">#  3 BWA     VA        1962   NA    NA     NA    NA    NA     NA    NA     NA     NA     NA     NA    </span></span>
<span id="cb40-10"><a href="#cb40-10"></a><span class="co">#  4 BWA     VA        1963   16.3  NA     NA     3.49 NA     NA     0.737 NA     NA      0.104 NA    </span></span>
<span id="cb40-11"><a href="#cb40-11"></a><span class="co">#  5 BWA     VA        1964   15.7  16.3   NA     2.50  3.49  NA     1.02   0.737 NA      0.135  0.104</span></span>
<span id="cb40-12"><a href="#cb40-12"></a><span class="co">#  6 BWA     VA        1965   17.7  15.7   16.3   1.97  2.50   3.49  0.804  1.02   0.737  0.203  0.135</span></span>
<span id="cb40-13"><a href="#cb40-13"></a><span class="co">#  7 BWA     VA        1966   19.1  17.7   15.7   2.30  1.97   2.50  0.938  0.804  1.02   0.203  0.203</span></span>
<span id="cb40-14"><a href="#cb40-14"></a><span class="co">#  8 BWA     VA        1967   21.1  19.1   17.7   1.84  2.30   1.97  0.750  0.938  0.804  0.203  0.203</span></span>
<span id="cb40-15"><a href="#cb40-15"></a><span class="co">#  9 BWA     VA        1968   21.9  21.1   19.1   5.24  1.84   2.30  2.14   0.750  0.938  0.578  0.203</span></span>
<span id="cb40-16"><a href="#cb40-16"></a><span class="co"># 10 BWA     VA        1969   23.1  21.9   21.1  10.2   5.24   1.84  4.15   2.14   0.750  1.12   0.578</span></span>
<span id="cb40-17"><a href="#cb40-17"></a><span class="co"># # ... with 5,017 more rows, and 22 more variables: L1.PU &lt;dbl&gt;, F1.CON &lt;dbl&gt;, CON &lt;dbl&gt;,</span></span>
<span id="cb40-18"><a href="#cb40-18"></a><span class="co"># #   L1.CON &lt;dbl&gt;, F1.WRT &lt;dbl&gt;, WRT &lt;dbl&gt;, L1.WRT &lt;dbl&gt;, F1.TRA &lt;dbl&gt;, TRA &lt;dbl&gt;, L1.TRA &lt;dbl&gt;,</span></span>
<span id="cb40-19"><a href="#cb40-19"></a><span class="co"># #   F1.FIRE &lt;dbl&gt;, FIRE &lt;dbl&gt;, L1.FIRE &lt;dbl&gt;, F1.GOV &lt;dbl&gt;, GOV &lt;dbl&gt;, L1.GOV &lt;dbl&gt;, F1.OTH &lt;dbl&gt;,</span></span>
<span id="cb40-20"><a href="#cb40-20"></a><span class="co"># #   OTH &lt;dbl&gt;, L1.OTH &lt;dbl&gt;, F1.SUM &lt;dbl&gt;, SUM &lt;dbl&gt;, L1.SUM &lt;dbl&gt;</span></span></code></pre></div>
<p>If the time-variable passed does not exactly identify the data (i.e. because of gaps or repeated values in each group), all 3 functions will issue appropriate error messages. <code>flag</code>, <code>fdiff</code> and <code>fgrowth</code> support unbalanced panels with different start and end periods and duration of coverage for each individual, but not irregular panels. A workaround for such panels exists with the function <code>seqid</code> which generates a new panel-id identifying consecutive time-sequences at the sub-individual level, see <code>?seqid</code>.</p>
<p>It is also possible to omit the time-variable if one is certain that the data is sorted:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="st">  </span><span class="kw">fselect</span>(Variable, Country,AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb41-3"><a href="#cb41-3"></a><span class="st">    </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span>flag</span>
<span id="cb41-4"><a href="#cb41-4"></a><span class="co"># # A tibble: 5,027 x 13</span></span>
<span id="cb41-5"><a href="#cb41-5"></a><span class="co">#    Variable Country L1.AGR L1.MIN L1.MAN  L1.PU L1.CON L1.WRT L1.TRA L1.FIRE L1.GOV L1.OTH L1.SUM</span></span>
<span id="cb41-6"><a href="#cb41-6"></a><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb41-7"><a href="#cb41-7"></a><span class="co">#  1 VA       BWA       NA    NA    NA     NA     NA      NA     NA      NA     NA     NA      NA  </span></span>
<span id="cb41-8"><a href="#cb41-8"></a><span class="co">#  2 VA       BWA       NA    NA    NA     NA     NA      NA     NA      NA     NA     NA      NA  </span></span>
<span id="cb41-9"><a href="#cb41-9"></a><span class="co">#  3 VA       BWA       NA    NA    NA     NA     NA      NA     NA      NA     NA     NA      NA  </span></span>
<span id="cb41-10"><a href="#cb41-10"></a><span class="co">#  4 VA       BWA       NA    NA    NA     NA     NA      NA     NA      NA     NA     NA      NA  </span></span>
<span id="cb41-11"><a href="#cb41-11"></a><span class="co">#  5 VA       BWA       NA    NA    NA     NA     NA      NA     NA      NA     NA     NA      NA  </span></span>
<span id="cb41-12"><a href="#cb41-12"></a><span class="co">#  6 VA       BWA       16.3   3.49  0.737  0.104  0.660   6.24   1.66    1.12   4.82   2.34   37.5</span></span>
<span id="cb41-13"><a href="#cb41-13"></a><span class="co">#  7 VA       BWA       15.7   2.50  1.02   0.135  1.35    7.06   1.94    1.25   5.70   2.68   39.3</span></span>
<span id="cb41-14"><a href="#cb41-14"></a><span class="co">#  8 VA       BWA       17.7   1.97  0.804  0.203  1.35    8.27   2.15    1.36   6.37   2.99   43.1</span></span>
<span id="cb41-15"><a href="#cb41-15"></a><span class="co">#  9 VA       BWA       19.1   2.30  0.938  0.203  0.897   4.31   1.72    1.54   7.04   3.31   41.4</span></span>
<span id="cb41-16"><a href="#cb41-16"></a><span class="co"># 10 VA       BWA       21.1   1.84  0.750  0.203  1.22    5.17   2.44    1.03   5.03   2.36   41.1</span></span>
<span id="cb41-17"><a href="#cb41-17"></a><span class="co"># # ... with 5,017 more rows</span></span></code></pre></div>
<p><code>fdiff</code> computes sequences of lagged-leaded and iterated differences as well as quasi-differences and log-differences on time-series and panel-data. The code below computes the 1 and 10 year first and second differences of each variable in the data:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2"></a><span class="st">  </span><span class="kw">fselect</span>(<span class="op">-</span>Region, <span class="op">-</span>Regioncode) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb42-3"><a href="#cb42-3"></a><span class="st">    </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fdiff</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, Year)</span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="co"># # A tibble: 5,027 x 47</span></span>
<span id="cb42-5"><a href="#cb42-5"></a><span class="co">#    Country Variable  Year D1.AGR D2.AGR L10D1.AGR L10D2.AGR D1.MIN D2.MIN L10D1.MIN L10D2.MIN D1.MAN</span></span>
<span id="cb42-6"><a href="#cb42-6"></a><span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb42-7"><a href="#cb42-7"></a><span class="co">#  1 BWA     VA        1960 NA     NA            NA        NA NA     NA            NA        NA NA    </span></span>
<span id="cb42-8"><a href="#cb42-8"></a><span class="co">#  2 BWA     VA        1961 NA     NA            NA        NA NA     NA            NA        NA NA    </span></span>
<span id="cb42-9"><a href="#cb42-9"></a><span class="co">#  3 BWA     VA        1962 NA     NA            NA        NA NA     NA            NA        NA NA    </span></span>
<span id="cb42-10"><a href="#cb42-10"></a><span class="co">#  4 BWA     VA        1963 NA     NA            NA        NA NA     NA            NA        NA NA    </span></span>
<span id="cb42-11"><a href="#cb42-11"></a><span class="co">#  5 BWA     VA        1964 NA     NA            NA        NA NA     NA            NA        NA NA    </span></span>
<span id="cb42-12"><a href="#cb42-12"></a><span class="co">#  6 BWA     VA        1965 -0.575 NA            NA        NA -0.998 NA            NA        NA  0.282</span></span>
<span id="cb42-13"><a href="#cb42-13"></a><span class="co">#  7 BWA     VA        1966  1.95   2.53         NA        NA -0.525  0.473        NA        NA -0.214</span></span>
<span id="cb42-14"><a href="#cb42-14"></a><span class="co">#  8 BWA     VA        1967  1.47  -0.488        NA        NA  0.328  0.854        NA        NA  0.134</span></span>
<span id="cb42-15"><a href="#cb42-15"></a><span class="co">#  9 BWA     VA        1968  1.95   0.488        NA        NA -0.460 -0.788        NA        NA -0.188</span></span>
<span id="cb42-16"><a href="#cb42-16"></a><span class="co"># 10 BWA     VA        1969  0.763 -1.19         NA        NA  3.41   3.87         NA        NA  1.39 </span></span>
<span id="cb42-17"><a href="#cb42-17"></a><span class="co"># # ... with 5,017 more rows, and 35 more variables: D2.MAN &lt;dbl&gt;, L10D1.MAN &lt;dbl&gt;, L10D2.MAN &lt;dbl&gt;,</span></span>
<span id="cb42-18"><a href="#cb42-18"></a><span class="co"># #   D1.PU &lt;dbl&gt;, D2.PU &lt;dbl&gt;, L10D1.PU &lt;dbl&gt;, L10D2.PU &lt;dbl&gt;, D1.CON &lt;dbl&gt;, D2.CON &lt;dbl&gt;,</span></span>
<span id="cb42-19"><a href="#cb42-19"></a><span class="co"># #   L10D1.CON &lt;dbl&gt;, L10D2.CON &lt;dbl&gt;, D1.WRT &lt;dbl&gt;, D2.WRT &lt;dbl&gt;, L10D1.WRT &lt;dbl&gt;, L10D2.WRT &lt;dbl&gt;,</span></span>
<span id="cb42-20"><a href="#cb42-20"></a><span class="co"># #   D1.TRA &lt;dbl&gt;, D2.TRA &lt;dbl&gt;, L10D1.TRA &lt;dbl&gt;, L10D2.TRA &lt;dbl&gt;, D1.FIRE &lt;dbl&gt;, D2.FIRE &lt;dbl&gt;,</span></span>
<span id="cb42-21"><a href="#cb42-21"></a><span class="co"># #   L10D1.FIRE &lt;dbl&gt;, L10D2.FIRE &lt;dbl&gt;, D1.GOV &lt;dbl&gt;, D2.GOV &lt;dbl&gt;, L10D1.GOV &lt;dbl&gt;,</span></span>
<span id="cb42-22"><a href="#cb42-22"></a><span class="co"># #   L10D2.GOV &lt;dbl&gt;, D1.OTH &lt;dbl&gt;, D2.OTH &lt;dbl&gt;, L10D1.OTH &lt;dbl&gt;, L10D2.OTH &lt;dbl&gt;, D1.SUM &lt;dbl&gt;,</span></span>
<span id="cb42-23"><a href="#cb42-23"></a><span class="co"># #   D2.SUM &lt;dbl&gt;, L10D1.SUM &lt;dbl&gt;, L10D2.SUM &lt;dbl&gt;</span></span></code></pre></div>
<p>Log-differences of the form <span class="math inline">\(log(x_t) - log(x_{t-s})\)</span> are also easily computed, although one caveat of log-differencing in C++ is that <code>log(NA) - log(NA)</code> gives a <code>NaN</code> value.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="st">  </span><span class="kw">fselect</span>(<span class="op">-</span>Region, <span class="op">-</span>Regioncode) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="st">    </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fdiff</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="dv">1</span>, Year, <span class="dt">logdiff =</span> <span class="ot">TRUE</span>)</span>
<span id="cb43-4"><a href="#cb43-4"></a><span class="co"># # A tibble: 5,027 x 25</span></span>
<span id="cb43-5"><a href="#cb43-5"></a><span class="co">#    Country Variable  Year Dlog1.AGR L10Dlog1.AGR Dlog1.MIN L10Dlog1.MIN Dlog1.MAN L10Dlog1.MAN</span></span>
<span id="cb43-6"><a href="#cb43-6"></a><span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;</span></span>
<span id="cb43-7"><a href="#cb43-7"></a><span class="co">#  1 BWA     VA        1960   NA                NA    NA               NA    NA               NA</span></span>
<span id="cb43-8"><a href="#cb43-8"></a><span class="co">#  2 BWA     VA        1961  NaN                NA   NaN               NA   NaN               NA</span></span>
<span id="cb43-9"><a href="#cb43-9"></a><span class="co">#  3 BWA     VA        1962  NaN                NA   NaN               NA   NaN               NA</span></span>
<span id="cb43-10"><a href="#cb43-10"></a><span class="co">#  4 BWA     VA        1963  NaN                NA   NaN               NA   NaN               NA</span></span>
<span id="cb43-11"><a href="#cb43-11"></a><span class="co">#  5 BWA     VA        1964  NaN                NA   NaN               NA   NaN               NA</span></span>
<span id="cb43-12"><a href="#cb43-12"></a><span class="co">#  6 BWA     VA        1965   -0.0359           NA    -0.336           NA     0.324           NA</span></span>
<span id="cb43-13"><a href="#cb43-13"></a><span class="co">#  7 BWA     VA        1966    0.117            NA    -0.236           NA    -0.236           NA</span></span>
<span id="cb43-14"><a href="#cb43-14"></a><span class="co">#  8 BWA     VA        1967    0.0796           NA     0.154           NA     0.154           NA</span></span>
<span id="cb43-15"><a href="#cb43-15"></a><span class="co">#  9 BWA     VA        1968    0.0972           NA    -0.223           NA    -0.223           NA</span></span>
<span id="cb43-16"><a href="#cb43-16"></a><span class="co"># 10 BWA     VA        1969    0.0355           NA     1.05            NA     1.05            NA</span></span>
<span id="cb43-17"><a href="#cb43-17"></a><span class="co"># # ... with 5,017 more rows, and 16 more variables: Dlog1.PU &lt;dbl&gt;, L10Dlog1.PU &lt;dbl&gt;,</span></span>
<span id="cb43-18"><a href="#cb43-18"></a><span class="co"># #   Dlog1.CON &lt;dbl&gt;, L10Dlog1.CON &lt;dbl&gt;, Dlog1.WRT &lt;dbl&gt;, L10Dlog1.WRT &lt;dbl&gt;, Dlog1.TRA &lt;dbl&gt;,</span></span>
<span id="cb43-19"><a href="#cb43-19"></a><span class="co"># #   L10Dlog1.TRA &lt;dbl&gt;, Dlog1.FIRE &lt;dbl&gt;, L10Dlog1.FIRE &lt;dbl&gt;, Dlog1.GOV &lt;dbl&gt;, L10Dlog1.GOV &lt;dbl&gt;,</span></span>
<span id="cb43-20"><a href="#cb43-20"></a><span class="co"># #   Dlog1.OTH &lt;dbl&gt;, L10Dlog1.OTH &lt;dbl&gt;, Dlog1.SUM &lt;dbl&gt;, L10Dlog1.SUM &lt;dbl&gt;</span></span></code></pre></div>
<p>Finally, it is also possible to compute quasi-differences and quasi-log-differences of the form <span class="math inline">\(x_t - \rho x_{t-s}\)</span> or <span class="math inline">\(log(x_t) - \rho log(x_{t-s})\)</span>:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2"></a><span class="st">  </span><span class="kw">fselect</span>(<span class="op">-</span>Region, <span class="op">-</span>Regioncode) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb44-3"><a href="#cb44-3"></a><span class="st">    </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fdiff</span>(<span class="dt">t =</span> Year, <span class="dt">rho =</span> <span class="fl">0.95</span>)</span>
<span id="cb44-4"><a href="#cb44-4"></a><span class="co"># # A tibble: 5,027 x 14</span></span>
<span id="cb44-5"><a href="#cb44-5"></a><span class="co">#    Country Variable  Year QD1.AGR QD1.MIN QD1.MAN  QD1.PU QD1.CON QD1.WRT QD1.TRA QD1.FIRE QD1.GOV</span></span>
<span id="cb44-6"><a href="#cb44-6"></a><span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb44-7"><a href="#cb44-7"></a><span class="co">#  1 BWA     VA        1960  NA      NA      NA     NA      NA       NA      NA       NA      NA    </span></span>
<span id="cb44-8"><a href="#cb44-8"></a><span class="co">#  2 BWA     VA        1961  NA      NA      NA     NA      NA       NA      NA       NA      NA    </span></span>
<span id="cb44-9"><a href="#cb44-9"></a><span class="co">#  3 BWA     VA        1962  NA      NA      NA     NA      NA       NA      NA       NA      NA    </span></span>
<span id="cb44-10"><a href="#cb44-10"></a><span class="co">#  4 BWA     VA        1963  NA      NA      NA     NA      NA       NA      NA       NA      NA    </span></span>
<span id="cb44-11"><a href="#cb44-11"></a><span class="co">#  5 BWA     VA        1964  NA      NA      NA     NA      NA       NA      NA       NA      NA    </span></span>
<span id="cb44-12"><a href="#cb44-12"></a><span class="co">#  6 BWA     VA        1965   0.241  -0.824   0.318  0.0359  0.719    1.13    0.363    0.184   1.11 </span></span>
<span id="cb44-13"><a href="#cb44-13"></a><span class="co">#  7 BWA     VA        1966   2.74   -0.401  -0.163  0.0743  0.0673   1.56    0.312    0.174   0.955</span></span>
<span id="cb44-14"><a href="#cb44-14"></a><span class="co">#  8 BWA     VA        1967   2.35    0.427   0.174  0.0101 -0.381   -3.55   -0.323    0.246   0.988</span></span>
<span id="cb44-15"><a href="#cb44-15"></a><span class="co">#  9 BWA     VA        1968   2.91   -0.345  -0.141  0.0101  0.365    1.08    0.804   -0.427  -1.66 </span></span>
<span id="cb44-16"><a href="#cb44-16"></a><span class="co"># 10 BWA     VA        1969   1.82    3.50    1.43   0.385   2.32     0.841   0.397    0.252   0.818</span></span>
<span id="cb44-17"><a href="#cb44-17"></a><span class="co"># # ... with 5,017 more rows, and 2 more variables: QD1.OTH &lt;dbl&gt;, QD1.SUM &lt;dbl&gt;</span></span></code></pre></div>
<p>The quasi-differencing feature was added to <code>fdiff</code> to facilitate the preparation of time-series and panel data for least-squares estimations suffering from serial correlation following Cochrane &amp; Orcutt (1949).</p>
<!-- and `fgrowth` computes lagged-leaded and iterated growth-rates obtained via the exact computation method or through log-differencing.  -->
<p>Finally, <code>fgrowth</code> computes growth rates in the same way. By default exact growth rates are computed in percentage terms using <span class="math inline">\((x_t-x_{t-s}) / x_{t-s} \times 100\)</span> (the default argument is <code>scale = 100</code>). The user can also request growth rates obtained by log-differencing using <span class="math inline">\(log(x_t/ x_{t-s}) \times 100\)</span>.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="co"># Exact growth rates, computed as: (x - lag(x)) / lag(x) * 100</span></span>
<span id="cb45-2"><a href="#cb45-2"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb45-3"><a href="#cb45-3"></a><span class="st">  </span><span class="kw">fselect</span>(<span class="op">-</span>Region, <span class="op">-</span>Regioncode) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb45-4"><a href="#cb45-4"></a><span class="st">    </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgrowth</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="dv">1</span>, Year)</span>
<span id="cb45-5"><a href="#cb45-5"></a><span class="co"># # A tibble: 5,027 x 25</span></span>
<span id="cb45-6"><a href="#cb45-6"></a><span class="co">#    Country Variable  Year G1.AGR L10G1.AGR G1.MIN L10G1.MIN G1.MAN L10G1.MAN G1.PU L10G1.PU G1.CON</span></span>
<span id="cb45-7"><a href="#cb45-7"></a><span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb45-8"><a href="#cb45-8"></a><span class="co">#  1 BWA     VA        1960  NA           NA   NA          NA   NA          NA  NA         NA   NA  </span></span>
<span id="cb45-9"><a href="#cb45-9"></a><span class="co">#  2 BWA     VA        1961  NA           NA   NA          NA   NA          NA  NA         NA   NA  </span></span>
<span id="cb45-10"><a href="#cb45-10"></a><span class="co">#  3 BWA     VA        1962  NA           NA   NA          NA   NA          NA  NA         NA   NA  </span></span>
<span id="cb45-11"><a href="#cb45-11"></a><span class="co">#  4 BWA     VA        1963  NA           NA   NA          NA   NA          NA  NA         NA   NA  </span></span>
<span id="cb45-12"><a href="#cb45-12"></a><span class="co">#  5 BWA     VA        1964  NA           NA   NA          NA   NA          NA  NA         NA   NA  </span></span>
<span id="cb45-13"><a href="#cb45-13"></a><span class="co">#  6 BWA     VA        1965  -3.52        NA  -28.6        NA   38.2        NA  29.4       NA  104. </span></span>
<span id="cb45-14"><a href="#cb45-14"></a><span class="co">#  7 BWA     VA        1966  12.4         NA  -21.1        NA  -21.1        NA  50.0       NA    0  </span></span>
<span id="cb45-15"><a href="#cb45-15"></a><span class="co">#  8 BWA     VA        1967   8.29        NA   16.7        NA   16.7        NA   0         NA  -33.3</span></span>
<span id="cb45-16"><a href="#cb45-16"></a><span class="co">#  9 BWA     VA        1968  10.2         NA  -20          NA  -20          NA   0         NA   35.7</span></span>
<span id="cb45-17"><a href="#cb45-17"></a><span class="co"># 10 BWA     VA        1969   3.61        NA  185.         NA  185.         NA 185.        NA  185. </span></span>
<span id="cb45-18"><a href="#cb45-18"></a><span class="co"># # ... with 5,017 more rows, and 13 more variables: L10G1.CON &lt;dbl&gt;, G1.WRT &lt;dbl&gt;, L10G1.WRT &lt;dbl&gt;,</span></span>
<span id="cb45-19"><a href="#cb45-19"></a><span class="co"># #   G1.TRA &lt;dbl&gt;, L10G1.TRA &lt;dbl&gt;, G1.FIRE &lt;dbl&gt;, L10G1.FIRE &lt;dbl&gt;, G1.GOV &lt;dbl&gt;, L10G1.GOV &lt;dbl&gt;,</span></span>
<span id="cb45-20"><a href="#cb45-20"></a><span class="co"># #   G1.OTH &lt;dbl&gt;, L10G1.OTH &lt;dbl&gt;, G1.SUM &lt;dbl&gt;, L10G1.SUM &lt;dbl&gt;</span></span>
<span id="cb45-21"><a href="#cb45-21"></a></span>
<span id="cb45-22"><a href="#cb45-22"></a><span class="co"># Log-difference growth rates, computed as: log(x / lag(x)) * 100</span></span>
<span id="cb45-23"><a href="#cb45-23"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb45-24"><a href="#cb45-24"></a><span class="st">  </span><span class="kw">fselect</span>(<span class="op">-</span>Region, <span class="op">-</span>Regioncode) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb45-25"><a href="#cb45-25"></a><span class="st">    </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgrowth</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="dv">1</span>, Year, <span class="dt">logdiff =</span> <span class="ot">TRUE</span>)</span>
<span id="cb45-26"><a href="#cb45-26"></a><span class="co"># # A tibble: 5,027 x 25</span></span>
<span id="cb45-27"><a href="#cb45-27"></a><span class="co">#    Country Variable  Year Dlog1.AGR L10Dlog1.AGR Dlog1.MIN L10Dlog1.MIN Dlog1.MAN L10Dlog1.MAN</span></span>
<span id="cb45-28"><a href="#cb45-28"></a><span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;</span></span>
<span id="cb45-29"><a href="#cb45-29"></a><span class="co">#  1 BWA     VA        1960     NA              NA      NA             NA      NA             NA</span></span>
<span id="cb45-30"><a href="#cb45-30"></a><span class="co">#  2 BWA     VA        1961    NaN              NA     NaN             NA     NaN             NA</span></span>
<span id="cb45-31"><a href="#cb45-31"></a><span class="co">#  3 BWA     VA        1962    NaN              NA     NaN             NA     NaN             NA</span></span>
<span id="cb45-32"><a href="#cb45-32"></a><span class="co">#  4 BWA     VA        1963    NaN              NA     NaN             NA     NaN             NA</span></span>
<span id="cb45-33"><a href="#cb45-33"></a><span class="co">#  5 BWA     VA        1964    NaN              NA     NaN             NA     NaN             NA</span></span>
<span id="cb45-34"><a href="#cb45-34"></a><span class="co">#  6 BWA     VA        1965     -3.59           NA     -33.6           NA      32.4           NA</span></span>
<span id="cb45-35"><a href="#cb45-35"></a><span class="co">#  7 BWA     VA        1966     11.7            NA     -23.6           NA     -23.6           NA</span></span>
<span id="cb45-36"><a href="#cb45-36"></a><span class="co">#  8 BWA     VA        1967      7.96           NA      15.4           NA      15.4           NA</span></span>
<span id="cb45-37"><a href="#cb45-37"></a><span class="co">#  9 BWA     VA        1968      9.72           NA     -22.3           NA     -22.3           NA</span></span>
<span id="cb45-38"><a href="#cb45-38"></a><span class="co"># 10 BWA     VA        1969      3.55           NA     105.            NA     105.            NA</span></span>
<span id="cb45-39"><a href="#cb45-39"></a><span class="co"># # ... with 5,017 more rows, and 16 more variables: Dlog1.PU &lt;dbl&gt;, L10Dlog1.PU &lt;dbl&gt;,</span></span>
<span id="cb45-40"><a href="#cb45-40"></a><span class="co"># #   Dlog1.CON &lt;dbl&gt;, L10Dlog1.CON &lt;dbl&gt;, Dlog1.WRT &lt;dbl&gt;, L10Dlog1.WRT &lt;dbl&gt;, Dlog1.TRA &lt;dbl&gt;,</span></span>
<span id="cb45-41"><a href="#cb45-41"></a><span class="co"># #   L10Dlog1.TRA &lt;dbl&gt;, Dlog1.FIRE &lt;dbl&gt;, L10Dlog1.FIRE &lt;dbl&gt;, Dlog1.GOV &lt;dbl&gt;, L10Dlog1.GOV &lt;dbl&gt;,</span></span>
<span id="cb45-42"><a href="#cb45-42"></a><span class="co"># #   Dlog1.OTH &lt;dbl&gt;, L10Dlog1.OTH &lt;dbl&gt;, Dlog1.SUM &lt;dbl&gt;, L10Dlog1.SUM &lt;dbl&gt;</span></span></code></pre></div>
<p><code>fdiff</code> and <code>fgrowth</code> can also perform leaded (forward) differences and growth rates (i.e. <code>... %&gt;% fgrowth(-c(1, 10), 1:2, Year)</code> would compute one and 10-year leaded first and second differences). Again it is possible to perform sequential operations:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a><span class="co"># This computes the 1 and 10-year growth rates, for the current period and lagged by one period</span></span>
<span id="cb46-2"><a href="#cb46-2"></a>GGDC10S <span class="op">%&gt;%</span></span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="st">  </span><span class="kw">fselect</span>(<span class="op">-</span>Region, <span class="op">-</span>Regioncode) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb46-4"><a href="#cb46-4"></a><span class="st">    </span><span class="kw">fgroup_by</span>(Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgrowth</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="dv">1</span>, Year) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">flag</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">1</span>, Year)</span>
<span id="cb46-5"><a href="#cb46-5"></a><span class="co"># # A tibble: 5,027 x 47</span></span>
<span id="cb46-6"><a href="#cb46-6"></a><span class="co">#    Country Variable  Year G1.AGR L1.G1.AGR L10G1.AGR L1.L10G1.AGR G1.MIN L1.G1.MIN L10G1.MIN</span></span>
<span id="cb46-7"><a href="#cb46-7"></a><span class="co">#  * &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb46-8"><a href="#cb46-8"></a><span class="co">#  1 BWA     VA        1960  NA        NA           NA           NA   NA        NA          NA</span></span>
<span id="cb46-9"><a href="#cb46-9"></a><span class="co">#  2 BWA     VA        1961  NA        NA           NA           NA   NA        NA          NA</span></span>
<span id="cb46-10"><a href="#cb46-10"></a><span class="co">#  3 BWA     VA        1962  NA        NA           NA           NA   NA        NA          NA</span></span>
<span id="cb46-11"><a href="#cb46-11"></a><span class="co">#  4 BWA     VA        1963  NA        NA           NA           NA   NA        NA          NA</span></span>
<span id="cb46-12"><a href="#cb46-12"></a><span class="co">#  5 BWA     VA        1964  NA        NA           NA           NA   NA        NA          NA</span></span>
<span id="cb46-13"><a href="#cb46-13"></a><span class="co">#  6 BWA     VA        1965  -3.52     NA           NA           NA  -28.6      NA          NA</span></span>
<span id="cb46-14"><a href="#cb46-14"></a><span class="co">#  7 BWA     VA        1966  12.4      -3.52        NA           NA  -21.1     -28.6        NA</span></span>
<span id="cb46-15"><a href="#cb46-15"></a><span class="co">#  8 BWA     VA        1967   8.29     12.4         NA           NA   16.7     -21.1        NA</span></span>
<span id="cb46-16"><a href="#cb46-16"></a><span class="co">#  9 BWA     VA        1968  10.2       8.29        NA           NA  -20        16.7        NA</span></span>
<span id="cb46-17"><a href="#cb46-17"></a><span class="co"># 10 BWA     VA        1969   3.61     10.2         NA           NA  185.      -20          NA</span></span>
<span id="cb46-18"><a href="#cb46-18"></a><span class="co"># # ... with 5,017 more rows, and 37 more variables: L1.L10G1.MIN &lt;dbl&gt;, G1.MAN &lt;dbl&gt;,</span></span>
<span id="cb46-19"><a href="#cb46-19"></a><span class="co"># #   L1.G1.MAN &lt;dbl&gt;, L10G1.MAN &lt;dbl&gt;, L1.L10G1.MAN &lt;dbl&gt;, G1.PU &lt;dbl&gt;, L1.G1.PU &lt;dbl&gt;,</span></span>
<span id="cb46-20"><a href="#cb46-20"></a><span class="co"># #   L10G1.PU &lt;dbl&gt;, L1.L10G1.PU &lt;dbl&gt;, G1.CON &lt;dbl&gt;, L1.G1.CON &lt;dbl&gt;, L10G1.CON &lt;dbl&gt;,</span></span>
<span id="cb46-21"><a href="#cb46-21"></a><span class="co"># #   L1.L10G1.CON &lt;dbl&gt;, G1.WRT &lt;dbl&gt;, L1.G1.WRT &lt;dbl&gt;, L10G1.WRT &lt;dbl&gt;, L1.L10G1.WRT &lt;dbl&gt;,</span></span>
<span id="cb46-22"><a href="#cb46-22"></a><span class="co"># #   G1.TRA &lt;dbl&gt;, L1.G1.TRA &lt;dbl&gt;, L10G1.TRA &lt;dbl&gt;, L1.L10G1.TRA &lt;dbl&gt;, G1.FIRE &lt;dbl&gt;,</span></span>
<span id="cb46-23"><a href="#cb46-23"></a><span class="co"># #   L1.G1.FIRE &lt;dbl&gt;, L10G1.FIRE &lt;dbl&gt;, L1.L10G1.FIRE &lt;dbl&gt;, G1.GOV &lt;dbl&gt;, L1.G1.GOV &lt;dbl&gt;,</span></span>
<span id="cb46-24"><a href="#cb46-24"></a><span class="co"># #   L10G1.GOV &lt;dbl&gt;, L1.L10G1.GOV &lt;dbl&gt;, G1.OTH &lt;dbl&gt;, L1.G1.OTH &lt;dbl&gt;, L10G1.OTH &lt;dbl&gt;,</span></span>
<span id="cb46-25"><a href="#cb46-25"></a><span class="co"># #   L1.L10G1.OTH &lt;dbl&gt;, G1.SUM &lt;dbl&gt;, L1.G1.SUM &lt;dbl&gt;, L10G1.SUM &lt;dbl&gt;, L1.L10G1.SUM &lt;dbl&gt;</span></span></code></pre></div>
</div>
</div>
<div id="benchmarks" class="section level2">
<h2>3. Benchmarks</h2>
<p>This section seeks to demonstrate that the functionality introduced in the preceeding 2 sections indeed produces code that evaluates substantially faster than native <em>dplyr</em>.</p>
<p>To do this properly, the different components of a typical piped call (selecting / subsetting, grouping, and performing some computation) are bechmarked separately on 2 different data sizes.</p>
<p>All benchmarks are run on a Windows 8.1 laptop with a 2x 2.2 GHZ Intel i5 processor, 8GB DDR3 RAM and a Samsung 850 EVO SSD hard drive.</p>
<div id="data" class="section level3">
<h3>3.1 Data</h3>
<p>Bechmarks are run on the original <code>GGDC10S</code> data used throughout this vignette and a larger dataset with approx. 1 million observations, obtained by replicating and row-binding <code>GGDC10S</code> 200 times while maintaining unique groups.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="co"># This shows the groups in GGDC10S</span></span>
<span id="cb47-2"><a href="#cb47-2"></a><span class="kw">GRP</span>(GGDC10S, <span class="op">~</span><span class="st"> </span>Variable <span class="op">+</span><span class="st"> </span>Country)</span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="co"># collapse grouping object of length 5027 with 85 ordered groups</span></span>
<span id="cb47-4"><a href="#cb47-4"></a><span class="co"># </span></span>
<span id="cb47-5"><a href="#cb47-5"></a><span class="co"># Call: GRP.default(X = GGDC10S, by = ~Variable + Country), unordered</span></span>
<span id="cb47-6"><a href="#cb47-6"></a><span class="co"># </span></span>
<span id="cb47-7"><a href="#cb47-7"></a><span class="co"># Distribution of group sizes: </span></span>
<span id="cb47-8"><a href="#cb47-8"></a><span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb47-9"><a href="#cb47-9"></a><span class="co">#    4.00   53.00   62.00   59.14   63.00   65.00 </span></span>
<span id="cb47-10"><a href="#cb47-10"></a><span class="co"># </span></span>
<span id="cb47-11"><a href="#cb47-11"></a><span class="co"># Groups with sizes: </span></span>
<span id="cb47-12"><a href="#cb47-12"></a><span class="co"># EMP.ARG EMP.BOL EMP.BRA EMP.BWA EMP.CHL EMP.CHN </span></span>
<span id="cb47-13"><a href="#cb47-13"></a><span class="co">#      62      61      62      52      63      62 </span></span>
<span id="cb47-14"><a href="#cb47-14"></a><span class="co">#   ---</span></span>
<span id="cb47-15"><a href="#cb47-15"></a><span class="co"># VA.TWN VA.TZA VA.USA VA.VEN VA.ZAF VA.ZMB </span></span>
<span id="cb47-16"><a href="#cb47-16"></a><span class="co">#     63     52     65     63     52     52</span></span>
<span id="cb47-17"><a href="#cb47-17"></a></span>
<span id="cb47-18"><a href="#cb47-18"></a><span class="co"># This replicates the data 200 times </span></span>
<span id="cb47-19"><a href="#cb47-19"></a>data &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">200</span>, GGDC10S, <span class="dt">simplify =</span> <span class="ot">FALSE</span>) </span>
<span id="cb47-20"><a href="#cb47-20"></a><span class="co"># This function adds a number i to the country and variable columns of each dataset</span></span>
<span id="cb47-21"><a href="#cb47-21"></a>uniquify &lt;-<span class="st"> </span><span class="cf">function</span>(x, i) <span class="st">`</span><span class="dt">get_vars&lt;-</span><span class="st">`</span>(x, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>), <span class="dt">value =</span> <span class="kw">lapply</span>(<span class="kw">unclass</span>(x)[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>)], paste0, i))</span>
<span id="cb47-22"><a href="#cb47-22"></a><span class="co"># Making datasets unique and row-binding them</span></span>
<span id="cb47-23"><a href="#cb47-23"></a>data &lt;-<span class="st"> </span><span class="kw">unlist2d</span>(<span class="kw">Map</span>(uniquify, data, <span class="kw">as.list</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">200</span>)), <span class="dt">idcols =</span> <span class="ot">FALSE</span>)</span>
<span id="cb47-24"><a href="#cb47-24"></a><span class="kw">dim</span>(data)</span>
<span id="cb47-25"><a href="#cb47-25"></a><span class="co"># [1] 1005400      16</span></span>
<span id="cb47-26"><a href="#cb47-26"></a></span>
<span id="cb47-27"><a href="#cb47-27"></a><span class="co"># This shows the groups in the replicated data</span></span>
<span id="cb47-28"><a href="#cb47-28"></a><span class="kw">GRP</span>(data, <span class="op">~</span><span class="st"> </span>Variable <span class="op">+</span><span class="st"> </span>Country)</span>
<span id="cb47-29"><a href="#cb47-29"></a><span class="co"># collapse grouping object of length 1005400 with 17000 ordered groups</span></span>
<span id="cb47-30"><a href="#cb47-30"></a><span class="co"># </span></span>
<span id="cb47-31"><a href="#cb47-31"></a><span class="co"># Call: GRP.default(X = data, by = ~Variable + Country), unordered</span></span>
<span id="cb47-32"><a href="#cb47-32"></a><span class="co"># </span></span>
<span id="cb47-33"><a href="#cb47-33"></a><span class="co"># Distribution of group sizes: </span></span>
<span id="cb47-34"><a href="#cb47-34"></a><span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb47-35"><a href="#cb47-35"></a><span class="co">#    4.00   53.00   62.00   59.14   63.00   65.00 </span></span>
<span id="cb47-36"><a href="#cb47-36"></a><span class="co"># </span></span>
<span id="cb47-37"><a href="#cb47-37"></a><span class="co"># Groups with sizes: </span></span>
<span id="cb47-38"><a href="#cb47-38"></a><span class="co"># EMP1.ARG1 EMP1.BOL1 EMP1.BRA1 EMP1.BWA1 EMP1.CHL1 EMP1.CHN1 </span></span>
<span id="cb47-39"><a href="#cb47-39"></a><span class="co">#        62        61        62        52        63        62 </span></span>
<span id="cb47-40"><a href="#cb47-40"></a><span class="co">#   ---</span></span>
<span id="cb47-41"><a href="#cb47-41"></a><span class="co"># VA99.TWN99 VA99.TZA99 VA99.USA99 VA99.VEN99 VA99.ZAF99 VA99.ZMB99 </span></span>
<span id="cb47-42"><a href="#cb47-42"></a><span class="co">#         63         52         65         63         52         52</span></span>
<span id="cb47-43"><a href="#cb47-43"></a></span>
<span id="cb47-44"><a href="#cb47-44"></a><span class="kw">gc</span>()</span>
<span id="cb47-45"><a href="#cb47-45"></a><span class="co">#            used  (Mb) gc trigger  (Mb) max used  (Mb)</span></span>
<span id="cb47-46"><a href="#cb47-46"></a><span class="co"># Ncells  1849039  98.8    3536118 188.9  3536118 188.9</span></span>
<span id="cb47-47"><a href="#cb47-47"></a><span class="co"># Vcells 19744242 150.7   28138280 214.7 22920896 174.9</span></span></code></pre></div>
</div>
<div id="selecting-subsetting-and-grouping" class="section level3">
<h3>3.1 Selecting, Subsetting and Grouping</h3>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="co">## Selecting columns</span></span>
<span id="cb48-2"><a href="#cb48-2"></a><span class="co"># Small</span></span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">select</span>(GGDC10S, Country, Variable, AGR<span class="op">:</span>SUM),</span>
<span id="cb48-4"><a href="#cb48-4"></a>               <span class="dt">collapse =</span> <span class="kw">fselect</span>(GGDC10S, Country, Variable, AGR<span class="op">:</span>SUM))</span>
<span id="cb48-5"><a href="#cb48-5"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb48-6"><a href="#cb48-6"></a><span class="co">#      expr      min       lq       mean   median       uq      max neval</span></span>
<span id="cb48-7"><a href="#cb48-7"></a><span class="co">#     dplyr 3484.298 3527.360 3656.58006 3605.230 3637.806 6765.999   100</span></span>
<span id="cb48-8"><a href="#cb48-8"></a><span class="co">#  collapse   12.495   17.404   28.01564   20.528   39.270   48.642   100</span></span>
<span id="cb48-9"><a href="#cb48-9"></a></span>
<span id="cb48-10"><a href="#cb48-10"></a><span class="co"># Large</span></span>
<span id="cb48-11"><a href="#cb48-11"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">select</span>(data, Country, Variable, AGR<span class="op">:</span>SUM),</span>
<span id="cb48-12"><a href="#cb48-12"></a>               <span class="dt">collapse =</span> <span class="kw">fselect</span>(data, Country, Variable, AGR<span class="op">:</span>SUM))</span>
<span id="cb48-13"><a href="#cb48-13"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb48-14"><a href="#cb48-14"></a><span class="co">#      expr      min        lq       mean   median       uq      max neval</span></span>
<span id="cb48-15"><a href="#cb48-15"></a><span class="co">#     dplyr 3495.007 3513.0800 3600.46001 3527.807 3569.307 6587.946   100</span></span>
<span id="cb48-16"><a href="#cb48-16"></a><span class="co">#  collapse   12.495   14.2805   25.25789   17.627   36.593   44.625   100</span></span>
<span id="cb48-17"><a href="#cb48-17"></a></span>
<span id="cb48-18"><a href="#cb48-18"></a><span class="co">## Subsetting columns </span></span>
<span id="cb48-19"><a href="#cb48-19"></a><span class="co"># Small</span></span>
<span id="cb48-20"><a href="#cb48-20"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">filter</span>(GGDC10S, Variable <span class="op">==</span><span class="st"> &quot;VA&quot;</span>),</span>
<span id="cb48-21"><a href="#cb48-21"></a>               <span class="dt">collapse =</span> <span class="kw">fsubset</span>(GGDC10S, Variable <span class="op">==</span><span class="st"> &quot;VA&quot;</span>))</span>
<span id="cb48-22"><a href="#cb48-22"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb48-23"><a href="#cb48-23"></a><span class="co">#      expr     min       lq      mean    median       uq      max neval</span></span>
<span id="cb48-24"><a href="#cb48-24"></a><span class="co">#     dplyr 813.063 955.4155 1301.3549 1131.4595 1343.873 3291.519   100</span></span>
<span id="cb48-25"><a href="#cb48-25"></a><span class="co">#  collapse 153.063 177.1605  284.1392  200.5885  332.454 1236.997   100</span></span>
<span id="cb48-26"><a href="#cb48-26"></a></span>
<span id="cb48-27"><a href="#cb48-27"></a><span class="co"># Large</span></span>
<span id="cb48-28"><a href="#cb48-28"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">filter</span>(data, Variable <span class="op">==</span><span class="st"> &quot;VA&quot;</span>),</span>
<span id="cb48-29"><a href="#cb48-29"></a>               <span class="dt">collapse =</span> <span class="kw">fsubset</span>(data, Variable <span class="op">==</span><span class="st"> &quot;VA&quot;</span>))</span>
<span id="cb48-30"><a href="#cb48-30"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb48-31"><a href="#cb48-31"></a><span class="co">#      expr      min        lq      mean    median        uq       max neval</span></span>
<span id="cb48-32"><a href="#cb48-32"></a><span class="co">#     dplyr 13.88230 14.187534 18.073788 15.496823 17.197024 162.43751   100</span></span>
<span id="cb48-33"><a href="#cb48-33"></a><span class="co">#  collapse  7.68616  7.793482  9.053992  7.964395  9.041635  24.29057   100</span></span>
<span id="cb48-34"><a href="#cb48-34"></a></span>
<span id="cb48-35"><a href="#cb48-35"></a><span class="co">## Grouping </span></span>
<span id="cb48-36"><a href="#cb48-36"></a><span class="co"># Small</span></span>
<span id="cb48-37"><a href="#cb48-37"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">group_by</span>(GGDC10S, Country, Variable),</span>
<span id="cb48-38"><a href="#cb48-38"></a>               <span class="dt">collapse =</span> <span class="kw">fgroup_by</span>(GGDC10S, Country, Variable))</span>
<span id="cb48-39"><a href="#cb48-39"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb48-40"><a href="#cb48-40"></a><span class="co">#      expr      min       lq      mean   median       uq      max neval</span></span>
<span id="cb48-41"><a href="#cb48-41"></a><span class="co">#     dplyr 1154.441 1189.026 1217.1971 1203.082 1224.056 1978.213   100</span></span>
<span id="cb48-42"><a href="#cb48-42"></a><span class="co">#  collapse  356.106  370.385  388.9939  391.805  399.838  438.661   100</span></span>
<span id="cb48-43"><a href="#cb48-43"></a></span>
<span id="cb48-44"><a href="#cb48-44"></a><span class="co"># Large</span></span>
<span id="cb48-45"><a href="#cb48-45"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">group_by</span>(data, Country, Variable),</span>
<span id="cb48-46"><a href="#cb48-46"></a>               <span class="dt">collapse =</span> <span class="kw">fgroup_by</span>(data, Country, Variable), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb48-47"><a href="#cb48-47"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb48-48"><a href="#cb48-48"></a><span class="co">#      expr       min        lq      mean   median        uq       max neval</span></span>
<span id="cb48-49"><a href="#cb48-49"></a><span class="co">#     dplyr 146.10933 146.57209 151.04049 148.4976 152.87845 164.92355    10</span></span>
<span id="cb48-50"><a href="#cb48-50"></a><span class="co">#  collapse  66.93483  67.04595  67.36586  67.1767  67.74343  68.24948    10</span></span>
<span id="cb48-51"><a href="#cb48-51"></a></span>
<span id="cb48-52"><a href="#cb48-52"></a><span class="co">## Computing a new column </span></span>
<span id="cb48-53"><a href="#cb48-53"></a><span class="co"># Small</span></span>
<span id="cb48-54"><a href="#cb48-54"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">mutate</span>(GGDC10S, <span class="dt">NEW =</span> AGR<span class="op">+</span><span class="dv">1</span>),</span>
<span id="cb48-55"><a href="#cb48-55"></a>               <span class="dt">collapse =</span> <span class="kw">ftransform</span>(GGDC10S, <span class="dt">NEW =</span> AGR<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb48-56"><a href="#cb48-56"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb48-57"><a href="#cb48-57"></a><span class="co">#      expr     min       lq      mean   median      uq      max neval</span></span>
<span id="cb48-58"><a href="#cb48-58"></a><span class="co">#     dplyr 535.943 542.4135 570.98235 545.3145 550.223 2844.826   100</span></span>
<span id="cb48-59"><a href="#cb48-59"></a><span class="co">#  collapse  22.312  27.2210  33.84809  38.1540  39.270   54.443   100</span></span>
<span id="cb48-60"><a href="#cb48-60"></a></span>
<span id="cb48-61"><a href="#cb48-61"></a><span class="co"># Large</span></span>
<span id="cb48-62"><a href="#cb48-62"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">mutate</span>(data, <span class="dt">NEW =</span> AGR<span class="op">+</span><span class="dv">1</span>),</span>
<span id="cb48-63"><a href="#cb48-63"></a>               <span class="dt">collapse =</span> <span class="kw">ftransform</span>(data, <span class="dt">NEW =</span> AGR<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb48-64"><a href="#cb48-64"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb48-65"><a href="#cb48-65"></a><span class="co">#      expr      min       lq     mean   median       uq      max neval</span></span>
<span id="cb48-66"><a href="#cb48-66"></a><span class="co">#     dplyr 4.308070 4.394195 5.573354 4.427663 4.652572 18.20420   100</span></span>
<span id="cb48-67"><a href="#cb48-67"></a><span class="co">#  collapse 3.540525 3.641822 4.643973 3.675515 3.701620 17.23005   100</span></span>
<span id="cb48-68"><a href="#cb48-68"></a></span>
<span id="cb48-69"><a href="#cb48-69"></a><span class="co">## All combined with pipes </span></span>
<span id="cb48-70"><a href="#cb48-70"></a><span class="co"># Small</span></span>
<span id="cb48-71"><a href="#cb48-71"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">filter</span>(GGDC10S, Variable <span class="op">==</span><span class="st"> &quot;VA&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-72"><a href="#cb48-72"></a><span class="st">                       </span><span class="kw">select</span>(Country, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-73"><a href="#cb48-73"></a><span class="st">                       </span><span class="kw">mutate</span>(<span class="dt">NEW =</span> AGR<span class="op">+</span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb48-74"><a href="#cb48-74"></a><span class="st">                       </span><span class="kw">group_by</span>(Country),</span>
<span id="cb48-75"><a href="#cb48-75"></a>               <span class="dt">collapse =</span> <span class="kw">fsubset</span>(GGDC10S, Variable <span class="op">==</span><span class="st"> &quot;VA&quot;</span>, Country, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-76"><a href="#cb48-76"></a><span class="st">                       </span><span class="kw">ftransform</span>(<span class="dt">NEW =</span> AGR<span class="op">+</span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb48-77"><a href="#cb48-77"></a><span class="st">                       </span><span class="kw">fgroup_by</span>(Country))</span>
<span id="cb48-78"><a href="#cb48-78"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb48-79"><a href="#cb48-79"></a><span class="co">#      expr      min       lq      mean    median       uq       max neval</span></span>
<span id="cb48-80"><a href="#cb48-80"></a><span class="co">#     dplyr 5472.775 5594.154 6018.0081 5727.8045 6248.352 10536.340   100</span></span>
<span id="cb48-81"><a href="#cb48-81"></a><span class="co">#  collapse  445.801  521.440  596.2444  567.1805  631.440  1087.951   100</span></span>
<span id="cb48-82"><a href="#cb48-82"></a></span>
<span id="cb48-83"><a href="#cb48-83"></a><span class="co"># Large</span></span>
<span id="cb48-84"><a href="#cb48-84"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">filter</span>(data, Variable <span class="op">==</span><span class="st"> &quot;VA&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-85"><a href="#cb48-85"></a><span class="st">                       </span><span class="kw">select</span>(Country, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-86"><a href="#cb48-86"></a><span class="st">                       </span><span class="kw">mutate</span>(<span class="dt">NEW =</span> AGR<span class="op">+</span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb48-87"><a href="#cb48-87"></a><span class="st">                       </span><span class="kw">group_by</span>(Country),</span>
<span id="cb48-88"><a href="#cb48-88"></a>               <span class="dt">collapse =</span> <span class="kw">fsubset</span>(data, Variable <span class="op">==</span><span class="st"> &quot;VA&quot;</span>, Country, AGR<span class="op">:</span>SUM) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb48-89"><a href="#cb48-89"></a><span class="st">                       </span><span class="kw">ftransform</span>(<span class="dt">NEW =</span> AGR<span class="op">+</span><span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb48-90"><a href="#cb48-90"></a><span class="st">                       </span><span class="kw">fgroup_by</span>(Country), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb48-91"><a href="#cb48-91"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb48-92"><a href="#cb48-92"></a><span class="co">#      expr       min       lq      mean    median        uq       max neval</span></span>
<span id="cb48-93"><a href="#cb48-93"></a><span class="co">#     dplyr 18.162257 18.37869 19.919935 18.585300 18.837875 28.691902    10</span></span>
<span id="cb48-94"><a href="#cb48-94"></a><span class="co">#  collapse  7.980683  8.02263  8.273377  8.088898  8.140886  9.225713    10</span></span>
<span id="cb48-95"><a href="#cb48-95"></a></span>
<span id="cb48-96"><a href="#cb48-96"></a><span class="kw">gc</span>()</span>
<span id="cb48-97"><a href="#cb48-97"></a><span class="co">#            used  (Mb) gc trigger  (Mb) max used  (Mb)</span></span>
<span id="cb48-98"><a href="#cb48-98"></a><span class="co"># Ncells  1849541  98.8    3536118 188.9  3536118 188.9</span></span>
<span id="cb48-99"><a href="#cb48-99"></a><span class="co"># Vcells 20834241 159.0   33845936 258.3 33843751 258.3</span></span></code></pre></div>
</div>
<div id="aggregation" class="section level3">
<h3>3.1 Aggregation</h3>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="co">## Grouping the data</span></span>
<span id="cb49-2"><a href="#cb49-2"></a>cgGGDC10S &lt;-<span class="st"> </span><span class="kw">fgroup_by</span>(GGDC10S, Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fselect</span>(<span class="op">-</span>Region, <span class="op">-</span>Regioncode)</span>
<span id="cb49-3"><a href="#cb49-3"></a>gGGDC10S &lt;-<span class="st"> </span><span class="kw">group_by</span>(GGDC10S, Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fselect</span>(<span class="op">-</span>Region, <span class="op">-</span>Regioncode)</span>
<span id="cb49-4"><a href="#cb49-4"></a>cgdata &lt;-<span class="st"> </span><span class="kw">fgroup_by</span>(data, Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fselect</span>(<span class="op">-</span>Region, <span class="op">-</span>Regioncode)</span>
<span id="cb49-5"><a href="#cb49-5"></a>gdata &lt;-<span class="st"> </span><span class="kw">group_by</span>(data, Variable, Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fselect</span>(<span class="op">-</span>Region, <span class="op">-</span>Regioncode)</span>
<span id="cb49-6"><a href="#cb49-6"></a><span class="kw">rm</span>(data, GGDC10S) </span>
<span id="cb49-7"><a href="#cb49-7"></a><span class="kw">gc</span>()</span>
<span id="cb49-8"><a href="#cb49-8"></a><span class="co">#            used  (Mb) gc trigger  (Mb) max used  (Mb)</span></span>
<span id="cb49-9"><a href="#cb49-9"></a><span class="co"># Ncells  1866672  99.7    3536118 188.9  3536118 188.9</span></span>
<span id="cb49-10"><a href="#cb49-10"></a><span class="co"># Vcells 19935919 152.1   33845936 258.3 33843751 258.3</span></span>
<span id="cb49-11"><a href="#cb49-11"></a></span>
<span id="cb49-12"><a href="#cb49-12"></a><span class="co">## Conversion of Grouping object: This time would be required extra in all hybrid calls </span></span>
<span id="cb49-13"><a href="#cb49-13"></a><span class="co">## i.e. when calling collapse functions on data grouped with dplyr::group_by</span></span>
<span id="cb49-14"><a href="#cb49-14"></a><span class="co"># Small</span></span>
<span id="cb49-15"><a href="#cb49-15"></a><span class="kw">microbenchmark</span>(<span class="kw">GRP</span>(gGGDC10S))</span>
<span id="cb49-16"><a href="#cb49-16"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb49-17"><a href="#cb49-17"></a><span class="co">#           expr    min     lq     mean median     uq    max neval</span></span>
<span id="cb49-18"><a href="#cb49-18"></a><span class="co">#  GRP(gGGDC10S) 29.452 30.345 31.50531 30.791 31.238 90.588   100</span></span>
<span id="cb49-19"><a href="#cb49-19"></a></span>
<span id="cb49-20"><a href="#cb49-20"></a><span class="co"># Large</span></span>
<span id="cb49-21"><a href="#cb49-21"></a><span class="kw">microbenchmark</span>(<span class="kw">GRP</span>(gdata))</span>
<span id="cb49-22"><a href="#cb49-22"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb49-23"><a href="#cb49-23"></a><span class="co">#        expr      min       lq     mean   median       uq      max neval</span></span>
<span id="cb49-24"><a href="#cb49-24"></a><span class="co">#  GRP(gdata) 4.159916 4.241355 4.817822 4.301376 4.394196 22.47256   100</span></span>
<span id="cb49-25"><a href="#cb49-25"></a></span>
<span id="cb49-26"><a href="#cb49-26"></a></span>
<span id="cb49-27"><a href="#cb49-27"></a><span class="co">## Sum </span></span>
<span id="cb49-28"><a href="#cb49-28"></a><span class="co"># Small</span></span>
<span id="cb49-29"><a href="#cb49-29"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">summarise_all</span>(gGGDC10S, sum, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb49-30"><a href="#cb49-30"></a>               <span class="dt">collapse =</span> <span class="kw">fsum</span>(cgGGDC10S))</span>
<span id="cb49-31"><a href="#cb49-31"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb49-32"><a href="#cb49-32"></a><span class="co">#      expr      min       lq      mean   median       uq      max neval</span></span>
<span id="cb49-33"><a href="#cb49-33"></a><span class="co">#     dplyr 1382.027 1391.845 1405.1610 1398.093 1407.240 1612.738   100</span></span>
<span id="cb49-34"><a href="#cb49-34"></a><span class="co">#  collapse  237.850  244.098  261.4074  250.568  275.335  327.992   100</span></span>
<span id="cb49-35"><a href="#cb49-35"></a></span>
<span id="cb49-36"><a href="#cb49-36"></a><span class="co"># Large</span></span>
<span id="cb49-37"><a href="#cb49-37"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">summarise_all</span>(gdata, sum, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb49-38"><a href="#cb49-38"></a>               <span class="dt">collapse =</span> <span class="kw">fsum</span>(cgdata), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb49-39"><a href="#cb49-39"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb49-40"><a href="#cb49-40"></a><span class="co">#      expr      min       lq     mean   median       uq      max neval</span></span>
<span id="cb49-41"><a href="#cb49-41"></a><span class="co">#     dplyr 90.80548 93.32588 93.27738 93.72728 93.78061 95.12828    10</span></span>
<span id="cb49-42"><a href="#cb49-42"></a><span class="co">#  collapse 39.78873 40.41883 40.52941 40.69037 40.75530 40.93201    10</span></span>
<span id="cb49-43"><a href="#cb49-43"></a></span>
<span id="cb49-44"><a href="#cb49-44"></a><span class="co">## Mean</span></span>
<span id="cb49-45"><a href="#cb49-45"></a><span class="co"># Small</span></span>
<span id="cb49-46"><a href="#cb49-46"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">summarise_all</span>(gGGDC10S, mean.default, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb49-47"><a href="#cb49-47"></a>               <span class="dt">collapse =</span> <span class="kw">fmean</span>(cgGGDC10S))</span>
<span id="cb49-48"><a href="#cb49-48"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb49-49"><a href="#cb49-49"></a><span class="co">#      expr      min       lq      mean   median        uq       max neval</span></span>
<span id="cb49-50"><a href="#cb49-50"></a><span class="co">#     dplyr 5952.937 6059.367 7022.5951 6133.220 6790.5420 28032.795   100</span></span>
<span id="cb49-51"><a href="#cb49-51"></a><span class="co">#  collapse  253.022  268.641  306.6657  323.083  330.2235   373.062   100</span></span>
<span id="cb49-52"><a href="#cb49-52"></a></span>
<span id="cb49-53"><a href="#cb49-53"></a><span class="co"># Large</span></span>
<span id="cb49-54"><a href="#cb49-54"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">summarise_all</span>(gdata, mean.default, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb49-55"><a href="#cb49-55"></a>               <span class="dt">collapse =</span> <span class="kw">fmean</span>(cgdata), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb49-56"><a href="#cb49-56"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb49-57"><a href="#cb49-57"></a><span class="co">#      expr       min         lq       mean     median         uq        max neval</span></span>
<span id="cb49-58"><a href="#cb49-58"></a><span class="co">#     dplyr 1069.6810 1072.22822 1088.73342 1088.79157 1102.81087 1108.67054    10</span></span>
<span id="cb49-59"><a href="#cb49-59"></a><span class="co">#  collapse   42.6822   42.72861   43.00456   42.91982   43.40556   43.46625    10</span></span>
<span id="cb49-60"><a href="#cb49-60"></a></span>
<span id="cb49-61"><a href="#cb49-61"></a><span class="co">## Median</span></span>
<span id="cb49-62"><a href="#cb49-62"></a><span class="co"># Small</span></span>
<span id="cb49-63"><a href="#cb49-63"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">summarise_all</span>(gGGDC10S, median, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb49-64"><a href="#cb49-64"></a>               <span class="dt">collapse =</span> <span class="kw">fmedian</span>(cgGGDC10S))</span>
<span id="cb49-65"><a href="#cb49-65"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb49-66"><a href="#cb49-66"></a><span class="co">#      expr       min         lq       mean    median         uq       max neval</span></span>
<span id="cb49-67"><a href="#cb49-67"></a><span class="co">#     dplyr 43426.982 44598.8265 48298.2816 45616.493 50668.9025 74759.774   100</span></span>
<span id="cb49-68"><a href="#cb49-68"></a><span class="co">#  collapse   494.442   517.6465   565.8058   568.296   583.0215  1006.287   100</span></span>
<span id="cb49-69"><a href="#cb49-69"></a></span>
<span id="cb49-70"><a href="#cb49-70"></a><span class="co"># Large</span></span>
<span id="cb49-71"><a href="#cb49-71"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">summarise_all</span>(gdata, median, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb49-72"><a href="#cb49-72"></a>               <span class="dt">collapse =</span> <span class="kw">fmedian</span>(cgdata), <span class="dt">times =</span> <span class="dv">2</span>)</span>
<span id="cb49-73"><a href="#cb49-73"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb49-74"><a href="#cb49-74"></a><span class="co">#      expr        min         lq       mean     median        uq       max neval</span></span>
<span id="cb49-75"><a href="#cb49-75"></a><span class="co">#     dplyr 9057.25573 9057.25573 9133.36719 9133.36719 9209.4786 9209.4786     2</span></span>
<span id="cb49-76"><a href="#cb49-76"></a><span class="co">#  collapse   87.92272   87.92272   94.27527   94.27527  100.6278  100.6278     2</span></span>
<span id="cb49-77"><a href="#cb49-77"></a></span>
<span id="cb49-78"><a href="#cb49-78"></a><span class="co">## Standard Deviation</span></span>
<span id="cb49-79"><a href="#cb49-79"></a><span class="co"># Small</span></span>
<span id="cb49-80"><a href="#cb49-80"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">summarise_all</span>(gGGDC10S, sd, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb49-81"><a href="#cb49-81"></a>               <span class="dt">collapse =</span> <span class="kw">fsd</span>(cgGGDC10S))</span>
<span id="cb49-82"><a href="#cb49-82"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb49-83"><a href="#cb49-83"></a><span class="co">#      expr       min        lq       mean    median        uq       max neval</span></span>
<span id="cb49-84"><a href="#cb49-84"></a><span class="co">#     dplyr 18201.972 18510.552 19660.2991 18953.675 19456.596 33023.177   100</span></span>
<span id="cb49-85"><a href="#cb49-85"></a><span class="co">#  collapse   426.166   456.065   495.3702   506.937   525.456   592.616   100</span></span>
<span id="cb49-86"><a href="#cb49-86"></a></span>
<span id="cb49-87"><a href="#cb49-87"></a><span class="co"># Large</span></span>
<span id="cb49-88"><a href="#cb49-88"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">summarise_all</span>(gdata, sd, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb49-89"><a href="#cb49-89"></a>               <span class="dt">collapse =</span> <span class="kw">fsd</span>(cgdata), <span class="dt">times =</span> <span class="dv">2</span>)</span>
<span id="cb49-90"><a href="#cb49-90"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb49-91"><a href="#cb49-91"></a><span class="co">#      expr        min         lq       mean     median         uq        max neval</span></span>
<span id="cb49-92"><a href="#cb49-92"></a><span class="co">#     dplyr 3593.06014 3593.06014 3694.16992 3694.16992 3795.27969 3795.27969     2</span></span>
<span id="cb49-93"><a href="#cb49-93"></a><span class="co">#  collapse   76.76565   76.76565   76.81229   76.81229   76.85892   76.85892     2</span></span>
<span id="cb49-94"><a href="#cb49-94"></a></span>
<span id="cb49-95"><a href="#cb49-95"></a><span class="co">## Maximum</span></span>
<span id="cb49-96"><a href="#cb49-96"></a><span class="co"># Small</span></span>
<span id="cb49-97"><a href="#cb49-97"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">summarise_all</span>(gGGDC10S, max, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb49-98"><a href="#cb49-98"></a>               <span class="dt">collapse =</span> <span class="kw">fmax</span>(cgGGDC10S))</span>
<span id="cb49-99"><a href="#cb49-99"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb49-100"><a href="#cb49-100"></a><span class="co">#      expr      min       lq     mean   median       uq      max neval</span></span>
<span id="cb49-101"><a href="#cb49-101"></a><span class="co">#     dplyr 1217.362 1230.526 1247.408 1236.105 1244.584 1591.317   100</span></span>
<span id="cb49-102"><a href="#cb49-102"></a><span class="co">#  collapse  176.714  187.201  204.194  204.159  209.067  590.832   100</span></span>
<span id="cb49-103"><a href="#cb49-103"></a></span>
<span id="cb49-104"><a href="#cb49-104"></a><span class="co"># Large</span></span>
<span id="cb49-105"><a href="#cb49-105"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">summarise_all</span>(gdata, max, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb49-106"><a href="#cb49-106"></a>               <span class="dt">collapse =</span> <span class="kw">fmax</span>(cgdata), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb49-107"><a href="#cb49-107"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb49-108"><a href="#cb49-108"></a><span class="co">#      expr      min       lq     mean   median       uq      max neval</span></span>
<span id="cb49-109"><a href="#cb49-109"></a><span class="co">#     dplyr 58.64490 58.89167 60.50664 59.32030 61.59236 66.00485    10</span></span>
<span id="cb49-110"><a href="#cb49-110"></a><span class="co">#  collapse 23.70107 23.75061 24.04567 24.09556 24.13795 24.83767    10</span></span>
<span id="cb49-111"><a href="#cb49-111"></a></span>
<span id="cb49-112"><a href="#cb49-112"></a><span class="co">## First Value</span></span>
<span id="cb49-113"><a href="#cb49-113"></a><span class="co"># Small</span></span>
<span id="cb49-114"><a href="#cb49-114"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">summarise_all</span>(gGGDC10S, first),</span>
<span id="cb49-115"><a href="#cb49-115"></a>               <span class="dt">collapse =</span> <span class="kw">ffirst</span>(cgGGDC10S, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>))</span>
<span id="cb49-116"><a href="#cb49-116"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb49-117"><a href="#cb49-117"></a><span class="co">#      expr     min       lq      mean   median      uq      max neval</span></span>
<span id="cb49-118"><a href="#cb49-118"></a><span class="co">#     dplyr 664.462 672.7175 720.66694 681.4195 758.398 1147.301   100</span></span>
<span id="cb49-119"><a href="#cb49-119"></a><span class="co">#  collapse  58.012  66.9375  80.34256  83.4485  93.712  175.822   100</span></span>
<span id="cb49-120"><a href="#cb49-120"></a></span>
<span id="cb49-121"><a href="#cb49-121"></a><span class="co"># Large</span></span>
<span id="cb49-122"><a href="#cb49-122"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">summarise_all</span>(gdata, first),</span>
<span id="cb49-123"><a href="#cb49-123"></a>               <span class="dt">collapse =</span> <span class="kw">ffirst</span>(cgdata, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb49-124"><a href="#cb49-124"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb49-125"><a href="#cb49-125"></a><span class="co">#      expr      min        lq      mean    median        uq       max neval</span></span>
<span id="cb49-126"><a href="#cb49-126"></a><span class="co">#     dplyr 14.33479 14.461529 15.117245 14.853112 15.841771 15.980555    10</span></span>
<span id="cb49-127"><a href="#cb49-127"></a><span class="co">#  collapse  4.36028  4.372776  4.425254  4.414276  4.429002  4.606609    10</span></span>
<span id="cb49-128"><a href="#cb49-128"></a></span>
<span id="cb49-129"><a href="#cb49-129"></a><span class="co">## Number of Distinct Values</span></span>
<span id="cb49-130"><a href="#cb49-130"></a><span class="co"># Small</span></span>
<span id="cb49-131"><a href="#cb49-131"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">summarise_all</span>(gGGDC10S, n_distinct, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb49-132"><a href="#cb49-132"></a>               <span class="dt">collapse =</span> <span class="kw">fNdistinct</span>(cgGGDC10S))</span>
<span id="cb49-133"><a href="#cb49-133"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb49-134"><a href="#cb49-134"></a><span class="co">#      expr       min        lq      mean    median        uq       max neval</span></span>
<span id="cb49-135"><a href="#cb49-135"></a><span class="co">#     dplyr 13.666317 14.010150 14.939442 14.300657 15.740474 26.882817   100</span></span>
<span id="cb49-136"><a href="#cb49-136"></a><span class="co">#  collapse  1.322676  1.371094  1.439517  1.421074  1.458112  1.878254   100</span></span>
<span id="cb49-137"><a href="#cb49-137"></a></span>
<span id="cb49-138"><a href="#cb49-138"></a><span class="co"># Large</span></span>
<span id="cb49-139"><a href="#cb49-139"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">summarise_all</span>(gdata, n_distinct, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb49-140"><a href="#cb49-140"></a>               <span class="dt">collapse =</span> <span class="kw">fNdistinct</span>(cgdata), <span class="dt">times =</span> <span class="dv">5</span>)</span>
<span id="cb49-141"><a href="#cb49-141"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb49-142"><a href="#cb49-142"></a><span class="co">#      expr       min        lq      mean    median        uq       max neval</span></span>
<span id="cb49-143"><a href="#cb49-143"></a><span class="co">#     dplyr 2494.7666 2526.5961 2553.5629 2530.2290 2534.2796 2681.9432     5</span></span>
<span id="cb49-144"><a href="#cb49-144"></a><span class="co">#  collapse  299.7027  301.5952  312.0312  308.6196  318.2482  331.9904     5</span></span>
<span id="cb49-145"><a href="#cb49-145"></a></span>
<span id="cb49-146"><a href="#cb49-146"></a><span class="kw">gc</span>()</span>
<span id="cb49-147"><a href="#cb49-147"></a><span class="co">#            used  (Mb) gc trigger  (Mb) max used  (Mb)</span></span>
<span id="cb49-148"><a href="#cb49-148"></a><span class="co"># Ncells  1868723  99.9    3536118 188.9  3536118 188.9</span></span>
<span id="cb49-149"><a href="#cb49-149"></a><span class="co"># Vcells 19940588 152.2   33845936 258.3 33845936 258.3</span></span></code></pre></div>
<!-- The benchmarks show that at this data size efficient primitives like `base::sum` or `base::max` can still deliver very decent performance with `summarize`. Less optimized base functions like `mean`, `median` and `sd` however take multiple seconds to compute, and here `collapse` fast functions really prove to be very useful complements to the *dplyr* system. -->
<!-- Weighted statistics are also performed extremely fast by *collapse* functions. I would not know how to compute weighted statistics by groups in *dplyr*, as it would require the weighting variable to be split as well, which seems impossible in native *dplyr*. -->
<!-- A further highlight of *collapse* is the extremely fast statistical mode function, which can also compute a weighted mode. Fast categorical aggregation has been an issue in R, and defining a mode function from base R and applying it to 17000 groups will probably let it run at least a minute. `fmode` reduces this time to half a second. -->
<!-- Thus in terms of data aggregation *collapse* fast functions are able to speed up *dplyr* to a level that makes it attractive again to R users working on medium-sized or larger data, and everyone programming with *dplyr*. I however strongly recommend *collapse* itself for easy and speedy programming as it does not rely on non-standard evaluation and has less R-overhead than *dplyr*. -->
<!-- In all of this the grouping system of *dplyr* remains the central bottleneck. For example grouping 10 million observations in 1 million groups takes around 10 second with `group_by`, whereas `GRP` takes around 1.5 seconds, and this difference grows exponentially as data get larger. Rewriting `group_by` using `GRP` / `radixorderv` and then writing a simple C++ conversion program for the grouping object could be a quick remedy for this issue, but that is at the discretion of Hadley Wickham and coauthors. -->
<!-- (If you need that speed program with *collapse* or use *data.table* with GeForce optimized functions). -->
<p>Below are some additional benchmarks for weighted aggregations and aggregations using the statistical mode, which cannot easily or efficiently be performed with <em>dplyr</em>.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="co">## Weighted Mean</span></span>
<span id="cb50-2"><a href="#cb50-2"></a><span class="co"># Small</span></span>
<span id="cb50-3"><a href="#cb50-3"></a><span class="kw">microbenchmark</span>(<span class="kw">fmean</span>(cgGGDC10S, SUM)) </span>
<span id="cb50-4"><a href="#cb50-4"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb50-5"><a href="#cb50-5"></a><span class="co">#                   expr     min      lq     mean   median       uq    max neval</span></span>
<span id="cb50-6"><a href="#cb50-6"></a><span class="co">#  fmean(cgGGDC10S, SUM) 278.458 280.243 288.1821 281.5825 295.6395 393.59   100</span></span>
<span id="cb50-7"><a href="#cb50-7"></a></span>
<span id="cb50-8"><a href="#cb50-8"></a><span class="co"># Large </span></span>
<span id="cb50-9"><a href="#cb50-9"></a><span class="kw">microbenchmark</span>(<span class="kw">fmean</span>(cgdata, SUM), <span class="dt">times =</span> <span class="dv">10</span>) </span>
<span id="cb50-10"><a href="#cb50-10"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb50-11"><a href="#cb50-11"></a><span class="co">#                expr      min      lq     mean  median       uq      max neval</span></span>
<span id="cb50-12"><a href="#cb50-12"></a><span class="co">#  fmean(cgdata, SUM) 47.61189 47.7712 49.68274 48.5557 51.26219 53.66389    10</span></span>
<span id="cb50-13"><a href="#cb50-13"></a></span>
<span id="cb50-14"><a href="#cb50-14"></a><span class="co">## Weighted Standard-Deviation</span></span>
<span id="cb50-15"><a href="#cb50-15"></a><span class="co"># Small</span></span>
<span id="cb50-16"><a href="#cb50-16"></a><span class="kw">microbenchmark</span>(<span class="kw">fsd</span>(cgGGDC10S, SUM)) </span>
<span id="cb50-17"><a href="#cb50-17"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb50-18"><a href="#cb50-18"></a><span class="co">#                 expr     min      lq     mean median      uq     max neval</span></span>
<span id="cb50-19"><a href="#cb50-19"></a><span class="co">#  fsd(cgGGDC10S, SUM) 427.951 430.852 439.2681 432.86 448.032 546.653   100</span></span>
<span id="cb50-20"><a href="#cb50-20"></a></span>
<span id="cb50-21"><a href="#cb50-21"></a><span class="co"># Large </span></span>
<span id="cb50-22"><a href="#cb50-22"></a><span class="kw">microbenchmark</span>(<span class="kw">fsd</span>(cgdata, SUM), <span class="dt">times =</span> <span class="dv">10</span>) </span>
<span id="cb50-23"><a href="#cb50-23"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb50-24"><a href="#cb50-24"></a><span class="co">#              expr      min       lq     mean   median       uq      max neval</span></span>
<span id="cb50-25"><a href="#cb50-25"></a><span class="co">#  fsd(cgdata, SUM) 77.00306 77.16683 77.29374 77.26768 77.43949 77.62289    10</span></span>
<span id="cb50-26"><a href="#cb50-26"></a></span>
<span id="cb50-27"><a href="#cb50-27"></a><span class="co">## Statistical Mode</span></span>
<span id="cb50-28"><a href="#cb50-28"></a><span class="co"># Small</span></span>
<span id="cb50-29"><a href="#cb50-29"></a><span class="kw">microbenchmark</span>(<span class="kw">fmode</span>(cgGGDC10S)) </span>
<span id="cb50-30"><a href="#cb50-30"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb50-31"><a href="#cb50-31"></a><span class="co">#              expr      min       lq     mean   median       uq     max neval</span></span>
<span id="cb50-32"><a href="#cb50-32"></a><span class="co">#  fmode(cgGGDC10S) 1.549817 1.572352 1.601791 1.608275 1.619877 1.79079   100</span></span>
<span id="cb50-33"><a href="#cb50-33"></a></span>
<span id="cb50-34"><a href="#cb50-34"></a><span class="co"># Large </span></span>
<span id="cb50-35"><a href="#cb50-35"></a><span class="kw">microbenchmark</span>(<span class="kw">fmode</span>(cgdata), <span class="dt">times =</span> <span class="dv">10</span>) </span>
<span id="cb50-36"><a href="#cb50-36"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb50-37"><a href="#cb50-37"></a><span class="co">#           expr      min      lq     mean   median       uq      max neval</span></span>
<span id="cb50-38"><a href="#cb50-38"></a><span class="co">#  fmode(cgdata) 378.4514 382.075 395.8943 396.3004 404.9652 423.0217    10</span></span>
<span id="cb50-39"><a href="#cb50-39"></a></span>
<span id="cb50-40"><a href="#cb50-40"></a><span class="co">## Weighted Statistical Mode</span></span>
<span id="cb50-41"><a href="#cb50-41"></a><span class="co"># Small</span></span>
<span id="cb50-42"><a href="#cb50-42"></a><span class="kw">microbenchmark</span>(<span class="kw">fmode</span>(cgGGDC10S, SUM)) </span>
<span id="cb50-43"><a href="#cb50-43"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb50-44"><a href="#cb50-44"></a><span class="co">#                   expr     min      lq     mean   median      uq      max neval</span></span>
<span id="cb50-45"><a href="#cb50-45"></a><span class="co">#  fmode(cgGGDC10S, SUM) 1.83943 1.85505 1.883979 1.864644 1.90079 2.303081   100</span></span>
<span id="cb50-46"><a href="#cb50-46"></a></span>
<span id="cb50-47"><a href="#cb50-47"></a><span class="co"># Large </span></span>
<span id="cb50-48"><a href="#cb50-48"></a><span class="kw">microbenchmark</span>(<span class="kw">fmode</span>(cgdata, SUM), <span class="dt">times =</span> <span class="dv">10</span>) </span>
<span id="cb50-49"><a href="#cb50-49"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb50-50"><a href="#cb50-50"></a><span class="co">#                expr      min       lq    mean   median       uq      max neval</span></span>
<span id="cb50-51"><a href="#cb50-51"></a><span class="co">#  fmode(cgdata, SUM) 446.6157 456.0266 481.108 476.2327 514.0155 521.9574    10</span></span>
<span id="cb50-52"><a href="#cb50-52"></a></span>
<span id="cb50-53"><a href="#cb50-53"></a><span class="kw">gc</span>()</span>
<span id="cb50-54"><a href="#cb50-54"></a><span class="co">#            used  (Mb) gc trigger  (Mb) max used  (Mb)</span></span>
<span id="cb50-55"><a href="#cb50-55"></a><span class="co"># Ncells  1868044  99.8    3536118 188.9  3536118 188.9</span></span>
<span id="cb50-56"><a href="#cb50-56"></a><span class="co"># Vcells 19936972 152.2   33845936 258.3 33845936 258.3</span></span></code></pre></div>
</div>
<div id="transformation" class="section level3">
<h3>3.2 Transformation</h3>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a></span>
<span id="cb51-2"><a href="#cb51-2"></a><span class="co">## Replacing with group sum</span></span>
<span id="cb51-3"><a href="#cb51-3"></a><span class="co"># Small</span></span>
<span id="cb51-4"><a href="#cb51-4"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">mutate_all</span>(gGGDC10S, sum, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb51-5"><a href="#cb51-5"></a>               <span class="dt">collapse =</span> <span class="kw">fsum</span>(cgGGDC10S, <span class="dt">TRA =</span> <span class="st">&quot;replace_fill&quot;</span>))</span>
<span id="cb51-6"><a href="#cb51-6"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb51-7"><a href="#cb51-7"></a><span class="co">#      expr      min        lq      mean    median       uq      max neval</span></span>
<span id="cb51-8"><a href="#cb51-8"></a><span class="co">#     dplyr 2659.186 2743.5275 2901.6684 2801.7625 2892.128 9098.532   100</span></span>
<span id="cb51-9"><a href="#cb51-9"></a><span class="co">#  collapse  303.002  321.5215  346.2702  352.0895  359.452  437.769   100</span></span>
<span id="cb51-10"><a href="#cb51-10"></a></span>
<span id="cb51-11"><a href="#cb51-11"></a><span class="co"># Large</span></span>
<span id="cb51-12"><a href="#cb51-12"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">mutate_all</span>(gdata, sum, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb51-13"><a href="#cb51-13"></a>               <span class="dt">collapse =</span> <span class="kw">fsum</span>(cgdata, <span class="dt">TRA =</span> <span class="st">&quot;replace_fill&quot;</span>), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb51-14"><a href="#cb51-14"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb51-15"><a href="#cb51-15"></a><span class="co">#      expr       min        lq     mean    median       uq      max neval</span></span>
<span id="cb51-16"><a href="#cb51-16"></a><span class="co">#     dplyr 261.12327 264.31661 302.4534 271.25352 306.2210 437.6698    10</span></span>
<span id="cb51-17"><a href="#cb51-17"></a><span class="co">#  collapse  79.69393  91.43737 106.7055  95.94937 105.2094 216.6034    10</span></span>
<span id="cb51-18"><a href="#cb51-18"></a></span>
<span id="cb51-19"><a href="#cb51-19"></a><span class="co">## Dividing by group sum</span></span>
<span id="cb51-20"><a href="#cb51-20"></a><span class="co"># Small</span></span>
<span id="cb51-21"><a href="#cb51-21"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">mutate_all</span>(gGGDC10S, <span class="cf">function</span>(x) x<span class="op">/</span><span class="kw">sum</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)),</span>
<span id="cb51-22"><a href="#cb51-22"></a>               <span class="dt">collapse =</span> <span class="kw">fsum</span>(cgGGDC10S, <span class="dt">TRA =</span> <span class="st">&quot;/&quot;</span>))</span>
<span id="cb51-23"><a href="#cb51-23"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb51-24"><a href="#cb51-24"></a><span class="co">#      expr      min       lq      mean   median       uq       max neval</span></span>
<span id="cb51-25"><a href="#cb51-25"></a><span class="co">#     dplyr 5665.107 5767.075 6204.4412 5847.845 6411.232 18948.990   100</span></span>
<span id="cb51-26"><a href="#cb51-26"></a><span class="co">#  collapse  549.776  569.635  633.4568  619.168  682.089   808.154   100</span></span>
<span id="cb51-27"><a href="#cb51-27"></a></span>
<span id="cb51-28"><a href="#cb51-28"></a><span class="co"># Large</span></span>
<span id="cb51-29"><a href="#cb51-29"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">mutate_all</span>(gdata, <span class="cf">function</span>(x) x<span class="op">/</span><span class="kw">sum</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)),</span>
<span id="cb51-30"><a href="#cb51-30"></a>               <span class="dt">collapse =</span> <span class="kw">fsum</span>(cgdata, <span class="dt">TRA =</span> <span class="st">&quot;/&quot;</span>), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb51-31"><a href="#cb51-31"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb51-32"><a href="#cb51-32"></a><span class="co">#      expr      min       lq     mean   median        uq       max neval</span></span>
<span id="cb51-33"><a href="#cb51-33"></a><span class="co">#     dplyr 916.6995 919.6844 964.5582 928.6275 1049.7615 1077.3806    10</span></span>
<span id="cb51-34"><a href="#cb51-34"></a><span class="co">#  collapse 131.4492 138.6784 157.8198 148.3504  156.2249  269.6145    10</span></span>
<span id="cb51-35"><a href="#cb51-35"></a></span>
<span id="cb51-36"><a href="#cb51-36"></a><span class="co">## Centering</span></span>
<span id="cb51-37"><a href="#cb51-37"></a><span class="co"># Small</span></span>
<span id="cb51-38"><a href="#cb51-38"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">mutate_all</span>(gGGDC10S, <span class="cf">function</span>(x) x<span class="op">-</span><span class="kw">mean.default</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)),</span>
<span id="cb51-39"><a href="#cb51-39"></a>               <span class="dt">collapse =</span> <span class="kw">fwithin</span>(cgGGDC10S))</span>
<span id="cb51-40"><a href="#cb51-40"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb51-41"><a href="#cb51-41"></a><span class="co">#      expr      min        lq      mean   median        uq       max neval</span></span>
<span id="cb51-42"><a href="#cb51-42"></a><span class="co">#     dplyr 8448.350 8606.7680 9700.1981 8693.117 9603.2375 34581.471   100</span></span>
<span id="cb51-43"><a href="#cb51-43"></a><span class="co">#  collapse  306.572  327.3225  361.3444  368.154  375.2945   430.629   100</span></span>
<span id="cb51-44"><a href="#cb51-44"></a></span>
<span id="cb51-45"><a href="#cb51-45"></a><span class="co"># Large</span></span>
<span id="cb51-46"><a href="#cb51-46"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">mutate_all</span>(gdata, <span class="cf">function</span>(x) x<span class="op">-</span><span class="kw">mean.default</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)),</span>
<span id="cb51-47"><a href="#cb51-47"></a>               <span class="dt">collapse =</span> <span class="kw">fwithin</span>(cgdata), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb51-48"><a href="#cb51-48"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb51-49"><a href="#cb51-49"></a><span class="co">#      expr        min        lq      mean    median        uq       max neval</span></span>
<span id="cb51-50"><a href="#cb51-50"></a><span class="co">#     dplyr 1573.20527 1603.7130 1644.1533 1617.4777 1689.4883 1747.0962    10</span></span>
<span id="cb51-51"><a href="#cb51-51"></a><span class="co">#  collapse   90.55067  100.3967  129.2609  108.1047  111.0589  235.5136    10</span></span>
<span id="cb51-52"><a href="#cb51-52"></a></span>
<span id="cb51-53"><a href="#cb51-53"></a><span class="co">## Centering and Scaling (Standardizing)</span></span>
<span id="cb51-54"><a href="#cb51-54"></a><span class="co"># Small</span></span>
<span id="cb51-55"><a href="#cb51-55"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">mutate_all</span>(gGGDC10S, <span class="cf">function</span>(x) (x<span class="op">-</span><span class="kw">mean.default</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))<span class="op">/</span><span class="kw">sd</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)),</span>
<span id="cb51-56"><a href="#cb51-56"></a>               <span class="dt">collapse =</span> <span class="kw">fscale</span>(cgGGDC10S))</span>
<span id="cb51-57"><a href="#cb51-57"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb51-58"><a href="#cb51-58"></a><span class="co">#      expr       min         lq       mean    median        uq       max neval</span></span>
<span id="cb51-59"><a href="#cb51-59"></a><span class="co">#     dplyr 25317.828 25973.3660 28179.4951 26870.099 28438.212 39703.942   100</span></span>
<span id="cb51-60"><a href="#cb51-60"></a><span class="co">#  collapse   494.888   516.0845   548.4156   556.247   566.065   645.273   100</span></span>
<span id="cb51-61"><a href="#cb51-61"></a></span>
<span id="cb51-62"><a href="#cb51-62"></a><span class="co"># Large</span></span>
<span id="cb51-63"><a href="#cb51-63"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr =</span> <span class="kw">mutate_all</span>(gdata, <span class="cf">function</span>(x) (x<span class="op">-</span><span class="kw">mean.default</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))<span class="op">/</span><span class="kw">sd</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)),</span>
<span id="cb51-64"><a href="#cb51-64"></a>               <span class="dt">collapse =</span> <span class="kw">fscale</span>(cgdata), <span class="dt">times =</span> <span class="dv">2</span>)</span>
<span id="cb51-65"><a href="#cb51-65"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb51-66"><a href="#cb51-66"></a><span class="co">#      expr       min        lq      mean    median        uq       max neval</span></span>
<span id="cb51-67"><a href="#cb51-67"></a><span class="co">#     dplyr 5410.9159 5410.9159 5438.1283 5438.1283 5465.3407 5465.3407     2</span></span>
<span id="cb51-68"><a href="#cb51-68"></a><span class="co">#  collapse  129.8485  129.8485  132.8861  132.8861  135.9237  135.9237     2</span></span>
<span id="cb51-69"><a href="#cb51-69"></a></span>
<span id="cb51-70"><a href="#cb51-70"></a><span class="co">## Lag</span></span>
<span id="cb51-71"><a href="#cb51-71"></a><span class="co"># Small</span></span>
<span id="cb51-72"><a href="#cb51-72"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr_unordered =</span> <span class="kw">mutate_all</span>(gGGDC10S, dplyr<span class="op">::</span>lag),</span>
<span id="cb51-73"><a href="#cb51-73"></a>               <span class="dt">collapse_unordered =</span> <span class="kw">flag</span>(cgGGDC10S),</span>
<span id="cb51-74"><a href="#cb51-74"></a>               <span class="dt">dplyr_ordered =</span> <span class="kw">mutate_all</span>(gGGDC10S, dplyr<span class="op">::</span>lag, <span class="dt">order_by =</span> <span class="st">&quot;Year&quot;</span>),</span>
<span id="cb51-75"><a href="#cb51-75"></a>               <span class="dt">collapse_ordered =</span> <span class="kw">flag</span>(cgGGDC10S, <span class="dt">t =</span> Year))</span>
<span id="cb51-76"><a href="#cb51-76"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb51-77"><a href="#cb51-77"></a><span class="co">#                expr       min         lq       mean     median         uq       max neval</span></span>
<span id="cb51-78"><a href="#cb51-78"></a><span class="co">#     dplyr_unordered  2016.145  2113.6495  2211.2616  2172.7775  2211.6010  2851.965   100</span></span>
<span id="cb51-79"><a href="#cb51-79"></a><span class="co">#  collapse_unordered   340.040   376.1865   441.2136   439.5535   485.9630   634.117   100</span></span>
<span id="cb51-80"><a href="#cb51-80"></a><span class="co">#       dplyr_ordered 49583.853 50956.5085 53893.6488 52644.6610 55580.9670 75382.289   100</span></span>
<span id="cb51-81"><a href="#cb51-81"></a><span class="co">#    collapse_ordered   317.282   342.7180   378.7569   380.8725   403.8535   530.588   100</span></span>
<span id="cb51-82"><a href="#cb51-82"></a></span>
<span id="cb51-83"><a href="#cb51-83"></a><span class="co"># Large</span></span>
<span id="cb51-84"><a href="#cb51-84"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr_unordered =</span> <span class="kw">mutate_all</span>(gdata, dplyr<span class="op">::</span>lag),</span>
<span id="cb51-85"><a href="#cb51-85"></a>               <span class="dt">collapse_unordered =</span> <span class="kw">flag</span>(cgdata),</span>
<span id="cb51-86"><a href="#cb51-86"></a>               <span class="dt">dplyr_ordered =</span> <span class="kw">mutate_all</span>(gdata, dplyr<span class="op">::</span>lag, <span class="dt">order_by =</span> <span class="st">&quot;Year&quot;</span>),</span>
<span id="cb51-87"><a href="#cb51-87"></a>               <span class="dt">collapse_ordered =</span> <span class="kw">flag</span>(cgdata, <span class="dt">t =</span> Year), <span class="dt">times =</span> <span class="dv">2</span>)</span>
<span id="cb51-88"><a href="#cb51-88"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb51-89"><a href="#cb51-89"></a><span class="co">#                expr         min          lq       mean     median          uq         max neval</span></span>
<span id="cb51-90"><a href="#cb51-90"></a><span class="co">#     dplyr_unordered   184.04658   184.04658   196.4893   196.4893   208.93199   208.93199     2</span></span>
<span id="cb51-91"><a href="#cb51-91"></a><span class="co">#  collapse_unordered    52.20243    52.20243   132.0862   132.0862   211.97004   211.97004     2</span></span>
<span id="cb51-92"><a href="#cb51-92"></a><span class="co">#       dplyr_ordered 10660.72013 10660.72013 10674.7593 10674.7593 10688.79844 10688.79844     2</span></span>
<span id="cb51-93"><a href="#cb51-93"></a><span class="co">#    collapse_ordered    91.04779    91.04779    91.4300    91.4300    91.81221    91.81221     2</span></span>
<span id="cb51-94"><a href="#cb51-94"></a></span>
<span id="cb51-95"><a href="#cb51-95"></a><span class="co">## First-Difference (unordered)</span></span>
<span id="cb51-96"><a href="#cb51-96"></a><span class="co"># Small</span></span>
<span id="cb51-97"><a href="#cb51-97"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr_unordered =</span> <span class="kw">mutate_all</span>(gGGDC10S, <span class="cf">function</span>(x) x <span class="op">-</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">lag</span>(x)),</span>
<span id="cb51-98"><a href="#cb51-98"></a>               <span class="dt">collapse_unordered =</span> <span class="kw">fdiff</span>(cgGGDC10S))</span>
<span id="cb51-99"><a href="#cb51-99"></a><span class="co"># Unit: microseconds</span></span>
<span id="cb51-100"><a href="#cb51-100"></a><span class="co">#                expr       min         lq       mean    median         uq       max neval</span></span>
<span id="cb51-101"><a href="#cb51-101"></a><span class="co">#     dplyr_unordered 31439.000 32377.4575 35122.4928 33240.723 37201.3885 50139.430   100</span></span>
<span id="cb51-102"><a href="#cb51-102"></a><span class="co">#  collapse_unordered   364.584   392.6975   464.4141   465.882   516.3085   626.531   100</span></span>
<span id="cb51-103"><a href="#cb51-103"></a></span>
<span id="cb51-104"><a href="#cb51-104"></a><span class="co"># Large</span></span>
<span id="cb51-105"><a href="#cb51-105"></a><span class="kw">microbenchmark</span>(<span class="dt">dplyr_unordered =</span> <span class="kw">mutate_all</span>(gdata, <span class="cf">function</span>(x) x <span class="op">-</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">lag</span>(x)),</span>
<span id="cb51-106"><a href="#cb51-106"></a>               <span class="dt">collapse_unordered =</span> <span class="kw">fdiff</span>(cgdata), <span class="dt">times =</span> <span class="dv">2</span>)</span>
<span id="cb51-107"><a href="#cb51-107"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb51-108"><a href="#cb51-108"></a><span class="co">#                expr        min         lq      mean    median         uq        max neval</span></span>
<span id="cb51-109"><a href="#cb51-109"></a><span class="co">#     dplyr_unordered 6726.73257 6726.73257 6966.3916 6966.3916 7206.05058 7206.05058     2</span></span>
<span id="cb51-110"><a href="#cb51-110"></a><span class="co">#  collapse_unordered   57.28028   57.28028   60.0276   60.0276   62.77492   62.77492     2</span></span>
<span id="cb51-111"><a href="#cb51-111"></a></span>
<span id="cb51-112"><a href="#cb51-112"></a><span class="kw">gc</span>()</span>
<span id="cb51-113"><a href="#cb51-113"></a><span class="co">#            used  (Mb) gc trigger  (Mb) max used  (Mb)</span></span>
<span id="cb51-114"><a href="#cb51-114"></a><span class="co"># Ncells  1871343 100.0    3536120 188.9  3536120 188.9</span></span>
<span id="cb51-115"><a href="#cb51-115"></a><span class="co"># Vcells 20987844 160.2   48914147 373.2 48914147 373.2</span></span></code></pre></div>
<p>Again below are some benchmarks for transformations not easily of efficiently performed with <em>dplyr</em>, such as centering on the overall mean, mean-preserving scaling, weighted scaling and centering, sequences of lags / leads, (iterated) panel-differences and growth rates.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="co"># Centering on overall mean</span></span>
<span id="cb52-2"><a href="#cb52-2"></a><span class="kw">microbenchmark</span>(<span class="kw">fwithin</span>(cgdata, <span class="dt">mean =</span> <span class="st">&quot;overall.mean&quot;</span>), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb52-4"><a href="#cb52-4"></a><span class="co">#                                    expr     min       lq    mean   median       uq      max neval</span></span>
<span id="cb52-5"><a href="#cb52-5"></a><span class="co">#  fwithin(cgdata, mean = &quot;overall.mean&quot;) 86.8379 90.44447 100.644 99.38146 110.4631 117.7775    10</span></span>
<span id="cb52-6"><a href="#cb52-6"></a></span>
<span id="cb52-7"><a href="#cb52-7"></a><span class="co"># Weighted Centering</span></span>
<span id="cb52-8"><a href="#cb52-8"></a><span class="kw">microbenchmark</span>(<span class="kw">fwithin</span>(cgdata, SUM), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb52-9"><a href="#cb52-9"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb52-10"><a href="#cb52-10"></a><span class="co">#                  expr      min       lq     mean  median       uq      max neval</span></span>
<span id="cb52-11"><a href="#cb52-11"></a><span class="co">#  fwithin(cgdata, SUM) 85.66873 88.54167 113.0686 103.233 111.3918 239.7391    10</span></span>
<span id="cb52-12"><a href="#cb52-12"></a><span class="kw">microbenchmark</span>(<span class="kw">fwithin</span>(cgdata, SUM, <span class="dt">mean =</span> <span class="st">&quot;overall.mean&quot;</span>), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb52-13"><a href="#cb52-13"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb52-14"><a href="#cb52-14"></a><span class="co">#                                         expr      min       lq     mean  median       uq      max</span></span>
<span id="cb52-15"><a href="#cb52-15"></a><span class="co">#  fwithin(cgdata, SUM, mean = &quot;overall.mean&quot;) 87.15027 93.07108 115.4685 105.556 110.4747 237.0188</span></span>
<span id="cb52-16"><a href="#cb52-16"></a><span class="co">#  neval</span></span>
<span id="cb52-17"><a href="#cb52-17"></a><span class="co">#     10</span></span>
<span id="cb52-18"><a href="#cb52-18"></a></span>
<span id="cb52-19"><a href="#cb52-19"></a><span class="co"># Weighted Scaling and Standardizing</span></span>
<span id="cb52-20"><a href="#cb52-20"></a><span class="kw">microbenchmark</span>(<span class="kw">fsd</span>(cgdata, SUM, <span class="dt">TRA =</span> <span class="st">&quot;/&quot;</span>), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb52-21"><a href="#cb52-21"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb52-22"><a href="#cb52-22"></a><span class="co">#                         expr      min       lq     mean   median       uq      max neval</span></span>
<span id="cb52-23"><a href="#cb52-23"></a><span class="co">#  fsd(cgdata, SUM, TRA = &quot;/&quot;) 155.6354 158.3106 181.9655 173.3973 179.5904 299.5264    10</span></span>
<span id="cb52-24"><a href="#cb52-24"></a><span class="kw">microbenchmark</span>(<span class="kw">fscale</span>(cgdata, SUM), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb52-25"><a href="#cb52-25"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb52-26"><a href="#cb52-26"></a><span class="co">#                 expr      min       lq     mean  median       uq      max neval</span></span>
<span id="cb52-27"><a href="#cb52-27"></a><span class="co">#  fscale(cgdata, SUM) 118.0694 120.6001 144.3765 134.097 139.2568 262.9136    10</span></span>
<span id="cb52-28"><a href="#cb52-28"></a></span>
<span id="cb52-29"><a href="#cb52-29"></a><span class="co"># Sequence of lags and leads</span></span>
<span id="cb52-30"><a href="#cb52-30"></a><span class="kw">microbenchmark</span>(<span class="kw">flag</span>(cgdata, <span class="dv">-1</span><span class="op">:</span><span class="dv">1</span>), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb52-31"><a href="#cb52-31"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb52-32"><a href="#cb52-32"></a><span class="co">#                expr     min       lq    mean   median       uq      max neval</span></span>
<span id="cb52-33"><a href="#cb52-33"></a><span class="co">#  flag(cgdata, -1:1) 126.653 149.5249 218.783 254.2807 254.5447 258.2999    10</span></span>
<span id="cb52-34"><a href="#cb52-34"></a></span>
<span id="cb52-35"><a href="#cb52-35"></a><span class="co"># Iterated difference</span></span>
<span id="cb52-36"><a href="#cb52-36"></a><span class="kw">microbenchmark</span>(<span class="kw">fdiff</span>(cgdata, <span class="dv">1</span>, <span class="dv">2</span>), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb52-37"><a href="#cb52-37"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb52-38"><a href="#cb52-38"></a><span class="co">#                 expr      min       lq     mean   median       uq      max neval</span></span>
<span id="cb52-39"><a href="#cb52-39"></a><span class="co">#  fdiff(cgdata, 1, 2) 86.16406 90.16244 114.0001 105.2255 112.9898 238.6128    10</span></span>
<span id="cb52-40"><a href="#cb52-40"></a></span>
<span id="cb52-41"><a href="#cb52-41"></a><span class="co"># Growth Rate</span></span>
<span id="cb52-42"><a href="#cb52-42"></a><span class="kw">microbenchmark</span>(<span class="kw">fgrowth</span>(cgdata,<span class="dv">1</span>), <span class="dt">times =</span> <span class="dv">10</span>)</span>
<span id="cb52-43"><a href="#cb52-43"></a><span class="co"># Unit: milliseconds</span></span>
<span id="cb52-44"><a href="#cb52-44"></a><span class="co">#                expr      min      lq     mean   median       uq      max neval</span></span>
<span id="cb52-45"><a href="#cb52-45"></a><span class="co">#  fgrowth(cgdata, 1) 93.15185 98.5019 126.6505 110.4267 122.9045 282.0549    10</span></span></code></pre></div>
<!-- Again the benchmarks show stunning performance gains using *collapse* functions. -->
</div>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<p>Timmer, M. P., de Vries, G. J., &amp; de Vries, K. (2015). “Patterns of Structural Change in Developing Countries.” . In J. Weiss, &amp; M. Tribe (Eds.), <em>Routledge Handbook of Industry and Development.</em> (pp. 65-83). Routledge.</p>
<p>Cochrane, D. &amp; Orcutt, G. H. (1949). “Application of Least Squares Regression to Relationships Containing Auto-Correlated Error Terms”. <em>Journal of the American Statistical Association.</em> 44 (245): 32–61.</p>
<p>Prais, S. J. &amp; Winsten, C. B. (1954). “Trend Estimators and Serial Correlation”. <em>Cowles Commission Discussion Paper No. 383.</em> Chicago.</p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Row-wise operations are not supported by TRA.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
