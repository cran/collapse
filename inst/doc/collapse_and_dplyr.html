<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Sebastian Krantz" />

<meta name="date" content="2020-03-12" />

<title>collapse and dplyr</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore"><em>collapse</em> and <em>dplyr</em></h1>
<h3 class="subtitle">Fast (weighted) Aggregations, Transformations and Time-Series/Panel Computations in a <em>dplyr</em> Workflow</h3>
<h4 class="author">Sebastian Krantz</h4>
<h4 class="date">2020-03-12</h4>


<div id="TOC">
<ul>
<li><a href="#fast-aggregations">1. Fast Aggregations</a><ul>
<li><a href="#simple-aggregations">1.1 Simple Aggregations</a></li>
<li><a href="#multi-function-aggregations">1.2 Multi-Function Aggregations</a></li>
<li><a href="#weighted-aggregations">1.3 Weighted Aggregations</a></li>
<li><a href="#benchmarks">Benchmarks</a></li>
</ul></li>
<li><a href="#fast-transformations">2. Fast Transformations</a><ul>
<li><a href="#replacing-and-sweeping-out-statistics">2.1 Replacing and Sweeping out Statistics</a></li>
<li><a href="#more-control-using-the-tra-function">2.2 More Control using the <code>TRA</code> Function</a></li>
<li><a href="#faster-centering-averaging-and-standardizing">2.3 Faster Centering, Averaging and Standardizing</a></li>
<li><a href="#lags-leads-differences-and-growth-rates">2.4 Lags / Leads, Differences and Growth Rates</a></li>
<li><a href="#benchmarks-1">Benchmarks</a></li>
</ul></li>
<li><a href="#references">References</a></li>
</ul>
</div>

<p><em>collapse</em> is a C/C++ based package for data manipulation in R. It’s aims are</p>
<ol style="list-style-type: decimal">
<li><p>to facilitate complex data transformation and exploration tasks and</p></li>
<li><p>to help make R code fast, flexible, parsimonious and programmer friendly.</p></li>
</ol>
<p>This vignette focuses on the integration of <em>collapse</em> and the popular <em>dplyr</em> package by Hadley Wickham. In particular it will demonstrate how using <em>collapse</em>’s fast functions can facilitate and speed up grouped and weighted aggregations and transformations, as well as panel-data computations (i.e. between- and within-transformations, panel-lags, differences and growth rates) in a <em>dplyr</em> workflow.</p>
<hr />
<p><em>Note:</em> This vignette is targeted at <em>dplyr</em> users. <em>collapse</em> is a standalone package and delivers even faster performance using it’s own grouping mechanism (based on <em>data.table</em> internals) and it’s own set of functions to efficiently select and replace variables. The ‘Introduction to <em>collapse</em>’ vignette provides a thorough introduction to the package and a built-in structured documentation is available under <code>help(&quot;collapse-documentation&quot;)</code> after installing the package. In addition <code>help(&quot;collapse-package&quot;)</code> provides a compact set of examples for quick-start.</p>
<hr />
<div id="fast-aggregations" class="section level2">
<h2>1. Fast Aggregations</h2>
<p>A key feature of <em>collapse</em> is it’s broad set of <em>Fast Statistical Functions</em> (<code>fsum, fprod, fmean, fmedian, fmode, fvar, fsd, fmin, fmax, ffirst, flast, fNobs, fNdistinct</code>) which are able to dramatically speed-up column-wise, grouped and weighted computations on vectors, matrices or data.frame’s. The functions are S3 generic, with a default (vector), matrix and data.frame method, as well as a grouped_df method for grouped tibbles used by dplyr. The grouped tibble method has the following arguments:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">FUN.grouped_df</span>(x, [<span class="dt">w =</span> <span class="ot">NULL</span>,] <span class="dt">TRA =</span> <span class="ot">NULL</span>, [<span class="dt">na.rm =</span> <span class="ot">TRUE</span>,]</a>
<a class="sourceLine" id="cb1-2" title="2">               <span class="dt">use.g.names =</span> <span class="ot">FALSE</span>, <span class="dt">keep.group_vars =</span> <span class="ot">TRUE</span>, [<span class="dt">keep.w =</span> <span class="ot">TRUE</span>,] ...)</a></code></pre></div>
<p>where <code>w</code> is a weight variable (available only to <code>fmean, fmode, fvar</code> and <code>fsd</code>), and <code>TRA</code> and can be used to transform <code>x</code> using the computed statistics and one of 8 available transformations (<code>&quot;replace_fill&quot;, &quot;replace&quot;, &quot;-&quot;, &quot;-+&quot;, &quot;/&quot;, &quot;%&quot;, &quot;+&quot;, &quot;*&quot;</code>). These transformations perform grouped replacing or sweeping out of the statistics computed by the function (discussed in section 2). <code>na.rm</code> efficiently removes missing values and is <code>TRUE</code> by default. <code>use.g.names</code> generates new row-names from the unique combinations of groups (default: disabled), whereas <code>keep.group_vars</code> (default: enabled) will keep the grouping columns as is custom in the native <code>data %&gt;% group_by(...) %&gt;% summarize(...)</code> workflow in <em>dplyr</em>. Finally, <code>keep.w</code> regulates whether a weighting variable used is also aggregated and saved in a column. For <code>fmean, fvar and fsd</code> this will compute the sum of the weights in each group, whereas <code>fmode</code> will return the maximum weight (corresponding to the mode) in each group.</p>
<p>With that in mind, let’s consider some straightforward applications:</p>
<div id="simple-aggregations" class="section level3">
<h3>1.1 Simple Aggregations</h3>
<p>Consider the Groningen Growth and Development Center 10-Sector Database included in <em>collapse</em>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">library</span>(collapse)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw">head</span>(GGDC10S)</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="co"># # A tibble: 6 x 16</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="co">#   Country Regioncode Region Variable  Year   AGR   MIN    MAN     PU    CON   WRT   TRA  FIRE   GOV</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="co">#   &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="co"># 1 BWA     SSA        Sub-s~ VA        1960  NA   NA    NA     NA     NA     NA    NA    NA    NA   </span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="co"># 2 BWA     SSA        Sub-s~ VA        1961  NA   NA    NA     NA     NA     NA    NA    NA    NA   </span></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="co"># 3 BWA     SSA        Sub-s~ VA        1962  NA   NA    NA     NA     NA     NA    NA    NA    NA   </span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="co"># 4 BWA     SSA        Sub-s~ VA        1963  NA   NA    NA     NA     NA     NA    NA    NA    NA   </span></a>
<a class="sourceLine" id="cb2-10" title="10"><span class="co"># 5 BWA     SSA        Sub-s~ VA        1964  16.3  3.49  0.737  0.104  0.660  6.24  1.66  1.12  4.82</span></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="co"># 6 BWA     SSA        Sub-s~ VA        1965  15.7  2.50  1.02   0.135  1.35   7.06  1.94  1.25  5.70</span></a>
<a class="sourceLine" id="cb2-12" title="12"><span class="co"># # ... with 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb2-13" title="13"></a>
<a class="sourceLine" id="cb2-14" title="14"><span class="co"># Summarize the Data: </span></a>
<a class="sourceLine" id="cb2-15" title="15"><span class="co"># descr(GGDC10S, cols = is.categorical)</span></a>
<a class="sourceLine" id="cb2-16" title="16"><span class="co"># aperm(qsu(GGDC10S, ~Variable, cols = is.numeric))</span></a></code></pre></div>
<p>Simple column-wise computations using the fast functions and pipe operators are performed as follows:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span>fNobs                       <span class="co"># Number of Observations</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co">#    Country Regioncode     Region   Variable       Year        AGR        MIN        MAN         PU </span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co">#       5027       5027       5027       5027       5027       4364       4355       4355       4354 </span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co">#        CON        WRT        TRA       FIRE        GOV        OTH        SUM </span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co">#       4355       4355       4355       4355       3482       4248       4364</span></a>
<a class="sourceLine" id="cb3-8" title="8">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span>fNdistinct                  <span class="co"># Number of distinct values</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="co">#    Country Regioncode     Region   Variable       Year        AGR        MIN        MAN         PU </span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="co">#         43          6          6          2         67       4353       4224       4353       4237 </span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="co">#        CON        WRT        TRA       FIRE        GOV        OTH        SUM </span></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="co">#       4339       4344       4334       4349       3470       4238       4364</span></a>
<a class="sourceLine" id="cb3-13" title="13">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fmedian <span class="co"># Median</span></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="co">#        AGR        MIN        MAN         PU        CON        WRT        TRA       FIRE        GOV </span></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="co">#  4394.5194   173.2234  3718.0981   167.9500  1473.4470  3773.6430  1174.8000   960.1251  3928.5127 </span></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="co">#        OTH        SUM </span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="co">#  1433.1722 23186.1936</span></a>
<a class="sourceLine" id="cb3-18" title="18">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span>fmode                       <span class="co"># Mode</span></a>
<a class="sourceLine" id="cb3-19" title="19"><span class="co">#            Country         Regioncode             Region           Variable               Year </span></a>
<a class="sourceLine" id="cb3-20" title="20"><span class="co">#              &quot;USA&quot;              &quot;ASI&quot;             &quot;Asia&quot;              &quot;EMP&quot;             &quot;2010&quot; </span></a>
<a class="sourceLine" id="cb3-21" title="21"><span class="co">#                AGR                MIN                MAN                 PU                CON </span></a>
<a class="sourceLine" id="cb3-22" title="22"><span class="co"># &quot;171.315882316326&quot;                &quot;0&quot; &quot;4645.12507642586&quot;                &quot;0&quot; &quot;1.34623115930777&quot; </span></a>
<a class="sourceLine" id="cb3-23" title="23"><span class="co">#                WRT                TRA               FIRE                GOV                OTH </span></a>
<a class="sourceLine" id="cb3-24" title="24"><span class="co"># &quot;21.8380052682527&quot; &quot;8.97743416914571&quot; &quot;40.0701608636442&quot;                &quot;0&quot; &quot;3626.84423577048&quot; </span></a>
<a class="sourceLine" id="cb3-25" title="25"><span class="co">#                SUM </span></a>
<a class="sourceLine" id="cb3-26" title="26"><span class="co"># &quot;37.4822945751317&quot;</span></a>
<a class="sourceLine" id="cb3-27" title="27">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmode</span>(<span class="dt">drop =</span> <span class="ot">FALSE</span>)         <span class="co"># Keep data structure intact</span></a>
<a class="sourceLine" id="cb3-28" title="28"><span class="co"># # A tibble: 1 x 16</span></a>
<a class="sourceLine" id="cb3-29" title="29"><span class="co">#   Country Regioncode Region Variable  Year   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV</span></a>
<a class="sourceLine" id="cb3-30" title="30"><span class="co"># * &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb3-31" title="31"><span class="co"># 1 USA     ASI        Asia   EMP       2010  171.     0 4645.     0  1.35  21.8  8.98  40.1     0</span></a>
<a class="sourceLine" id="cb3-32" title="32"><span class="co"># # ... with 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></a></code></pre></div>
<p>Moving on to grouped statistics, we can compute the average value added and employment by sector and country using:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="st">  </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fmean</a>
<a class="sourceLine" id="cb4-4" title="4"><span class="co"># # A tibble: 85 x 13</span></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="co">#    Variable Country     AGR     MIN     MAN     PU    CON    WRT    TRA   FIRE     GOV    OTH    SUM</span></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="co">#    &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co">#  1 EMP      ARG       1420.   52.1   1932.  1.02e2 7.42e2 1.98e3 6.49e2  628.   2043.  9.92e2 1.05e4</span></a>
<a class="sourceLine" id="cb4-8" title="8"><span class="co">#  2 EMP      BOL        964.   56.0    235.  5.35e0 1.23e2 2.82e2 1.15e2   44.6    NA   3.96e2 2.22e3</span></a>
<a class="sourceLine" id="cb4-9" title="9"><span class="co">#  3 EMP      BRA      17191.  206.    6991.  3.65e2 3.52e3 8.51e3 2.05e3 4414.   5307.  5.71e3 5.43e4</span></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="co">#  4 EMP      BWA        188.   10.5     18.1 3.09e0 2.53e1 3.63e1 8.36e0   15.3    61.1 2.76e1 3.94e2</span></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="co">#  5 EMP      CHL        702.  101.     625.  2.94e1 2.96e2 6.95e2 2.58e2  272.     NA   1.00e3 3.98e3</span></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="co">#  6 EMP      CHN     287744. 7050.   67144.  1.61e3 2.09e4 2.89e4 1.39e4 4929.  22669.  3.10e4 4.86e5</span></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="co">#  7 EMP      COL       3091.  145.    1175.  3.39e1 5.24e2 2.07e3 4.70e2  649.     NA   1.73e3 9.89e3</span></a>
<a class="sourceLine" id="cb4-14" title="14"><span class="co">#  8 EMP      CRI        231.    1.70   136.  1.43e1 5.76e1 1.57e2 4.24e1   54.9   128.  6.51e1 8.87e2</span></a>
<a class="sourceLine" id="cb4-15" title="15"><span class="co">#  9 EMP      DEW       2490.  407.    8473.  2.26e2 2.09e3 4.44e3 1.48e3 1689.   3945.  9.99e2 2.62e4</span></a>
<a class="sourceLine" id="cb4-16" title="16"><span class="co"># 10 EMP      DNK        236.    8.03   507.  1.38e1 1.71e2 4.55e2 1.61e2  181.    549.  1.11e2 2.39e3</span></a>
<a class="sourceLine" id="cb4-17" title="17"><span class="co"># # ... with 75 more rows</span></a></code></pre></div>
<p>Similarly we can obtain the median or the standard deviation:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="st">  </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fmedian</a>
<a class="sourceLine" id="cb5-4" title="4"><span class="co"># # A tibble: 85 x 13</span></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="co">#    Variable Country     AGR     MIN     MAN     PU    CON    WRT    TRA   FIRE     GOV    OTH    SUM</span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="co">#    &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="co">#  1 EMP      ARG       1325.   47.4   1988.  1.05e2 7.82e2 1.85e3 5.80e2  464.   1739.   866.  9.74e3</span></a>
<a class="sourceLine" id="cb5-8" title="8"><span class="co">#  2 EMP      BOL        943.   53.5    167.  4.46e0 6.60e1 1.32e2 9.70e1   15.3    NA    384.  1.84e3</span></a>
<a class="sourceLine" id="cb5-9" title="9"><span class="co">#  3 EMP      BRA      17481.  225.    7208.  3.76e2 4.05e3 6.45e3 1.58e3 4355.   4450.  4479.  5.19e4</span></a>
<a class="sourceLine" id="cb5-10" title="10"><span class="co">#  4 EMP      BWA        175.   12.2     13.1 3.71e0 1.90e1 2.11e1 6.75e0   10.4    53.8   31.2 3.61e2</span></a>
<a class="sourceLine" id="cb5-11" title="11"><span class="co">#  5 EMP      CHL        690.   93.9    607.  2.58e1 2.30e2 4.84e2 2.05e2  106.     NA    900.  3.31e3</span></a>
<a class="sourceLine" id="cb5-12" title="12"><span class="co">#  6 EMP      CHN     293915  8150.   61761.  1.14e3 1.06e4 1.70e4 9.56e3 4328.  19468.  9954.  4.45e5</span></a>
<a class="sourceLine" id="cb5-13" title="13"><span class="co">#  7 EMP      COL       3006.   84.0   1033.  3.71e1 4.19e2 1.55e3 3.91e2  655.     NA   1430.  8.63e3</span></a>
<a class="sourceLine" id="cb5-14" title="14"><span class="co">#  8 EMP      CRI        216.    1.49   114.  7.92e0 5.50e1 8.98e1 2.55e1   19.6   122.    60.6 7.19e2</span></a>
<a class="sourceLine" id="cb5-15" title="15"><span class="co">#  9 EMP      DEW       2178   320.    8459.  2.47e2 2.10e3 4.45e3 1.53e3 1656    3700    900   2.65e4</span></a>
<a class="sourceLine" id="cb5-16" title="16"><span class="co"># 10 EMP      DNK        187.    3.75   508.  1.36e1 1.65e2 4.61e2 1.61e2  169.    642.   104.  2.42e3</span></a>
<a class="sourceLine" id="cb5-17" title="17"><span class="co"># # ... with 75 more rows</span></a>
<a class="sourceLine" id="cb5-18" title="18"></a>
<a class="sourceLine" id="cb5-19" title="19">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-20" title="20"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-21" title="21"><span class="st">  </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fsd</a>
<a class="sourceLine" id="cb5-22" title="22"><span class="co"># # A tibble: 85 x 13</span></a>
<a class="sourceLine" id="cb5-23" title="23"><span class="co">#    Variable Country     AGR      MIN    MAN     PU    CON    WRT    TRA   FIRE     GOV    OTH    SUM</span></a>
<a class="sourceLine" id="cb5-24" title="24"><span class="co">#    &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb5-25" title="25"><span class="co">#  1 EMP      ARG       242.    19.1   1.73e2 2.23e1 2.78e2 8.33e2 1.81e2  453.   1073.  4.89e2 3.05e3</span></a>
<a class="sourceLine" id="cb5-26" title="26"><span class="co">#  2 EMP      BOL        92.6   18.2   1.50e2 4.48e0 1.08e2 2.88e2 8.96e1   58.7    NA   2.49e2 9.47e2</span></a>
<a class="sourceLine" id="cb5-27" title="27"><span class="co">#  3 EMP      BRA      1975.    83.1   3.28e3 1.14e2 2.04e3 6.35e3 1.28e3 3144.   3787.  4.33e3 2.52e4</span></a>
<a class="sourceLine" id="cb5-28" title="28"><span class="co">#  4 EMP      BWA        31.3    4.70  1.52e1 1.91e0 1.90e1 3.69e1 6.09e0   13.4    42.2 1.14e1 1.67e2</span></a>
<a class="sourceLine" id="cb5-29" title="29"><span class="co">#  5 EMP      CHL        68.6   32.3   1.38e2 1.12e1 1.81e2 5.09e2 1.30e2  286.     NA   4.18e2 1.61e3</span></a>
<a class="sourceLine" id="cb5-30" title="30"><span class="co">#  6 EMP      CHN     64477.  3450.    4.23e4 1.27e3 1.90e4 2.41e4 9.40e3 2910.  11973.  3.54e4 1.95e5</span></a>
<a class="sourceLine" id="cb5-31" title="31"><span class="co">#  7 EMP      COL       710.   127.    6.00e2 1.68e1 3.76e2 1.82e3 3.30e2  409.     NA   9.96e2 5.27e3</span></a>
<a class="sourceLine" id="cb5-32" title="32"><span class="co">#  8 EMP      CRI        48.7    0.876 8.78e1 1.30e1 3.54e1 1.53e2 3.93e1   68.8    82.4 4.29e1 5.46e2</span></a>
<a class="sourceLine" id="cb5-33" title="33"><span class="co">#  9 EMP      DEW      1220.   188.    7.93e2 5.39e1 2.07e2 6.34e2 2.21e2  704.   1241.  3.55e2 2.23e3</span></a>
<a class="sourceLine" id="cb5-34" title="34"><span class="co"># 10 EMP      DNK       144.     7.96  7.67e1 1.96e0 2.63e1 5.43e1 1.61e1   91.1   255.  1.91e1 2.23e2</span></a>
<a class="sourceLine" id="cb5-35" title="35"><span class="co"># # ... with 75 more rows</span></a></code></pre></div>
<p>It is important to not use <em>dplyr</em>’s <code>summarize</code> together with the fast functions since that would totally eliminate their speed gain. These functions are fast because they are executed only once and carry out the grouped computations in C++, whereas <code>summarize</code> will split and then apply the function to each group in the grouped tibble. - It will also work with the fast functions, but is slower than using primitive base functions since the fast functions are S3 generic -.</p>
<hr />
<div id="excursus-what-is-happening-behind-the-scenes" class="section level4">
<h4>Excursus: What is Happening Behind the Scenes?</h4>
<p>To drive this point home it is perhaps good to shed some light on what is happening behind the scenes of <em>dplyr</em> and <em>collapse</em>. Fundamentally both packages follow different computing paradigms:</p>
<p><em>dplyr</em> is an efficient implementation of the Split-Apply-Combine computing paradigm. Data is split into groups, these data-chunks are then passed to a function carrying out the computation, and finally recombined to produce the aggregated data.frame. <!-- The efficiency of that process depends on the efficiency of the grouping, splitting, the function(s) applied and the recombining.  --> This modus operandi is evident in the grouping mechanism of <em>dplyr</em>. When a data.frame is passed through <em>group_by</em>, a ‘groups’ attribute is attached:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">attr</span>(<span class="st">&quot;groups&quot;</span>)</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co"># # A tibble: 85 x 3</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co">#    Variable Country .rows     </span></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="co">#    &lt;chr&gt;    &lt;chr&gt;   &lt;list&gt;    </span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="co">#  1 EMP      ARG     &lt;int [62]&gt;</span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="co">#  2 EMP      BOL     &lt;int [61]&gt;</span></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="co">#  3 EMP      BRA     &lt;int [62]&gt;</span></a>
<a class="sourceLine" id="cb6-8" title="8"><span class="co">#  4 EMP      BWA     &lt;int [52]&gt;</span></a>
<a class="sourceLine" id="cb6-9" title="9"><span class="co">#  5 EMP      CHL     &lt;int [63]&gt;</span></a>
<a class="sourceLine" id="cb6-10" title="10"><span class="co">#  6 EMP      CHN     &lt;int [62]&gt;</span></a>
<a class="sourceLine" id="cb6-11" title="11"><span class="co">#  7 EMP      COL     &lt;int [61]&gt;</span></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="co">#  8 EMP      CRI     &lt;int [62]&gt;</span></a>
<a class="sourceLine" id="cb6-13" title="13"><span class="co">#  9 EMP      DEW     &lt;int [61]&gt;</span></a>
<a class="sourceLine" id="cb6-14" title="14"><span class="co"># 10 EMP      DNK     &lt;int [64]&gt;</span></a>
<a class="sourceLine" id="cb6-15" title="15"><span class="co"># # ... with 75 more rows</span></a></code></pre></div>
<p>This object is a data.frame giving the unique groups and in the third (last) column vectors containing the indices of the rows belonging to that group. A command like <code>summarize</code> uses this information to split the data.frame into groups which are then passed sequentially to the function used and later recombined.</p>
<p>Now <em>collapse</em> is based around one-pass grouped computations at the C++ level, in other words the data is not split and recombined but the entire computation is performed in a single C++ loop running through that data and completing the computations for each group simultaneously. This modus operandi is also evident in <em>collapse</em> grouping objects. The method <code>GRP.grouped_df</code> takes a <em>dplyr</em> grouping object from a grouped tibble and efficiently converts it to a <em>collapse</em> grouping object:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span>GRP <span class="op">%&gt;%</span><span class="st"> </span>str</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="co"># List of 8</span></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="co">#  $ N.groups   : int 85</span></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="co">#  $ group.id   : int [1:5027] 46 46 46 46 46 46 46 46 46 46 ...</span></a>
<a class="sourceLine" id="cb7-5" title="5"><span class="co">#  $ group.sizes: int [1:85] 62 61 62 52 63 62 61 62 61 64 ...</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="co">#  $ groups     :List of 2</span></a>
<a class="sourceLine" id="cb7-7" title="7"><span class="co">#   ..$ Variable: chr [1:85] &quot;EMP&quot; &quot;EMP&quot; &quot;EMP&quot; &quot;EMP&quot; ...</span></a>
<a class="sourceLine" id="cb7-8" title="8"><span class="co">#   .. ..- attr(*, &quot;label&quot;)= chr &quot;Variable&quot;</span></a>
<a class="sourceLine" id="cb7-9" title="9"><span class="co">#   .. ..- attr(*, &quot;format.stata&quot;)= chr &quot;%9s&quot;</span></a>
<a class="sourceLine" id="cb7-10" title="10"><span class="co">#   ..$ Country : chr [1:85] &quot;ARG&quot; &quot;BOL&quot; &quot;BRA&quot; &quot;BWA&quot; ...</span></a>
<a class="sourceLine" id="cb7-11" title="11"><span class="co">#   .. ..- attr(*, &quot;label&quot;)= chr &quot;Country&quot;</span></a>
<a class="sourceLine" id="cb7-12" title="12"><span class="co">#   .. ..- attr(*, &quot;format.stata&quot;)= chr &quot;%9s&quot;</span></a>
<a class="sourceLine" id="cb7-13" title="13"><span class="co">#  $ group.vars : chr [1:2] &quot;Variable&quot; &quot;Country&quot;</span></a>
<a class="sourceLine" id="cb7-14" title="14"><span class="co">#  $ ordered    : logi [1:2] TRUE TRUE</span></a>
<a class="sourceLine" id="cb7-15" title="15"><span class="co">#  $ order      : NULL</span></a>
<a class="sourceLine" id="cb7-16" title="16"><span class="co">#  $ call       : language GRP.grouped_df(X = .)</span></a>
<a class="sourceLine" id="cb7-17" title="17"><span class="co">#  - attr(*, &quot;class&quot;)= chr &quot;GRP&quot;</span></a></code></pre></div>
<p>This object is a list where the first three elements give the number of groups, the group-id to which each row belongs and a vector of group-sizes. A function like <code>fsum</code> uses this information to (for each column) create a result vector of size ‘N.groups’ and the run through the column using the ‘group.id’ vector to add the i’th data point to the ’group.id[i]’th element of the result vector. When the loop is finished, the grouped computation is also finished.</p>
<p>It is clear that <em>collapse</em> is prone to be faster than <em>dplyr</em> since it’s method of computing involves less (and less computationally intensive) steps. A slight qualifier added to this is the additional conversion cost incurred by <code>GRP.grouped_df</code> when using the fast functions on grouped tibbles. This cost is however quite low as the benchmarks at the end show (since <code>GRP.grouped_df</code> is also implemented in C++). <!-- This performance gain is realized especially as data become large, since the conversion perfomed by `GRP.grouped_df` also involves a small computational cost.  --></p>
<hr />
</div>
</div>
<div id="multi-function-aggregations" class="section level3">
<h3>1.2 Multi-Function Aggregations</h3>
<p>One can also aggregate with multiple functions at the same time, but then the programming becomes a bit verbose. In particular, one needs to use curly braces <code>{</code> to prevent first argument injection so that <code>%&gt;% cbind(FUN1(.), FUN2(.))</code> does not evaluate as <code>%&gt;% cbind(., FUN1(.), FUN2(.))</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">GGDC10S <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="st">  </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb8-4" title="4">    <span class="kw">cbind</span>(<span class="kw">fmedian</span>(.), </a>
<a class="sourceLine" id="cb8-5" title="5">          <span class="kw">add_stub</span>(<span class="kw">fmean</span>(., <span class="dt">keep.group_vars =</span> <span class="ot">FALSE</span>), <span class="st">&quot;mean_&quot;</span>))</a>
<a class="sourceLine" id="cb8-6" title="6">    } <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb8-7" title="7"><span class="co">#   Variable Country        AGR       MIN       MAN         PU        CON      WRT        TRA</span></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="co"># 1      EMP     ARG  1324.5255  47.35255 1987.5912 104.738825  782.40283 1854.612  579.93982</span></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="co"># 2      EMP     BOL   943.1612  53.53538  167.1502   4.457895   65.97904  132.225   96.96828</span></a>
<a class="sourceLine" id="cb8-10" title="10"><span class="co"># 3      EMP     BRA 17480.9810 225.43693 7207.7915 375.851832 4054.66103 6454.523 1580.81120</span></a>
<a class="sourceLine" id="cb8-11" title="11"><span class="co">#         FIRE      GOV       OTH       SUM   mean_AGR  mean_MIN  mean_MAN    mean_PU  mean_CON</span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="co"># 1  464.39920 1738.836  866.1119  9743.223  1419.8013  52.08903 1931.7602 101.720936  742.4044</span></a>
<a class="sourceLine" id="cb8-13" title="13"><span class="co"># 2   15.34259       NA  384.0678  1842.055   964.2103  56.03295  235.0332   5.346433  122.7827</span></a>
<a class="sourceLine" id="cb8-14" title="14"><span class="co"># 3 4354.86210 4449.942 4478.6927 51881.110 17191.3529 206.02389 6991.3710 364.573404 3524.7384</span></a>
<a class="sourceLine" id="cb8-15" title="15"><span class="co">#    mean_WRT  mean_TRA  mean_FIRE mean_GOV  mean_OTH  mean_SUM</span></a>
<a class="sourceLine" id="cb8-16" title="16"><span class="co"># 1 1982.1775  648.5119  627.79291 2043.471  992.4475 10542.177</span></a>
<a class="sourceLine" id="cb8-17" title="17"><span class="co"># 2  281.5164  115.4728   44.56442       NA  395.5650  2220.524</span></a>
<a class="sourceLine" id="cb8-18" title="18"><span class="co"># 3 8509.4612 2054.3731 4413.54448 5307.280 5710.2665 54272.985</span></a></code></pre></div>
<p>The function <code>add_stub</code> used above is a <em>collapse</em> function adding a prefix (default) or suffix to variables names.</p>
<p>A slightly more elegant solution to such multi-function aggregations can be found using <code>get_vars</code>, a collapse predicate to efficiently select variables. In contrast to <code>select_at</code>, <code>get_vars</code> does not automatically add the grouping columns to the selection. Next to <code>get_vars</code>, <em>collapse</em> also introduces the predicates <code>num_vars</code>, <code>cat_vars</code>, <code>char_vars</code>, <code>fact_vars</code>, <code>logi_vars</code> and <code>Date_vars</code> to select columns by type. Finally, the predicate <code>add_vars</code> provides a more efficient alternative to <code>cbind.data.frame</code>. The idea here is ‘adding’ variables to the data.frame in the first argument i.e. the attributes of the first argument are preserved, so the expression below still gives a tibble instead of a data.frame:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb9-3" title="3">   <span class="kw">add_vars</span>(<span class="kw">group_keys</span>(.), </a>
<a class="sourceLine" id="cb9-4" title="4">            <span class="kw">ffirst</span>(<span class="kw">get_vars</span>(., <span class="st">&quot;Reg&quot;</span>, <span class="dt">regex =</span> <span class="ot">TRUE</span>)),        <span class="co"># Regular expression matching column names</span></a>
<a class="sourceLine" id="cb9-5" title="5">            <span class="kw">add_stub</span>(<span class="kw">fmean</span>(<span class="kw">num_vars</span>(.)), <span class="st">&quot;mean_&quot;</span>),           <span class="co"># num_vars selects all numeric variables</span></a>
<a class="sourceLine" id="cb9-6" title="6">            <span class="kw">add_stub</span>(<span class="kw">fmedian</span>(<span class="kw">get_vars</span>(., <span class="dv">9</span><span class="op">:</span><span class="dv">12</span>)), <span class="st">&quot;median_&quot;</span>), <span class="co"># columns 9-12</span></a>
<a class="sourceLine" id="cb9-7" title="7">            <span class="kw">add_stub</span>(<span class="kw">fmin</span>(<span class="kw">get_vars</span>(., <span class="dv">9</span><span class="op">:</span><span class="dv">10</span>)), <span class="st">&quot;min_&quot;</span>))       <span class="co"># columns 9:10</span></a>
<a class="sourceLine" id="cb9-8" title="8">  }</a>
<a class="sourceLine" id="cb9-9" title="9"><span class="co"># # A tibble: 85 x 22</span></a>
<a class="sourceLine" id="cb9-10" title="10"><span class="co">#    Variable Country Regioncode Region mean_Year mean_AGR mean_MIN mean_MAN mean_PU mean_CON mean_WRT</span></a>
<a class="sourceLine" id="cb9-11" title="11"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb9-12" title="12"><span class="co">#  1 EMP      ARG     LAM        Latin~     1980.    1420.    52.1    1932.   102.      742.    1982. </span></a>
<a class="sourceLine" id="cb9-13" title="13"><span class="co">#  2 EMP      BOL     LAM        Latin~     1980      964.    56.0     235.     5.35    123.     282. </span></a>
<a class="sourceLine" id="cb9-14" title="14"><span class="co">#  3 EMP      BRA     LAM        Latin~     1980.   17191.   206.     6991.   365.     3525.    8509. </span></a>
<a class="sourceLine" id="cb9-15" title="15"><span class="co">#  4 EMP      BWA     SSA        Sub-s~     1986.     188.    10.5      18.1    3.09     25.3     36.3</span></a>
<a class="sourceLine" id="cb9-16" title="16"><span class="co">#  5 EMP      CHL     LAM        Latin~     1981      702.   101.      625.    29.4     296.     695. </span></a>
<a class="sourceLine" id="cb9-17" title="17"><span class="co">#  6 EMP      CHN     ASI        Asia       1980.  287744.  7050.    67144.  1606.    20852.   28908. </span></a>
<a class="sourceLine" id="cb9-18" title="18"><span class="co">#  7 EMP      COL     LAM        Latin~     1980     3091.   145.     1175.    33.9     524.    2071. </span></a>
<a class="sourceLine" id="cb9-19" title="19"><span class="co">#  8 EMP      CRI     LAM        Latin~     1980.     231.     1.70    136.    14.3      57.6    157. </span></a>
<a class="sourceLine" id="cb9-20" title="20"><span class="co">#  9 EMP      DEW     EUR        Europe     1980     2490.   407.     8473.   226.     2093.    4442. </span></a>
<a class="sourceLine" id="cb9-21" title="21"><span class="co"># 10 EMP      DNK     EUR        Europe     1980.     236.     8.03    507.    13.8     171.     455. </span></a>
<a class="sourceLine" id="cb9-22" title="22"><span class="co"># # ... with 75 more rows, and 11 more variables: mean_TRA &lt;dbl&gt;, mean_FIRE &lt;dbl&gt;, mean_GOV &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb9-23" title="23"><span class="co"># #   mean_OTH &lt;dbl&gt;, mean_SUM &lt;dbl&gt;, median_PU &lt;dbl&gt;, median_CON &lt;dbl&gt;, median_WRT &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb9-24" title="24"><span class="co"># #   median_TRA &lt;dbl&gt;, min_PU &lt;dbl&gt;, min_CON &lt;dbl&gt;</span></a></code></pre></div>
<p>Another nice feature of <code>add_vars</code> is that it can also very efficiently reorder columns i.e. bind columns in a different order than they are passed. This can be done by simply specifying the positions the added columns should have in the final data.frame, and then <code>add_vars</code> shifts the first argument columns (the <code>group_keys</code> in the example below) to the right to fill in the gaps.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb10-3" title="3">   <span class="kw">add_vars</span>(<span class="kw">group_keys</span>(.), </a>
<a class="sourceLine" id="cb10-4" title="4">            <span class="kw">add_stub</span>(<span class="kw">fmean</span>(<span class="kw">get_vars</span>(., <span class="kw">c</span>(<span class="st">&quot;AGR&quot;</span>,<span class="st">&quot;SUM&quot;</span>))), <span class="st">&quot;mean_&quot;</span>), </a>
<a class="sourceLine" id="cb10-5" title="5">            <span class="kw">add_stub</span>(<span class="kw">fsd</span>(<span class="kw">get_vars</span>(., <span class="kw">c</span>(<span class="st">&quot;AGR&quot;</span>,<span class="st">&quot;SUM&quot;</span>))), <span class="st">&quot;sd_&quot;</span>), </a>
<a class="sourceLine" id="cb10-6" title="6">            <span class="dt">pos =</span> <span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">5</span>))       </a>
<a class="sourceLine" id="cb10-7" title="7">  }</a>
<a class="sourceLine" id="cb10-8" title="8"><span class="co"># # A tibble: 85 x 6</span></a>
<a class="sourceLine" id="cb10-9" title="9"><span class="co">#    Variable mean_AGR  sd_AGR mean_SUM  sd_SUM Country</span></a>
<a class="sourceLine" id="cb10-10" title="10"><span class="co">#  * &lt;chr&gt;       &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;  </span></a>
<a class="sourceLine" id="cb10-11" title="11"><span class="co">#  1 EMP         1420.   242.    10542.   3048. ARG    </span></a>
<a class="sourceLine" id="cb10-12" title="12"><span class="co">#  2 EMP          964.    92.6    2221.    947. BOL    </span></a>
<a class="sourceLine" id="cb10-13" title="13"><span class="co">#  3 EMP        17191.  1975.    54273.  25237. BRA    </span></a>
<a class="sourceLine" id="cb10-14" title="14"><span class="co">#  4 EMP          188.    31.3     394.    167. BWA    </span></a>
<a class="sourceLine" id="cb10-15" title="15"><span class="co">#  5 EMP          702.    68.6    3982.   1608. CHL    </span></a>
<a class="sourceLine" id="cb10-16" title="16"><span class="co">#  6 EMP       287744. 64477.   485820. 195284. CHN    </span></a>
<a class="sourceLine" id="cb10-17" title="17"><span class="co">#  7 EMP         3091.   710.     9892.   5265. COL    </span></a>
<a class="sourceLine" id="cb10-18" title="18"><span class="co">#  8 EMP          231.    48.7     887.    546. CRI    </span></a>
<a class="sourceLine" id="cb10-19" title="19"><span class="co">#  9 EMP         2490.  1220.    26247.   2231. DEW    </span></a>
<a class="sourceLine" id="cb10-20" title="20"><span class="co"># 10 EMP          236.   144.     2394.    223. DNK    </span></a>
<a class="sourceLine" id="cb10-21" title="21"><span class="co"># # ... with 75 more rows</span></a></code></pre></div>
<p>A much more compact solution to multi-function and multi-type aggregation with <em>dplyr</em> is offered by the function <em>collapg</em>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="co"># This aggregates numeric colums using the mean (fmean) and categorical columns with the mode (fmode)</span></a>
<a class="sourceLine" id="cb11-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span>collapg</a>
<a class="sourceLine" id="cb11-3" title="3"><span class="co"># # A tibble: 85 x 16</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="co">#    Variable Country Regioncode Region  Year    AGR    MIN    MAN     PU    CON    WRT    TRA   FIRE</span></a>
<a class="sourceLine" id="cb11-5" title="5"><span class="co">#    &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="co">#  1 EMP      ARG     LAM        Latin~ 1980. 1.42e3 5.21e1 1.93e3 1.02e2 7.42e2 1.98e3 6.49e2  628. </span></a>
<a class="sourceLine" id="cb11-7" title="7"><span class="co">#  2 EMP      BOL     LAM        Latin~ 1980  9.64e2 5.60e1 2.35e2 5.35e0 1.23e2 2.82e2 1.15e2   44.6</span></a>
<a class="sourceLine" id="cb11-8" title="8"><span class="co">#  3 EMP      BRA     LAM        Latin~ 1980. 1.72e4 2.06e2 6.99e3 3.65e2 3.52e3 8.51e3 2.05e3 4414. </span></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="co">#  4 EMP      BWA     SSA        Sub-s~ 1986. 1.88e2 1.05e1 1.81e1 3.09e0 2.53e1 3.63e1 8.36e0   15.3</span></a>
<a class="sourceLine" id="cb11-10" title="10"><span class="co">#  5 EMP      CHL     LAM        Latin~ 1981  7.02e2 1.01e2 6.25e2 2.94e1 2.96e2 6.95e2 2.58e2  272. </span></a>
<a class="sourceLine" id="cb11-11" title="11"><span class="co">#  6 EMP      CHN     ASI        Asia   1980. 2.88e5 7.05e3 6.71e4 1.61e3 2.09e4 2.89e4 1.39e4 4929. </span></a>
<a class="sourceLine" id="cb11-12" title="12"><span class="co">#  7 EMP      COL     LAM        Latin~ 1980  3.09e3 1.45e2 1.18e3 3.39e1 5.24e2 2.07e3 4.70e2  649. </span></a>
<a class="sourceLine" id="cb11-13" title="13"><span class="co">#  8 EMP      CRI     LAM        Latin~ 1980. 2.31e2 1.70e0 1.36e2 1.43e1 5.76e1 1.57e2 4.24e1   54.9</span></a>
<a class="sourceLine" id="cb11-14" title="14"><span class="co">#  9 EMP      DEW     EUR        Europe 1980  2.49e3 4.07e2 8.47e3 2.26e2 2.09e3 4.44e3 1.48e3 1689. </span></a>
<a class="sourceLine" id="cb11-15" title="15"><span class="co"># 10 EMP      DNK     EUR        Europe 1980. 2.36e2 8.03e0 5.07e2 1.38e1 1.71e2 4.55e2 1.61e2  181. </span></a>
<a class="sourceLine" id="cb11-16" title="16"><span class="co"># # ... with 75 more rows, and 3 more variables: GOV &lt;dbl&gt;, OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></a></code></pre></div>
<p>By default it aggregates numeric columns using the mean and categorical columns using the mode, and preserves the order of all columns. Changing these defaults is very easy:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="co"># This aggregates numeric colums using the median and categorical columns using the first value</span></a>
<a class="sourceLine" id="cb12-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collapg</span>(fmedian, flast)</a>
<a class="sourceLine" id="cb12-3" title="3"><span class="co"># # A tibble: 85 x 16</span></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="co">#    Variable Country Regioncode Region  Year    AGR    MIN    MAN     PU    CON    WRT    TRA   FIRE</span></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="co">#    &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb12-6" title="6"><span class="co">#  1 EMP      ARG     LAM        Latin~ 1980. 1.32e3 4.74e1 1.99e3 1.05e2 7.82e2 1.85e3 5.80e2  464. </span></a>
<a class="sourceLine" id="cb12-7" title="7"><span class="co">#  2 EMP      BOL     LAM        Latin~ 1980  9.43e2 5.35e1 1.67e2 4.46e0 6.60e1 1.32e2 9.70e1   15.3</span></a>
<a class="sourceLine" id="cb12-8" title="8"><span class="co">#  3 EMP      BRA     LAM        Latin~ 1980. 1.75e4 2.25e2 7.21e3 3.76e2 4.05e3 6.45e3 1.58e3 4355. </span></a>
<a class="sourceLine" id="cb12-9" title="9"><span class="co">#  4 EMP      BWA     SSA        Sub-s~ 1986. 1.75e2 1.22e1 1.31e1 3.71e0 1.90e1 2.11e1 6.75e0   10.4</span></a>
<a class="sourceLine" id="cb12-10" title="10"><span class="co">#  5 EMP      CHL     LAM        Latin~ 1981  6.90e2 9.39e1 6.07e2 2.58e1 2.30e2 4.84e2 2.05e2  106. </span></a>
<a class="sourceLine" id="cb12-11" title="11"><span class="co">#  6 EMP      CHN     ASI        Asia   1980. 2.94e5 8.15e3 6.18e4 1.14e3 1.06e4 1.70e4 9.56e3 4328. </span></a>
<a class="sourceLine" id="cb12-12" title="12"><span class="co">#  7 EMP      COL     LAM        Latin~ 1980  3.01e3 8.40e1 1.03e3 3.71e1 4.19e2 1.55e3 3.91e2  655. </span></a>
<a class="sourceLine" id="cb12-13" title="13"><span class="co">#  8 EMP      CRI     LAM        Latin~ 1980. 2.16e2 1.49e0 1.14e2 7.92e0 5.50e1 8.98e1 2.55e1   19.6</span></a>
<a class="sourceLine" id="cb12-14" title="14"><span class="co">#  9 EMP      DEW     EUR        Europe 1980  2.18e3 3.20e2 8.46e3 2.47e2 2.10e3 4.45e3 1.53e3 1656  </span></a>
<a class="sourceLine" id="cb12-15" title="15"><span class="co"># 10 EMP      DNK     EUR        Europe 1980. 1.87e2 3.75e0 5.08e2 1.36e1 1.65e2 4.61e2 1.61e2  169. </span></a>
<a class="sourceLine" id="cb12-16" title="16"><span class="co"># # ... with 75 more rows, and 3 more variables: GOV &lt;dbl&gt;, OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></a></code></pre></div>
<p>One can apply multiple functions to both numeric and/or categorical data:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-2" title="2"><span class="st">  </span><span class="kw">collapg</span>(<span class="kw">list</span>(fmean, fmedian), <span class="kw">list</span>(first, fmode, flast))</a>
<a class="sourceLine" id="cb13-3" title="3"><span class="co"># # A tibble: 85 x 32</span></a>
<a class="sourceLine" id="cb13-4" title="4"><span class="co">#    Variable Country first.Regioncode fmode.Regioncode flast.Regioncode first.Region fmode.Region</span></a>
<a class="sourceLine" id="cb13-5" title="5"><span class="co">#    &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;            &lt;chr&gt;            &lt;chr&gt;            &lt;chr&gt;        &lt;chr&gt;       </span></a>
<a class="sourceLine" id="cb13-6" title="6"><span class="co">#  1 EMP      ARG     LAM              LAM              LAM              Latin Ameri~ Latin Ameri~</span></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="co">#  2 EMP      BOL     LAM              LAM              LAM              Latin Ameri~ Latin Ameri~</span></a>
<a class="sourceLine" id="cb13-8" title="8"><span class="co">#  3 EMP      BRA     LAM              LAM              LAM              Latin Ameri~ Latin Ameri~</span></a>
<a class="sourceLine" id="cb13-9" title="9"><span class="co">#  4 EMP      BWA     SSA              SSA              SSA              Sub-saharan~ Sub-saharan~</span></a>
<a class="sourceLine" id="cb13-10" title="10"><span class="co">#  5 EMP      CHL     LAM              LAM              LAM              Latin Ameri~ Latin Ameri~</span></a>
<a class="sourceLine" id="cb13-11" title="11"><span class="co">#  6 EMP      CHN     ASI              ASI              ASI              Asia         Asia        </span></a>
<a class="sourceLine" id="cb13-12" title="12"><span class="co">#  7 EMP      COL     LAM              LAM              LAM              Latin Ameri~ Latin Ameri~</span></a>
<a class="sourceLine" id="cb13-13" title="13"><span class="co">#  8 EMP      CRI     LAM              LAM              LAM              Latin Ameri~ Latin Ameri~</span></a>
<a class="sourceLine" id="cb13-14" title="14"><span class="co">#  9 EMP      DEW     EUR              EUR              EUR              Europe       Europe      </span></a>
<a class="sourceLine" id="cb13-15" title="15"><span class="co"># 10 EMP      DNK     EUR              EUR              EUR              Europe       Europe      </span></a>
<a class="sourceLine" id="cb13-16" title="16"><span class="co"># # ... with 75 more rows, and 25 more variables: flast.Region &lt;chr&gt;, fmean.Year &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb13-17" title="17"><span class="co"># #   fmedian.Year &lt;dbl&gt;, fmean.AGR &lt;dbl&gt;, fmedian.AGR &lt;dbl&gt;, fmean.MIN &lt;dbl&gt;, fmedian.MIN &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb13-18" title="18"><span class="co"># #   fmean.MAN &lt;dbl&gt;, fmedian.MAN &lt;dbl&gt;, fmean.PU &lt;dbl&gt;, fmedian.PU &lt;dbl&gt;, fmean.CON &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb13-19" title="19"><span class="co"># #   fmedian.CON &lt;dbl&gt;, fmean.WRT &lt;dbl&gt;, fmedian.WRT &lt;dbl&gt;, fmean.TRA &lt;dbl&gt;, fmedian.TRA &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb13-20" title="20"><span class="co"># #   fmean.FIRE &lt;dbl&gt;, fmedian.FIRE &lt;dbl&gt;, fmean.GOV &lt;dbl&gt;, fmedian.GOV &lt;dbl&gt;, fmean.OTH &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb13-21" title="21"><span class="co"># #   fmedian.OTH &lt;dbl&gt;, fmean.SUM &lt;dbl&gt;, fmedian.SUM &lt;dbl&gt;</span></a></code></pre></div>
<p>Applying multiple functions to only numeric (or only categorical) data allows return in a long format:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="st">  </span><span class="kw">collapg</span>(<span class="kw">list</span>(fmean, fmedian), <span class="dt">cols =</span> is.numeric, <span class="dt">return =</span> <span class="st">&quot;long&quot;</span>)</a>
<a class="sourceLine" id="cb14-3" title="3"><span class="co"># # A tibble: 170 x 15</span></a>
<a class="sourceLine" id="cb14-4" title="4"><span class="co">#    Function Variable Country  Year    AGR    MIN    MAN     PU    CON    WRT    TRA   FIRE     GOV</span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="co">#    &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb14-6" title="6"><span class="co">#  1 fmean    EMP      ARG     1980. 1.42e3 5.21e1 1.93e3 1.02e2 7.42e2 1.98e3 6.49e2  628.   2043. </span></a>
<a class="sourceLine" id="cb14-7" title="7"><span class="co">#  2 fmean    EMP      BOL     1980  9.64e2 5.60e1 2.35e2 5.35e0 1.23e2 2.82e2 1.15e2   44.6    NA  </span></a>
<a class="sourceLine" id="cb14-8" title="8"><span class="co">#  3 fmean    EMP      BRA     1980. 1.72e4 2.06e2 6.99e3 3.65e2 3.52e3 8.51e3 2.05e3 4414.   5307. </span></a>
<a class="sourceLine" id="cb14-9" title="9"><span class="co">#  4 fmean    EMP      BWA     1986. 1.88e2 1.05e1 1.81e1 3.09e0 2.53e1 3.63e1 8.36e0   15.3    61.1</span></a>
<a class="sourceLine" id="cb14-10" title="10"><span class="co">#  5 fmean    EMP      CHL     1981  7.02e2 1.01e2 6.25e2 2.94e1 2.96e2 6.95e2 2.58e2  272.     NA  </span></a>
<a class="sourceLine" id="cb14-11" title="11"><span class="co">#  6 fmean    EMP      CHN     1980. 2.88e5 7.05e3 6.71e4 1.61e3 2.09e4 2.89e4 1.39e4 4929.  22669. </span></a>
<a class="sourceLine" id="cb14-12" title="12"><span class="co">#  7 fmean    EMP      COL     1980  3.09e3 1.45e2 1.18e3 3.39e1 5.24e2 2.07e3 4.70e2  649.     NA  </span></a>
<a class="sourceLine" id="cb14-13" title="13"><span class="co">#  8 fmean    EMP      CRI     1980. 2.31e2 1.70e0 1.36e2 1.43e1 5.76e1 1.57e2 4.24e1   54.9   128. </span></a>
<a class="sourceLine" id="cb14-14" title="14"><span class="co">#  9 fmean    EMP      DEW     1980  2.49e3 4.07e2 8.47e3 2.26e2 2.09e3 4.44e3 1.48e3 1689.   3945. </span></a>
<a class="sourceLine" id="cb14-15" title="15"><span class="co"># 10 fmean    EMP      DNK     1980. 2.36e2 8.03e0 5.07e2 1.38e1 1.71e2 4.55e2 1.61e2  181.    549. </span></a>
<a class="sourceLine" id="cb14-16" title="16"><span class="co"># # ... with 160 more rows, and 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></a></code></pre></div>
<p>Finally, <code>collapg</code> also makes it very easy to apply aggregator functions to certain columns only:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="st">  </span><span class="kw">collapg</span>(<span class="dt">custom =</span> <span class="kw">list</span>(<span class="dt">fmean =</span> <span class="dv">6</span><span class="op">:</span><span class="dv">8</span>, <span class="dt">fmedian =</span> <span class="dv">10</span><span class="op">:</span><span class="dv">12</span>))</a>
<a class="sourceLine" id="cb15-3" title="3"><span class="co"># # A tibble: 85 x 8</span></a>
<a class="sourceLine" id="cb15-4" title="4"><span class="co">#    Variable Country fmean.MAN fmean.PU fmean.CON fmedian.TRA fmedian.FIRE fmedian.GOV</span></a>
<a class="sourceLine" id="cb15-5" title="5"><span class="co">#    &lt;chr&gt;    &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb15-6" title="6"><span class="co">#  1 EMP      ARG        1932.    102.       742.       580.          464.       1739. </span></a>
<a class="sourceLine" id="cb15-7" title="7"><span class="co">#  2 EMP      BOL         235.      5.35     123.        97.0          15.3        NA  </span></a>
<a class="sourceLine" id="cb15-8" title="8"><span class="co">#  3 EMP      BRA        6991.    365.      3525.      1581.         4355.       4450. </span></a>
<a class="sourceLine" id="cb15-9" title="9"><span class="co">#  4 EMP      BWA          18.1     3.09      25.3        6.75         10.4        53.8</span></a>
<a class="sourceLine" id="cb15-10" title="10"><span class="co">#  5 EMP      CHL         625.     29.4      296.       205.          106.         NA  </span></a>
<a class="sourceLine" id="cb15-11" title="11"><span class="co">#  6 EMP      CHN       67144.   1606.     20852.      9564.         4328.      19468. </span></a>
<a class="sourceLine" id="cb15-12" title="12"><span class="co">#  7 EMP      COL        1175.     33.9      524.       391.          655.         NA  </span></a>
<a class="sourceLine" id="cb15-13" title="13"><span class="co">#  8 EMP      CRI         136.     14.3       57.6       25.5          19.6       122. </span></a>
<a class="sourceLine" id="cb15-14" title="14"><span class="co">#  9 EMP      DEW        8473.    226.      2093.      1525.         1656        3700  </span></a>
<a class="sourceLine" id="cb15-15" title="15"><span class="co"># 10 EMP      DNK         507.     13.8      171.       161.          169.        642. </span></a>
<a class="sourceLine" id="cb15-16" title="16"><span class="co"># # ... with 75 more rows</span></a></code></pre></div>
<p>To understand more about <code>collapg</code>, look it up in the documentation (<code>?collapg</code>).</p>
</div>
<div id="weighted-aggregations" class="section level3">
<h3>1.3 Weighted Aggregations</h3>
<p>Weighted aggregations are possible with the functions <code>fmean, fmode, fvar</code> and <code>fsd</code>. The implementation is such that by default (option <code>keep.w = TRUE</code>) these functions also aggregate the weights, so that further weighted computations can be performed on the aggregated data. <code>fmean</code>, <code>fsd</code> and <code>fvar</code> compute a grouped sum of the weight column and place it next to the group-identifiers, whereas <code>fmode</code> computes the maximum weight (corresponding to the mode).</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="co"># This compute a frequency-weighted grouped standard-deviation, taking the total EMP / VA as weight</span></a>
<a class="sourceLine" id="cb16-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="st">  </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fsd</span>(SUM)</a>
<a class="sourceLine" id="cb16-5" title="5"><span class="co"># # A tibble: 85 x 13</span></a>
<a class="sourceLine" id="cb16-6" title="6"><span class="co">#    Variable Country  sum.SUM     AGR    MIN    MAN     PU    CON    WRT    TRA   FIRE     GOV    OTH</span></a>
<a class="sourceLine" id="cb16-7" title="7"><span class="co">#    &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb16-8" title="8"><span class="co">#  1 EMP      ARG       6.54e5   225.  2.22e1 1.76e2 2.05e1 2.85e2 8.56e2 1.95e2  493.   1123.  5.06e2</span></a>
<a class="sourceLine" id="cb16-9" title="9"><span class="co">#  2 EMP      BOL       1.35e5    99.7 1.71e1 1.68e2 4.87e0 1.23e2 3.24e2 9.81e1   69.8    NA   2.58e2</span></a>
<a class="sourceLine" id="cb16-10" title="10"><span class="co">#  3 EMP      BRA       3.36e6  1587.  7.38e1 2.95e3 9.38e1 1.86e3 6.28e3 1.31e3 3003.   3621.  4.26e3</span></a>
<a class="sourceLine" id="cb16-11" title="11"><span class="co">#  4 EMP      BWA       1.85e4    32.2 3.72e0 1.48e1 1.59e0 1.80e1 3.87e1 6.02e0   13.5    39.8 8.94e0</span></a>
<a class="sourceLine" id="cb16-12" title="12"><span class="co">#  5 EMP      CHL       2.51e5    71.0 3.99e1 1.29e2 1.24e1 1.88e2 5.51e2 1.34e2  313.     NA   4.26e2</span></a>
<a class="sourceLine" id="cb16-13" title="13"><span class="co">#  6 EMP      CHN       2.91e7 56281.  3.09e3 4.04e4 1.27e3 1.92e4 2.45e4 9.26e3 2853.  11541.  3.74e4</span></a>
<a class="sourceLine" id="cb16-14" title="14"><span class="co">#  7 EMP      COL       6.03e5   637.  1.48e2 5.94e2 1.52e1 3.97e2 1.89e3 3.62e2  435.     NA   1.01e3</span></a>
<a class="sourceLine" id="cb16-15" title="15"><span class="co">#  8 EMP      CRI       5.50e4    40.4 1.04e0 7.93e1 1.37e1 3.44e1 1.68e2 4.53e1   79.8    80.7 4.34e1</span></a>
<a class="sourceLine" id="cb16-16" title="16"><span class="co">#  9 EMP      DEW       1.10e6  1175.  1.83e2 7.42e2 5.32e1 1.94e2 6.06e2 2.12e2  699.   1225.  3.55e2</span></a>
<a class="sourceLine" id="cb16-17" title="17"><span class="co"># 10 EMP      DNK       1.53e5   139.  7.45e0 7.73e1 1.92e0 2.56e1 5.33e1 1.57e1   91.6   248.  1.95e1</span></a>
<a class="sourceLine" id="cb16-18" title="18"><span class="co"># # ... with 75 more rows</span></a>
<a class="sourceLine" id="cb16-19" title="19"></a>
<a class="sourceLine" id="cb16-20" title="20"><span class="co"># This compute a weighted grouped mode, taking the total EMP / VA as weight</span></a>
<a class="sourceLine" id="cb16-21" title="21">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-22" title="22"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-23" title="23"><span class="st">  </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmode</span>(SUM)</a>
<a class="sourceLine" id="cb16-24" title="24"><span class="co"># # A tibble: 85 x 13</span></a>
<a class="sourceLine" id="cb16-25" title="25"><span class="co">#    Variable Country max.SUM     AGR     MIN     MAN     PU    CON    WRT    TRA   FIRE    GOV    OTH</span></a>
<a class="sourceLine" id="cb16-26" title="26"><span class="co">#    &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb16-27" title="27"><span class="co">#  1 EMP      ARG      17929.  1.16e3  127.    2.16e3 1.52e2 1.41e3  3768. 1.06e3 1.75e3  4336. 2.00e3</span></a>
<a class="sourceLine" id="cb16-28" title="28"><span class="co">#  2 EMP      BOL       4508.  8.19e2   37.6   6.04e2 1.08e1 4.33e2   893. 3.33e2 3.21e2    NA  1.06e3</span></a>
<a class="sourceLine" id="cb16-29" title="29"><span class="co">#  3 EMP      BRA     102572.  1.65e4  313.    1.18e4 3.88e2 8.15e3 21860. 5.17e3 1.20e4 12149. 1.42e4</span></a>
<a class="sourceLine" id="cb16-30" title="30"><span class="co">#  4 EMP      BWA        668.  1.71e2   13.1   4.33e1 3.93e0 1.81e1   129. 2.10e1 4.67e1   113. 2.62e1</span></a>
<a class="sourceLine" id="cb16-31" title="31"><span class="co">#  5 EMP      CHL       7559.  6.30e2  249.    7.42e2 6.07e1 6.71e2  1989. 4.81e2 8.54e2    NA  1.88e3</span></a>
<a class="sourceLine" id="cb16-32" title="32"><span class="co">#  6 EMP      CHN     764200   2.66e5 9247.    1.43e5 3.53e3 6.99e4 84165. 3.12e4 1.08e4 43240. 1.03e5</span></a>
<a class="sourceLine" id="cb16-33" title="33"><span class="co">#  7 EMP      COL      21114.  3.93e3  513.    2.37e3 5.89e1 1.41e3  6069. 1.36e3 1.82e3    NA  3.57e3</span></a>
<a class="sourceLine" id="cb16-34" title="34"><span class="co">#  8 EMP      CRI       2058.  2.83e2    2.42  2.49e2 4.38e1 1.20e2   489. 1.44e2 2.25e2   328. 1.75e2</span></a>
<a class="sourceLine" id="cb16-35" title="35"><span class="co">#  9 EMP      DEW      31261   1.03e3  260     8.73e3 2.91e2 2.06e3  4398  1.63e3 3.26e3  6129  1.79e3</span></a>
<a class="sourceLine" id="cb16-36" title="36"><span class="co"># 10 EMP      DNK       2823.  7.85e1    3.12  3.99e2 1.14e1 1.95e2   579. 1.87e2 3.82e2   835. 1.50e2</span></a>
<a class="sourceLine" id="cb16-37" title="37"><span class="co"># # ... with 75 more rows</span></a></code></pre></div>
<p>The weighted variance / standard deviation is currently only implemented with frequency weights. Reliability weights may be implemented in a further update of <em>collapse</em>, if this is a strongly requested feature.</p>
<p>Weighted aggregations may also be performed with <code>collapg</code>, although this does not aggregate and save the weights.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="co"># This aggregates numeric colums using the weighted mean and categorical columns using the weighted mode</span></a>
<a class="sourceLine" id="cb17-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collapg</span>(<span class="dt">w =</span> .<span class="op">$</span>SUM)</a>
<a class="sourceLine" id="cb17-3" title="3"><span class="co"># # A tibble: 85 x 16</span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="co">#    Variable Country Regioncode Region  Year    AGR    MIN    MAN     PU    CON    WRT    TRA   FIRE</span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="co">#    &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb17-6" title="6"><span class="co">#  1 EMP      ARG     LAM        Latin~ 1985. 1.36e3 5.65e1 1.93e3 1.05e2 8.11e2 2.22e3 6.95e2  754. </span></a>
<a class="sourceLine" id="cb17-7" title="7"><span class="co">#  2 EMP      BOL     LAM        Latin~ 1987. 9.77e2 5.79e1 2.96e2 7.07e0 1.67e2 4.00e2 1.52e2   67.3</span></a>
<a class="sourceLine" id="cb17-8" title="8"><span class="co">#  3 EMP      BRA     LAM        Latin~ 1989. 1.77e4 2.38e2 8.47e3 3.89e2 4.44e3 1.14e4 2.62e3 5841. </span></a>
<a class="sourceLine" id="cb17-9" title="9"><span class="co">#  4 EMP      BWA     SSA        Sub-s~ 1993. 2.00e2 1.21e1 2.43e1 3.70e0 3.14e1 5.08e1 1.08e1   20.8</span></a>
<a class="sourceLine" id="cb17-10" title="10"><span class="co">#  5 EMP      CHL     LAM        Latin~ 1988. 6.93e2 1.07e2 6.68e2 3.35e1 3.67e2 8.95e2 3.09e2  382. </span></a>
<a class="sourceLine" id="cb17-11" title="11"><span class="co">#  6 EMP      CHN     ASI        Asia   1988. 3.09e5 8.23e3 8.34e4 2.09e3 2.80e4 3.80e4 1.75e4 6048. </span></a>
<a class="sourceLine" id="cb17-12" title="12"><span class="co">#  7 EMP      COL     LAM        Latin~ 1989. 3.44e3 2.04e2 1.49e3 4.20e1 7.18e2 3.02e3 6.39e2  854. </span></a>
<a class="sourceLine" id="cb17-13" title="13"><span class="co">#  8 EMP      CRI     LAM        Latin~ 1991. 2.54e2 2.10e0 1.87e2 2.19e1 7.84e1 2.47e2 6.50e1   94.2</span></a>
<a class="sourceLine" id="cb17-14" title="14"><span class="co">#  9 EMP      DEW     EUR        Europe 1971. 2.40e3 3.95e2 8.51e3 2.29e2 2.10e3 4.49e3 1.50e3 1740. </span></a>
<a class="sourceLine" id="cb17-15" title="15"><span class="co"># 10 EMP      DNK     EUR        Europe 1981. 2.23e2 7.41e0 5.03e2 1.39e1 1.72e2 4.60e2 1.62e2  189. </span></a>
<a class="sourceLine" id="cb17-16" title="16"><span class="co"># # ... with 75 more rows, and 3 more variables: GOV &lt;dbl&gt;, OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></a></code></pre></div>
<p>Thus to aggregate the entire data and save the weights one would need to opt for a manual solution:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span>{</a>
<a class="sourceLine" id="cb18-3" title="3">    <span class="kw">add_vars</span>(<span class="kw">fmean</span>(<span class="kw">select_at</span>(., <span class="dv">6</span><span class="op">:</span><span class="dv">16</span>), SUM),      <span class="co"># Again select_at preserves grouping columns, </span></a>
<a class="sourceLine" id="cb18-4" title="4">             <span class="kw">fmode</span>(<span class="kw">get_vars</span>(., <span class="kw">c</span>(<span class="dv">2</span><span class="op">:</span><span class="dv">3</span>,<span class="dv">16</span>)), SUM),  <span class="co"># get_vars does not! Both preserve attributes</span></a>
<a class="sourceLine" id="cb18-5" title="5">             <span class="dt">pos =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">2</span><span class="op">:</span><span class="dv">3</span>))</a>
<a class="sourceLine" id="cb18-6" title="6">  }</a>
<a class="sourceLine" id="cb18-7" title="7"><span class="co"># # A tibble: 85 x 16</span></a>
<a class="sourceLine" id="cb18-8" title="8"><span class="co">#    Variable Regioncode Region Country max.SUM sum.SUM    AGR    MIN    MAN     PU    CON    WRT</span></a>
<a class="sourceLine" id="cb18-9" title="9"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb18-10" title="10"><span class="co">#  1 EMP      LAM        Latin~ ARG      17929.  6.54e5 1.36e3 5.65e1 1.93e3 1.05e2 8.11e2 2.22e3</span></a>
<a class="sourceLine" id="cb18-11" title="11"><span class="co">#  2 EMP      LAM        Latin~ BOL       4508.  1.35e5 9.77e2 5.79e1 2.96e2 7.07e0 1.67e2 4.00e2</span></a>
<a class="sourceLine" id="cb18-12" title="12"><span class="co">#  3 EMP      LAM        Latin~ BRA     102572.  3.36e6 1.77e4 2.38e2 8.47e3 3.89e2 4.44e3 1.14e4</span></a>
<a class="sourceLine" id="cb18-13" title="13"><span class="co">#  4 EMP      SSA        Sub-s~ BWA        668.  1.85e4 2.00e2 1.21e1 2.43e1 3.70e0 3.14e1 5.08e1</span></a>
<a class="sourceLine" id="cb18-14" title="14"><span class="co">#  5 EMP      LAM        Latin~ CHL       7559.  2.51e5 6.93e2 1.07e2 6.68e2 3.35e1 3.67e2 8.95e2</span></a>
<a class="sourceLine" id="cb18-15" title="15"><span class="co">#  6 EMP      ASI        Asia   CHN     764200   2.91e7 3.09e5 8.23e3 8.34e4 2.09e3 2.80e4 3.80e4</span></a>
<a class="sourceLine" id="cb18-16" title="16"><span class="co">#  7 EMP      LAM        Latin~ COL      21114.  6.03e5 3.44e3 2.04e2 1.49e3 4.20e1 7.18e2 3.02e3</span></a>
<a class="sourceLine" id="cb18-17" title="17"><span class="co">#  8 EMP      LAM        Latin~ CRI       2058.  5.50e4 2.54e2 2.10e0 1.87e2 2.19e1 7.84e1 2.47e2</span></a>
<a class="sourceLine" id="cb18-18" title="18"><span class="co">#  9 EMP      EUR        Europe DEW      31261   1.10e6 2.40e3 3.95e2 8.51e3 2.29e2 2.10e3 4.49e3</span></a>
<a class="sourceLine" id="cb18-19" title="19"><span class="co"># 10 EMP      EUR        Europe DNK       2823.  1.53e5 2.23e2 7.41e0 5.03e2 1.39e1 1.72e2 4.60e2</span></a>
<a class="sourceLine" id="cb18-20" title="20"><span class="co"># # ... with 75 more rows, and 4 more variables: TRA &lt;dbl&gt;, FIRE &lt;dbl&gt;, GOV &lt;dbl&gt;, OTH &lt;dbl&gt;</span></a></code></pre></div>
<!-- ```{r} -->
<!-- GGDC10S %>%  -->
<!--   group_by(Variable,Country) %>% collapg(w = .$SUM) -->
<!-- ``` -->
</div>
<div id="benchmarks" class="section level3">
<h3>Benchmarks</h3>
<p>Below I provide a set of benchmarks for the standard set of functions commonly used in aggregations. For this purpose I duplicate and row-bind the <code>GGDC10S</code> dataset used so far 200 times to yield a dataset of approx. 1 million observations, while keeping the groups unique. My windows laptop on which these benchmarks were run has a 2x 2.2 GHZ Intel i5 processor, 8GB DDR3 RAM and a Samsung SSD hard drive (so a decent laptop but nothing fancy).</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="co"># This replicates the data 200 times while keeping Country and Variable (columns 1 and 4) unique</span></a>
<a class="sourceLine" id="cb19-2" title="2">data &lt;-<span class="st"> </span><span class="kw">replicate</span>(<span class="dv">200</span>, GGDC10S, <span class="dt">simplify =</span> <span class="ot">FALSE</span>) <span class="co"># gv and gv&lt;- are shortcuts for get_vars and get_vars&lt;-</span></a>
<a class="sourceLine" id="cb19-3" title="3">uniquify &lt;-<span class="st"> </span><span class="cf">function</span>(x, i) <span class="st">`</span><span class="dt">gv&lt;-</span><span class="st">`</span>(x, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>), <span class="dt">value =</span> <span class="kw">lapply</span>(<span class="kw">gv</span>(x, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>)), paste0, i))</a>
<a class="sourceLine" id="cb19-4" title="4">data &lt;-<span class="st"> </span><span class="kw">unlist2d</span>(<span class="kw">Map</span>(uniquify, data, <span class="kw">as.list</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">200</span>)), <span class="dt">idcols =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb19-5" title="5"></a>
<a class="sourceLine" id="cb19-6" title="6"><span class="kw">dim</span>(data)</a>
<a class="sourceLine" id="cb19-7" title="7"><span class="co"># [1] 1005400      16</span></a>
<a class="sourceLine" id="cb19-8" title="8"><span class="kw">GRP</span>(data, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>))<span class="op">$</span>N.groups <span class="co"># This shows the number of groups. </span></a>
<a class="sourceLine" id="cb19-9" title="9"><span class="co"># [1] 17000</span></a>
<a class="sourceLine" id="cb19-10" title="10"></a>
<a class="sourceLine" id="cb19-11" title="11"><span class="co"># Grouping: This is still a key bottleneck of dplyr compared to data.table and collapse</span></a>
<a class="sourceLine" id="cb19-12" title="12"><span class="kw">system.time</span>(<span class="kw">group_by</span>(data,Variable,Country))</a>
<a class="sourceLine" id="cb19-13" title="13"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-14" title="14"><span class="co">#    0.14    0.00    0.14</span></a>
<a class="sourceLine" id="cb19-15" title="15"><span class="kw">system.time</span>(<span class="kw">GRP</span>(data, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>)))               </a>
<a class="sourceLine" id="cb19-16" title="16"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-17" title="17"><span class="co">#    0.04    0.00    0.05</span></a>
<a class="sourceLine" id="cb19-18" title="18"></a>
<a class="sourceLine" id="cb19-19" title="19"><span class="kw">library</span>(microbenchmark)</a>
<a class="sourceLine" id="cb19-20" title="20"></a>
<a class="sourceLine" id="cb19-21" title="21"><span class="co"># Selection </span></a>
<a class="sourceLine" id="cb19-22" title="22"><span class="kw">microbenchmark</span>(<span class="kw">select_at</span>(data, <span class="dv">6</span><span class="op">:</span><span class="dv">16</span>))</a>
<a class="sourceLine" id="cb19-23" title="23"><span class="co"># Unit: milliseconds</span></a>
<a class="sourceLine" id="cb19-24" title="24"><span class="co">#                   expr     min       lq     mean   median       uq      max neval</span></a>
<a class="sourceLine" id="cb19-25" title="25"><span class="co">#  select_at(data, 6:16) 11.5846 11.74948 12.32206 11.99961 12.48735 15.25186   100</span></a>
<a class="sourceLine" id="cb19-26" title="26"><span class="kw">microbenchmark</span>(<span class="kw">get_vars</span>(data, <span class="dv">6</span><span class="op">:</span><span class="dv">16</span>))</a>
<a class="sourceLine" id="cb19-27" title="27"><span class="co"># Unit: microseconds</span></a>
<a class="sourceLine" id="cb19-28" title="28"><span class="co">#                  expr   min    lq    mean median    uq    max neval</span></a>
<a class="sourceLine" id="cb19-29" title="29"><span class="co">#  get_vars(data, 6:16) 7.586 8.479 9.07241  8.479 8.925 44.178   100</span></a>
<a class="sourceLine" id="cb19-30" title="30"></a>
<a class="sourceLine" id="cb19-31" title="31">data &lt;-<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>)</a>
<a class="sourceLine" id="cb19-32" title="32"></a>
<a class="sourceLine" id="cb19-33" title="33"><span class="co"># Conversion of Grouping object: This time is also required in all computations below using collapse fast functions</span></a>
<a class="sourceLine" id="cb19-34" title="34"><span class="kw">microbenchmark</span>(<span class="kw">GRP</span>(data)) </a>
<a class="sourceLine" id="cb19-35" title="35"><span class="co"># Unit: milliseconds</span></a>
<a class="sourceLine" id="cb19-36" title="36"><span class="co">#       expr      min       lq     mean   median       uq      max neval</span></a>
<a class="sourceLine" id="cb19-37" title="37"><span class="co">#  GRP(data) 2.947021 4.238463 4.817924 4.545704 4.588767 25.67264   100</span></a>
<a class="sourceLine" id="cb19-38" title="38"></a>
<a class="sourceLine" id="cb19-39" title="39"><span class="co"># Sum </span></a>
<a class="sourceLine" id="cb19-40" title="40"><span class="kw">system.time</span>(<span class="kw">fsum</span>(data))</a>
<a class="sourceLine" id="cb19-41" title="41"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-42" title="42"><span class="co">#    0.04    0.00    0.04</span></a>
<a class="sourceLine" id="cb19-43" title="43"><span class="kw">system.time</span>(<span class="kw">summarise_all</span>(data, sum, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb19-44" title="44"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-45" title="45"><span class="co">#     0.1     0.0     0.1</span></a>
<a class="sourceLine" id="cb19-46" title="46"></a>
<a class="sourceLine" id="cb19-47" title="47"><span class="co"># Product</span></a>
<a class="sourceLine" id="cb19-48" title="48"><span class="kw">system.time</span>(<span class="kw">fprod</span>(data))</a>
<a class="sourceLine" id="cb19-49" title="49"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-50" title="50"><span class="co">#    0.05    0.00    0.04</span></a>
<a class="sourceLine" id="cb19-51" title="51"><span class="kw">system.time</span>(<span class="kw">summarise_all</span>(data, prod, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb19-52" title="52"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-53" title="53"><span class="co">#    0.45    0.00    0.45</span></a>
<a class="sourceLine" id="cb19-54" title="54"></a>
<a class="sourceLine" id="cb19-55" title="55"><span class="co"># Mean</span></a>
<a class="sourceLine" id="cb19-56" title="56"><span class="kw">system.time</span>(<span class="kw">fmean</span>(data))</a>
<a class="sourceLine" id="cb19-57" title="57"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-58" title="58"><span class="co">#    0.05    0.00    0.04</span></a>
<a class="sourceLine" id="cb19-59" title="59"><span class="kw">system.time</span>(<span class="kw">summarise_all</span>(data, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb19-60" title="60"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-61" title="61"><span class="co">#    1.92    0.01    1.94</span></a>
<a class="sourceLine" id="cb19-62" title="62"></a>
<a class="sourceLine" id="cb19-63" title="63"><span class="co"># Weighted Mean</span></a>
<a class="sourceLine" id="cb19-64" title="64"><span class="kw">system.time</span>(<span class="kw">fmean</span>(data, SUM)) <span class="co"># This cannot easily be performed in dplyr</span></a>
<a class="sourceLine" id="cb19-65" title="65"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-66" title="66"><span class="co">#    0.07    0.00    0.06</span></a>
<a class="sourceLine" id="cb19-67" title="67"></a>
<a class="sourceLine" id="cb19-68" title="68"><span class="co"># Median</span></a>
<a class="sourceLine" id="cb19-69" title="69"><span class="kw">system.time</span>(<span class="kw">fmedian</span>(data))</a>
<a class="sourceLine" id="cb19-70" title="70"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-71" title="71"><span class="co">#    0.08    0.00    0.08</span></a>
<a class="sourceLine" id="cb19-72" title="72"><span class="kw">system.time</span>(<span class="kw">summarise_all</span>(data, median, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb19-73" title="73"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-74" title="74"><span class="co">#    8.72    0.00    8.72</span></a>
<a class="sourceLine" id="cb19-75" title="75"></a>
<a class="sourceLine" id="cb19-76" title="76"><span class="co"># Standard-Deviation</span></a>
<a class="sourceLine" id="cb19-77" title="77"><span class="kw">system.time</span>(<span class="kw">fsd</span>(data))</a>
<a class="sourceLine" id="cb19-78" title="78"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-79" title="79"><span class="co">#    0.08    0.01    0.09</span></a>
<a class="sourceLine" id="cb19-80" title="80"><span class="kw">system.time</span>(<span class="kw">summarise_all</span>(data, sd, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb19-81" title="81"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-82" title="82"><span class="co">#    3.18    0.00    3.17</span></a>
<a class="sourceLine" id="cb19-83" title="83"></a>
<a class="sourceLine" id="cb19-84" title="84"><span class="co"># Weighted Standard-Deviation</span></a>
<a class="sourceLine" id="cb19-85" title="85"><span class="kw">system.time</span>(<span class="kw">fsd</span>(data, SUM))</a>
<a class="sourceLine" id="cb19-86" title="86"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-87" title="87"><span class="co">#    0.08    0.00    0.07</span></a>
<a class="sourceLine" id="cb19-88" title="88"></a>
<a class="sourceLine" id="cb19-89" title="89"><span class="co"># Maximum</span></a>
<a class="sourceLine" id="cb19-90" title="90"><span class="kw">system.time</span>(<span class="kw">fmax</span>(data))</a>
<a class="sourceLine" id="cb19-91" title="91"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-92" title="92"><span class="co">#    0.03    0.00    0.03</span></a>
<a class="sourceLine" id="cb19-93" title="93"><span class="kw">system.time</span>(<span class="kw">summarise_all</span>(data, max, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb19-94" title="94"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-95" title="95"><span class="co">#    0.04    0.00    0.05</span></a>
<a class="sourceLine" id="cb19-96" title="96"></a>
<a class="sourceLine" id="cb19-97" title="97"><span class="co"># First Value</span></a>
<a class="sourceLine" id="cb19-98" title="98"><span class="kw">system.time</span>(<span class="kw">ffirst</span>(data, <span class="dt">na.rm =</span> <span class="ot">FALSE</span>))</a>
<a class="sourceLine" id="cb19-99" title="99"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-100" title="100"><span class="co">#    0.03    0.00    0.03</span></a>
<a class="sourceLine" id="cb19-101" title="101"><span class="kw">system.time</span>(<span class="kw">summarise_all</span>(data, first))</a>
<a class="sourceLine" id="cb19-102" title="102"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-103" title="103"><span class="co">#    0.60    0.00    0.59</span></a>
<a class="sourceLine" id="cb19-104" title="104"></a>
<a class="sourceLine" id="cb19-105" title="105"><span class="co"># Distinct Values</span></a>
<a class="sourceLine" id="cb19-106" title="106"><span class="kw">system.time</span>(<span class="kw">fNdistinct</span>(data))</a>
<a class="sourceLine" id="cb19-107" title="107"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-108" title="108"><span class="co">#    0.25    0.08    0.33</span></a>
<a class="sourceLine" id="cb19-109" title="109"><span class="kw">system.time</span>(<span class="kw">summarise_all</span>(data, n_distinct, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb19-110" title="110"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-111" title="111"><span class="co">#    2.33    0.00    2.33</span></a>
<a class="sourceLine" id="cb19-112" title="112"></a>
<a class="sourceLine" id="cb19-113" title="113"><span class="co"># Mode</span></a>
<a class="sourceLine" id="cb19-114" title="114"><span class="kw">system.time</span>(<span class="kw">fmode</span>(data))</a>
<a class="sourceLine" id="cb19-115" title="115"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-116" title="116"><span class="co">#    0.23    0.11    0.34</span></a>
<a class="sourceLine" id="cb19-117" title="117"></a>
<a class="sourceLine" id="cb19-118" title="118"><span class="co"># Weighted Mode</span></a>
<a class="sourceLine" id="cb19-119" title="119"><span class="kw">system.time</span>(<span class="kw">fmode</span>(data, SUM))</a>
<a class="sourceLine" id="cb19-120" title="120"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb19-121" title="121"><span class="co">#    0.36    0.11    0.47</span></a></code></pre></div>
<p>The benchmarks show that at this data size efficient primitives like <code>base::sum</code> or <code>base::max</code> can still deliver very decent performance with <code>summarize</code>. Less optimized base functions like <code>mean</code>, <code>median</code> and <code>sd</code> however take multiple seconds to compute, and here <code>collapse</code> fast functions really prove to be very useful complements to the <em>dplyr</em> system.</p>
<p>Weighted statistics are also performed extremely fast by <em>collapse</em> functions. I would not know how to compute weighted statistics by groups in <em>dplyr</em>, as it would require the weighting variable to be split as well, which seems impossible in native <em>dplyr</em>.</p>
<p>A further highlight of <em>collapse</em> is the extremely fast statistical mode function, which can also compute a weighted mode. Fast categorical aggregation has been an issue in R, and defining a mode function from base R and applying it to 17000 groups will probably let it run at least a minute. <code>fmode</code> reduces this time to half a second.</p>
<p>Thus in terms of data aggregation <em>collapse</em> fast functions are able to speed up <em>dplyr</em> to a level that makes it attractive again to R users working on medium-sized or larger data, and everyone programming with <em>dplyr</em>. I however strongly recommend <em>collapse</em> itself for easy and speedy programming as it does not rely on non-standard evaluation and has less R-overhead than <em>dplyr</em>.</p>
<p>In all of this the grouping system of <em>dplyr</em> remains the central bottleneck. For example grouping 10 million observations in 1 million groups takes around 10 second with <code>group_by</code>, whereas <code>GRP</code> takes around 1.5 seconds, and this difference grows exponentially as data get larger. Rewriting <code>group_by</code> using <code>GRP</code> / <em>data.table</em>’s <code>forderv</code> and then writing a simple C++ conversion program for the grouping object could be a quick remedy for this issue, but that is at the discretion of Hadley Wickham and coauthors. <!-- (If you need that speed program with *collapse* or use *data.table* with GeForce optimized functions). --></p>
</div>
</div>
<div id="fast-transformations" class="section level2">
<h2>2. Fast Transformations</h2>
<p>Fast aggregation’s are just the tip of the iceberg compared to what <em>collapse</em> can bring to <em>dplyr</em> in terms of grouped transformations.</p>
<div id="replacing-and-sweeping-out-statistics" class="section level3">
<h3>2.1 Replacing and Sweeping out Statistics</h3>
<!-- using Fast Statistical Functions -->
<p>All statistical (scalar-valued) functions in the collapse package (<code>fsum, fprod, fmean, fmedian, fmode, fvar, fsd, fmin, fmax, ffirst, flast, fNobs, fNdistinct</code>) have a <code>TRA</code> argument which can be used to efficiently transforms data by either (column-wise) replacing data values with supplied statistics or sweeping the statistics out of the data. Operations can be specified using either an integer or quoted operator / string. The 8 operations supported by <code>TRA</code> are:</p>
<ul>
<li><p>1 - “replace_fill” : replace and overwrite missing values</p></li>
<li><p>2 - “replace” : replace but preserve missing values</p></li>
<li><p>3 - “-” : subtract (center)</p></li>
<li><p>4 - “-+” : subtract group-statistics but add average of group statistics</p></li>
<li><p>5 - “/” : divide (scale)</p></li>
<li><p>6 - “%” : compute percentages (divide and multiply by 100)</p></li>
<li><p>7 - “+” : add</p></li>
<li><p>8 - &quot;*&quot; : multiply</p></li>
</ul>
<p>For functions supporting weights (<code>fmean, fmode, fvar</code> and <code>fsd</code>) the <code>TRA</code> argument is in the third position following the data and weight vector (in the <em>grouped_df</em> method), whereas functions not supporting weights have the argument in the second position.</p>
<p>Simple transformations are again straightforward to specify:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1"><span class="co"># This subtracts the median value from all data points i.e. centers on the median</span></a>
<a class="sourceLine" id="cb20-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span>num_vars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmedian</span>(<span class="dt">TRA =</span> <span class="st">&quot;-&quot;</span>)</a>
<a class="sourceLine" id="cb20-3" title="3"><span class="co"># # A tibble: 5,027 x 12</span></a>
<a class="sourceLine" id="cb20-4" title="4"><span class="co">#     Year    AGR   MIN    MAN    PU    CON    WRT    TRA  FIRE    GOV    OTH     SUM</span></a>
<a class="sourceLine" id="cb20-5" title="5"><span class="co">#  * &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb20-6" title="6"><span class="co">#  1   -22    NA    NA     NA    NA     NA     NA     NA    NA     NA     NA      NA </span></a>
<a class="sourceLine" id="cb20-7" title="7"><span class="co">#  2   -21    NA    NA     NA    NA     NA     NA     NA    NA     NA     NA      NA </span></a>
<a class="sourceLine" id="cb20-8" title="8"><span class="co">#  3   -20    NA    NA     NA    NA     NA     NA     NA    NA     NA     NA      NA </span></a>
<a class="sourceLine" id="cb20-9" title="9"><span class="co">#  4   -19    NA    NA     NA    NA     NA     NA     NA    NA     NA     NA      NA </span></a>
<a class="sourceLine" id="cb20-10" title="10"><span class="co">#  5   -18 -4378. -170. -3717. -168. -1473. -3767. -1173. -959. -3924. -1431. -23149.</span></a>
<a class="sourceLine" id="cb20-11" title="11"><span class="co">#  6   -17 -4379. -171. -3717. -168. -1472. -3767. -1173. -959. -3923. -1430. -23147.</span></a>
<a class="sourceLine" id="cb20-12" title="12"><span class="co">#  7   -16 -4377. -171. -3717. -168. -1472. -3765. -1173. -959. -3922. -1430. -23143.</span></a>
<a class="sourceLine" id="cb20-13" title="13"><span class="co">#  8   -15 -4375. -171. -3717. -168. -1473. -3769. -1173. -959. -3921. -1430. -23145.</span></a>
<a class="sourceLine" id="cb20-14" title="14"><span class="co">#  9   -14 -4373. -171. -3717. -168. -1472. -3768. -1172. -959. -3923. -1431. -23145.</span></a>
<a class="sourceLine" id="cb20-15" title="15"><span class="co"># 10   -13 -4373. -168. -3716. -167. -1470. -3768. -1172. -959. -3923. -1431. -23135.</span></a>
<a class="sourceLine" id="cb20-16" title="16"><span class="co"># # ... with 5,017 more rows</span></a>
<a class="sourceLine" id="cb20-17" title="17"></a>
<a class="sourceLine" id="cb20-18" title="18"><span class="co"># This replaces all data points with the mode</span></a>
<a class="sourceLine" id="cb20-19" title="19">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span>char_vars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmode</span>(<span class="dt">TRA =</span> <span class="st">&quot;replace&quot;</span>)</a>
<a class="sourceLine" id="cb20-20" title="20"><span class="co"># # A tibble: 5,027 x 4</span></a>
<a class="sourceLine" id="cb20-21" title="21"><span class="co">#    Country Regioncode Region Variable</span></a>
<a class="sourceLine" id="cb20-22" title="22"><span class="co">#  * &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;   </span></a>
<a class="sourceLine" id="cb20-23" title="23"><span class="co">#  1 USA     ASI        Asia   EMP     </span></a>
<a class="sourceLine" id="cb20-24" title="24"><span class="co">#  2 USA     ASI        Asia   EMP     </span></a>
<a class="sourceLine" id="cb20-25" title="25"><span class="co">#  3 USA     ASI        Asia   EMP     </span></a>
<a class="sourceLine" id="cb20-26" title="26"><span class="co">#  4 USA     ASI        Asia   EMP     </span></a>
<a class="sourceLine" id="cb20-27" title="27"><span class="co">#  5 USA     ASI        Asia   EMP     </span></a>
<a class="sourceLine" id="cb20-28" title="28"><span class="co">#  6 USA     ASI        Asia   EMP     </span></a>
<a class="sourceLine" id="cb20-29" title="29"><span class="co">#  7 USA     ASI        Asia   EMP     </span></a>
<a class="sourceLine" id="cb20-30" title="30"><span class="co">#  8 USA     ASI        Asia   EMP     </span></a>
<a class="sourceLine" id="cb20-31" title="31"><span class="co">#  9 USA     ASI        Asia   EMP     </span></a>
<a class="sourceLine" id="cb20-32" title="32"><span class="co"># 10 USA     ASI        Asia   EMP     </span></a>
<a class="sourceLine" id="cb20-33" title="33"><span class="co"># # ... with 5,017 more rows</span></a></code></pre></div>
<p>We can also easily specify code to demean, scale or compute percentages<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> by groups:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="co"># Demeaning sectoral data by Variable and Country (within transformation)</span></a>
<a class="sourceLine" id="cb21-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="st">  </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmean</span>(<span class="dt">TRA =</span> <span class="st">&quot;-&quot;</span>)</a>
<a class="sourceLine" id="cb21-5" title="5"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb21-6" title="6"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="co">#    Variable Country   AGR    MIN   MAN    PU   CON    WRT   TRA   FIRE    GOV   OTH     SUM</span></a>
<a class="sourceLine" id="cb21-8" title="8"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb21-9" title="9"><span class="co">#  1 VA       BWA       NA     NA    NA    NA    NA     NA    NA     NA     NA    NA      NA </span></a>
<a class="sourceLine" id="cb21-10" title="10"><span class="co">#  2 VA       BWA       NA     NA    NA    NA    NA     NA    NA     NA     NA    NA      NA </span></a>
<a class="sourceLine" id="cb21-11" title="11"><span class="co">#  3 VA       BWA       NA     NA    NA    NA    NA     NA    NA     NA     NA    NA      NA </span></a>
<a class="sourceLine" id="cb21-12" title="12"><span class="co">#  4 VA       BWA       NA     NA    NA    NA    NA     NA    NA     NA     NA    NA      NA </span></a>
<a class="sourceLine" id="cb21-13" title="13"><span class="co">#  5 VA       BWA     -446. -4505. -941. -216. -895. -1942. -634. -1358. -2368. -771. -14074.</span></a>
<a class="sourceLine" id="cb21-14" title="14"><span class="co">#  6 VA       BWA     -446. -4506. -941. -216. -894. -1941. -633. -1357. -2367. -770. -14072.</span></a>
<a class="sourceLine" id="cb21-15" title="15"><span class="co">#  7 VA       BWA     -444. -4507. -941. -216. -894. -1940. -633. -1357. -2366. -770. -14069.</span></a>
<a class="sourceLine" id="cb21-16" title="16"><span class="co">#  8 VA       BWA     -443. -4506. -941. -216. -894. -1944. -634. -1357. -2366. -770. -14070.</span></a>
<a class="sourceLine" id="cb21-17" title="17"><span class="co">#  9 VA       BWA     -441. -4507. -941. -216. -894. -1943. -633. -1358. -2368. -771. -14071.</span></a>
<a class="sourceLine" id="cb21-18" title="18"><span class="co"># 10 VA       BWA     -440. -4503. -939. -216. -892. -1942. -633. -1357. -2367. -770. -14061.</span></a>
<a class="sourceLine" id="cb21-19" title="19"><span class="co"># # ... with 5,017 more rows</span></a>
<a class="sourceLine" id="cb21-20" title="20"></a>
<a class="sourceLine" id="cb21-21" title="21"><span class="co"># Scaling sectoral data by Variable and Country</span></a>
<a class="sourceLine" id="cb21-22" title="22">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-23" title="23"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-24" title="24"><span class="st">    </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fsd</span>(<span class="dt">TRA =</span> <span class="st">&quot;/&quot;</span>)</a>
<a class="sourceLine" id="cb21-25" title="25"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb21-26" title="26"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb21-27" title="27"><span class="co">#    Variable Country     AGR      MIN      MAN       PU      CON      WRT      TRA     FIRE      GOV</span></a>
<a class="sourceLine" id="cb21-28" title="28"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb21-29" title="29"><span class="co">#  1 VA       BWA     NA      NA       NA       NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb21-30" title="30"><span class="co">#  2 VA       BWA     NA      NA       NA       NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb21-31" title="31"><span class="co">#  3 VA       BWA     NA      NA       NA       NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb21-32" title="32"><span class="co">#  4 VA       BWA     NA      NA       NA       NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb21-33" title="33"><span class="co">#  5 VA       BWA      0.0270  5.56e-4  5.23e-4  3.88e-4  5.11e-4  0.00194  0.00154  5.23e-4  0.00134</span></a>
<a class="sourceLine" id="cb21-34" title="34"><span class="co">#  6 VA       BWA      0.0260  3.97e-4  7.23e-4  5.03e-4  1.04e-3  0.00220  0.00180  5.83e-4  0.00158</span></a>
<a class="sourceLine" id="cb21-35" title="35"><span class="co">#  7 VA       BWA      0.0293  3.13e-4  5.71e-4  7.54e-4  1.04e-3  0.00257  0.00200  6.35e-4  0.00176</span></a>
<a class="sourceLine" id="cb21-36" title="36"><span class="co">#  8 VA       BWA      0.0317  3.66e-4  6.66e-4  7.54e-4  6.94e-4  0.00134  0.00160  7.19e-4  0.00195</span></a>
<a class="sourceLine" id="cb21-37" title="37"><span class="co">#  9 VA       BWA      0.0349  2.93e-4  5.33e-4  7.54e-4  9.42e-4  0.00161  0.00227  4.83e-4  0.00139</span></a>
<a class="sourceLine" id="cb21-38" title="38"><span class="co"># 10 VA       BWA      0.0362  8.34e-4  1.52e-3  2.15e-3  2.69e-3  0.00179  0.00253  5.77e-4  0.00155</span></a>
<a class="sourceLine" id="cb21-39" title="39"><span class="co"># # ... with 5,017 more rows, and 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb21-40" title="40"></a>
<a class="sourceLine" id="cb21-41" title="41"><span class="co"># Computing sercentages of sectoral data by Variable and Country</span></a>
<a class="sourceLine" id="cb21-42" title="42">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-43" title="43"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-44" title="44"><span class="st">    </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fsum</span>(<span class="st">&quot;%&quot;</span>)</a>
<a class="sourceLine" id="cb21-45" title="45"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb21-46" title="46"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb21-47" title="47"><span class="co">#    Variable Country     AGR      MIN      MAN       PU      CON      WRT      TRA     FIRE      GOV</span></a>
<a class="sourceLine" id="cb21-48" title="48"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb21-49" title="49"><span class="co">#  1 VA       BWA     NA      NA       NA       NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb21-50" title="50"><span class="co">#  2 VA       BWA     NA      NA       NA       NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb21-51" title="51"><span class="co">#  3 VA       BWA     NA      NA       NA       NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb21-52" title="52"><span class="co">#  4 VA       BWA     NA      NA       NA       NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb21-53" title="53"><span class="co">#  5 VA       BWA      0.0750  1.65e-3  0.00166  0.00103  0.00157  0.00682  0.00556  0.00175  0.00432</span></a>
<a class="sourceLine" id="cb21-54" title="54"><span class="co">#  6 VA       BWA      0.0724  1.18e-3  0.00230  0.00133  0.00320  0.00772  0.00649  0.00195  0.00511</span></a>
<a class="sourceLine" id="cb21-55" title="55"><span class="co">#  7 VA       BWA      0.0814  9.30e-4  0.00182  0.00199  0.00320  0.00903  0.00722  0.00213  0.00571</span></a>
<a class="sourceLine" id="cb21-56" title="56"><span class="co">#  8 VA       BWA      0.0881  1.08e-3  0.00212  0.00199  0.00213  0.00471  0.00577  0.00241  0.00631</span></a>
<a class="sourceLine" id="cb21-57" title="57"><span class="co">#  9 VA       BWA      0.0971  8.68e-4  0.00170  0.00199  0.00289  0.00565  0.00818  0.00162  0.00451</span></a>
<a class="sourceLine" id="cb21-58" title="58"><span class="co"># 10 VA       BWA      0.101   2.47e-3  0.00483  0.00568  0.00825  0.00628  0.00910  0.00193  0.00501</span></a>
<a class="sourceLine" id="cb21-59" title="59"><span class="co"># # ... with 5,017 more rows, and 2 more variables: OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></a></code></pre></div>
<p>Weighted demeaning and scaling can be computed using:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1"><span class="co"># Weighted demeaning (within transformation)</span></a>
<a class="sourceLine" id="cb22-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-4" title="4"><span class="st">  </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmean</span>(SUM, <span class="st">&quot;-&quot;</span>)</a>
<a class="sourceLine" id="cb22-5" title="5"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb22-6" title="6"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb22-7" title="7"><span class="co">#    Variable Country   SUM    AGR     MIN    MAN    PU    CON    WRT    TRA   FIRE    GOV    OTH</span></a>
<a class="sourceLine" id="cb22-8" title="8"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb22-9" title="9"><span class="co">#  1 VA       BWA      NA      NA      NA     NA    NA     NA     NA     NA     NA     NA     NA </span></a>
<a class="sourceLine" id="cb22-10" title="10"><span class="co">#  2 VA       BWA      NA      NA      NA     NA    NA     NA     NA     NA     NA     NA     NA </span></a>
<a class="sourceLine" id="cb22-11" title="11"><span class="co">#  3 VA       BWA      NA      NA      NA     NA    NA     NA     NA     NA     NA     NA     NA </span></a>
<a class="sourceLine" id="cb22-12" title="12"><span class="co">#  4 VA       BWA      NA      NA      NA     NA    NA     NA     NA     NA     NA     NA     NA </span></a>
<a class="sourceLine" id="cb22-13" title="13"><span class="co">#  5 VA       BWA      37.5 -1301. -13317. -2965. -529. -2746. -6540. -2157. -4431. -7551. -2613.</span></a>
<a class="sourceLine" id="cb22-14" title="14"><span class="co">#  6 VA       BWA      39.3 -1302. -13318. -2964. -529. -2745. -6540. -2156. -4431. -7550. -2613.</span></a>
<a class="sourceLine" id="cb22-15" title="15"><span class="co">#  7 VA       BWA      43.1 -1300. -13319. -2965. -528. -2745. -6538. -2156. -4431. -7550. -2612.</span></a>
<a class="sourceLine" id="cb22-16" title="16"><span class="co">#  8 VA       BWA      41.4 -1298. -13318. -2964. -528. -2746. -6542. -2156. -4431. -7549. -2612.</span></a>
<a class="sourceLine" id="cb22-17" title="17"><span class="co">#  9 VA       BWA      41.1 -1296. -13319. -2965. -528. -2745. -6541. -2156. -4431. -7551. -2613.</span></a>
<a class="sourceLine" id="cb22-18" title="18"><span class="co"># 10 VA       BWA      51.2 -1296. -13315. -2963. -528. -2743. -6541. -2155. -4431. -7550. -2613.</span></a>
<a class="sourceLine" id="cb22-19" title="19"><span class="co"># # ... with 5,017 more rows</span></a>
<a class="sourceLine" id="cb22-20" title="20"></a>
<a class="sourceLine" id="cb22-21" title="21"><span class="co"># Weighted scaling</span></a>
<a class="sourceLine" id="cb22-22" title="22">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-23" title="23"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-24" title="24"><span class="st">  </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fsd</span>(SUM, <span class="st">&quot;/&quot;</span>)</a>
<a class="sourceLine" id="cb22-25" title="25"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb22-26" title="26"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb22-27" title="27"><span class="co">#    Variable Country   SUM     AGR      MIN      MAN       PU      CON      WRT      TRA     FIRE</span></a>
<a class="sourceLine" id="cb22-28" title="28"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb22-29" title="29"><span class="co">#  1 VA       BWA      NA   NA      NA       NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb22-30" title="30"><span class="co">#  2 VA       BWA      NA   NA      NA       NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb22-31" title="31"><span class="co">#  3 VA       BWA      NA   NA      NA       NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb22-32" title="32"><span class="co">#  4 VA       BWA      NA   NA      NA       NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb22-33" title="33"><span class="co">#  5 VA       BWA      37.5  0.0221  5.29e-4  4.49e-4  4.71e-4  4.56e-4  0.00155  0.00117  4.63e-4</span></a>
<a class="sourceLine" id="cb22-34" title="34"><span class="co">#  6 VA       BWA      39.3  0.0214  3.78e-4  6.21e-4  6.10e-4  9.30e-4  0.00175  0.00137  5.15e-4</span></a>
<a class="sourceLine" id="cb22-35" title="35"><span class="co">#  7 VA       BWA      43.1  0.0240  2.98e-4  4.90e-4  9.15e-4  9.30e-4  0.00205  0.00152  5.62e-4</span></a>
<a class="sourceLine" id="cb22-36" title="36"><span class="co">#  8 VA       BWA      41.4  0.0260  3.48e-4  5.72e-4  9.15e-4  6.20e-4  0.00107  0.00122  6.35e-4</span></a>
<a class="sourceLine" id="cb22-37" title="37"><span class="co">#  9 VA       BWA      41.1  0.0287  2.78e-4  4.57e-4  9.15e-4  8.41e-4  0.00128  0.00173  4.27e-4</span></a>
<a class="sourceLine" id="cb22-38" title="38"><span class="co"># 10 VA       BWA      51.2  0.0297  7.93e-4  1.30e-3  2.61e-3  2.40e-3  0.00143  0.00192  5.10e-4</span></a>
<a class="sourceLine" id="cb22-39" title="39"><span class="co"># # ... with 5,017 more rows, and 2 more variables: GOV &lt;dbl&gt;, OTH &lt;dbl&gt;</span></a></code></pre></div>
<p>Alternatively we could also replace data points with their groupwise weighted mean or standard deviation:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1"><span class="co"># This conducts a weighted between transformation (replacing with weighted mean)</span></a>
<a class="sourceLine" id="cb23-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb23-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-4" title="4"><span class="st">    </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmean</span>(SUM, <span class="st">&quot;replace&quot;</span>)</a>
<a class="sourceLine" id="cb23-5" title="5"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb23-6" title="6"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb23-7" title="7"><span class="co">#    Variable Country   SUM   AGR    MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH</span></a>
<a class="sourceLine" id="cb23-8" title="8"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb23-9" title="9"><span class="co">#  1 VA       BWA      NA     NA     NA    NA    NA    NA    NA    NA    NA    NA    NA </span></a>
<a class="sourceLine" id="cb23-10" title="10"><span class="co">#  2 VA       BWA      NA     NA     NA    NA    NA    NA    NA    NA    NA    NA    NA </span></a>
<a class="sourceLine" id="cb23-11" title="11"><span class="co">#  3 VA       BWA      NA     NA     NA    NA    NA    NA    NA    NA    NA    NA    NA </span></a>
<a class="sourceLine" id="cb23-12" title="12"><span class="co">#  4 VA       BWA      NA     NA     NA    NA    NA    NA    NA    NA    NA    NA    NA </span></a>
<a class="sourceLine" id="cb23-13" title="13"><span class="co">#  5 VA       BWA      37.5 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-14" title="14"><span class="co">#  6 VA       BWA      39.3 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-15" title="15"><span class="co">#  7 VA       BWA      43.1 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-16" title="16"><span class="co">#  8 VA       BWA      41.4 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-17" title="17"><span class="co">#  9 VA       BWA      41.1 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-18" title="18"><span class="co"># 10 VA       BWA      51.2 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-19" title="19"><span class="co"># # ... with 5,017 more rows</span></a>
<a class="sourceLine" id="cb23-20" title="20"></a>
<a class="sourceLine" id="cb23-21" title="21"><span class="co"># This also replaces missing values in each group</span></a>
<a class="sourceLine" id="cb23-22" title="22">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb23-23" title="23"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-24" title="24"><span class="st">    </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmean</span>(SUM, <span class="st">&quot;replace_fill&quot;</span>)</a>
<a class="sourceLine" id="cb23-25" title="25"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb23-26" title="26"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb23-27" title="27"><span class="co">#    Variable Country   SUM   AGR    MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH</span></a>
<a class="sourceLine" id="cb23-28" title="28"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb23-29" title="29"><span class="co">#  1 VA       BWA      NA   1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-30" title="30"><span class="co">#  2 VA       BWA      NA   1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-31" title="31"><span class="co">#  3 VA       BWA      NA   1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-32" title="32"><span class="co">#  4 VA       BWA      NA   1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-33" title="33"><span class="co">#  5 VA       BWA      37.5 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-34" title="34"><span class="co">#  6 VA       BWA      39.3 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-35" title="35"><span class="co">#  7 VA       BWA      43.1 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-36" title="36"><span class="co">#  8 VA       BWA      41.4 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-37" title="37"><span class="co">#  9 VA       BWA      41.1 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-38" title="38"><span class="co"># 10 VA       BWA      51.2 1317. 13321. 2965.  529. 2747. 6547. 2158. 4432. 7556. 2615.</span></a>
<a class="sourceLine" id="cb23-39" title="39"><span class="co"># # ... with 5,017 more rows</span></a></code></pre></div>
<p>It is also possible to center data points on the global mean, which is achieved by subtracting out group means and adding the overall mean of the data again:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1"><span class="co"># This group-centers data on the overall mean of the data</span></a>
<a class="sourceLine" id="cb24-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-4" title="4"><span class="st">    </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmean</span>(<span class="dt">TRA =</span> <span class="st">&quot;-+&quot;</span>) </a>
<a class="sourceLine" id="cb24-5" title="5"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb24-6" title="6"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb24-7" title="7"><span class="co">#    Variable Country     AGR     MIN     MAN      PU     CON     WRT     TRA    FIRE     GOV     OTH</span></a>
<a class="sourceLine" id="cb24-8" title="8"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb24-9" title="9"><span class="co">#  1 VA       BWA     NA      NA      NA          NA  NA      NA      NA      NA      NA      NA     </span></a>
<a class="sourceLine" id="cb24-10" title="10"><span class="co">#  2 VA       BWA     NA      NA      NA          NA  NA      NA      NA      NA      NA      NA     </span></a>
<a class="sourceLine" id="cb24-11" title="11"><span class="co">#  3 VA       BWA     NA      NA      NA          NA  NA      NA      NA      NA      NA      NA     </span></a>
<a class="sourceLine" id="cb24-12" title="12"><span class="co">#  4 VA       BWA     NA      NA      NA          NA  NA      NA      NA      NA      NA      NA     </span></a>
<a class="sourceLine" id="cb24-13" title="13"><span class="co">#  5 VA       BWA      2.53e6  1.86e6  5.54e6 335463.  1.80e6  3.39e6  1.47e6  1.66e6  1.71e6  1.68e6</span></a>
<a class="sourceLine" id="cb24-14" title="14"><span class="co">#  6 VA       BWA      2.53e6  1.86e6  5.54e6 335463.  1.80e6  3.39e6  1.47e6  1.66e6  1.71e6  1.68e6</span></a>
<a class="sourceLine" id="cb24-15" title="15"><span class="co">#  7 VA       BWA      2.53e6  1.86e6  5.54e6 335463.  1.80e6  3.39e6  1.47e6  1.66e6  1.71e6  1.68e6</span></a>
<a class="sourceLine" id="cb24-16" title="16"><span class="co">#  8 VA       BWA      2.53e6  1.86e6  5.54e6 335463.  1.80e6  3.39e6  1.47e6  1.66e6  1.71e6  1.68e6</span></a>
<a class="sourceLine" id="cb24-17" title="17"><span class="co">#  9 VA       BWA      2.53e6  1.86e6  5.54e6 335463.  1.80e6  3.39e6  1.47e6  1.66e6  1.71e6  1.68e6</span></a>
<a class="sourceLine" id="cb24-18" title="18"><span class="co"># 10 VA       BWA      2.53e6  1.86e6  5.54e6 335464.  1.80e6  3.39e6  1.47e6  1.66e6  1.71e6  1.68e6</span></a>
<a class="sourceLine" id="cb24-19" title="19"><span class="co"># # ... with 5,017 more rows, and 1 more variable: SUM &lt;dbl&gt;</span></a></code></pre></div>
<p>Sequential operations such as scaling and then centering are also easily performed:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1"><span class="co"># This scales and centers (i.e. standardizes) the data </span></a>
<a class="sourceLine" id="cb25-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-4" title="4"><span class="st">    </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fsd</span>(<span class="dt">TRA =</span> <span class="st">&quot;/&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmean</span>(<span class="dt">TRA =</span> <span class="st">&quot;-&quot;</span>)</a>
<a class="sourceLine" id="cb25-5" title="5"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb25-6" title="6"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb25-7" title="7"><span class="co">#    Variable Country    AGR    MIN    MAN     PU    CON    WRT    TRA   FIRE    GOV    OTH    SUM</span></a>
<a class="sourceLine" id="cb25-8" title="8"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb25-9" title="9"><span class="co">#  1 VA       BWA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span></a>
<a class="sourceLine" id="cb25-10" title="10"><span class="co">#  2 VA       BWA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span></a>
<a class="sourceLine" id="cb25-11" title="11"><span class="co">#  3 VA       BWA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span></a>
<a class="sourceLine" id="cb25-12" title="12"><span class="co">#  4 VA       BWA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span></a>
<a class="sourceLine" id="cb25-13" title="13"><span class="co">#  5 VA       BWA     -0.738 -0.717 -0.668 -0.805 -0.692 -0.603 -0.589 -0.635 -0.656 -0.596 -0.676</span></a>
<a class="sourceLine" id="cb25-14" title="14"><span class="co">#  6 VA       BWA     -0.739 -0.717 -0.668 -0.805 -0.692 -0.603 -0.589 -0.635 -0.656 -0.596 -0.676</span></a>
<a class="sourceLine" id="cb25-15" title="15"><span class="co">#  7 VA       BWA     -0.736 -0.717 -0.668 -0.805 -0.692 -0.603 -0.589 -0.635 -0.656 -0.595 -0.676</span></a>
<a class="sourceLine" id="cb25-16" title="16"><span class="co">#  8 VA       BWA     -0.734 -0.717 -0.668 -0.805 -0.692 -0.604 -0.589 -0.635 -0.655 -0.595 -0.676</span></a>
<a class="sourceLine" id="cb25-17" title="17"><span class="co">#  9 VA       BWA     -0.730 -0.717 -0.668 -0.805 -0.692 -0.604 -0.588 -0.635 -0.656 -0.596 -0.676</span></a>
<a class="sourceLine" id="cb25-18" title="18"><span class="co"># 10 VA       BWA     -0.729 -0.716 -0.667 -0.803 -0.690 -0.603 -0.588 -0.635 -0.656 -0.596 -0.675</span></a>
<a class="sourceLine" id="cb25-19" title="19"><span class="co"># # ... with 5,017 more rows</span></a></code></pre></div>
<p>Of course it is also possible to combine multiple functions as in the aggregation section, or to add variables to existing data, as shown below:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1"><span class="co"># This group-centers data on the group-medians and adds the new variables right next to the original ones</span></a>
<a class="sourceLine" id="cb26-2" title="2"><span class="kw">add_vars</span>(GGDC10S, <span class="kw">seq</span>(<span class="dv">7</span>,<span class="dv">27</span>,<span class="dv">2</span>)) &lt;-<span class="st"> </span>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb26-3" title="3"><span class="st">    </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">get_vars</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb26-4" title="4"><span class="st">    </span><span class="kw">fmedian</span>(<span class="dt">TRA =</span> <span class="st">&quot;-&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_stub</span>(<span class="st">&quot;demean_&quot;</span>)</a>
<a class="sourceLine" id="cb26-5" title="5"></a>
<a class="sourceLine" id="cb26-6" title="6">GGDC10S</a>
<a class="sourceLine" id="cb26-7" title="7"><span class="co"># # A tibble: 5,027 x 27</span></a>
<a class="sourceLine" id="cb26-8" title="8"><span class="co">#    Country Regioncode Region Variable  Year   AGR demean_AGR   MIN demean_MIN    MAN demean_MAN</span></a>
<a class="sourceLine" id="cb26-9" title="9"><span class="co">#  * &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb26-10" title="10"><span class="co">#  1 BWA     SSA        Sub-s~ VA        1960  NA          NA  NA           NA  NA            NA </span></a>
<a class="sourceLine" id="cb26-11" title="11"><span class="co">#  2 BWA     SSA        Sub-s~ VA        1961  NA          NA  NA           NA  NA            NA </span></a>
<a class="sourceLine" id="cb26-12" title="12"><span class="co">#  3 BWA     SSA        Sub-s~ VA        1962  NA          NA  NA           NA  NA            NA </span></a>
<a class="sourceLine" id="cb26-13" title="13"><span class="co">#  4 BWA     SSA        Sub-s~ VA        1963  NA          NA  NA           NA  NA            NA </span></a>
<a class="sourceLine" id="cb26-14" title="14"><span class="co">#  5 BWA     SSA        Sub-s~ VA        1964  16.3      -110.  3.49     -1476.  0.737      -258.</span></a>
<a class="sourceLine" id="cb26-15" title="15"><span class="co">#  6 BWA     SSA        Sub-s~ VA        1965  15.7      -110.  2.50     -1477.  1.02       -258.</span></a>
<a class="sourceLine" id="cb26-16" title="16"><span class="co">#  7 BWA     SSA        Sub-s~ VA        1966  17.7      -109.  1.97     -1477.  0.804      -258.</span></a>
<a class="sourceLine" id="cb26-17" title="17"><span class="co">#  8 BWA     SSA        Sub-s~ VA        1967  19.1      -107.  2.30     -1477.  0.938      -258.</span></a>
<a class="sourceLine" id="cb26-18" title="18"><span class="co">#  9 BWA     SSA        Sub-s~ VA        1968  21.1      -105.  1.84     -1478.  0.750      -258.</span></a>
<a class="sourceLine" id="cb26-19" title="19"><span class="co"># 10 BWA     SSA        Sub-s~ VA        1969  21.9      -104.  5.24     -1474.  2.14       -257.</span></a>
<a class="sourceLine" id="cb26-20" title="20"><span class="co"># # ... with 5,017 more rows, and 16 more variables: PU &lt;dbl&gt;, demean_PU &lt;dbl&gt;, CON &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb26-21" title="21"><span class="co"># #   demean_CON &lt;dbl&gt;, WRT &lt;dbl&gt;, demean_WRT &lt;dbl&gt;, TRA &lt;dbl&gt;, demean_TRA &lt;dbl&gt;, FIRE &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb26-22" title="22"><span class="co"># #   demean_FIRE &lt;dbl&gt;, GOV &lt;dbl&gt;, demean_GOV &lt;dbl&gt;, OTH &lt;dbl&gt;, demean_OTH &lt;dbl&gt;, SUM &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb26-23" title="23"><span class="co"># #   demean_SUM &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb26-24" title="24"><span class="kw">rm</span>(GGDC10S)</a></code></pre></div>
<p>Certainly There are lots of other examples one could construct using the 8 operations and 13 functions listed above, the examples provided just outline the suggested programming basics.</p>
<!-- ***could add add_vars example again*** -->
</div>
<div id="more-control-using-the-tra-function" class="section level3">
<h3>2.2 More Control using the <code>TRA</code> Function</h3>
<p>Behind the scenes of the <code>TRA = ...</code> argument, the fast functions first compute the grouped statistics on all columns of the data, and these statistics are then directly fed into a C++ function that uses them to replace or sweep them out of data points in one of the 8 ways described above. This function can however also be called directly by the name of <code>TRA</code> (shorthand for ‘transforming’ data by replacing or sweeping out statistics). Fundamentally, <code>TRA</code> is a generalization of <code>base::sweep</code> for column-wise grouped operations<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>. Direct calls to <code>TRA</code> enable more control over inputs and outputs.</p>
<p>The two operations below are equivalent, although the first is slightly more efficient as it only requires one method dispatch and one check of the inputs:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1"><span class="co"># This divides by the product</span></a>
<a class="sourceLine" id="cb27-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-4" title="4"><span class="st">    </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fprod</span>(<span class="dt">TRA =</span> <span class="st">&quot;/&quot;</span>)</a>
<a class="sourceLine" id="cb27-5" title="5"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb27-6" title="6"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb27-7" title="7"><span class="co">#    Variable Country        AGR        MIN        MAN        PU        CON        WRT       TRA</span></a>
<a class="sourceLine" id="cb27-8" title="8"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;        &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb27-9" title="9"><span class="co">#  1 VA       BWA     NA         NA         NA         NA        NA         NA         NA       </span></a>
<a class="sourceLine" id="cb27-10" title="10"><span class="co">#  2 VA       BWA     NA         NA         NA         NA        NA         NA         NA       </span></a>
<a class="sourceLine" id="cb27-11" title="11"><span class="co">#  3 VA       BWA     NA         NA         NA         NA        NA         NA         NA       </span></a>
<a class="sourceLine" id="cb27-12" title="12"><span class="co">#  4 VA       BWA     NA         NA         NA         NA        NA         NA         NA       </span></a>
<a class="sourceLine" id="cb27-13" title="13"><span class="co">#  5 VA       BWA      1.29e-105  2.81e-127  1.40e-101  4.44e-74  4.19e-102  3.97e-113  6.91e-92</span></a>
<a class="sourceLine" id="cb27-14" title="14"><span class="co">#  6 VA       BWA      1.24e-105  2.00e-127  1.94e-101  5.75e-74  8.55e-102  4.49e-113  8.08e-92</span></a>
<a class="sourceLine" id="cb27-15" title="15"><span class="co">#  7 VA       BWA      1.39e-105  1.58e-127  1.53e-101  8.62e-74  8.55e-102  5.26e-113  8.98e-92</span></a>
<a class="sourceLine" id="cb27-16" title="16"><span class="co">#  8 VA       BWA      1.51e-105  1.85e-127  1.78e-101  8.62e-74  5.70e-102  2.74e-113  7.18e-92</span></a>
<a class="sourceLine" id="cb27-17" title="17"><span class="co">#  9 VA       BWA      1.66e-105  1.48e-127  1.43e-101  8.62e-74  7.74e-102  3.29e-113  1.02e-91</span></a>
<a class="sourceLine" id="cb27-18" title="18"><span class="co"># 10 VA       BWA      1.72e-105  4.21e-127  4.07e-101  2.46e-73  2.21e-101  3.66e-113  1.13e-91</span></a>
<a class="sourceLine" id="cb27-19" title="19"><span class="co"># # ... with 5,017 more rows, and 4 more variables: FIRE &lt;dbl&gt;, GOV &lt;dbl&gt;, OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb27-20" title="20"></a>
<a class="sourceLine" id="cb27-21" title="21"><span class="co"># Same thing </span></a>
<a class="sourceLine" id="cb27-22" title="22">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb27-23" title="23"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-24" title="24"><span class="st">    </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">TRA</span>(<span class="kw">fprod</span>(.),<span class="st">&quot;/&quot;</span>) <span class="co"># [same as TRA(.,fprod(.),&quot;/&quot;)]</span></a>
<a class="sourceLine" id="cb27-25" title="25"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb27-26" title="26"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb27-27" title="27"><span class="co">#    Variable Country        AGR        MIN        MAN        PU        CON        WRT       TRA</span></a>
<a class="sourceLine" id="cb27-28" title="28"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;        &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb27-29" title="29"><span class="co">#  1 VA       BWA     NA         NA         NA         NA        NA         NA         NA       </span></a>
<a class="sourceLine" id="cb27-30" title="30"><span class="co">#  2 VA       BWA     NA         NA         NA         NA        NA         NA         NA       </span></a>
<a class="sourceLine" id="cb27-31" title="31"><span class="co">#  3 VA       BWA     NA         NA         NA         NA        NA         NA         NA       </span></a>
<a class="sourceLine" id="cb27-32" title="32"><span class="co">#  4 VA       BWA     NA         NA         NA         NA        NA         NA         NA       </span></a>
<a class="sourceLine" id="cb27-33" title="33"><span class="co">#  5 VA       BWA      1.29e-105  2.81e-127  1.40e-101  4.44e-74  4.19e-102  3.97e-113  6.91e-92</span></a>
<a class="sourceLine" id="cb27-34" title="34"><span class="co">#  6 VA       BWA      1.24e-105  2.00e-127  1.94e-101  5.75e-74  8.55e-102  4.49e-113  8.08e-92</span></a>
<a class="sourceLine" id="cb27-35" title="35"><span class="co">#  7 VA       BWA      1.39e-105  1.58e-127  1.53e-101  8.62e-74  8.55e-102  5.26e-113  8.98e-92</span></a>
<a class="sourceLine" id="cb27-36" title="36"><span class="co">#  8 VA       BWA      1.51e-105  1.85e-127  1.78e-101  8.62e-74  5.70e-102  2.74e-113  7.18e-92</span></a>
<a class="sourceLine" id="cb27-37" title="37"><span class="co">#  9 VA       BWA      1.66e-105  1.48e-127  1.43e-101  8.62e-74  7.74e-102  3.29e-113  1.02e-91</span></a>
<a class="sourceLine" id="cb27-38" title="38"><span class="co"># 10 VA       BWA      1.72e-105  4.21e-127  4.07e-101  2.46e-73  2.21e-101  3.66e-113  1.13e-91</span></a>
<a class="sourceLine" id="cb27-39" title="39"><span class="co"># # ... with 5,017 more rows, and 4 more variables: FIRE &lt;dbl&gt;, GOV &lt;dbl&gt;, OTH &lt;dbl&gt;, SUM &lt;dbl&gt;</span></a></code></pre></div>
<p><code>TRA.grouped_df</code> was designed such that it matches the columns of statistics (aggregated columns) to those of the original data, and only transforms matching columns while returning the whole data.frame. Thus it is easily possible to only apply a transformation to the first two sectors:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1"><span class="co"># This only demeans Agriculture (AGR) and Mining (MIN)</span></a>
<a class="sourceLine" id="cb28-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb28-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-4" title="4"><span class="st">    </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">TRA</span>(<span class="kw">fmean</span>(<span class="kw">get_vars</span>(.,<span class="kw">c</span>(<span class="st">&quot;AGR&quot;</span>,<span class="st">&quot;MIN&quot;</span>))),<span class="st">&quot;-&quot;</span>) </a>
<a class="sourceLine" id="cb28-5" title="5"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb28-6" title="6"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb28-7" title="7"><span class="co">#    Variable Country   AGR    MIN    MAN     PU    CON   WRT   TRA  FIRE   GOV   OTH   SUM</span></a>
<a class="sourceLine" id="cb28-8" title="8"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb28-9" title="9"><span class="co">#  1 VA       BWA       NA     NA  NA     NA     NA     NA    NA    NA    NA    NA     NA  </span></a>
<a class="sourceLine" id="cb28-10" title="10"><span class="co">#  2 VA       BWA       NA     NA  NA     NA     NA     NA    NA    NA    NA    NA     NA  </span></a>
<a class="sourceLine" id="cb28-11" title="11"><span class="co">#  3 VA       BWA       NA     NA  NA     NA     NA     NA    NA    NA    NA    NA     NA  </span></a>
<a class="sourceLine" id="cb28-12" title="12"><span class="co">#  4 VA       BWA       NA     NA  NA     NA     NA     NA    NA    NA    NA    NA     NA  </span></a>
<a class="sourceLine" id="cb28-13" title="13"><span class="co">#  5 VA       BWA     -446. -4505.  0.737  0.104  0.660  6.24  1.66  1.12  4.82  2.34  37.5</span></a>
<a class="sourceLine" id="cb28-14" title="14"><span class="co">#  6 VA       BWA     -446. -4506.  1.02   0.135  1.35   7.06  1.94  1.25  5.70  2.68  39.3</span></a>
<a class="sourceLine" id="cb28-15" title="15"><span class="co">#  7 VA       BWA     -444. -4507.  0.804  0.203  1.35   8.27  2.15  1.36  6.37  2.99  43.1</span></a>
<a class="sourceLine" id="cb28-16" title="16"><span class="co">#  8 VA       BWA     -443. -4506.  0.938  0.203  0.897  4.31  1.72  1.54  7.04  3.31  41.4</span></a>
<a class="sourceLine" id="cb28-17" title="17"><span class="co">#  9 VA       BWA     -441. -4507.  0.750  0.203  1.22   5.17  2.44  1.03  5.03  2.36  41.1</span></a>
<a class="sourceLine" id="cb28-18" title="18"><span class="co"># 10 VA       BWA     -440. -4503.  2.14   0.578  3.47   5.75  2.72  1.23  5.59  2.63  51.2</span></a>
<a class="sourceLine" id="cb28-19" title="19"><span class="co"># # ... with 5,017 more rows</span></a></code></pre></div>
<p>Another potential use of <code>TRA</code> is to do computations in two- or more steps, for example if both aggregated and transformed data are needed, or if computations are more complex and involve other manipulations in between the aggregating and sweeping part:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1"><span class="co"># Get grouped tibble</span></a>
<a class="sourceLine" id="cb29-2" title="2">gGGDC &lt;-<span class="st"> </span>GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(Variable,Country)</a>
<a class="sourceLine" id="cb29-3" title="3"></a>
<a class="sourceLine" id="cb29-4" title="4"><span class="co"># Get aggregated data</span></a>
<a class="sourceLine" id="cb29-5" title="5">gsumGGDC &lt;-<span class="st"> </span>gGGDC <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fsum</a>
<a class="sourceLine" id="cb29-6" title="6">gsumGGDC</a>
<a class="sourceLine" id="cb29-7" title="7"><span class="co"># # A tibble: 85 x 13</span></a>
<a class="sourceLine" id="cb29-8" title="8"><span class="co">#    Variable Country     AGR     MIN     MAN     PU    CON    WRT    TRA   FIRE     GOV    OTH    SUM</span></a>
<a class="sourceLine" id="cb29-9" title="9"><span class="co">#    &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb29-10" title="10"><span class="co">#  1 EMP      ARG      8.80e4   3230.  1.20e5  6307. 4.60e4 1.23e5 4.02e4 3.89e4  1.27e5 6.15e4 6.54e5</span></a>
<a class="sourceLine" id="cb29-11" title="11"><span class="co">#  2 EMP      BOL      5.88e4   3418.  1.43e4   326. 7.49e3 1.72e4 7.04e3 2.72e3 NA      2.41e4 1.35e5</span></a>
<a class="sourceLine" id="cb29-12" title="12"><span class="co">#  3 EMP      BRA      1.07e6  12773.  4.33e5 22604. 2.19e5 5.28e5 1.27e5 2.74e5  3.29e5 3.54e5 3.36e6</span></a>
<a class="sourceLine" id="cb29-13" title="13"><span class="co">#  4 EMP      BWA      8.84e3    493.  8.49e2   145. 1.19e3 1.71e3 3.93e2 7.21e2  2.87e3 1.30e3 1.85e4</span></a>
<a class="sourceLine" id="cb29-14" title="14"><span class="co">#  5 EMP      CHL      4.42e4   6389.  3.94e4  1850. 1.86e4 4.38e4 1.63e4 1.72e4 NA      6.32e4 2.51e5</span></a>
<a class="sourceLine" id="cb29-15" title="15"><span class="co">#  6 EMP      CHN      1.73e7 422972.  4.03e6 96364. 1.25e6 1.73e6 8.36e5 2.96e5  1.36e6 1.86e6 2.91e7</span></a>
<a class="sourceLine" id="cb29-16" title="16"><span class="co">#  7 EMP      COL      1.89e5   8843.  7.17e4  2068. 3.20e4 1.26e5 2.86e4 3.96e4 NA      1.06e5 6.03e5</span></a>
<a class="sourceLine" id="cb29-17" title="17"><span class="co">#  8 EMP      CRI      1.43e4    106.  8.44e3   884. 3.57e3 9.71e3 2.63e3 3.40e3  7.94e3 4.04e3 5.50e4</span></a>
<a class="sourceLine" id="cb29-18" title="18"><span class="co">#  9 EMP      DEW      1.05e5  17083.  3.56e5  9499. 8.79e4 1.87e5 6.23e4 7.09e4  1.66e5 4.20e4 1.10e6</span></a>
<a class="sourceLine" id="cb29-19" title="19"><span class="co"># 10 EMP      DNK      1.51e4    514.  3.25e4   881. 1.10e4 2.91e4 1.03e4 1.16e4  3.51e4 7.13e3 1.53e5</span></a>
<a class="sourceLine" id="cb29-20" title="20"><span class="co"># # ... with 75 more rows</span></a>
<a class="sourceLine" id="cb29-21" title="21"></a>
<a class="sourceLine" id="cb29-22" title="22"><span class="co"># Get transformed (scaled) data </span></a>
<a class="sourceLine" id="cb29-23" title="23"><span class="kw">TRA</span>(gGGDC, gsumGGDC, <span class="st">&quot;/&quot;</span>)</a>
<a class="sourceLine" id="cb29-24" title="24"><span class="co"># # A tibble: 5,027 x 16</span></a>
<a class="sourceLine" id="cb29-25" title="25"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb29-26" title="26"><span class="co">#    Country Regioncode Region Variable  Year      AGR      MIN      MAN       PU      CON      WRT</span></a>
<a class="sourceLine" id="cb29-27" title="27"><span class="co">#  * &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb29-28" title="28"><span class="co">#  1 BWA     SSA        Sub-s~ VA        1960 NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb29-29" title="29"><span class="co">#  2 BWA     SSA        Sub-s~ VA        1961 NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb29-30" title="30"><span class="co">#  3 BWA     SSA        Sub-s~ VA        1962 NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb29-31" title="31"><span class="co">#  4 BWA     SSA        Sub-s~ VA        1963 NA       NA       NA       NA       NA       NA      </span></a>
<a class="sourceLine" id="cb29-32" title="32"><span class="co">#  5 BWA     SSA        Sub-s~ VA        1964  7.50e-4  1.65e-5  1.66e-5  1.03e-5  1.57e-5  6.82e-5</span></a>
<a class="sourceLine" id="cb29-33" title="33"><span class="co">#  6 BWA     SSA        Sub-s~ VA        1965  7.24e-4  1.18e-5  2.30e-5  1.33e-5  3.20e-5  7.72e-5</span></a>
<a class="sourceLine" id="cb29-34" title="34"><span class="co">#  7 BWA     SSA        Sub-s~ VA        1966  8.14e-4  9.30e-6  1.82e-5  1.99e-5  3.20e-5  9.03e-5</span></a>
<a class="sourceLine" id="cb29-35" title="35"><span class="co">#  8 BWA     SSA        Sub-s~ VA        1967  8.81e-4  1.08e-5  2.12e-5  1.99e-5  2.13e-5  4.71e-5</span></a>
<a class="sourceLine" id="cb29-36" title="36"><span class="co">#  9 BWA     SSA        Sub-s~ VA        1968  9.71e-4  8.68e-6  1.70e-5  1.99e-5  2.89e-5  5.65e-5</span></a>
<a class="sourceLine" id="cb29-37" title="37"><span class="co"># 10 BWA     SSA        Sub-s~ VA        1969  1.01e-3  2.47e-5  4.83e-5  5.68e-5  8.25e-5  6.28e-5</span></a>
<a class="sourceLine" id="cb29-38" title="38"><span class="co"># # ... with 5,017 more rows, and 5 more variables: TRA &lt;dbl&gt;, FIRE &lt;dbl&gt;, GOV &lt;dbl&gt;, OTH &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb29-39" title="39"><span class="co"># #   SUM &lt;dbl&gt;</span></a></code></pre></div>
<p>I have already noted above that whether using the argument to fast statistical functions or <code>TRA</code> directly, these data transformations are essentially a two-step process: Statistics are first computed and then used to transform this original data. This process is already very efficient since all functions are written in C++, and programmatically separating the computation of statistics and data transformation tasks allows for unlimited combinations and drastically simplifies the code base of this package.</p>
<p>Nonetheless there are of course more memory efficient and faster ways to program such data transformations, which principally involve doing them column-by-column with a single C++ function. To ensure that this package lives up to the highest standards of performance for common uses, I have implemented such slightly more efficient algorithms for the very commonly applied tasks of centering and averaging data by groups (widely known as ‘between’-group and ‘within’-group transformations), and scaling and centering data by groups (also known as ‘standardizing’ data).</p>
</div>
<div id="faster-centering-averaging-and-standardizing" class="section level3">
<h3>2.3 Faster Centering, Averaging and Standardizing</h3>
<!-- Between and Within Transformations and Standardization -->
<p>The functions <code>fbetween</code> and <code>fwithin</code> are faster implementations of <code>fmean</code> invoked with different <code>TRA</code> options:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Same as ... %&gt;% fmean(TRA = &quot;replace&quot;)</span></a>
<a class="sourceLine" id="cb30-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fbetween <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb30-3" title="3"><span class="co"># # A tibble: 2 x 13</span></a>
<a class="sourceLine" id="cb30-4" title="4"><span class="co"># # Groups:   Variable, Country [1]</span></a>
<a class="sourceLine" id="cb30-5" title="5"><span class="co">#   Variable Country   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH   SUM</span></a>
<a class="sourceLine" id="cb30-6" title="6"><span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb30-7" title="7"><span class="co"># 1 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></a>
<a class="sourceLine" id="cb30-8" title="8"><span class="co"># 2 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></a>
<a class="sourceLine" id="cb30-9" title="9"></a>
<a class="sourceLine" id="cb30-10" title="10">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Same as ... %&gt;% fmean(TRA = &quot;replace_fill&quot;)</span></a>
<a class="sourceLine" id="cb30-11" title="11"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fbetween</span>(<span class="dt">fill =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb30-12" title="12"><span class="co"># # A tibble: 2 x 13</span></a>
<a class="sourceLine" id="cb30-13" title="13"><span class="co"># # Groups:   Variable, Country [1]</span></a>
<a class="sourceLine" id="cb30-14" title="14"><span class="co">#   Variable Country   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH    SUM</span></a>
<a class="sourceLine" id="cb30-15" title="15"><span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb30-16" title="16"><span class="co"># 1 VA       BWA      462. 4509.  942.  216.  895. 1948.  635. 1359. 2373.  773. 14112.</span></a>
<a class="sourceLine" id="cb30-17" title="17"><span class="co"># 2 VA       BWA      462. 4509.  942.  216.  895. 1948.  635. 1359. 2373.  773. 14112.</span></a>
<a class="sourceLine" id="cb30-18" title="18"></a>
<a class="sourceLine" id="cb30-19" title="19">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Same as ... %&gt;% fmean(TRA = &quot;-&quot;)</span></a>
<a class="sourceLine" id="cb30-20" title="20"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fwithin <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb30-21" title="21"><span class="co"># # A tibble: 2 x 13</span></a>
<a class="sourceLine" id="cb30-22" title="22"><span class="co"># # Groups:   Variable, Country [1]</span></a>
<a class="sourceLine" id="cb30-23" title="23"><span class="co">#   Variable Country   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH   SUM</span></a>
<a class="sourceLine" id="cb30-24" title="24"><span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb30-25" title="25"><span class="co"># 1 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></a>
<a class="sourceLine" id="cb30-26" title="26"><span class="co"># 2 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></a>
<a class="sourceLine" id="cb30-27" title="27"></a>
<a class="sourceLine" id="cb30-28" title="28">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Same as ... %&gt;% fmean(TRA = &quot;-+&quot;)</span></a>
<a class="sourceLine" id="cb30-29" title="29"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fwithin</span>(<span class="dt">add.global.mean =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb30-30" title="30"><span class="co"># # A tibble: 2 x 13</span></a>
<a class="sourceLine" id="cb30-31" title="31"><span class="co"># # Groups:   Variable, Country [1]</span></a>
<a class="sourceLine" id="cb30-32" title="32"><span class="co">#   Variable Country   AGR   MIN   MAN    PU   CON   WRT   TRA  FIRE   GOV   OTH   SUM</span></a>
<a class="sourceLine" id="cb30-33" title="33"><span class="co">#   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb30-34" title="34"><span class="co"># 1 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></a>
<a class="sourceLine" id="cb30-35" title="35"><span class="co"># 2 VA       BWA        NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA</span></a></code></pre></div>
<p>Apart from higher speed, there is one additional advantage of using <code>fwithin</code> in particular, which regards the joint use of weights and the <code>add.global.mean</code> option: <code>... %&gt;% fmean(w = SUM, TRA = &quot;-+&quot;)</code> will not properly group-center the data on the overall weighted mean. Instead, it will group-center data on a frequency weighted average of the weighted group-means, thus not taking into account different aggregated weights attached to those weighted group-means themselves. The reason for this shortcoming is simply that <code>TRA</code> was not designed to take a separate weight vector as input. <code>fwithin(w = SUM, add.global.mean = TRUE)</code> does a better job and properly centers data on the weighted overall mean after subtracting out weighted group means:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># This does not center data on a properly computed weighted overall mean</span></a>
<a class="sourceLine" id="cb31-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fmean</span>(SUM, <span class="dt">TRA =</span> <span class="st">&quot;-+&quot;</span>) </a>
<a class="sourceLine" id="cb31-3" title="3"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb31-4" title="4"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb31-5" title="5"><span class="co">#    Variable Country   SUM     AGR     MIN     MAN      PU     CON     WRT     TRA    FIRE     GOV</span></a>
<a class="sourceLine" id="cb31-6" title="6"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb31-7" title="7"><span class="co">#  1 VA       BWA      NA   NA      NA      NA      NA      NA      NA      NA      NA      NA     </span></a>
<a class="sourceLine" id="cb31-8" title="8"><span class="co">#  2 VA       BWA      NA   NA      NA      NA      NA      NA      NA      NA      NA      NA     </span></a>
<a class="sourceLine" id="cb31-9" title="9"><span class="co">#  3 VA       BWA      NA   NA      NA      NA      NA      NA      NA      NA      NA      NA     </span></a>
<a class="sourceLine" id="cb31-10" title="10"><span class="co">#  4 VA       BWA      NA   NA      NA      NA      NA      NA      NA      NA      NA      NA     </span></a>
<a class="sourceLine" id="cb31-11" title="11"><span class="co">#  5 VA       BWA      37.5  8.72e6  7.25e6  1.74e7  1.01e6  6.43e6  1.05e7  4.86e6  4.85e6  4.99e6</span></a>
<a class="sourceLine" id="cb31-12" title="12"><span class="co">#  6 VA       BWA      39.3  8.72e6  7.25e6  1.74e7  1.01e6  6.43e6  1.05e7  4.86e6  4.85e6  4.99e6</span></a>
<a class="sourceLine" id="cb31-13" title="13"><span class="co">#  7 VA       BWA      43.1  8.72e6  7.25e6  1.74e7  1.01e6  6.43e6  1.05e7  4.86e6  4.85e6  4.99e6</span></a>
<a class="sourceLine" id="cb31-14" title="14"><span class="co">#  8 VA       BWA      41.4  8.72e6  7.25e6  1.74e7  1.01e6  6.43e6  1.05e7  4.86e6  4.85e6  4.99e6</span></a>
<a class="sourceLine" id="cb31-15" title="15"><span class="co">#  9 VA       BWA      41.1  8.72e6  7.25e6  1.74e7  1.01e6  6.43e6  1.05e7  4.86e6  4.85e6  4.99e6</span></a>
<a class="sourceLine" id="cb31-16" title="16"><span class="co"># 10 VA       BWA      51.2  8.72e6  7.25e6  1.74e7  1.01e6  6.43e6  1.05e7  4.86e6  4.85e6  4.99e6</span></a>
<a class="sourceLine" id="cb31-17" title="17"><span class="co"># # ... with 5,017 more rows, and 1 more variable: OTH &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb31-18" title="18"></a>
<a class="sourceLine" id="cb31-19" title="19">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># This does a proper job by both subtracting weighted group-means and adding a weighted overall mean</span></a>
<a class="sourceLine" id="cb31-20" title="20"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fwithin</span>(SUM, <span class="dt">add.global.mean =</span> <span class="ot">TRUE</span>) </a>
<a class="sourceLine" id="cb31-21" title="21"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb31-22" title="22"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb31-23" title="23"><span class="co">#    Variable Country   SUM     AGR     MIN     MAN      PU     CON     WRT     TRA    FIRE     GOV</span></a>
<a class="sourceLine" id="cb31-24" title="24"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb31-25" title="25"><span class="co">#  1 VA       BWA      NA   NA      NA      NA      NA      NA      NA      NA      NA      NA     </span></a>
<a class="sourceLine" id="cb31-26" title="26"><span class="co">#  2 VA       BWA      NA   NA      NA      NA      NA      NA      NA      NA      NA      NA     </span></a>
<a class="sourceLine" id="cb31-27" title="27"><span class="co">#  3 VA       BWA      NA   NA      NA      NA      NA      NA      NA      NA      NA      NA     </span></a>
<a class="sourceLine" id="cb31-28" title="28"><span class="co">#  4 VA       BWA      NA   NA      NA      NA      NA      NA      NA      NA      NA      NA     </span></a>
<a class="sourceLine" id="cb31-29" title="29"><span class="co">#  5 VA       BWA      37.5  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8  1.97e8  1.55e8  2.10e8</span></a>
<a class="sourceLine" id="cb31-30" title="30"><span class="co">#  6 VA       BWA      39.3  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8  1.97e8  1.55e8  2.10e8</span></a>
<a class="sourceLine" id="cb31-31" title="31"><span class="co">#  7 VA       BWA      43.1  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8  1.97e8  1.55e8  2.10e8</span></a>
<a class="sourceLine" id="cb31-32" title="32"><span class="co">#  8 VA       BWA      41.4  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8  1.97e8  1.55e8  2.10e8</span></a>
<a class="sourceLine" id="cb31-33" title="33"><span class="co">#  9 VA       BWA      41.1  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8  1.97e8  1.55e8  2.10e8</span></a>
<a class="sourceLine" id="cb31-34" title="34"><span class="co"># 10 VA       BWA      51.2  4.29e8  3.70e8  7.38e8  2.73e7  2.83e8  4.33e8  1.97e8  1.55e8  2.10e8</span></a>
<a class="sourceLine" id="cb31-35" title="35"><span class="co"># # ... with 5,017 more rows, and 1 more variable: OTH &lt;dbl&gt;</span></a></code></pre></div>
<p>The sequential scaling and centering <code>... %&gt;% fsd(TRA = &quot;/&quot;) %&gt;% fmean(TRA = &quot;-&quot;)</code> shown in an earlier example is also not the best way of doing things. The function <code>fscale</code> does this much quicker in a single step:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" title="1"><span class="co"># This efficiently scales and centers (i.e. standardizes) the data </span></a>
<a class="sourceLine" id="cb32-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-4" title="4"><span class="st">    </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>fscale</a>
<a class="sourceLine" id="cb32-5" title="5"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb32-6" title="6"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb32-7" title="7"><span class="co">#    Variable Country    AGR    MIN    MAN     PU    CON    WRT    TRA   FIRE    GOV    OTH    SUM</span></a>
<a class="sourceLine" id="cb32-8" title="8"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb32-9" title="9"><span class="co">#  1 VA       BWA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span></a>
<a class="sourceLine" id="cb32-10" title="10"><span class="co">#  2 VA       BWA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span></a>
<a class="sourceLine" id="cb32-11" title="11"><span class="co">#  3 VA       BWA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span></a>
<a class="sourceLine" id="cb32-12" title="12"><span class="co">#  4 VA       BWA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA     NA    </span></a>
<a class="sourceLine" id="cb32-13" title="13"><span class="co">#  5 VA       BWA     -0.738 -0.717 -0.668 -0.805 -0.692 -0.603 -0.589 -0.635 -0.656 -0.596 -0.676</span></a>
<a class="sourceLine" id="cb32-14" title="14"><span class="co">#  6 VA       BWA     -0.739 -0.717 -0.668 -0.805 -0.692 -0.603 -0.589 -0.635 -0.656 -0.596 -0.676</span></a>
<a class="sourceLine" id="cb32-15" title="15"><span class="co">#  7 VA       BWA     -0.736 -0.717 -0.668 -0.805 -0.692 -0.603 -0.589 -0.635 -0.656 -0.595 -0.676</span></a>
<a class="sourceLine" id="cb32-16" title="16"><span class="co">#  8 VA       BWA     -0.734 -0.717 -0.668 -0.805 -0.692 -0.604 -0.589 -0.635 -0.655 -0.595 -0.676</span></a>
<a class="sourceLine" id="cb32-17" title="17"><span class="co">#  9 VA       BWA     -0.730 -0.717 -0.668 -0.805 -0.692 -0.604 -0.588 -0.635 -0.656 -0.596 -0.676</span></a>
<a class="sourceLine" id="cb32-18" title="18"><span class="co"># 10 VA       BWA     -0.729 -0.716 -0.667 -0.803 -0.690 -0.603 -0.588 -0.635 -0.656 -0.596 -0.675</span></a>
<a class="sourceLine" id="cb32-19" title="19"><span class="co"># # ... with 5,017 more rows</span></a></code></pre></div>
</div>
<div id="lags-leads-differences-and-growth-rates" class="section level3">
<h3>2.4 Lags / Leads, Differences and Growth Rates</h3>
<p>It was suggested some time ago that leaving the best wine for the end is not he best strategy when giving a feast. Considering the marriage of <em>collapse</em> and <em>dplyr</em> the 3 functions for time-computations introduced in this section combine great flexibility with precision and computing power, and feature amongst the highlights of <em>collapse</em>.</p>
<p>The first function, <code>flag</code>, computes sequences of lags and leads on time-series and panel-data. <code>fdiff</code> computes sequences of lagged-leaded and iterated differences on time-series and panel-data, and <code>fgrowth</code> computes lagged-leaded and iterated growth-rates obtained via the exact computation method or through log-differencing. In addition: None of these functions require the data to be sorted, they can carry out fast computations on completely unordered data as long as a time-variable is supplied that uniquely identifies the data.</p>
<p>Beginning with <code>flag</code>, the following code computes 1 fully-identified panel-lag and 1 fully identified panel-lead of each variable in the data:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb33-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-3" title="3"><span class="st">     </span><span class="kw">select_at</span>(<span class="dv">5</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">flag</span>(<span class="op">-</span><span class="dv">1</span><span class="op">:</span><span class="dv">1</span>, Year)</a>
<a class="sourceLine" id="cb33-4" title="4"><span class="co"># # A tibble: 5,027 x 36</span></a>
<a class="sourceLine" id="cb33-5" title="5"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb33-6" title="6"><span class="co">#    Variable Country  Year F1.AGR   AGR L1.AGR F1.MIN   MIN L1.MIN F1.MAN    MAN L1.MAN  F1.PU     PU</span></a>
<a class="sourceLine" id="cb33-7" title="7"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb33-8" title="8"><span class="co">#  1 VA       BWA      1960   NA    NA     NA    NA    NA     NA    NA     NA     NA     NA     NA    </span></a>
<a class="sourceLine" id="cb33-9" title="9"><span class="co">#  2 VA       BWA      1961   NA    NA     NA    NA    NA     NA    NA     NA     NA     NA     NA    </span></a>
<a class="sourceLine" id="cb33-10" title="10"><span class="co">#  3 VA       BWA      1962   NA    NA     NA    NA    NA     NA    NA     NA     NA     NA     NA    </span></a>
<a class="sourceLine" id="cb33-11" title="11"><span class="co">#  4 VA       BWA      1963   16.3  NA     NA     3.49 NA     NA     0.737 NA     NA      0.104 NA    </span></a>
<a class="sourceLine" id="cb33-12" title="12"><span class="co">#  5 VA       BWA      1964   15.7  16.3   NA     2.50  3.49  NA     1.02   0.737 NA      0.135  0.104</span></a>
<a class="sourceLine" id="cb33-13" title="13"><span class="co">#  6 VA       BWA      1965   17.7  15.7   16.3   1.97  2.50   3.49  0.804  1.02   0.737  0.203  0.135</span></a>
<a class="sourceLine" id="cb33-14" title="14"><span class="co">#  7 VA       BWA      1966   19.1  17.7   15.7   2.30  1.97   2.50  0.938  0.804  1.02   0.203  0.203</span></a>
<a class="sourceLine" id="cb33-15" title="15"><span class="co">#  8 VA       BWA      1967   21.1  19.1   17.7   1.84  2.30   1.97  0.750  0.938  0.804  0.203  0.203</span></a>
<a class="sourceLine" id="cb33-16" title="16"><span class="co">#  9 VA       BWA      1968   21.9  21.1   19.1   5.24  1.84   2.30  2.14   0.750  0.938  0.578  0.203</span></a>
<a class="sourceLine" id="cb33-17" title="17"><span class="co"># 10 VA       BWA      1969   23.1  21.9   21.1  10.2   5.24   1.84  4.15   2.14   0.750  1.12   0.578</span></a>
<a class="sourceLine" id="cb33-18" title="18"><span class="co"># # ... with 5,017 more rows, and 22 more variables: L1.PU &lt;dbl&gt;, F1.CON &lt;dbl&gt;, CON &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb33-19" title="19"><span class="co"># #   L1.CON &lt;dbl&gt;, F1.WRT &lt;dbl&gt;, WRT &lt;dbl&gt;, L1.WRT &lt;dbl&gt;, F1.TRA &lt;dbl&gt;, TRA &lt;dbl&gt;, L1.TRA &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb33-20" title="20"><span class="co"># #   F1.FIRE &lt;dbl&gt;, FIRE &lt;dbl&gt;, L1.FIRE &lt;dbl&gt;, F1.GOV &lt;dbl&gt;, GOV &lt;dbl&gt;, L1.GOV &lt;dbl&gt;, F1.OTH &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb33-21" title="21"><span class="co"># #   OTH &lt;dbl&gt;, L1.OTH &lt;dbl&gt;, F1.SUM &lt;dbl&gt;, SUM &lt;dbl&gt;, L1.SUM &lt;dbl&gt;</span></a></code></pre></div>
<p>If the time-variable passed does not exactly identify the data (i.e. because of gaps or repeated values in each group), all 3 functions will issue appropriate error messages. It is also possible to omit the time-variable if one is certain that the data is sorted:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-3" title="3"><span class="st">     </span><span class="kw">select_at</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span>flag</a>
<a class="sourceLine" id="cb34-4" title="4"><span class="co"># # A tibble: 5,027 x 13</span></a>
<a class="sourceLine" id="cb34-5" title="5"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb34-6" title="6"><span class="co">#    Variable Country L1.AGR L1.MIN L1.MAN  L1.PU L1.CON L1.WRT L1.TRA L1.FIRE L1.GOV L1.OTH L1.SUM</span></a>
<a class="sourceLine" id="cb34-7" title="7"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb34-8" title="8"><span class="co">#  1 VA       BWA       NA    NA    NA     NA     NA      NA     NA      NA     NA     NA      NA  </span></a>
<a class="sourceLine" id="cb34-9" title="9"><span class="co">#  2 VA       BWA       NA    NA    NA     NA     NA      NA     NA      NA     NA     NA      NA  </span></a>
<a class="sourceLine" id="cb34-10" title="10"><span class="co">#  3 VA       BWA       NA    NA    NA     NA     NA      NA     NA      NA     NA     NA      NA  </span></a>
<a class="sourceLine" id="cb34-11" title="11"><span class="co">#  4 VA       BWA       NA    NA    NA     NA     NA      NA     NA      NA     NA     NA      NA  </span></a>
<a class="sourceLine" id="cb34-12" title="12"><span class="co">#  5 VA       BWA       NA    NA    NA     NA     NA      NA     NA      NA     NA     NA      NA  </span></a>
<a class="sourceLine" id="cb34-13" title="13"><span class="co">#  6 VA       BWA       16.3   3.49  0.737  0.104  0.660   6.24   1.66    1.12   4.82   2.34   37.5</span></a>
<a class="sourceLine" id="cb34-14" title="14"><span class="co">#  7 VA       BWA       15.7   2.50  1.02   0.135  1.35    7.06   1.94    1.25   5.70   2.68   39.3</span></a>
<a class="sourceLine" id="cb34-15" title="15"><span class="co">#  8 VA       BWA       17.7   1.97  0.804  0.203  1.35    8.27   2.15    1.36   6.37   2.99   43.1</span></a>
<a class="sourceLine" id="cb34-16" title="16"><span class="co">#  9 VA       BWA       19.1   2.30  0.938  0.203  0.897   4.31   1.72    1.54   7.04   3.31   41.4</span></a>
<a class="sourceLine" id="cb34-17" title="17"><span class="co"># 10 VA       BWA       21.1   1.84  0.750  0.203  1.22    5.17   2.44    1.03   5.03   2.36   41.1</span></a>
<a class="sourceLine" id="cb34-18" title="18"><span class="co"># # ... with 5,017 more rows</span></a></code></pre></div>
<p><code>fdiff</code> can compute continuous sequences of lagged, leaded and iterated differences. The code below computes the 1 and 10 year first and second differences of each variable in the data:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" title="1">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb35-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-3" title="3"><span class="st">     </span><span class="kw">select_at</span>(<span class="dv">5</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fdiff</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, Year)</a>
<a class="sourceLine" id="cb35-4" title="4"><span class="co"># # A tibble: 5,027 x 47</span></a>
<a class="sourceLine" id="cb35-5" title="5"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb35-6" title="6"><span class="co">#    Variable Country  Year D1.AGR D2.AGR L10D1.AGR L10D2.AGR D1.MIN D2.MIN L10D1.MIN L10D2.MIN D1.MAN</span></a>
<a class="sourceLine" id="cb35-7" title="7"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb35-8" title="8"><span class="co">#  1 VA       BWA      1960 NA     NA            NA        NA NA     NA            NA        NA NA    </span></a>
<a class="sourceLine" id="cb35-9" title="9"><span class="co">#  2 VA       BWA      1961 NA     NA            NA        NA NA     NA            NA        NA NA    </span></a>
<a class="sourceLine" id="cb35-10" title="10"><span class="co">#  3 VA       BWA      1962 NA     NA            NA        NA NA     NA            NA        NA NA    </span></a>
<a class="sourceLine" id="cb35-11" title="11"><span class="co">#  4 VA       BWA      1963 NA     NA            NA        NA NA     NA            NA        NA NA    </span></a>
<a class="sourceLine" id="cb35-12" title="12"><span class="co">#  5 VA       BWA      1964 NA     NA            NA        NA NA     NA            NA        NA NA    </span></a>
<a class="sourceLine" id="cb35-13" title="13"><span class="co">#  6 VA       BWA      1965 -0.575 NA            NA        NA -0.998 NA            NA        NA  0.282</span></a>
<a class="sourceLine" id="cb35-14" title="14"><span class="co">#  7 VA       BWA      1966  1.95   2.53         NA        NA -0.525  0.473        NA        NA -0.214</span></a>
<a class="sourceLine" id="cb35-15" title="15"><span class="co">#  8 VA       BWA      1967  1.47  -0.488        NA        NA  0.328  0.854        NA        NA  0.134</span></a>
<a class="sourceLine" id="cb35-16" title="16"><span class="co">#  9 VA       BWA      1968  1.95   0.488        NA        NA -0.460 -0.788        NA        NA -0.188</span></a>
<a class="sourceLine" id="cb35-17" title="17"><span class="co"># 10 VA       BWA      1969  0.763 -1.19         NA        NA  3.41   3.87         NA        NA  1.39 </span></a>
<a class="sourceLine" id="cb35-18" title="18"><span class="co"># # ... with 5,017 more rows, and 35 more variables: D2.MAN &lt;dbl&gt;, L10D1.MAN &lt;dbl&gt;, L10D2.MAN &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb35-19" title="19"><span class="co"># #   D1.PU &lt;dbl&gt;, D2.PU &lt;dbl&gt;, L10D1.PU &lt;dbl&gt;, L10D2.PU &lt;dbl&gt;, D1.CON &lt;dbl&gt;, D2.CON &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb35-20" title="20"><span class="co"># #   L10D1.CON &lt;dbl&gt;, L10D2.CON &lt;dbl&gt;, D1.WRT &lt;dbl&gt;, D2.WRT &lt;dbl&gt;, L10D1.WRT &lt;dbl&gt;, L10D2.WRT &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb35-21" title="21"><span class="co"># #   D1.TRA &lt;dbl&gt;, D2.TRA &lt;dbl&gt;, L10D1.TRA &lt;dbl&gt;, L10D2.TRA &lt;dbl&gt;, D1.FIRE &lt;dbl&gt;, D2.FIRE &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb35-22" title="22"><span class="co"># #   L10D1.FIRE &lt;dbl&gt;, L10D2.FIRE &lt;dbl&gt;, D1.GOV &lt;dbl&gt;, D2.GOV &lt;dbl&gt;, L10D1.GOV &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb35-23" title="23"><span class="co"># #   L10D2.GOV &lt;dbl&gt;, D1.OTH &lt;dbl&gt;, D2.OTH &lt;dbl&gt;, L10D1.OTH &lt;dbl&gt;, L10D2.OTH &lt;dbl&gt;, D1.SUM &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb35-24" title="24"><span class="co"># #   D2.SUM &lt;dbl&gt;, L10D1.SUM &lt;dbl&gt;, L10D2.SUM &lt;dbl&gt;</span></a></code></pre></div>
<p>Finally, <code>fgrowth</code> computes growth rates in the same way. By default exact growth rates are computed, but the user can also request growth rates obtained by log-differencing:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" title="1"><span class="co"># Exact growth rates, computed as: (x - lag(x)) / lag(x) * 100</span></a>
<a class="sourceLine" id="cb36-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb36-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-4" title="4"><span class="st">     </span><span class="kw">select_at</span>(<span class="dv">5</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgrowth</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, Year)</a>
<a class="sourceLine" id="cb36-5" title="5"><span class="co"># # A tibble: 5,027 x 47</span></a>
<a class="sourceLine" id="cb36-6" title="6"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb36-7" title="7"><span class="co">#    Variable Country  Year G1.AGR G2.AGR L10G1.AGR L10G2.AGR G1.MIN  G2.MIN L10G1.MIN L10G2.MIN</span></a>
<a class="sourceLine" id="cb36-8" title="8"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb36-9" title="9"><span class="co">#  1 VA       BWA      1960  NA      NA          NA        NA   NA      NA          NA        NA</span></a>
<a class="sourceLine" id="cb36-10" title="10"><span class="co">#  2 VA       BWA      1961  NA      NA          NA        NA   NA      NA          NA        NA</span></a>
<a class="sourceLine" id="cb36-11" title="11"><span class="co">#  3 VA       BWA      1962  NA      NA          NA        NA   NA      NA          NA        NA</span></a>
<a class="sourceLine" id="cb36-12" title="12"><span class="co">#  4 VA       BWA      1963  NA      NA          NA        NA   NA      NA          NA        NA</span></a>
<a class="sourceLine" id="cb36-13" title="13"><span class="co">#  5 VA       BWA      1964  NA      NA          NA        NA   NA      NA          NA        NA</span></a>
<a class="sourceLine" id="cb36-14" title="14"><span class="co">#  6 VA       BWA      1965  -3.52   NA          NA        NA  -28.6    NA          NA        NA</span></a>
<a class="sourceLine" id="cb36-15" title="15"><span class="co">#  7 VA       BWA      1966  12.4  -452.         NA        NA  -21.1   -26.3        NA        NA</span></a>
<a class="sourceLine" id="cb36-16" title="16"><span class="co">#  8 VA       BWA      1967   8.29  -33.3        NA        NA   16.7  -179.         NA        NA</span></a>
<a class="sourceLine" id="cb36-17" title="17"><span class="co">#  9 VA       BWA      1968  10.2    23.1        NA        NA  -20    -220.         NA        NA</span></a>
<a class="sourceLine" id="cb36-18" title="18"><span class="co"># 10 VA       BWA      1969   3.61  -64.6        NA        NA  185.  -1026.         NA        NA</span></a>
<a class="sourceLine" id="cb36-19" title="19"><span class="co"># # ... with 5,017 more rows, and 36 more variables: G1.MAN &lt;dbl&gt;, G2.MAN &lt;dbl&gt;, L10G1.MAN &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-20" title="20"><span class="co"># #   L10G2.MAN &lt;dbl&gt;, G1.PU &lt;dbl&gt;, G2.PU &lt;dbl&gt;, L10G1.PU &lt;dbl&gt;, L10G2.PU &lt;dbl&gt;, G1.CON &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-21" title="21"><span class="co"># #   G2.CON &lt;dbl&gt;, L10G1.CON &lt;dbl&gt;, L10G2.CON &lt;dbl&gt;, G1.WRT &lt;dbl&gt;, G2.WRT &lt;dbl&gt;, L10G1.WRT &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-22" title="22"><span class="co"># #   L10G2.WRT &lt;dbl&gt;, G1.TRA &lt;dbl&gt;, G2.TRA &lt;dbl&gt;, L10G1.TRA &lt;dbl&gt;, L10G2.TRA &lt;dbl&gt;, G1.FIRE &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-23" title="23"><span class="co"># #   G2.FIRE &lt;dbl&gt;, L10G1.FIRE &lt;dbl&gt;, L10G2.FIRE &lt;dbl&gt;, G1.GOV &lt;dbl&gt;, G2.GOV &lt;dbl&gt;, L10G1.GOV &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-24" title="24"><span class="co"># #   L10G2.GOV &lt;dbl&gt;, G1.OTH &lt;dbl&gt;, G2.OTH &lt;dbl&gt;, L10G1.OTH &lt;dbl&gt;, L10G2.OTH &lt;dbl&gt;, G1.SUM &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-25" title="25"><span class="co"># #   G2.SUM &lt;dbl&gt;, L10G1.SUM &lt;dbl&gt;, L10G2.SUM &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb36-26" title="26"></a>
<a class="sourceLine" id="cb36-27" title="27"><span class="co"># Log-difference growth rates, computed as: log(x / lag(x)) * 100</span></a>
<a class="sourceLine" id="cb36-28" title="28">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb36-29" title="29"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-30" title="30"><span class="st">     </span><span class="kw">select_at</span>(<span class="dv">5</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgrowth</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>, Year, <span class="dt">logdiff =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb36-31" title="31"><span class="co"># # A tibble: 5,027 x 47</span></a>
<a class="sourceLine" id="cb36-32" title="32"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb36-33" title="33"><span class="co">#    Variable Country  Year Dlog1.AGR Dlog2.AGR L10Dlog1.AGR L10Dlog2.AGR Dlog1.MIN Dlog2.MIN</span></a>
<a class="sourceLine" id="cb36-34" title="34"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb36-35" title="35"><span class="co">#  1 VA       BWA      1960     NA         NA             NA           NA      NA          NA</span></a>
<a class="sourceLine" id="cb36-36" title="36"><span class="co">#  2 VA       BWA      1961    NaN         NA             NA           NA     NaN          NA</span></a>
<a class="sourceLine" id="cb36-37" title="37"><span class="co">#  3 VA       BWA      1962    NaN        NaN             NA           NA     NaN         NaN</span></a>
<a class="sourceLine" id="cb36-38" title="38"><span class="co">#  4 VA       BWA      1963    NaN        NaN             NA           NA     NaN         NaN</span></a>
<a class="sourceLine" id="cb36-39" title="39"><span class="co">#  5 VA       BWA      1964    NaN        NaN             NA           NA     NaN         NaN</span></a>
<a class="sourceLine" id="cb36-40" title="40"><span class="co">#  6 VA       BWA      1965     -3.59     NaN             NA           NA     -33.6       NaN</span></a>
<a class="sourceLine" id="cb36-41" title="41"><span class="co">#  7 VA       BWA      1966     11.7      NaN             NA           NA     -23.6       NaN</span></a>
<a class="sourceLine" id="cb36-42" title="42"><span class="co">#  8 VA       BWA      1967      7.96     -38.6           NA           NA      15.4       NaN</span></a>
<a class="sourceLine" id="cb36-43" title="43"><span class="co">#  9 VA       BWA      1968      9.72      19.9           NA           NA     -22.3       NaN</span></a>
<a class="sourceLine" id="cb36-44" title="44"><span class="co"># 10 VA       BWA      1969      3.55    -101.            NA           NA     105.        NaN</span></a>
<a class="sourceLine" id="cb36-45" title="45"><span class="co"># # ... with 5,017 more rows, and 38 more variables: L10Dlog1.MIN &lt;dbl&gt;, L10Dlog2.MIN &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-46" title="46"><span class="co"># #   Dlog1.MAN &lt;dbl&gt;, Dlog2.MAN &lt;dbl&gt;, L10Dlog1.MAN &lt;dbl&gt;, L10Dlog2.MAN &lt;dbl&gt;, Dlog1.PU &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-47" title="47"><span class="co"># #   Dlog2.PU &lt;dbl&gt;, L10Dlog1.PU &lt;dbl&gt;, L10Dlog2.PU &lt;dbl&gt;, Dlog1.CON &lt;dbl&gt;, Dlog2.CON &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-48" title="48"><span class="co"># #   L10Dlog1.CON &lt;dbl&gt;, L10Dlog2.CON &lt;dbl&gt;, Dlog1.WRT &lt;dbl&gt;, Dlog2.WRT &lt;dbl&gt;, L10Dlog1.WRT &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-49" title="49"><span class="co"># #   L10Dlog2.WRT &lt;dbl&gt;, Dlog1.TRA &lt;dbl&gt;, Dlog2.TRA &lt;dbl&gt;, L10Dlog1.TRA &lt;dbl&gt;, L10Dlog2.TRA &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-50" title="50"><span class="co"># #   Dlog1.FIRE &lt;dbl&gt;, Dlog2.FIRE &lt;dbl&gt;, L10Dlog1.FIRE &lt;dbl&gt;, L10Dlog2.FIRE &lt;dbl&gt;, Dlog1.GOV &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-51" title="51"><span class="co"># #   Dlog2.GOV &lt;dbl&gt;, L10Dlog1.GOV &lt;dbl&gt;, L10Dlog2.GOV &lt;dbl&gt;, Dlog1.OTH &lt;dbl&gt;, Dlog2.OTH &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-52" title="52"><span class="co"># #   L10Dlog1.OTH &lt;dbl&gt;, L10Dlog2.OTH &lt;dbl&gt;, Dlog1.SUM &lt;dbl&gt;, Dlog2.SUM &lt;dbl&gt;, L10Dlog1.SUM &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb36-53" title="53"><span class="co"># #   L10Dlog2.SUM &lt;dbl&gt;</span></a></code></pre></div>
<p><code>fdiff</code> and <code>fgrowth</code> can also perform leaded (forward) differences and growth rates, although I have never come to employ these in my personal work (i.e. <code>... %&gt;% fgrowth(-c(1, 10), 1:2, Year)</code> would compute one and 10-year leaded first and second differences). Again it is possible to perform sequential operations:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" title="1"><span class="co"># This computes the 1 and 10-year growth rates, for the current period and lagged by one period</span></a>
<a class="sourceLine" id="cb37-2" title="2">GGDC10S <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb37-3" title="3"><span class="st">  </span><span class="kw">group_by</span>(Variable,Country) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-4" title="4"><span class="st">     </span><span class="kw">select_at</span>(<span class="dv">5</span><span class="op">:</span><span class="dv">16</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fgrowth</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">10</span>), <span class="dv">1</span>, Year) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">flag</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">1</span>, Year)</a>
<a class="sourceLine" id="cb37-5" title="5"><span class="co"># # A tibble: 5,027 x 47</span></a>
<a class="sourceLine" id="cb37-6" title="6"><span class="co"># # Groups:   Variable, Country [85]</span></a>
<a class="sourceLine" id="cb37-7" title="7"><span class="co">#    Variable Country  Year G1.AGR L1.G1.AGR L10G1.AGR L1.L10G1.AGR G1.MIN L1.G1.MIN L10G1.MIN</span></a>
<a class="sourceLine" id="cb37-8" title="8"><span class="co">#  * &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb37-9" title="9"><span class="co">#  1 VA       BWA      1960  NA        NA           NA           NA   NA        NA          NA</span></a>
<a class="sourceLine" id="cb37-10" title="10"><span class="co">#  2 VA       BWA      1961  NA        NA           NA           NA   NA        NA          NA</span></a>
<a class="sourceLine" id="cb37-11" title="11"><span class="co">#  3 VA       BWA      1962  NA        NA           NA           NA   NA        NA          NA</span></a>
<a class="sourceLine" id="cb37-12" title="12"><span class="co">#  4 VA       BWA      1963  NA        NA           NA           NA   NA        NA          NA</span></a>
<a class="sourceLine" id="cb37-13" title="13"><span class="co">#  5 VA       BWA      1964  NA        NA           NA           NA   NA        NA          NA</span></a>
<a class="sourceLine" id="cb37-14" title="14"><span class="co">#  6 VA       BWA      1965  -3.52     NA           NA           NA  -28.6      NA          NA</span></a>
<a class="sourceLine" id="cb37-15" title="15"><span class="co">#  7 VA       BWA      1966  12.4      -3.52        NA           NA  -21.1     -28.6        NA</span></a>
<a class="sourceLine" id="cb37-16" title="16"><span class="co">#  8 VA       BWA      1967   8.29     12.4         NA           NA   16.7     -21.1        NA</span></a>
<a class="sourceLine" id="cb37-17" title="17"><span class="co">#  9 VA       BWA      1968  10.2       8.29        NA           NA  -20        16.7        NA</span></a>
<a class="sourceLine" id="cb37-18" title="18"><span class="co"># 10 VA       BWA      1969   3.61     10.2         NA           NA  185.      -20          NA</span></a>
<a class="sourceLine" id="cb37-19" title="19"><span class="co"># # ... with 5,017 more rows, and 37 more variables: L1.L10G1.MIN &lt;dbl&gt;, G1.MAN &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb37-20" title="20"><span class="co"># #   L1.G1.MAN &lt;dbl&gt;, L10G1.MAN &lt;dbl&gt;, L1.L10G1.MAN &lt;dbl&gt;, G1.PU &lt;dbl&gt;, L1.G1.PU &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb37-21" title="21"><span class="co"># #   L10G1.PU &lt;dbl&gt;, L1.L10G1.PU &lt;dbl&gt;, G1.CON &lt;dbl&gt;, L1.G1.CON &lt;dbl&gt;, L10G1.CON &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb37-22" title="22"><span class="co"># #   L1.L10G1.CON &lt;dbl&gt;, G1.WRT &lt;dbl&gt;, L1.G1.WRT &lt;dbl&gt;, L10G1.WRT &lt;dbl&gt;, L1.L10G1.WRT &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb37-23" title="23"><span class="co"># #   G1.TRA &lt;dbl&gt;, L1.G1.TRA &lt;dbl&gt;, L10G1.TRA &lt;dbl&gt;, L1.L10G1.TRA &lt;dbl&gt;, G1.FIRE &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb37-24" title="24"><span class="co"># #   L1.G1.FIRE &lt;dbl&gt;, L10G1.FIRE &lt;dbl&gt;, L1.L10G1.FIRE &lt;dbl&gt;, G1.GOV &lt;dbl&gt;, L1.G1.GOV &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb37-25" title="25"><span class="co"># #   L10G1.GOV &lt;dbl&gt;, L1.L10G1.GOV &lt;dbl&gt;, G1.OTH &lt;dbl&gt;, L1.G1.OTH &lt;dbl&gt;, L10G1.OTH &lt;dbl&gt;,</span></a>
<a class="sourceLine" id="cb37-26" title="26"><span class="co"># #   L1.L10G1.OTH &lt;dbl&gt;, G1.SUM &lt;dbl&gt;, L1.G1.SUM &lt;dbl&gt;, L10G1.SUM &lt;dbl&gt;, L1.L10G1.SUM &lt;dbl&gt;</span></a></code></pre></div>
</div>
<div id="benchmarks-1" class="section level3">
<h3>Benchmarks</h3>
<p>Using the same data as in section 1.4 (1 million obs in 17000 groups), I run benchmarks of <em>collapse</em> functions against native dplyr solutions:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" title="1"><span class="kw">dim</span>(data)</a>
<a class="sourceLine" id="cb38-2" title="2"><span class="co"># [1] 1005400      13</span></a>
<a class="sourceLine" id="cb38-3" title="3"><span class="kw">GRP</span>(data)</a>
<a class="sourceLine" id="cb38-4" title="4"><span class="co"># collapse grouping object of length 1005400 with 17000 ordered groups</span></a>
<a class="sourceLine" id="cb38-5" title="5"><span class="co"># </span></a>
<a class="sourceLine" id="cb38-6" title="6"><span class="co"># Call: GRP.grouped_df(X = data), ordered</span></a>
<a class="sourceLine" id="cb38-7" title="7"><span class="co"># </span></a>
<a class="sourceLine" id="cb38-8" title="8"><span class="co"># Distribution of group sizes: </span></a>
<a class="sourceLine" id="cb38-9" title="9"><span class="co">#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></a>
<a class="sourceLine" id="cb38-10" title="10"><span class="co">#    4.00   53.00   62.00   59.14   63.00   65.00 </span></a>
<a class="sourceLine" id="cb38-11" title="11"><span class="co"># </span></a>
<a class="sourceLine" id="cb38-12" title="12"><span class="co"># Groups with sizes: </span></a>
<a class="sourceLine" id="cb38-13" title="13"><span class="co"># EMP1.ARG1 EMP1.BOL1 EMP1.BRA1 EMP1.BWA1 EMP1.CHL1 EMP1.CHN1 </span></a>
<a class="sourceLine" id="cb38-14" title="14"><span class="co">#        62        61        62        52        63        62 </span></a>
<a class="sourceLine" id="cb38-15" title="15"><span class="co">#   ---</span></a>
<a class="sourceLine" id="cb38-16" title="16"><span class="co"># VA99.TWN99 VA99.TZA99 VA99.USA99 VA99.VEN99 VA99.ZAF99 VA99.ZMB99 </span></a>
<a class="sourceLine" id="cb38-17" title="17"><span class="co">#         63         52         65         63         52         52</span></a>
<a class="sourceLine" id="cb38-18" title="18"></a>
<a class="sourceLine" id="cb38-19" title="19"><span class="co"># Grouped Sum (mutate does not have an option to preserve missing values as given by &quot;replace&quot;)</span></a>
<a class="sourceLine" id="cb38-20" title="20"><span class="kw">system.time</span>(<span class="kw">fsum</span>(data, <span class="dt">TRA =</span> <span class="st">&quot;replace_fill&quot;</span>))</a>
<a class="sourceLine" id="cb38-21" title="21"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-22" title="22"><span class="co">#    0.08    0.00    0.08</span></a>
<a class="sourceLine" id="cb38-23" title="23"><span class="kw">system.time</span>(<span class="kw">mutate_all</span>(data, sum, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb38-24" title="24"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-25" title="25"><span class="co">#    0.21    0.05    0.25</span></a>
<a class="sourceLine" id="cb38-26" title="26"></a>
<a class="sourceLine" id="cb38-27" title="27"><span class="co"># Dviding by grouped sum</span></a>
<a class="sourceLine" id="cb38-28" title="28"><span class="kw">system.time</span>(<span class="kw">fsum</span>(data, <span class="dt">TRA =</span> <span class="st">&quot;/&quot;</span>))</a>
<a class="sourceLine" id="cb38-29" title="29"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-30" title="30"><span class="co">#    0.13    0.02    0.14</span></a>
<a class="sourceLine" id="cb38-31" title="31"><span class="kw">system.time</span>(<span class="kw">mutate_all</span>(data, <span class="cf">function</span>(x) x<span class="op">/</span><span class="kw">sum</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)))</a>
<a class="sourceLine" id="cb38-32" title="32"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-33" title="33"><span class="co">#    0.86    0.05    0.91</span></a>
<a class="sourceLine" id="cb38-34" title="34"></a>
<a class="sourceLine" id="cb38-35" title="35"><span class="co"># Mean (between transformation)</span></a>
<a class="sourceLine" id="cb38-36" title="36"><span class="kw">system.time</span>(<span class="kw">fmean</span>(data, <span class="dt">TRA =</span> <span class="st">&quot;replace_fill&quot;</span>))</a>
<a class="sourceLine" id="cb38-37" title="37"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-38" title="38"><span class="co">#    0.05    0.05    0.09</span></a>
<a class="sourceLine" id="cb38-39" title="39"><span class="kw">system.time</span>(<span class="kw">fbetween</span>(data, <span class="dt">fill =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb38-40" title="40"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-41" title="41"><span class="co">#    0.05    0.04    0.10</span></a>
<a class="sourceLine" id="cb38-42" title="42"><span class="kw">system.time</span>(<span class="kw">mutate_all</span>(data, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb38-43" title="43"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-44" title="44"><span class="co">#    2.75    0.03    2.78</span></a>
<a class="sourceLine" id="cb38-45" title="45"></a>
<a class="sourceLine" id="cb38-46" title="46"><span class="co"># De-Mean (within transformation)</span></a>
<a class="sourceLine" id="cb38-47" title="47"><span class="kw">system.time</span>(<span class="kw">fmean</span>(data, <span class="dt">TRA =</span> <span class="st">&quot;-&quot;</span>))</a>
<a class="sourceLine" id="cb38-48" title="48"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-49" title="49"><span class="co">#    0.08    0.01    0.10</span></a>
<a class="sourceLine" id="cb38-50" title="50"><span class="kw">system.time</span>(<span class="kw">fwithin</span>(data))</a>
<a class="sourceLine" id="cb38-51" title="51"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-52" title="52"><span class="co">#    0.06    0.03    0.10</span></a>
<a class="sourceLine" id="cb38-53" title="53"><span class="kw">system.time</span>(<span class="kw">mutate_all</span>(data, <span class="cf">function</span>(x) x <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)))</a>
<a class="sourceLine" id="cb38-54" title="54"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-55" title="55"><span class="co">#    2.31    0.08    2.39</span></a>
<a class="sourceLine" id="cb38-56" title="56"></a>
<a class="sourceLine" id="cb38-57" title="57"><span class="co"># Centering on global mean</span></a>
<a class="sourceLine" id="cb38-58" title="58"><span class="kw">system.time</span>(<span class="kw">fwithin</span>(data, <span class="dt">add.global.mean =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb38-59" title="59"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-60" title="60"><span class="co">#    0.08    0.00    0.08</span></a>
<a class="sourceLine" id="cb38-61" title="61"></a>
<a class="sourceLine" id="cb38-62" title="62"><span class="co"># Weighted Demeaning</span></a>
<a class="sourceLine" id="cb38-63" title="63"><span class="kw">system.time</span>(<span class="kw">fwithin</span>(data, SUM))</a>
<a class="sourceLine" id="cb38-64" title="64"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-65" title="65"><span class="co">#    0.08    0.00    0.08</span></a>
<a class="sourceLine" id="cb38-66" title="66"><span class="kw">system.time</span>(<span class="kw">fwithin</span>(data, SUM, <span class="dt">add.global.mean =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb38-67" title="67"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-68" title="68"><span class="co">#    0.06    0.01    0.08</span></a>
<a class="sourceLine" id="cb38-69" title="69"></a>
<a class="sourceLine" id="cb38-70" title="70"><span class="co"># Scaling</span></a>
<a class="sourceLine" id="cb38-71" title="71"><span class="kw">system.time</span>(<span class="kw">fsd</span>(data, <span class="dt">TRA =</span> <span class="st">&quot;/&quot;</span>))</a>
<a class="sourceLine" id="cb38-72" title="72"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-73" title="73"><span class="co">#    0.12    0.03    0.15</span></a>
<a class="sourceLine" id="cb38-74" title="74"><span class="kw">system.time</span>(<span class="kw">mutate_all</span>(data, <span class="cf">function</span>(x) x<span class="op">/</span><span class="kw">sd</span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)))</a>
<a class="sourceLine" id="cb38-75" title="75"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-76" title="76"><span class="co">#    3.72    0.02    3.75</span></a>
<a class="sourceLine" id="cb38-77" title="77"></a>
<a class="sourceLine" id="cb38-78" title="78"><span class="co"># Standardizing</span></a>
<a class="sourceLine" id="cb38-79" title="79"><span class="kw">system.time</span>(<span class="kw">fscale</span>(data))</a>
<a class="sourceLine" id="cb38-80" title="80"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-81" title="81"><span class="co">#    0.10    0.02    0.12</span></a>
<a class="sourceLine" id="cb38-82" title="82"><span class="co"># system.time(mutate_all(data, scale)) This takes 32 seconds to compute.. </span></a>
<a class="sourceLine" id="cb38-83" title="83"></a>
<a class="sourceLine" id="cb38-84" title="84"><span class="co"># Weighted Scaling and standardizing</span></a>
<a class="sourceLine" id="cb38-85" title="85"><span class="kw">system.time</span>(<span class="kw">fsd</span>(data, SUM, <span class="dt">TRA =</span> <span class="st">&quot;/&quot;</span>))</a>
<a class="sourceLine" id="cb38-86" title="86"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-87" title="87"><span class="co">#    0.12    0.02    0.14</span></a>
<a class="sourceLine" id="cb38-88" title="88"><span class="kw">system.time</span>(<span class="kw">fscale</span>(data, SUM))</a>
<a class="sourceLine" id="cb38-89" title="89"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-90" title="90"><span class="co">#    0.07    0.03    0.11</span></a>
<a class="sourceLine" id="cb38-91" title="91"></a>
<a class="sourceLine" id="cb38-92" title="92"><span class="co"># Lags and Leads</span></a>
<a class="sourceLine" id="cb38-93" title="93"><span class="kw">system.time</span>(<span class="kw">flag</span>(data))</a>
<a class="sourceLine" id="cb38-94" title="94"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-95" title="95"><span class="co">#    0.01    0.04    0.04</span></a>
<a class="sourceLine" id="cb38-96" title="96"><span class="kw">system.time</span>(<span class="kw">mutate_all</span>(data, lag))</a>
<a class="sourceLine" id="cb38-97" title="97"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-98" title="98"><span class="co">#    0.18    0.01    0.19</span></a>
<a class="sourceLine" id="cb38-99" title="99"><span class="kw">system.time</span>(<span class="kw">flag</span>(data, <span class="dv">-1</span>))</a>
<a class="sourceLine" id="cb38-100" title="100"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-101" title="101"><span class="co">#    0.02    0.03    0.04</span></a>
<a class="sourceLine" id="cb38-102" title="102"><span class="kw">system.time</span>(<span class="kw">mutate_all</span>(data, lead))</a>
<a class="sourceLine" id="cb38-103" title="103"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-104" title="104"><span class="co">#    0.17    0.01    0.19</span></a>
<a class="sourceLine" id="cb38-105" title="105"><span class="kw">system.time</span>(<span class="kw">flag</span>(data, <span class="dv">-1</span><span class="op">:</span><span class="dv">1</span>))</a>
<a class="sourceLine" id="cb38-106" title="106"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-107" title="107"><span class="co">#    0.07    0.04    0.10</span></a>
<a class="sourceLine" id="cb38-108" title="108"></a>
<a class="sourceLine" id="cb38-109" title="109"><span class="co"># Differences</span></a>
<a class="sourceLine" id="cb38-110" title="110"><span class="kw">system.time</span>(<span class="kw">fdiff</span>(data))</a>
<a class="sourceLine" id="cb38-111" title="111"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-112" title="112"><span class="co">#    0.04    0.02    0.06</span></a>
<a class="sourceLine" id="cb38-113" title="113"><span class="kw">system.time</span>(<span class="kw">fdiff</span>(data,<span class="dv">1</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb38-114" title="114"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-115" title="115"><span class="co">#    0.11    0.04    0.16</span></a>
<a class="sourceLine" id="cb38-116" title="116"><span class="kw">system.time</span>(<span class="kw">fdiff</span>(data, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>)))</a>
<a class="sourceLine" id="cb38-117" title="117"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-118" title="118"><span class="co">#    0.04    0.06    0.11</span></a>
<a class="sourceLine" id="cb38-119" title="119"><span class="kw">system.time</span>(<span class="kw">fdiff</span>(data, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>), <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb38-120" title="120"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-121" title="121"><span class="co">#    0.38    0.08    0.46</span></a>
<a class="sourceLine" id="cb38-122" title="122"></a>
<a class="sourceLine" id="cb38-123" title="123"><span class="co"># Growth Rates</span></a>
<a class="sourceLine" id="cb38-124" title="124"><span class="kw">system.time</span>(<span class="kw">fgrowth</span>(data))</a>
<a class="sourceLine" id="cb38-125" title="125"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-126" title="126"><span class="co">#    0.06    0.03    0.09</span></a>
<a class="sourceLine" id="cb38-127" title="127"><span class="kw">system.time</span>(<span class="kw">fgrowth</span>(data,<span class="dv">1</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb38-128" title="128"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-129" title="129"><span class="co">#    0.17    0.05    0.22</span></a>
<a class="sourceLine" id="cb38-130" title="130"><span class="kw">system.time</span>(<span class="kw">fgrowth</span>(data, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>)))</a>
<a class="sourceLine" id="cb38-131" title="131"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-132" title="132"><span class="co">#    0.12    0.04    0.17</span></a>
<a class="sourceLine" id="cb38-133" title="133"><span class="kw">system.time</span>(<span class="kw">fgrowth</span>(data, <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">10</span>), <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb38-134" title="134"><span class="co">#    user  system elapsed </span></a>
<a class="sourceLine" id="cb38-135" title="135"><span class="co">#    0.36    0.20    0.57</span></a></code></pre></div>
<p>Again the benchmarks show stunning performance gains using <em>collapse</em> functions.</p>
</div>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<p>Timmer, M. P., de Vries, G. J., &amp; de Vries, K. (2015). “Patterns of Structural Change in Developing Countries.” . In J. Weiss, &amp; M. Tribe (Eds.), <em>Routledge Handbook of Industry and Development.</em> (pp. 65-83). Routledge.</p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>100% being the sum of all VA/EMP in a given sector and country across all years, not the sectoral output share which would gave to be obtained using <code>sweep(GGDC10S[6:16], 1, GGDC10S$SUM, &quot;/&quot;)</code><a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>Row-wise operations are not supported by TRA.<a href="#fnref2" class="footnote-back">↩</a></p></li>
</ol>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
